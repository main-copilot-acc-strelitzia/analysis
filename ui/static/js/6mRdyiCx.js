var t,i,e,s,h,r,a,n,o,c,l,d,g,p,u,w,f,m,v,y,M,k,b,x,W,C,E,L,T,S,F,D,A,_,Y,X,P,R,H,I,N,U,G,B,j,z,O,V,K,$,q,J,Q,Z,tt,it,et,st,ht,rt,at,nt,ot,ct,lt,dt,gt,pt,ut,wt,ft,mt,vt,yt,Mt,kt,bt,xt,Wt,Ct,Et,Lt,Tt,St,Ft,Dt,At,_t,Yt,Xt,Pt,Rt,Ht,It,Nt,Ut,Gt,Bt,jt,zt,Ot,Vt,Kt,$t,qt,Jt,Qt,Zt,ti,ii,ei,si,hi,ri,ai,ni,oi,ci,li,di,gi,pi,ui,wi,fi,mi,vi,yi,Mi,ki,bi,xi,Wi,Ci,Ei,Li,Ti,Si,Fi,Di,Ai,_i,Yi,Xi,Pi,Ri,Hi,Ii,Ni,Ui,Gi,Bi,ji,zi,Oi,Vi,Ki,$i,qi,Ji,Qi,Zi,te,ie,ee,se,he,re,ae,ne,oe,ce,le,de=t=>{throw TypeError(t)},ge=(t,i,e)=>i.has(t)||de("Cannot "+e),pe=(t,i,e)=>(ge(t,i,"read from private field"),e?e.call(t):i.get(t)),ue=(t,i,e)=>i.has(t)?de("Cannot add the same private member more than once"):i instanceof WeakSet?i.add(t):i.set(t,e),we=(t,i,e,s)=>(ge(t,i,"write to private field"),s?s.call(t,e):i.set(t,e),e),fe=(t,i,e)=>(ge(t,i,"access private method"),e);import{B as me,G as ve,c as ye,d as Me,e as ke,s as be,f as xe}from"./CQ67ee1G.js";import{ae as We}from"./d_ed_6Ut.js";import{h as Ce,S as Ee,l as Le}from"./HcGwWu0z.js";import{a as Te,C as Se,B as Fe,M as De,r as Ae,t as _e,E as Ye,c as Xe,d as Pe,e as Re}from"./B6FSvflP.js";import{f as He,h as Ie,g as Ne}from"./B6FSvflP.js";import{j as Ue,i as Ge}from"./BAEQURWy.js";import{g as Be,B as je,c as ze,e as Oe,f as Ve}from"./Bp5cWvCe.js";import{a as Ke,l as $e,k as qe,h as Je,i as Qe,d as Ze,j as ts,p as is,u as es}from"./Bp5cWvCe.js";function ss(t,i){return 2*t*Math.max(i,1)}async function hs(t,i,e,s,h,r){if(await ds(t,i,1,null,e,s,h,r),!t.length)return;let a=null,n=null;const o=Be(t.buffer),c=os(t.period,e,s,h),l=ns(c,i,t.period,e,s,h);o<c&&(a=r(t.symbol,t.period,l,c,1)),t&&t.length<i&&(n=rs(t,i,e,s,h,r)),await n,await a}async function rs(t,i,e,s,h,r){try{await ls(t,i,1,e,s,h,r)}catch(a){}}async function as(t,i,e,s,h,r){try{await cs(t,i,1,e,s,h,r)}catch(a){}}function ns(t,i,e,s,h,r){const a=60*s*1e3,n=60*e*1e3,o=1e3*(h+3600*r);return Math.max(Math.floor(o+(t-n*i-a)),0)}function os(t,i,e,s){const h=60*i*1e3,r=Date.now()-h;return Te(r+1e3*(e+3600*s),t)}async function cs(t,i,e,s,h,r,a){if(t.pending)throw new Error("bars is pending already");const n=os(t.period,s,h,r),o=t.time(t.length-1),c=Math.min(function(t,i,e,s){const h=60*s*1e3;return Math.floor(t+60*e*1e3*i-h)}(o,ss(i,e),t.period,s),n);if(o>n)throw new Error("bars from feature");if(o===n&&e>1)throw new Error("attempt more then one");const l=await a(t.symbol,t.period,o,c,1);l&&l.byteLength<=48&&e<20&&await cs(t,i,e+1,s,h,r,a)}async function ls(t,i,e=1,s,h,r,a){if(t.final)throw new Error(`bars max count: ${je.MAX_COUNT}`);if(t.pending)throw new Error("bars is pending already");const n=t.time(-1),o=ns(n,ss(i,e),t.period,s,h,r),c=await a(t.symbol,t.period,o,n,-1);if(c&&!c.byteLength){if(e<20)return void(await ls(t,i,e+1,s,h,r,a));t.final=!0}}async function ds(t,i,e,s,h,r,a,n){const o=s??os(t.period,h,r,a),c=ns(o,ss(i,e),t.period,h,r,a);await n(t.symbol,t.period,c,o,-1);const l=Date.now()-h,d=ze(l,c,1440);!t.length&&(d<31||e<20)&&await ds(t,i,e+1,c,h,r,a,n)}class gs extends Se{constructor(i,e=1e3){super(i,e),ue(this,t)}_draw(){const{chart:i}=this,{colors:e}=i,s=this.changed(0,e.chart.backgroundColor,i.app.screen.width,i.app.screen.height,i.showCrosshair);let h=pe(this,t);h&&!s||(we(this,t,this._createGraphics()),pe(this,t).eventMode=i.showCrosshair?"static":"auto",pe(this,t).cursor=i.showCrosshair?"crosshair":"default",h=pe(this,t),h.beginFill(e.chart.backgroundColor),h.drawRect(0,0,i.app.screen.width,i.app.screen.height),h.endFill()),this.container.addChild(h)}tick(){}_init(){}_before(){}}t=new WeakMap,i=new WeakSet,e=function(t,i,e,s=!1){const{state:h,colors:r}=this.chart;if(i<h.graphX||i>h.graphX+h.graphWidth)return null;const a=this.createText(e),n=s?18:16,o=s?"Trebuchet MS Bold":"Trebuchet MS";return a.fontSize!==n&&(a.fontSize=n),a.fontName!==o&&(a.fontName=o),r.chart.axis.textColor>0&&(a.tint=r.chart.axis.textColor),a.x=Math.floor(i),a.y=Math.floor(h.graphHeight+(h.axisXHeight-a.height-4)/2),t.addChild(a),a},s=function(t,i,e){const{state:s,colors:h}=this.chart;i<=s.graphX||i>s.graphX+s.graphWidth||(t.beginFill(h.chart.gridColor),t.drawRect(i,0,1,e))},h=function(t,i){const{state:e,colors:s}=this.chart;i<=e.graphX||i>e.graphX+e.graphWidth||(t.beginFill(s.chart.axis.borderColor),t.drawRect(i,e.graphHeight,1,4))},r=function(t,i,e){const s=new Date(i),h=new Date(e);switch(t){case"m":return s.getUTCHours()!==h.getUTCHours();case"h":return s.getUTCDay()!==h.getUTCDay();case"D":return s.getUTCMonth()!==h.getUTCMonth();case"M":return s.getUTCFullYear()!==h.getUTCFullYear();default:return!1}},a=function(t,e,s){const h=new Date(e),r={isAllowed:!0,firstDate:e};if(null===s||240===this.chart.bars.period)return r;const a=new Date(s);switch(t){case"D":return fe(this,i,n).call(this,h,a);case"Y":return fe(this,i,o).call(this,h,a);default:return r}},n=function(t,i){const e=Date.now();return t.getTime()>e?{isAllowed:t.getUTCHours()===i.getUTCHours(),firstDate:null}:t.getTime()<e&&(i.getUTCDate()<t.getUTCDate()||i.getUTCDate()>t.getUTCDate()&&i.getTime()<t.getTime())?{isAllowed:!0,firstDate:t.getTime()}:{isAllowed:!1,firstDate:null}},o=function(t,i){const e=new Date;return t.getUTCFullYear()<e.getUTCFullYear()?i.getUTCFullYear()!==t.getUTCFullYear()&&i.getTime()<t.getTime()?{isAllowed:!0,firstDate:t.getTime()}:{isAllowed:!1,firstDate:null}:t.getUTCFullYear()===e.getUTCFullYear()?{isAllowed:!1,firstDate:null}:{isAllowed:!0,firstDate:t.getTime()}},c=function(t,e){const{state:s}=this.chart,h=this.chart.bars;for(let a=e;a>s.xShift;a--){const e=h.time(a),s=h.time(a-1);if(fe(this,i,r).call(this,t,e,s))return a-1}return e},l=function(t,i,e=!1){const s=new Date(t),{period:h}=this.chart.bars;let r="DD.MM.YY hhhh:mm";return"m"===i&&(r="hhhh:mm",e&&0===s.getUTCHours()&&0===s.getUTCMinutes()&&(r="D MMM hhhh:mm")),"h"===i&&(r="hhhh:mm",e&&(r="D MMM",0!==s.getUTCHours()&&(r+=" hhhh:mm"))),"D"===i&&(r="D",240===h&&(r+=" MMM"),e&&(r="D MMM",0===s.getUTCMonth()&&(r+=" YY")),240===h&&(r+=" hhhh:mm")),"M"===i&&(r="MMM",e&&(r="YY",0!==s.getUTCMonth()&&(r="MMM YY"))),"Y"===i&&(r="YY"),r},d=function(t,i,e){let s=["Y","M","D","h"].find((s=>Oe(t,i,s)>e));return s||(s="m"),s};let ps=class t extends Se{constructor(t,e=2e3){super(t,e),ue(this,i)}static get STEP(){return 90}tick(){}_before(){}_draw(){const{state:n,colors:o}=this.chart,g=this.chart.bars;if(!g)return;const p=n.getFrom(),u=n.getCount(),w=n.getStep(),f=g.time(p),m=g.time(p+u),v=Math.floor(n.graphWidth/t.STEP*.7),y=fe(this,i,d).call(this,f,m,v);let M=!0;const k=Math.ceil(u/Math.ceil(n.graphWidth/t.STEP)),b=fe(this,i,c).call(this,y,p),x=g.length-1;let W,C=null,E=null,L=n.startX()-(p-b)*w;const T=n.graphHeight,S=this._createGraphics();S.x=n.graphX,S.beginFill(o.chart.backgroundColor),S.drawRect(0,T,n.graphWidth,this.chart.state.axisXHeight),S.endFill(),S.beginFill(o.chart.axis.borderColor),S.drawRect(0,T,n.graphWidth+1,1),S.endFill();for(let t=b,c=p+u,d=0;t<c;t++){const o=t===x,c=g.time(t),p=fe(this,i,a).call(this,y,c,E);if(E=p.firstDate||E,p.isAllowed||o){let t=!1;if(W&&(t=fe(this,i,r).call(this,y,c,W)),M||d===k||t||o){M=!1;const r=fe(this,i,l).call(this,c,y,t),a=Ce(c,r),n=fe(this,i,e).call(this,S,L,a,t);n&&(C&&C.x+C.textWidth+5>n.x?o?(S.removeChild(C),C=n,fe(this,i,h).call(this,S,L),this.chart.showGrid&&fe(this,i,s).call(this,S,L,T)):S.removeChild(n):(C=n,fe(this,i,h).call(this,S,L),this.chart.showGrid&&fe(this,i,s).call(this,S,L,T))),d=0,W=c}d+=1}else M=!0;L+=n.getStep()}S.endFill(),this.container.addChild(S)}};class us extends Se{constructor(t,i=9e3){super(t,i),ue(this,w),ue(this,g),ue(this,p),ue(this,u),this.section=t.section,this.container.interactiveChildren=!1}tick(t){if(!pe(this,g)&&!pe(this,p))return this;const{digits:i}=this.chart;t.close>t.open?fe(this,w,m).call(this,pe(this,g),t.close,i):fe(this,w,m).call(this,pe(this,p),t.close,i);const e=this.valueToY(t.close);return e<this.section.y||e>=this.section.y+this.section.height-1||pe(this,g)&&pe(this,p)&&(pe(this,g).y=e,pe(this,p).y=e,pe(this,g).visible=t.close>t.open,pe(this,p).visible=!pe(this,g).visible),this}_draw(){var t;(null==(t=this.chart.bars)?void 0:t.real)&&fe(this,w,f).call(this)}}g=new WeakMap,p=new WeakMap,u=new WeakMap,w=new WeakSet,f=function(){const t=this.chart.state.yAxisIsLeft?this.chart.state.graphX:this.chart.app.screen.width,i=this.chart.app.screen.height,e=this._createGraphics("mask");e.isMask=!0,e.beginFill(),e.drawRect(0,0,t,i),e.endFill(),this.container.addChild(e);const s=this._createGraphics();s.mask=e,this.container.addChild(s);const h=fe(this,w,v).call(this),r=this.valueToY(h.close);if(r<this.section.y||r>=this.section.y+this.section.height-1)return;const a=this.changed(0,this.chart.state.graphWidth,this.chart.colors.chart.priceLines.bidUp,this.chart.colors.chart.priceLines.bidDown,this.chart.colors.chart.priceLines.bidText);pe(this,g)&&!a||(we(this,g,this.createPriceLine("up",this.chart.colors.chart.priceLines.bidUp,this.chart.colors.chart.priceLines.bidText,this.chart.colors.chart.priceLines.bidUp)),pe(this,g).y=r),pe(this,p)&&!a||(we(this,p,this.createPriceLine("down",this.chart.colors.chart.priceLines.bidDown,this.chart.colors.chart.priceLines.bidText,this.chart.colors.chart.priceLines.bidDown)),pe(this,p).y=r),pe(this,g).visible=h.close>h.open,pe(this,p).visible=!pe(this,g).visible;const n=this.chart.digits;h.close>h.open?fe(this,w,m).call(this,pe(this,g),h.close,n):fe(this,w,m).call(this,pe(this,p),h.close,n),s.addChild(pe(this,g),pe(this,p)),pe(this,p).y=r,pe(this,g).y=pe(this,p).y},m=function(t=null,i,e){if(!t)return;const s=t.getChildAt(0);if(s&&s instanceof me&&(s.text=i.toFixed(e),this.chart.state.yAxisIsLeft)){let t=pe(this,u);t&&!this.changed("price",i.toFixed().length,e)||(we(this,u,s.textWidth),t=pe(this,u)),s.x=this.chart.state.yAxisWidth-(t||0)-8}},v=function(){const t=this.chart.bars,i=t.length-1,e=t.close(i);return{index:i,open:t.open(i),close:e}};class ws extends Se{constructor(t,i=7e3,e){super(t,i),ue(this,y,null),ue(this,M,null),ue(this,k,0),ue(this,b,0),ue(this,x,0),ue(this,W,(t=>{t.detail.hideSelectedDate||this.draw()})),this.objects=e,e.on("301",pe(this,W)),e.on("302",pe(this,W)),e.on("303",pe(this,W)),this.container.interactiveChildren=!1}updateDateLine(t="date",i=0){const{period:e}=this.chart.bars;let s="YY.MM.DD hhhh:mm";e>240&&(s="YY.MM.DD"),e>10080&&(s="YY.MM");const h=Ce(i,s),r=this._getGraphicsFromCache(t);if(r&&r.children.length){const t=r.getChildAt(0);if(t&&t instanceof me){const i=!t.text;t.text=h,i&&(t.x=-Math.round(.5*t.textWidth))}}}updateSizes(t){const{state:i,style:e}=this.chart,{text:s}=t;t.text="0123456789 .",we(this,b,Math.floor(t.height)-3+2*e.indent),we(this,k,Math.floor(i.graphHeight+(i.axisXHeight-t.height)/2)),t.y=pe(this,k),we(this,k,pe(this,k)+3-e.indent),t.text=s,we(this,x,96+2*e.indent),this.chart.bars.period>240&&we(this,x,62+2*e.indent),this.chart.bars.period>10080&&we(this,x,44+2*e.indent)}createDateLine(t="date",i=3355443,e=16777215,s=3355443){const{chart:h}=this,{state:r}=h,a=this._createGraphics(t);a.x-=1e3,a.beginFill(i),a.drawRect(0,0,1,r.graphHeight+(h.app.screen.height-r.graphHeight)/2),a.endFill();const n=this.createText("",t);return e&&(n.tint=e),this.updateSizes(n),a.beginFill(s),a.drawRect(Math.round(.5*-pe(this,x)),pe(this,k),pe(this,x),pe(this,b)),n.text="",a.endFill(),a.addChild(n),a}tick(){}_draw(){this._drawPrice()}_drawPrice(){const{chart:t}=this,{bars:i,colors:e,state:s}=t,h=e.chart.selected,r=s.yAxisIsLeft?s.yAxisWidth:0,a=s.graphHeight,n=s.graphWidth,o=t.app.screen.height-s.graphHeight,c=this._createGraphics("mask");c.isMask=!0,c.beginFill(),c.drawRect(r,a,n,o),c.endFill(),this.container.addChild(c);const l=this._createGraphics();l.mask=c,this.container.addChild(l);const d=this.changed(0,s.graphHeight,h.marker.textColor,h.marker.backgroundColor,this.chart.bars.period,pe(this,x),pe(this,k),pe(this,b),this.chart.style.indent);let g,p;d&&(we(this,y,null),we(this,M,null));const u=this.getMin();u!==Number.MAX_VALUE&&(g=s.indexToX(i.index(u)),g>=r&&g<=r+n?(pe(this,y)&&!d||we(this,y,this.createDateLine("min",h.marker.backgroundColor,h.marker.textColor,h.marker.backgroundColor)),pe(this,y).x=g+s.graphX,pe(this,y).visible=!0,this.updateDateLine("min",u),l.addChild(pe(this,y))):pe(this,y)&&(pe(this,y).visible=!1));const w=this.getMax();w!==Number.MIN_VALUE&&(p=s.indexToX(i.index(w)),p>=r&&p<=r+n?(pe(this,M)&&!d||we(this,M,this.createDateLine("max",h.marker.backgroundColor,h.marker.textColor,h.marker.backgroundColor)),pe(this,M).x=p+s.graphX,pe(this,M).visible=!0,this.updateDateLine("max",w),l.addChild(pe(this,M))):pe(this,M)&&(pe(this,M).visible=!1)),"number"==typeof g&&"number"==typeof p&&u!==Number.MAX_VALUE&&w!==Number.MIN_VALUE&&(g>=r&&g<=r+n||p>=r&&p<=r+n)&&(l.beginFill(h.diff.color,h.diff.alpha),l.drawRect(Math.min(p,g)+s.graphX,pe(this,k),Math.max(p,g)-Math.min(p,g),pe(this,b)),l.endFill())}getMin(){let t=Number.MAX_VALUE;return this.objects.data.forEach((i=>{if(i.focused){const{date1:e,date2:s,date3:h,date4:r}=i.settings.coordinates,a=[t,e,s,h,r].filter((t=>"number"==typeof t)).map(Number);t=Math.min(...a)}})),t}getMax(){let t=Number.MIN_VALUE;return this.objects.data.forEach((i=>{if(i.focused){const{date1:e,date2:s,date3:h,date4:r}=i.settings.coordinates,a=[t,e,s,h,r].filter((t=>"number"==typeof t)).map(Number);t=Math.max(...a)}})),t}destroy(){const{objects:t}=this;t.off("301",pe(this,W)),t.off("302",pe(this,W)),t.off("303",pe(this,W)),super.destroy()}}y=new WeakMap,M=new WeakMap,k=new WeakMap,b=new WeakMap,x=new WeakMap,W=new WeakMap;const fs=.75*De;class ms extends Fe{_draw(){2===this.chart.chartType?super._draw():this.clear()}_drawGraph(t,i){const{state:e,colors:s}=this.chart,h=this.chart.bars,r=e.getStep();let a=r;a-=a%2;let n=Math.min(Math.floor(fs*e.xScale),a);n>=3?(n=n-n%2+1,n>a&&(n=a-1)):n=1;const o=.5*n-.5,c=h.length-1;let l=e.startX();const d=e.getFrom();for(let g=d,p=d+(e.getCount()+1);g<p;g++){const e=Math.floor(l);if(g>=0){let r=h.open(g),a=h.high(g),l=h.low(g),d=h.close(g);if(g===c&&i&&(r=i.open,a=i.high,l=i.low,d=i.close),d){const i=d>r?s.chart.graph.upColor:s.chart.graph.downColor;t.beginFill(i);let h=this.valueToY(a),c=this.valueToY(l);t.drawRect(e,h,1,c-h),h=this.valueToY(Math.max(d,r)),c=this.valueToY(Math.min(d,r)),c-h==0&&(c+=1),t.drawRect(e-o,h,n,c-h),t.endFill()}}l+=r}}}class vs extends Fe{_draw(){1===this.chart.chartType?super._draw():this.clear()}_drawGraph(t,i){const{state:e,colors:s}=this.chart,h=this.chart.bars,r=e.getFrom(),a=e.getStep(),n=a>3?.4*a:0,o=h.length-1;let c=e.startX();for(let l=r,d=r+e.getCount()+1;l<d;l++){const e=Math.round(c);if(l>=0){let r=h.open(l),a=h.high(l),c=h.low(l),d=h.close(l);if(l===o&&i&&(r=i.open,a=i.high,c=i.low,d=i.close),d){const i=d>r?s.chart.graph.upColor:s.chart.graph.downColor;let h=this.valueToY(a),o=this.valueToY(c);t.beginFill(i),t.lineStyle(0,i,1),t.drawRect(e,h,1,o-h),h=this.valueToY(r),t.drawRect(e-n,h,n,1),o=this.valueToY(d),t.drawRect(e,o,n,1),t.endFill()}}c+=a}}}class ys extends Fe{constructor(){super(...arguments),ue(this,C)}_draw(){this.chart.bars.real?super._draw():this.clear()}_drawGraph(t,i){fe(this,C,E).call(this,t,i)}}C=new WeakSet,E=function(t,i){const{state:e,colors:s}=this.chart,h=this.chart.bars;let r=e.startX();const a=h.length-1;let n=!1;const{thickness:o}=this.settings.style;t.lineStyle(o,s.chart.graph.lineColor);const c=e.getFrom();for(let l=c,d=c+e.getCount()+1;l<d;l++){if(l>=0){let e=h.close(l);if(l===a&&i&&(e=i.close),e){const i=this.valueToY(e);n?t.lineTo(r,i):(t.moveTo(r,i),n=!0)}}r+=e.getStep()}};class Ms extends ys{constructor(){super(...arguments),ue(this,L)}_drawGraph(t,i){fe(this,L,T).call(this,t),fe(this,L,S).call(this,t,i),super._drawGraph(t,i)}}function ks(t){return window.TouchEvent&&t instanceof TouchEvent?"touchstart"===t.type:t instanceof MouseEvent?0===t.button&&"mousedown"===t.type:"pointerdown"===t.type&&0===t.button}function bs(t){return!(window.TouchEvent&&t instanceof TouchEvent)&&(t instanceof MouseEvent?1===t.button&&"mousedown"===t.type:"pointerdown"===t.type&&1===t.button)}function xs(t){return!(window.TouchEvent&&t instanceof TouchEvent)&&(t instanceof MouseEvent?2===t.button&&"mousedown"===t.type:"pointerdown"===t.type&&2===t.button)}L=new WeakSet,T=function(t){const{state:i,colors:e}=this.chart;if(this.changed("gradient",i.graphWidth,i.graphHeight,e.chart.graph.areaColor)){let t=i.graphY;const s=t+i.graphHeight,h=.2,r=h/(s-t);let a=h;this.gradient=new ve;const n=this.gradient;for(;t<s;)a-=r,n.beginFill(e.chart.graph.areaColor,a),n.drawRect(0,t,i.graphWidth,1),t+=1}this.gradient&&t.addChild(this.gradient)},S=function(t,i){const{state:e}=this.chart,s=this.chart.bars;let h=e.startX(),r=0,a=!0;const n=this._createGraphics("mask-gradient");n.isMask=!0,n.beginFill(0),this.gradient&&(this.gradient.mask=n);const o=s.length-1,c=e.getFrom();for(let l=c,d=c+e.getCount()+1;l<d;l++){if(l>=-1){let t=s.close(l);l===o&&i&&(t=i.close),t&&(a&&(n.moveTo(h,e.graphHeight),a=!1),n.lineTo(h,this.valueToY(t)),r=h)}h+=e.getStep()}n.lineTo(r,e.graphHeight),n.endFill(),this.container.addChild(n),this.gradient&&t.addChild(this.gradient)};class Ws extends Ee{constructor(t,i,e){super(),this.category=5,this.style={thickness:1},this.digits=0,this.flags=19,this.uid=Ae(16),this.parent="",this.visible=!0,this.mask={period:511,navigator:!0},this.params={},this.type=i,this.title=e,this.style.thickness=t}toJSON(){return _e(this)}}class Cs extends Fe{get yMin(){return 0}get yMax(){const{state:t}=this.chart,i=this.chart.bars,e=t.getFrom(),s=t.getCount(),h=Math.max(0,e),r=Math.max(0,e+s+1);return i.max(h,r,this.chart.volumeType)}get yHeight(){var t;return Math.round(.2*((null==(t=this.section)?void 0:t.height)??0))}getYDigits(){return 1}_draw(t){0!==this.chart.volumeType&&super._draw(t)}_before(){var t;const i=this.yMax*this.getYDigits();this.yStep=this.yHeight/i,this.yNull=(null==(t=this.section)?void 0:t.height)??0}_drawGraph(t,i){const{chart:e,section:s}=this,{state:h,colors:r}=e,a=this.chart.bars,n=h.getStep(),o=h.getFrom(),c=h.getCount(),l=Math.max(1,Math.floor(n-1));let d=h.startX()-Math.floor(.5*l);t.alpha=.4;const g=a.length-1;for(let p=o,u=o+c;p<u;p++){const e=Math.round(d);if(p>=0){const h=a.open(p),n=a.close(p);let o=a.tickVolume(p),c=a.realVolume(p);p===g&&i&&(o=i.tickVolume,c=i.realVolume);const d=n>h?r.chart.volume.upColor:r.chart.volume.downColor,u=2===this.chart.volumeType?c:o;if(0!==u){const i=this.valueToY(u),h=((null==s?void 0:s.height)??0)-i;t.beginFill(d),t.drawRect(e,i,l,h),t.endFill()}}d+=n}}tick(t){this._draw(t)}}let Es,Ls;class Ts extends Se{constructor(t,i=1e4){super(t,i),ue(this,X),ue(this,F),ue(this,D),ue(this,A),ue(this,_),ue(this,Y),ue(this,j,(t=>{const i=t.global.y;let e=t.global.x;e-=this.chart.state.graphX,we(this,F,e),we(this,D,i),fe(this,X,R).call(this,e,i)})),ue(this,z,(()=>{this.container.visible=!1,we(this,F,void 0),we(this,D,void 0)}));const{stage:e}=this.chart.app;e&&(e.removeEventListener("pointerdown",pe(this,j)),e.removeEventListener("pointermove",pe(this,j)),e.removeEventListener("mouseout",pe(this,z)),e.addEventListener("pointerdown",pe(this,j)),e.addEventListener("pointermove",pe(this,j)),e.addEventListener("mouseout",pe(this,z))),this.container.interactiveChildren=!1}tick(){}_draw(){!this.chart.showCrosshair&&!this.chart.showRulerCrosshair||this.chart.previewMode||(pe(this,A)&&pe(this,_)&&this.container.addChild(pe(this,A),pe(this,_)),void 0!==pe(this,F)&&void 0!==pe(this,D)&&fe(this,X,R).call(this,pe(this,F),pe(this,D)))}destroy(){var t;null==(t=this.chart.app.stage)||t.off("pointerdown",pe(this,j)).off("pointermove",pe(this,j)).off("mouseout",pe(this,z)),super.destroy()}}F=new WeakMap,D=new WeakMap,A=new WeakMap,_=new WeakMap,Y=new WeakMap,X=new WeakSet,P=function(t){const i=new ve;i.beginFill(t,.7),i.drawRect(0,0,1,3),i.drawRect(0,9,1,3),i.width=1,i.height=9,i.endFill(),Es=this.chart.app.renderer.generateTexture(i,{scaleMode:0,resolution:window.devicePixelRatio})},R=function(t,i){const{state:e}=this.chart;(this.chart.showCrosshair||this.chart.showRulerCrosshair)&&!this.chart.previewMode&&t>e.graphX&&t<e.graphX+e.graphWidth&&i>e.graphY&&i<e.graphY+e.graphHeight?(this.container.visible=!0,fe(this,X,H).call(this,t)):this.container.visible=!1},H=function(t){const{state:i}=this.chart,e=this.chart.bars,s=i.xToIndex(t),h=e.time(s);if(h&&(fe(this,X,U).call(this),pe(this,A))){const{graphX:t,graphWidth:e,yAxisIsLeft:r,yAxisWidth:a}=i,n=i.indexToX(s)+t,o=n>t&&n<t+e;if(pe(this,A).x=n,pe(this,A).visible=o,o){if(pe(this,_)||fe(this,X,B).call(this),pe(this,_)&&pe(this,Y)){const t=pe(this,_).width/2;pe(this,Y).text=Ce(h,fe(this,X,I).call(this));const i=r?n+a:n,s=r?n:e+a-n;pe(this,_).x=i<t?Math.floor(t):s<t?e-Math.floor(t):n}fe(this,X,B).call(this)}}},I=function(){let t="YY.MM.DD hhhh:mm";return this.chart.bars.period>240&&(t="YY.MM.DD"),this.chart.bars.period>10080&&(t="YY.MM"),t},N=function(){var t;const{state:i,colors:e}=this.chart,{lineColor:s}=e.chart.crosshair;fe(this,X,P).call(this,s);const h=new ye(Es,1,Math.floor(i.graphHeight+(i.axisXHeight-((null==(t=pe(this,Y))?void 0:t.height)??0)-4)/2));return h.x-=1e3,h},U=function(){const{colors:t,state:i}=this.chart,e=this.changed("main",i.graphWidth,i.graphHeight,t.chart.crosshair.lineColor);pe(this,A)&&!e||(we(this,A,fe(this,X,N).call(this)),this.container.addChild(pe(this,A)))},G=function(){const{state:t,colors:i,style:e}=this.chart,{textColor:s,textBackgroundColor:h}=i.chart.crosshair,r=this._createGraphics("textBlock");pe(this,Y)||we(this,Y,this.createText(Ce(Date.now(),fe(this,X,I).call(this))));const a=Math.max(pe(this,Y).height,12),n=Math.floor(t.graphHeight+(t.axisXHeight-a)/2);pe(this,Y).tint!==s&&(pe(this,Y).tint=s);const o=pe(this,Y).textWidth,c=o+2*e.indent;return pe(this,Y).y=n,pe(this,Y).x=-Math.round(.5*o),r.beginFill(h),r.drawRect(Math.round(.5*-c),n+3-e.indent,c,Math.floor(a-3+2*e.indent)),r.endFill(),r.addChild(pe(this,Y)),r},B=function(){const{colors:t,state:i,style:e}=this.chart,{textColor:s,textBackgroundColor:h}=t.chart.crosshair;this.changed("textBlock",i.graphHeight,i.axisXHeight,e.indent,this.chart.bars.period,h,s)&&(we(this,_,fe(this,X,G).call(this)),this.container.addChild(pe(this,_)))},j=new WeakMap,z=new WeakMap;class Ss extends Se{constructor(t,i=9e3){super(t,i),ue(this,K),ue(this,O),ue(this,V),this.section=t.section,this.container.interactiveChildren=!1}tick(t){if(!this.chart.showAskPrice||void 0===this.chart.bars.askPrice||!pe(this,O))return this;const{digits:i}=this.chart,e=pe(this,O).getChildAt(1);fe(this,K,q).call(this,e,this.chart.bars.askPrice,i);const s=this.valueToY(this.chart.bars.askPrice);if(s<this.section.y||s>=this.section.y+this.section.height-1)return this;const h=fe(this,K,Z).call(this,this.chart.bars.askPrice,t.close);return e.y=h,pe(this,O).y=s,this}_draw(){this.chart.showAskPrice&&fe(this,K,$).call(this)}}O=new WeakMap,V=new WeakMap,K=new WeakSet,$=function(){const t=this.chart.state.yAxisIsLeft?this.chart.state.graphX:this.chart.app.screen.width,i=this.chart.app.screen.height,e=this._createGraphics("mask");e.isMask=!0,e.beginFill(),e.drawRect(0,0,t,i),e.endFill(),this.container.addChild(e);const s=this._createGraphics();let h;if(s.mask=e,this.container.addChild(s),void 0!==this.chart.bars.askPrice){if(h=this.valueToY(this.chart.bars.askPrice),h<this.section.y||h>=this.section.y+this.section.height-1)return}else pe(this,O)&&(pe(this,O).visible=!1);const r=this.changed(0,this.chart.state.graphWidth,this.chart.colors.chart.priceLines.askText,this.chart.colors.chart.priceLines.ask);if(!pe(this,O)||r){we(this,O,this._createGraphics("askLine"));const t=fe(this,K,J).call(this,"line",this.chart.colors.chart.priceLines.ask),i=fe(this,K,Q).call(this,"priceBlock",this.chart.colors.chart.priceLines.ask);pe(this,O).addChild(t,i),pe(this,O).visible=!1}if(s.addChild(pe(this,O)),void 0===this.chart.bars.askPrice||!h)return;const a=fe(this,K,tt).call(this);pe(this,O).visible=!0;const{digits:n}=this.chart,o=pe(this,O).getChildAt(1);fe(this,K,q).call(this,o,this.chart.bars.askPrice,n);const c=fe(this,K,Z).call(this,this.chart.bars.askPrice,a.close);o.y=c,pe(this,O).y=h},q=function(t=null,i,e){if(!t)return;const s=t.getChildAt(0);if(s&&s instanceof me&&(s.text=i.toFixed(e),this.chart.state.yAxisIsLeft)){let t=pe(this,V);t&&!this.changed("askPrice",i.toFixed().length,e)||(we(this,V,s.textWidth),t=pe(this,V)),s.x=this.chart.state.yAxisWidth-(t||0)-8}},J=function(t,i){const e=this._createGraphics(t);return e.beginFill(i,1),e.drawRect(this.chart.state.graphX,0,this.chart.state.graphWidth+1,1),e.endFill(),e},Q=function(t,i){const e=this._createGraphics(t),s=this.createText("",t);s.tint=this.chart.colors.chart.priceLines.askText;const h=(this.chart.state.yAxisIsLeft,this.chart.state.yAxisWidth),r=this.chart.state.yAxisIsLeft?this.chart.state.yAxisWidth-h+1:this.chart.state.graphX+this.chart.state.graphWidth+1;return s.y=-8,s.x=r+5,e.beginFill(i),e.drawRect(r,-7,h,14),e.endFill(),e.addChild(s),e},Z=function(t,i){const e=this.valueToY(t),s=this.valueToY(i)-e;return s>=18?0:s-18},tt=function(){const t=this.chart.bars,i=t.length-1,e=t.close(i);return{index:i,open:t.open(i),close:e}};class Fs{constructor(t){ue(this,it),ue(this,et),ue(this,st),ue(this,ht),ue(this,rt),ue(this,at),ue(this,nt),ue(this,ot),ue(this,ct,(()=>{var t,i,e,s,h;return pe(this,et).draw(),this.axisX.draw(),null==(t=pe(this,ht))||t.draw(),null==(i=pe(this,rt))||i.draw(),null==(e=pe(this,at))||e.draw(),null==(s=pe(this,nt))||s.draw(),null==(h=pe(this,st))||h.draw(),pe(this,ot).draw(),this})),ue(this,lt,(t=>{var i,e,s,h,r;const a=t.detail;return pe(this,et).tick(),this.axisX.tick(),null==(i=pe(this,ht))||i.tick(a),null==(e=pe(this,rt))||e.tick(a),null==(s=pe(this,at))||s.tick(),null==(h=pe(this,nt))||h.tick(a),null==(r=pe(this,st))||r.tick(),pe(this,ot).tick(),this})),ue(this,dt,(t=>{var i,e,s,h,r,a,n,o,c;const l=t.detail;if(1===l&&"bars"!==(null==(i=pe(this,st))?void 0:i.settings.type)){null==(e=pe(this,st))||e.destroy();const t=pe(this,it).createOptions();we(this,st,new vs(t,4e3,new Ye({type:"bars"})))}else if(4===l&&"area"!==(null==(s=pe(this,st))?void 0:s.settings.type)){null==(h=pe(this,st))||h.destroy();const t=pe(this,it).createOptions();we(this,st,new Ms(t,4e3,new Ws(1,"area",window.window.tr(window.lang.chart.types.area))))}else if(3===l&&"line"!==(null==(r=pe(this,st))?void 0:r.settings.type)){null==(a=pe(this,st))||a.destroy();const t=pe(this,it).createOptions();we(this,st,new ys(t,4e3,new Ws(2,"line",window.window.tr(window.lang.chart.types.line))))}else if(2===l&&"quotes"!==(null==(n=pe(this,st))?void 0:n.settings.type)){null==(o=pe(this,st))||o.destroy();const t=pe(this,it).createOptions();we(this,st,new ms(t,4e3,new Ye({type:"quotes"})))}null==(c=pe(this,st))||c.draw()})),ue(this,gt,(t=>{const i=t.detail;if(0===i&&pe(this,nt))pe(this,nt).destroy(),we(this,nt,void 0);else if(0!==i&&!pe(this,nt)){const t=pe(this,it).createOptions();we(this,nt,new Cs(t,3e3,new Ye({type:"volume"})))}})),ue(this,pt,(t=>{const i=t.detail;if(i&&!pe(this,at)){const t=pe(this,it).createOptions();we(this,at,new Ts(t))}else!i&&pe(this,at)&&(pe(this,at).destroy(),we(this,at,void 0))})),ue(this,ut,(t=>{const i=t.detail;if(i&&!pe(this,rt)){const t=pe(this,it).createOptions();we(this,rt,new Ss(t))}else!i&&pe(this,rt)&&(pe(this,rt).destroy(),we(this,rt,void 0))})),we(this,it,t),this.destroy=this.destroy.bind(this),pe(this,it).on("119",pe(this,ct)),pe(this,it).on("120",pe(this,lt)),pe(this,it).on("121",this.destroy),pe(this,it).on("103",pe(this,dt)),pe(this,it).on("117",pe(this,gt)),pe(this,it).on("112",pe(this,pt)),pe(this,it).on("111",pe(this,ut));const i=t.createOptions();we(this,et,new gs(i)),this.axisX=new ps(i),we(this,ht,new us(i)),we(this,ot,new ws(i,7e3,pe(this,it).objects))}updatePrice(t){var i;return null==(i=pe(this,ht))||i.tick(t),this}updateAskPrice(t){var i;return null==(i=pe(this,rt))||i.tick(t),this}destroy(){var t,i,e,s,h;pe(this,et).destroy(),this.axisX.destroy(),null==(t=pe(this,ht))||t.destroy(),null==(i=pe(this,rt))||i.destroy(),null==(e=pe(this,at))||e.destroy(),null==(s=pe(this,nt))||s.destroy(),null==(h=pe(this,st))||h.destroy(),pe(this,ot).destroy(),pe(this,it).off("119",pe(this,ct)),pe(this,it).off("120",pe(this,lt)),pe(this,it).off("121",this.destroy),pe(this,it).off("103",pe(this,dt)),pe(this,it).off("117",pe(this,gt)),pe(this,it).off("112",pe(this,pt)),pe(this,it).off("111",pe(this,ut))}}it=new WeakMap,et=new WeakMap,st=new WeakMap,ht=new WeakMap,rt=new WeakMap,at=new WeakMap,nt=new WeakMap,ot=new WeakMap,ct=new WeakMap,lt=new WeakMap,dt=new WeakMap,gt=new WeakMap,pt=new WeakMap,ut=new WeakMap;class Ds extends Se{constructor(t,i=2e3){super(t,i),ue(this,ft),ue(this,wt,0),this.section=t.section}get yHeight(){const{indicator:t}=this.section;return t?(t.calc(),t.yHeight):super.yHeight}get yMin(){const{indicator:t}=this.section;return t?(t.calc(),t.yMin):super.yMin}get yMax(){const{indicator:t}=this.section;return t?(t.calc(),t.yMax):super.yMax}tick(){}_calc(){super._calc(),this.calcTextLength()}calcTextLength(){const{digits:t}=this.section,i=this.yMin.toFixed(t).length,e=this.yMax.toFixed(t).length,s=pe(this,wt);return we(this,wt,Math.max(e,i)),[s,pe(this,wt)]}_draw(){const{chart:t,section:i}=this,{state:e,colors:s,style:h}=t,r=this._createGraphics();if(r.y=i.y,h.axis.yVisible){const t=e.yAxisIsLeft?0:e.graphWidth+1,h=e.yAxisWidth;r.beginFill(s.chart.backgroundColor),r.drawRect(t,0,h,i.height),r.endFill();let a=e.yAxisIsLeft?e.yAxisWidth:e.graphWidth+1;r.beginFill(s.chart.axis.borderColor),r.drawRect(a,0,1,i.height+1),r.endFill(),a=e.yAxisIsLeft?e.yAxisWidth:e.graphX,r.beginFill(s.chart.axis.borderColor),r.drawRect(a,-1,e.graphWidth+1,1),r.endFill()}if(!i.collapsed()){const{digits:t}=i,e=Math.ceil(50/this.yStep),s=fe(this,ft,Mt).call(this,e)/this.getYDigits();let a=Math.floor(this.yToValue(i.height)/s)*s;const n=this.yToValue(0);for(;a<n;){const i=this.valueToY(a);this.chart.showGrid&&fe(this,ft,vt).call(this,r,i),h.axis.yVisible&&(fe(this,ft,mt).call(this,r,i,a.toFixed(t)),fe(this,ft,yt).call(this,r,i)),a+=s}}r.endFill(),this.container.addChild(r)}}wt=new WeakMap,ft=new WeakSet,mt=function(t,i,e){const{chart:s,section:h}=this,{colors:r,state:a}=s;if(i<0||i>h.height-10)return;const n=this.createText(e);r.chart.axis.textColor&&(n.tint=r.chart.axis.textColor),n.x=a.yAxisIsLeft?a.yAxisWidth-n.textWidth-8:a.graphWidth+8,n.y=Math.round(i-8),t.addChild(n)},vt=function(t,i){const{chart:e,section:s}=this,{state:h,colors:r}=e;if(i<0||i>s.height-10)return;const a=h.yAxisIsLeft?h.yAxisWidth+1:0,n=h.yAxisIsLeft?h.graphWidth:h.graphWidth+1;t.beginFill(r.chart.gridColor),t.drawRect(a,i,n,1)},yt=function(t,i){const{chart:e,section:s}=this,{state:h,colors:r}=e,a=h.graphWidth+1;i<0||i>s.height-10||(t.beginFill(r.chart.axis.borderColor),t.drawRect(a,i,4,1))},Mt=function(t){for(let i=1;i<10;i++){const e=10**i;for(let i=1;i<10;i++){const s=i*e;if(t<s)return s}}return t};class As extends Se{constructor(t,i=7e3,e){super(t,i),ue(this,xt),ue(this,kt),ue(this,bt),ue(this,Ct,(()=>{this.draw()})),this.section=t.section,this.objects=e,e.on("202",pe(this,Ct)),e.on("301",pe(this,Ct)),e.on("302",pe(this,Ct)),e.on("303",pe(this,Ct)),this.container.interactiveChildren=!1}get yHeight(){const{indicator:t}=this.section;return t?(t.calc(),t.yHeight):super.yHeight}get yMin(){const{indicator:t}=this.section;return t?(t.calc(),t.yMin):super.yMin}get yMax(){const{indicator:t}=this.section;return t?(t.calc(),t.yMax):super.yMax}destroy(){this.objects.off("202",pe(this,Ct)),this.objects.off("301",pe(this,Ct)),this.objects.off("302",pe(this,Ct)),this.objects.off("303",pe(this,Ct)),super.destroy()}tick(){}_draw(){fe(this,xt,Wt).call(this)}getMin(){let t=Number.MAX_SAFE_INTEGER;const{section:i}=this;return this.objects.data.forEach((e=>{if(e.focused&&e.section===i){const{price1:i,price2:s,price3:h,price4:r}=e.settings.coordinates,a=[t,i,s,h,r].filter((t=>"number"==typeof t)).map(Number);t=Math.min(...a)}})),t}getMax(){let t=Number.MIN_SAFE_INTEGER;const{section:i}=this;return this.objects.data.forEach((e=>{if(e.focused&&e.section===i){const{price1:i,price2:s,price3:h,price4:r}=e.settings.coordinates,a=[t,i,s,h,r].filter((t=>"number"==typeof t)).map(Number);t=Math.max(...a)}})),t}}kt=new WeakMap,bt=new WeakMap,xt=new WeakSet,Wt=function(){const{chart:t,section:i}=this,{state:e}=t,s=this.chart.colors.chart.selected;let h=0;const r=i.y;let a=t.app.screen.width;const n=i.height;e.yAxisIsLeft?a=e.yAxisWidth:(h=e.graphX+e.graphWidth+1,a=t.app.screen.width-h);const o=this._createGraphics("mask");o.x=h,o.y=r,o.isMask=!0,o.beginFill(),o.drawRect(0,0,a,n),o.endFill(),this.container.addChild(o);const c=this._createGraphics();c.y=r,c.mask=o,this.container.addChild(c);const l=this.changed(0,e.graphWidth,s.marker.textColor,s.marker.backgroundColor);let d,g;const p=this.getMin();if(p!==Number.MAX_SAFE_INTEGER){d=this.valueToY(p);let t=pe(this,kt);d>=0&&d<=i.height?(t&&!l||(we(this,kt,this.createPriceLine("min",s.marker.backgroundColor,s.marker.textColor,s.marker.backgroundColor)),t=pe(this,kt)),t.y=d,t.visible=!0,this.updatePriceLine("min",p,i.digits),c.addChild(t)):t&&(t.visible=!1)}const u=this.getMax();if(u!==Number.MIN_SAFE_INTEGER){g=this.valueToY(u);let t=pe(this,bt);g>=0&&g<=i.height?(t&&!l||(we(this,bt,this.createPriceLine("max",s.marker.backgroundColor,s.marker.textColor,s.marker.backgroundColor)),t=pe(this,bt)),t.y=g,t.visible=!0,this.updatePriceLine("max",u,i.digits),c.addChild(t)):t&&(t.visible=!1)}"number"==typeof d&&"number"==typeof g&&p!==Number.MAX_SAFE_INTEGER&&u!==Number.MIN_SAFE_INTEGER&&(d>=0&&d<=i.height||g>=0&&g<=i.height)&&(c.beginFill(s.diff.color,s.diff.alpha),c.drawRect(h+2,Math.min(g,d),a,Math.max(g,d)-Math.min(g,d)),c.endFill())},Ct=new WeakMap;class _s extends Se{constructor(t,i=1e4){super(t,i),ue(this,Dt),ue(this,Et),ue(this,Lt),ue(this,Tt),ue(this,St),ue(this,Ft),ue(this,It,(t=>{const{x:i,y:e}=t.global;we(this,St,i),we(this,Ft,e),fe(this,Dt,_t).call(this,i,e)})),ue(this,Nt,(()=>{this.container.visible=!1,we(this,St,void 0),we(this,Ft,void 0)})),this.section=t.section;const{stage:e}=this.chart.app;e&&(e.removeEventListener("pointerdown",pe(this,It)),e.removeEventListener("pointermove",pe(this,It)),e.removeEventListener("mouseout",pe(this,Nt)),e.addEventListener("pointerdown",pe(this,It)),e.addEventListener("pointermove",pe(this,It)),e.addEventListener("mouseout",pe(this,Nt))),this.container.interactiveChildren=!1}get yHeight(){const{indicator:t}=this.section;return t?(t.calc(),t.yHeight):super.yHeight}get yMin(){const{indicator:t}=this.section;return t?(t.calc(),t.yMin):super.yMin}get yMax(){const{indicator:t}=this.section;return t?(t.calc(),t.yMax):super.yMax}tick(){}_draw(){(this.chart.showCrosshair||this.chart.showRulerCrosshair||!this.chart.previewMode)&&(this.section.collapsed()||(pe(this,Et)&&pe(this,Lt)&&this.container.addChild(pe(this,Et),pe(this,Lt)),void 0!==pe(this,St)&&void 0!==pe(this,Ft)&&fe(this,Dt,_t).call(this,pe(this,St),pe(this,Ft))))}destroy(){const{stage:t}=this.chart.app;t&&(t.removeEventListener("pointerdown",pe(this,It)),t.removeEventListener("pointermove",pe(this,It)),t.removeEventListener("mouseout",pe(this,Nt))),super.destroy()}}Et=new WeakMap,Lt=new WeakMap,Tt=new WeakMap,St=new WeakMap,Ft=new WeakMap,Dt=new WeakSet,At=function(t){const i=new ve;i.beginFill(t,.7),i.drawRect(0,0,3,1),i.drawRect(9,0,3,1),i.width=9,i.height=1,i.endFill(),Ls=this.chart.app.renderer.generateTexture(i,{scaleMode:0,resolution:1})},_t=function(t,i){(this.chart.showCrosshair||this.chart.showRulerCrosshair)&&!this.chart.previewMode&&t>this.chart.state.graphX&&t<this.chart.state.graphX+this.chart.state.graphWidth&&i>this.section.y&&i<this.section.y+this.section.height?(this.container.visible=!0,fe(this,Dt,Yt).call(this,t,i)):this.container.visible=!1},Yt=function(t,i){let e=i;const s=this.chart.bars;let h=this.yToValue(e-this.section.y);if(fe(this,Dt,Pt).call(this),pe(this,Et)){if(this.chart.state.getScale()>20){const i=this.chart.state.xToIndex(t),r=["open","high","low","close"],a=r.reduce(((t,e)=>("open"===e?t.open=s.open(i):"high"===e?t.high=s.high(i):"low"===e?t.low=s.low(i):"close"===e&&(t.colse=s.close(i)),t)),{}),n=r.map((t=>this.valueToY(a[t]))),o=n.map((t=>Math.abs(e-t))),c=o.reduce(((t,i)=>Math.min(t,i)),Number.MAX_VALUE);if(c<10){const t=o.findIndex((t=>t===c));t>-1&&(h=a[r[t]],e=n[t])}}pe(this,Et).y=Math.round(e),pe(this,Lt)||fe(this,Dt,Ht).call(this),pe(this,Tt)&&(pe(this,Tt).text=isNaN(h)?"":h.toFixed(this.section.digits)),pe(this,Lt)&&(pe(this,Lt).y=Math.round(e),pe(this,Lt).x=this.chart.state.graphX),fe(this,Dt,Ht).call(this)}},Xt=function(){const{lineColor:t}=this.chart.colors.chart.crosshair;fe(this,Dt,At).call(this,t);const i=new ye(Ls,this.chart.state.graphWidth+1,1);return i.y=-1e3,i},Pt=function(){const{state:t}=this.chart,{lineColor:i}=this.chart.colors.chart.crosshair,{period:e}=this.chart.bars,s=this.changed("main",e,t.graphWidth,t.graphHeight,i);pe(this,Et)&&!s||(we(this,Et,fe(this,Dt,Xt).call(this)),this.container.addChild(pe(this,Et)))},Rt=function(){const{state:t}=this.chart,{textColor:i,textBackgroundColor:e}=this.chart.colors.chart.crosshair,s=this._createGraphics("textBlock");pe(this,Tt)||we(this,Tt,this.createText("")),pe(this,Tt).tint!==i&&(pe(this,Tt).tint=i);const h=t.yAxisIsLeft?t.yAxisWidth-2:t.yAxisWidth-1,r=t.yAxisIsLeft?t.yAxisWidth-h+1:t.graphX+t.graphWidth+1;return pe(this,Tt).y=-8,pe(this,Tt).x=r+5,s.beginFill(e),s.drawRect(r,-9,h,18),s.endFill(),s.addChild(pe(this,Tt)),s},Ht=function(){const{state:t}=this.chart,{textColor:i,textBackgroundColor:e}=this.chart.colors.chart.crosshair,{period:s}=this.chart.bars;this.changed("textBlock",s,t.graphWidth,t.graphHeight,e,i)&&(we(this,Lt,fe(this,Dt,Rt).call(this)),this.container.addChild(pe(this,Lt)))},It=new WeakMap,Nt=new WeakMap;class Ys{constructor(t,i){ue(this,Ut),ue(this,Gt),ue(this,Bt,0),ue(this,jt,0),ue(this,zt,Ve((()=>{pe(this,Gt).section.resetYScale(),pe(this,Ut).redraw()}))),ue(this,Ot,(t=>{const i=t.global.x,{state:e}=pe(this,Ut);if(i>e.graphX&&i<e.graphX+e.graphWidth)return;t.stopPropagation(),t.originalEvent.preventDefault(),we(this,Bt,t.global.y),we(this,jt,pe(this,Gt).section.getScale());const{stage:s}=pe(this,Ut).app;s&&(s.addEventListener("pointermove",pe(this,Vt)),s.addEventListener("pointerup",pe(this,Kt)),s.addEventListener("pointerupoutside",pe(this,Kt))),pe(this,Gt).container.cursor="ns-resize"})),ue(this,Vt,(t=>{t.stopPropagation();const i=t.data.global.y-pe(this,Bt);let e=pe(this,jt);e-=i/pe(this,Gt).section.height*.5,pe(this,Gt).section.setScale(Math.min(10,Math.max(.05,e))),pe(this,Ut).refresh()})),ue(this,Kt,(()=>{const{stage:t}=pe(this,Ut).app;t&&(t.removeEventListener("pointermove",pe(this,Vt)),t.removeEventListener("pointerup",pe(this,Kt)),t.removeEventListener("pointerupoutside",pe(this,Kt))),pe(this,Gt).container.cursor="auto"})),we(this,Gt,t),we(this,Ut,i),pe(this,Gt).view.eventMode="static",pe(this,Gt).view.addEventListener("pointerdown",pe(this,Ot)),pe(this,Gt).view.addEventListener("pointerup",pe(this,zt))}destroy(){pe(this,Gt).view&&(pe(this,Gt).view.removeEventListener("pointerdown",pe(this,Ot)),pe(this,Gt).view.removeEventListener("pointerup",pe(this,zt)),pe(this,Gt).view.removeEventListener("pointermove",pe(this,Vt)),pe(this,Gt).view.removeEventListener("pointerup",pe(this,Kt)),pe(this,Gt).view.removeEventListener("pointerupoutside",pe(this,Kt)))}}Ut=new WeakMap,Gt=new WeakMap,Bt=new WeakMap,jt=new WeakMap,zt=new WeakMap,Ot=new WeakMap,Vt=new WeakMap,Kt=new WeakMap;class Xs{constructor(t,i){ue(this,$t),ue(this,qt),ue(this,Jt,0),ue(this,Qt,0),ue(this,Zt,(t=>{if(0!==pe(this,qt).mode||t.ctrlKey&&Ue()||t.metaKey&&Ge())return;const{x:i,y:e}=t.global;if(1===pe(this,$t).section.getScale())return;if(i<pe(this,qt).state.graphX||i>pe(this,qt).state.graphX+pe(this,qt).state.graphWidth||e<pe(this,$t).section.y||e>pe(this,$t).section.y+pe(this,$t).section.height)return;t.stopPropagation(),t.originalEvent.preventDefault(),we(this,Jt,e),we(this,Qt,pe(this,$t).section.getYPadding());const{stage:s}=pe(this,qt).app;s&&(s.addEventListener("pointermove",pe(this,ti)),s.addEventListener("pointerup",pe(this,ii)),s.addEventListener("pointerupoutside",pe(this,ii)),s.cursor="move")})),ue(this,ti,We(16,(t=>{t.stopPropagation();const{y:i}=t.global;pe(this,$t).section.setYPadding(pe(this,Qt)-(pe(this,Jt)-i)),pe(this,qt).redraw()}))),ue(this,ii,(()=>{const{stage:t}=pe(this,qt).app;t&&(t.removeEventListener("pointermove",pe(this,ti)),t.removeEventListener("pointerup",pe(this,ii)),t.removeEventListener("pointerupoutside",pe(this,ii)),t.cursor="auto")})),we(this,$t,t),we(this,qt,i);const{stage:e}=pe(this,qt).app;e&&(e.eventMode="static",e.addEventListener("pointerdown",pe(this,Zt)))}destroy(){const{stage:t}=pe(this,qt).app;t&&(t.removeEventListener("pointerdown",pe(this,Zt)),t.removeEventListener("pointermove",pe(this,ti)),t.removeEventListener("pointerup",pe(this,ii)),t.removeEventListener("pointerupoutside",pe(this,ii)))}}$t=new WeakMap,qt=new WeakMap,Jt=new WeakMap,Qt=new WeakMap,Zt=new WeakMap,ti=new WeakMap,ii=new WeakMap;class Ps extends Xe{constructor(t,i=1,e=0){super("section"),ue(this,ei),ue(this,si),ue(this,hi),ue(this,ri),ue(this,ai),ue(this,ni),this.uid=Ae(16),this.digits=0,this.indicator=null,this.chart=t,this.x=0,this.y=0,this.width=400,this.height=400,we(this,ei,i),we(this,si,e),this.setDigits(t.digits);const s=t.createOptions(this);this.axis=new Ds(s),we(this,hi,new _s(s)),we(this,ri,new As(s,7e3,t.objects)),we(this,ai,new Ys(this.axis,t)),we(this,ni,new Xs(this.axis,t))}setDigits(t){this.digits=t}collapsed(){return Boolean(this.indicator&&this.indicator.isCollapsed())}destroy(){super.destroy(),this.axis.destroy(),pe(this,hi).destroy(),pe(this,ri).destroy(),pe(this,ai).destroy(),pe(this,ni).destroy()}redraw(){this.axis.draw(),pe(this,hi).draw(),pe(this,ri).draw()}applyTick(){this.axis.tick(),pe(this,hi).tick(),pe(this,ri).tick()}resetYScale(){this.setScale(1),this.setYPadding(0)}setScale(t){return t!==pe(this,ei)&&(we(this,ei,t),this.chart.sections.trigger("403",{index:this.chart.sections.getIndex(this.uid),uid:this.uid,scale:pe(this,ei)}),this.trigger("124"),!0)}getScale(){return pe(this,ei)}setYPadding(t){return t!==pe(this,si)&&(we(this,si,t),this.chart.sections.trigger("404",{uid:this.uid,index:this.chart.sections.getIndex(this.uid),padding:pe(this,si)}),this.trigger("124"),!0)}getYPadding(){return pe(this,si)}}ei=new WeakMap,si=new WeakMap,hi=new WeakMap,ri=new WeakMap,ai=new WeakMap,ni=new WeakMap;class Rs extends Xe{constructor(t,i,e){super("section_manager"),ue(this,ui),ue(this,oi),ue(this,ci,[]),ue(this,li,{}),ue(this,di,1),ue(this,gi,0),ue(this,pi,0),ue(this,fi,(()=>(pe(this,ci).forEach((t=>t.redraw())),this))),ue(this,vi,(()=>(pe(this,ci).forEach((t=>t.applyTick())),this.resize(),this))),we(this,oi,t),we(this,di,i??pe(this,di)),we(this,gi,e??pe(this,gi)),this.destroy=this.destroy.bind(this),pe(this,oi).on("119",pe(this,fi)),pe(this,oi).on("120",pe(this,vi)),pe(this,oi).on("121",this.destroy)}getSections(){return pe(this,ci).length?pe(this,ci):[this.add(pe(this,di),pe(this,gi))]}move(t,i){const e=this.getByIndex(t),s=this.getSections();return s.splice(t,1),s.splice(i,0,e),fe(this,ui,wi).call(this),this.trigger("402",{uid:e.uid,from:t,to:i}),this.resize(),e}clear(){we(this,ci,[])}init(){we(this,pi,0);const t=this.getSections();return t.slice(1).forEach((t=>t.destroy())),t.splice(1,pe(this,ci).length-1),t[0].setDigits(pe(this,oi).digits),this.resize(),this}add(t,i){const e=new Ps(pe(this,oi),t,i);return pe(this,ci).push(e),pe(this,li)[e.uid]=pe(this,ci).length-1,this.resize(),this.trigger("405",{uid:e.uid,index:pe(this,ci).length-1}),e}remove(t){var i;if(!pe(this,ci)[t])return this;const e=null==(i=pe(this,ci)[t])?void 0:i.uid;return pe(this,ci)[t].destroy(),pe(this,ci).splice(t,1),delete pe(this,li)[e],this.resize(),fe(this,ui,wi).call(this),this.trigger("406",{uid:e,index:t}),this.resize(),this}resize(){const{state:t}=pe(this,oi),i=this.getSections(),e=i.filter((t=>t.collapsed())).length;let s=i.length-e;const h=t.graphHeight-t.graphY;let r=i.length;if(r){const a=i[0];if(a.x=t.graphX,a.y=t.graphY,a.width=t.graphWidth,a.height=h,r>1){r-=1,s-=1;const n=42;s?a.height=.6*h:a.height-=n*e;let o=.4*h;o-=e*n,o/=s,o-=r;let c=a.y+a.height;i.slice(1).forEach((i=>{c+=1,i.x=Math.round(t.graphX),i.y=Math.round(c),i.width=t.graphWidth,i.height=o,i.collapsed()&&(i.height=n),c+=i.height}));const l=i[i.length-1];l.collapsed()||(l.height=t.graphHeight-t.graphY-l.y)}}return fe(this,ui,mi).call(this),this}getByIndex(t){return this.getSections()[t]}getByCoordinate(t,i){return this.getSections().find((e=>t>=e.x&&t<=e.x+e.width&&i>=e.y&&i<=e.y+e.height))}getByIndicatorUid(t){return this.getSections().find((i=>i.indicator&&i.indicator.settings.uid===t))}getIndex(t){return pe(this,li)[t]}destroy(){super.destroy(),pe(this,oi).off("119",pe(this,fi)),pe(this,oi).off("120",pe(this,vi)),pe(this,oi).off("121",this.destroy),pe(this,ci).forEach((t=>t.destroy())),we(this,ci,[]),we(this,li,{})}}oi=new WeakMap,ci=new WeakMap,li=new WeakMap,di=new WeakMap,gi=new WeakMap,pi=new WeakMap,ui=new WeakSet,wi=function(){we(this,li,{}),this.getSections().forEach(((t,i)=>{pe(this,li)[t.uid]=i}))},fi=new WeakMap,mi=function(){let t=0,i=!1;pe(this,ci).forEach((e=>{const[s,h]=e.axis.calcTextLength();t<h&&(t=h),i=i||s!==h})),(pe(this,pi)!==t||i)&&(we(this,pi,t),this.trigger("401",{width:t}))},vi=new WeakMap;class Hs{constructor(t){var i;ue(this,yi,0),ue(this,Mi,0),ue(this,ki),ue(this,bi,!0),ue(this,xi,0),ue(this,Wi,0),ue(this,Ci,49),ue(this,Ei,(t=>{if(we(this,bi,t.isPrimary),!(0!==pe(this,ki).mode||t.ctrlKey&&Ue()||t.metaKey&&Ge()||t.shiftKey)&&ks(t)){t.stopPropagation();const i=pe(this,ki).app.view.getBoundingClientRect();we(this,Ci,i.left),we(this,xi,t.global.x),we(this,Wi,pe(this,ki).state.getFrom());const{stage:e}=pe(this,ki).app;e&&(e.addEventListener("pointerup",pe(this,Si)),e.addEventListener("pointerupoutside",pe(this,Si)),e.cursor="move",pe(this,ki).state.setData({moving:!0}))}})),ue(this,Li,(t=>{if(we(this,Mi,Date.now()),t.stopPropagation(),!pe(this,ki).state.moving)return;if(we(this,yi,t.movementX?t.movementX*(10-Math.log2(Math.abs(t.movementX)))/2:0),!pe(this,bi))return;const i=t.pageX-pe(this,Ci),e=Math.round(pe(this,xi)-i);e&&(pe(this,ki).move(e),we(this,xi,i))})),ue(this,Ti,(()=>{we(this,yi,pe(this,ki).state.moving?0:.9*pe(this,yi)),pe(this,yi)>1||pe(this,yi)<-1?(pe(this,ki).move(-1*Math.round(pe(this,yi))),requestAnimationFrame(pe(this,Ti))):pe(this,ki).onScroll(pe(this,Wi))})),ue(this,Si,(()=>{pe(this,ki).state.setData({moving:!1});const{stage:t}=pe(this,ki).app;t&&(t.removeEventListener("pointerup",pe(this,Si)),t.removeEventListener("pointerupoutside",pe(this,Si)),t.cursor="auto"),(pe(this,yi)>12||pe(this,yi)<-12)&&Date.now()-pe(this,Mi)<30&&requestAnimationFrame(pe(this,Ti)),pe(this,ki).onScroll(pe(this,Wi))})),we(this,ki,t);const e=null==(i=pe(this,ki).app)?void 0:i.stage;e&&(e.eventMode="static",null==e||e.addEventListener("pointerdown",pe(this,Ei)),window.addEventListener("pointermove",pe(this,Li)))}destroy(){pe(this,ki).app.stage&&(pe(this,ki).app.stage.removeEventListener("pointerdown",pe(this,Ei)),window.removeEventListener("pointermove",pe(this,Li)),pe(this,ki).app.stage.removeEventListener("pointerup",pe(this,Si)),pe(this,ki).app.stage.removeEventListener("pointerupoutside",pe(this,Si)))}}yi=new WeakMap,Mi=new WeakMap,ki=new WeakMap,bi=new WeakMap,xi=new WeakMap,Wi=new WeakMap,Ci=new WeakMap,Ei=new WeakMap,Li=new WeakMap,Ti=new WeakMap,Si=new WeakMap;class Is{constructor(t){ue(this,Fi),ue(this,Di,0),ue(this,Ai,0),ue(this,_i,0),ue(this,Yi,Ve((()=>{pe(this,Fi).resetXScale()}))),ue(this,Xi,(t=>{if(t.global.y<pe(this,Fi).state.graphHeight)return;t.stopPropagation(),t.originalEvent.preventDefault(),we(this,Di,t.global.x),we(this,Ai,pe(this,Fi).state.xScale),we(this,_i,pe(this,Fi).state.getFrom());const{stage:i}=pe(this,Fi).app;i&&(i.addEventListener("pointermove",pe(this,Pi)),i.addEventListener("pointerup",pe(this,Ri)),i.addEventListener("pointerupoutside",pe(this,Ri))),pe(this,Fi).native.axisX.container.cursor="ew-resize",pe(this,Fi).state.moving||pe(this,Fi).state.setData({moving:!0})})),ue(this,Pi,We(16,(t=>{t.stopPropagation();const i=pe(this,Fi).state.graphWidth,e=t.global.x-pe(this,Di);let s=pe(this,Ai);s+=e/i*.5,pe(this,Fi).setXScale(s)}))),ue(this,Ri,(()=>{pe(this,Fi).state.moving&&pe(this,Fi).state.setData({moving:!1}),pe(this,Fi).redraw();const{stage:t}=pe(this,Fi).app;t&&(t.removeEventListener("pointermove",pe(this,Pi)),t.removeEventListener("pointerup",pe(this,Ri)),t.removeEventListener("pointerupoutside",pe(this,Ri))),pe(this,Fi).native.axisX.container.cursor="auto",pe(this,Fi).onScroll(pe(this,_i))})),we(this,Fi,t);const i=t.native.axisX.view;i.eventMode="static",i.addEventListener("pointerdown",pe(this,Xi)),i.addEventListener("pointerup",pe(this,Yi))}destroy(){const{stage:t}=pe(this,Fi).app;t&&(t.removeEventListener("pointermove",pe(this,Pi)),t.removeEventListener("pointerup",pe(this,Ri)),t.removeEventListener("pointerupoutside",pe(this,Ri)),t.removeEventListener("pointerdown",pe(this,Xi)),t.removeEventListener("pointerup",pe(this,Yi)))}}Fi=new WeakMap,Di=new WeakMap,Ai=new WeakMap,_i=new WeakMap,Yi=new WeakMap,Xi=new WeakMap,Pi=new WeakMap,Ri=new WeakMap;class Ns{constructor(t){var i,e;ue(this,Hi,(t=>{(bs(t)||t.shiftKey&&0===this.chart.mode)&&this.chart.setMode(33),33===this.chart.mode&&xs(t)&&this.chart.setMode(0),0!==this.chart.mode&&ks(t)&&(t.stopPropagation(),this.chart.hidden&&this.chart.setHidden(!1),this.chart.locked&&this.chart.setLocked(!1),this.manager.create(this.chart.mode,t),this.chart.setMode(0))})),this.chart=t,this.manager=t.objects,null==(e=null==(i=t.app)?void 0:i.stage)||e.addEventListener("pointerdown",pe(this,Hi))}destroy(){var t,i;null==(i=null==(t=this.chart.app)?void 0:t.stage)||i.removeEventListener("pointerdown",pe(this,Hi))}}Hi=new WeakMap;class Us{constructor(t){var i,e;ue(this,Ii),ue(this,Ni),ue(this,Ui),ue(this,Gi,(t=>{const{uid:i}=t.detail;we(this,Ui,new Map);const e=pe(this,Ui);pe(this,Ni).data.forEach((t=>{if(t.focused&&t.settings.uid!==i){const i=t.settings.coordinates,s=Le(i);e.set(t.settings.uid,s)}}))})),ue(this,Bi,(()=>{pe(this,Ui)&&pe(this,Ui).clear()})),ue(this,ji,(t=>{const i=pe(this,Ii).bars,{uid:e,price:s,bar:h}=t.detail;pe(this,Ni).data.forEach((t=>{var r;if(t.focused&&t.settings.uid!==e){const e=null==(r=pe(this,Ui))?void 0:r.get(t.settings.uid),a=e&&Le(e);a&&(Object.keys(a).forEach((t=>{let e=a[t];h&&0===t.indexOf("date")&&"number"==typeof e&&(e=i.index(e),e+=h,e=i.time(e),a[t]=e),s&&0===t.indexOf("price")&&"number"==typeof e&&(a[t]=e+s)})),t.move(a))}}))})),ue(this,zi,(t=>{const{detail:i}=t;t&&!(i.ctrlKey&&Ue()||i.metaKey&&Ge())&&pe(this,Ni).data.forEach((t=>{t.settings.uid!==i.uid&&t.blur()}))})),ue(this,Oi,(t=>{ks(t)&&(t.ctrlKey&&Ue()||t.metaKey&&Ge()?pe(this,Ni).selectAreaStart(t):pe(this,Ni).data.forEach((t=>t.blur())))})),ue(this,Vi,(t=>{const{target:i}=t;"Delete"!==t.code&&"Backspace"!==t.code||i!==document.body||pe(this,Ni).data.slice().forEach((t=>{t.focused&&!t.active&&pe(this,Ni).remove(t.settings.uid)}))})),we(this,Ii,t),we(this,Ni,t.objects),pe(this,Ni).on("303",pe(this,ji)),pe(this,Ni).on("304",pe(this,Gi)),pe(this,Ni).on("305",pe(this,Bi)),pe(this,Ni).on("301",pe(this,zi)),null==(e=null==(i=t.app)?void 0:i.stage)||e.addEventListener("pointerdown",pe(this,Oi)),window.addEventListener("keydown",pe(this,Vi))}destroy(){var t,i;null==(i=null==(t=pe(this,Ii).app)?void 0:t.stage)||i.removeEventListener("pointerdown",pe(this,Oi)),pe(this,Ni).off("303",pe(this,ji)),pe(this,Ni).off("304",pe(this,Gi)),pe(this,Ni).off("305",pe(this,Bi)),pe(this,Ni).off("301",pe(this,zi)),window.removeEventListener("keydown",pe(this,Vi))}}function Gs(t,i=!1){const e=(16711680&t)>>16,s=(65280&t)>>8,h=255&t;if(i)return.299*e+.587*s+.114*h>186?0:16777215;const r=(255-e).toString(16).padStart(2,"0"),a=(255-s).toString(16).padStart(2,"0"),n=(255-h).toString(16).padStart(2,"0");return Number(`0x${r}${a}${n}`)}Ii=new WeakMap,Ni=new WeakMap,Ui=new WeakMap,Gi=new WeakMap,Bi=new WeakMap,ji=new WeakMap,zi=new WeakMap,Oi=new WeakMap,Vi=new WeakMap;class Bs extends Xe{constructor(t,i,e,s,h,r,a,n,o,c,l,d,g,p,u,w,f){super("chart"),ue(this,ie),ue(this,Ki),ue(this,$i),ue(this,qi),ue(this,Ji),ue(this,Qi),ue(this,Zi),ue(this,te),ue(this,se),ue(this,he),ue(this,re),ue(this,ae),ue(this,ne),this.invert=Gs,we(this,$i,!1),we(this,qi,!1),we(this,Ji,!1),we(this,Qi,!1),this.destroyed=!1,this.error="",this.hidden=!1,this.locked=!1,this.loading="Loading...",this.mode=0,this.previewMode=!1,we(this,se,(()=>{this.app.resize(),this.state.resize(),this.sections.resize(),this.redraw()})),we(this,he,(t=>{if(t.target){const{x:i,y:e}=t.data.global;this.trigger("101",[i,e])}else this.trigger("101",[-1,-1])})),we(this,re,(()=>{this.trigger("101",[-1,-1])})),we(this,ae,(()=>{this.redraw()})),we(this,ne,(t=>{const{detail:i}=t;let e=0;if(i.width&&Me.available["Trebuchet MS"]){const t=6,s=2*t;e=i.width*t+s+this.style.indent/2}this.state.setData({yAxisWidth:e})})),this.setBars=this.setBars.bind(this),this.loadBars=this.loadBars.bind(this),this.refresh=this.refresh.bind(this),this.redraw=this.redraw.bind(this),this.move=this.move.bind(this),this.showAskPrice=t,this.showGrid=i,this.showCrosshair=e,this.showRulerCrosshair=!1,this.ticksDelay=s,this.digits=h,this.magnet=o,this.chartType=a,this.volumeType=n,this.timezoneShift=g,this.dayLightMode=p,this.style=c,this.colors=l,we(this,te,d),this.app=fe(this,ie,ee).call(this),this.state=new Pe(this,r),this.state.on("500",pe(this,ae)),this.setXScale(r),this.loadBarsCallback=u,we(this,Zi,new ResizeObserver(pe(this,se))),this.sections=new Rs(this,1,0),this.sections.clear(),this.sections.on("401",pe(this,ne)),this.analysis=new w(this),this.objects=new f(this),this.native=new Fs(this),we(this,Ki,new Map),this.trigger("105",this.digits),this.trigger("103",this.chartType),this.trigger("117",this.volumeType),this.trigger("111",this.showAskPrice),this.trigger("112",this.showCrosshair),this.trigger("124"),this.refresh(),this.trigger("102"),this.app.stage.on("mousemove",pe(this,he)),this.app.stage.on("mouseout",pe(this,re)),this.sections.resize()}get bars(){return pe(this,te)}async loadBars(t,i,e,s,h){return await this.loadBarsCallback(t,i,e,s,h)}mount(t){this.element&&pe(this,Zi).unobserve(this.element),this.element=t,pe(this,Zi).observe(this.element),this.app.resizeTo=t,t.appendChild(this.app.view),fe(this,ie,oe).call(this),we(this,Ji,!0),this.moveToEnd(),this.refresh()}setPreviewMode(t){this.previewMode=t}async setBars(t,i,e=!1){return!(this.bars===t&&!e||(we(this,Qi,!1),we(this,te,t),i&&this.setDigits(i),this.moveToEnd(),await fe(this,ie,le).call(this),this.moveToEnd(),we(this,Qi,!0),this.refresh(),0))}setChartType(t){return this.chartType!==t&&(this.chartType=t,this.trigger("103",this.chartType),this.refresh(),!0)}setDayLightMode(t){return this.dayLightMode!==t&&(this.dayLightMode=t,this.trigger("104",this.dayLightMode),this.refresh(),!0)}setDigits(t){return this.digits!==t&&(this.digits=t,this.sections.getByIndex(0).setDigits(this.digits),pe(this,se).call(this),this.trigger("105",this.digits),this.trigger("124"),!0)}setError(t=""){return this.error!==t&&(this.error=t,this.redraw(),this.trigger("106",this.error),this.trigger("124"),!0)}setHidden(t){return this.hidden!==t&&(this.hidden=t,this.refresh(),this.trigger("107",this.hidden),this.trigger("124"),!0)}setLocked(t){return this.locked!==t&&(this.locked=t,this.refresh(),this.trigger("108",this.locked),this.trigger("124"),!0)}setMagnet(t){return this.magnet!==t&&(this.magnet=t,this.refresh(),this.trigger("109",this.magnet),this.trigger("124"),!0)}setMode(t){return this.mode!==t&&(0!==t&&33!==this.mode||(this.showRulerCrosshair=!1),this.mode=t,this.refresh(),this.trigger("110",this.mode),33===this.mode&&(this.showRulerCrosshair=!0,this.trigger("112",!0)),this.trigger("124"),!0)}setShowAskPrice(t){return this.showAskPrice!==t&&(this.showAskPrice=t,this.refresh(),this.trigger("111",this.showAskPrice),this.trigger("124"),!0)}getSize(){return{width:this.app.screen.width,height:this.app.screen.height}}setShowCrosshair(t){return this.showCrosshair!==t&&!this.showRulerCrosshair&&(this.showCrosshair=t,this.refresh(),this.trigger("112",this.showCrosshair),this.trigger("124"),!0)}setShowGrid(t){return this.showGrid!==t&&(this.showGrid=t,this.refresh(),this.trigger("113",this.showGrid),this.trigger("124"),!0)}setStyle(t){return this.style!==t&&(this.style=t,this.state.setData({axisXHeight:6*this.style.indent}),this.refresh(),this.trigger("114"),this.trigger("124"),!0)}setTicksDelay(t){return this.ticksDelay!==t&&(this.ticksDelay=t,this.refresh(),this.trigger("115",this.ticksDelay),this.trigger("124"),!0)}setTimezoneShift(t){return this.timezoneShift!==t&&(this.timezoneShift=t,this.trigger("116",this.timezoneShift),this.trigger("124"),!0)}setVolumeType(t){return this.volumeType!==t&&(this.volumeType=t,this.trigger("117",this.volumeType),this.trigger("124"),this.refresh(),!0)}setLoading(t=""){return this.loading!==t&&(this.loading=t,this.trigger("118",this.loading),this.trigger("124"),this.refresh(),!0)}setXScale(t,i){return this.state.xScale!==t&&(this.state.scale(t,i),this.trigger("122",this.state.xScale),this.trigger("124"),!0)}onScroll(t,i=!1){var e;const s=3*this.count();let h=this.state.getFrom();if(null==(e=this.bars)?void 0:e.real)if(h<t||i){if(h<s){if(this.bars.final)return;const t=this.bars.length;rs(this.bars,s,this.ticksDelay,this.timezoneShift,this.dayLightMode,this.loadBars).then((()=>{h=this.state.getFrom();const i=this.bars.length-t;if(!i)return void this.refresh();let e=0;h>0?e=i+h:(h=Math.abs(h),e=i>h?i-h:-h),this.scroll(e)}))}}else h>t&&this.bars.length-(h+s)<.3*s&&as(this.bars,s,this.ticksDelay,this.timezoneShift,this.dayLightMode,this.loadBars)}destroy(){super.destroy(),this.destroyed=!0,this.element&&pe(this,Zi).unobserve(this.element),fe(this,ie,ce).call(this),this.state.off("500",pe(this,ae)),this.sections.off("401",pe(this,ne)),this.trigger("121"),this.app.stage.off("mousemove",pe(this,he)),this.app.stage.off("mouseleave",pe(this,re)),this.app.destroy()}createOptions(t){var i;return{chart:this,section:t??(null==(i=this.sections)?void 0:i.getByIndex(0))}}redraw(){!this.destroyed&&pe(this,Ji)&&we(this,$i,!0)}refresh(){!this.destroyed&&pe(this,Ji)&&pe(this,Qi)&&(this.state.calc(),pe(this,se).call(this))}zoomOut(){const t=this.state.getStep(),i=t/De*2.5;let e=Math.log10(Math.abs(-10))*i*(-10/Math.abs(-10));e>0&&e<.012&&(e=.012),e<0&&e>-.012&&(e=-.012);const s=Math.max(1,t+e)/De;this.setXScale(s)}zoomIn(){const t=this.state.getStep(),i=t/De*2.5;let e=Math.log10(Math.abs(10))*i*(10/Math.abs(10));e>0&&e<.012&&(e=.012),e<0&&e>-.012&&(e=-.012);const s=Math.max(1,t+e)/De;this.setXScale(s)}move(t){if("number"!=typeof t||isNaN(t))return this;const i=this.state.getFrom();return this.state.move(t),this.onScroll(i),this}moveLeft(){const t=this.state.getStep(),i=this.state.getPadding();i?this.move(-t-t/2%i):this.move(-t)}moveRight(){const t=this.state.getStep(),i=this.state.getPadding();i?this.move(t-t/2%i):this.move(t)}moveScreenLeft(){this.move(-this.state.getCount()*this.state.getStep())}moveScreenRight(){this.move(this.state.getCount()*this.state.getStep())}resetView(){this.resetYScale(),this.resetXScale(),this.moveToEnd()}resetXScale(){return this.setXScale(.03336)}resetYScale(){let t=0;return this.sections.getSections().forEach((i=>{t+=Number(i.setScale(1)),t+=Number(i.setYPadding(0))})),!!t&&(this.trigger("123"),this.trigger("124"),!0)}wasScaledByY(){const t=this.sections.getSections();for(let i=0;i<t.length;i++){const e=t[i];if(1!==e.getScale()||e.getYPadding())return!0}return!1}isDefaultView(){const{state:t}=this,i=this.sections.getSections();for(let e=0;e<i.length;e++){const t=i[e];if(1!==t.getScale()||t.getYPadding())return!1}return!(.03336!==t.xScale||!t.isEnd())&&1===i[0].getScale()&&0===i[0].getYPadding()}moveToStart(){return this.state.moveToStart(),this}moveToEnd(){const t=this.state.getFrom();return this.state.moveToEnd(),this.onScroll(t,!0),this}getCurrentTime(){const t=this.state.getCount(),i=this.state.getFrom();return this.bars.time(i+t)}async moveToDate(t){const i=this.bars,e=this.state.getCount(),s=Te(t,this.bars.period),h=Te(t-this.bars.period*e*60*1e3*2,this.bars.period);let r=i.index(s);r<0&&await this.loadBars(i.symbol,i.period,h,Te(Date.now(),this.bars.period),-1),r=i.index(s);const a=Math.floor(r-e);this.state.resetPadding(),this.scroll(a)}scroll(t){return t!==this.state.getFrom()&&this.state.setFrom(t),this.state.calc(),this}count(){return this.state.getCount()}tick(){const t=this.bars,{lastBarAfter:i,lastBarBefore:e,lastPrice:s}=t;return i&&e&&s?this.state.isEnd()?s<this.state.dataMinValue||s>this.state.dataMaxValue?(this.refresh(),this):e.time!==i.time?(this.move(this.state.getStep()),this.redraw(),this):(we(this,qi,i),this):(this.native.updatePrice(i),this.showAskPrice&&this.native.updateAskPrice(i),this):this}toCanvas(){return this.app.renderer.plugins.extract.canvas(this.app.stage)}takeScreenshot(t){const i=Ce(Date.now(),"DD-MM-YY_hhhh-mm-ss",!1),e=`${this.bars.symbol}_${t}_${i}`;this.toCanvas().toBlob((t=>{if(!t)return;const i=document.createElement("a"),s=URL.createObjectURL(t);i.download=e,i.href=s,i.click(),i.remove(),URL.revokeObjectURL(s)}),"image/png")}}Ki=new WeakMap,$i=new WeakMap,qi=new WeakMap,Ji=new WeakMap,Qi=new WeakMap,Zi=new WeakMap,te=new WeakMap,ie=new WeakSet,ee=function(){var t;ke.defaultOptions.scaleMode=0,be.RESOLUTION=window.devicePixelRatio,(null==(t=be)?void 0:t.RENDER_OPTIONS)&&(be.RENDER_OPTIONS.hello=!1);const i=new xe({antialias:!0,resolution:window.devicePixelRatio||1,autoDensity:!0,backgroundColor:this.colors.chart.backgroundColor,sharedTicker:!0});return i.ticker.add((()=>{pe(this,qi)&&(this.trigger("120",pe(this,qi)),we(this,qi,!1)),pe(this,$i)&&(we(this,$i,!1),this.trigger("119"))})),i.stage.sortableChildren=!0,i},se=new WeakMap,he=new WeakMap,re=new WeakMap,ae=new WeakMap,ne=new WeakMap,oe=function(){fe(this,ie,ce).call(this),pe(this,Ki).set("move",new Hs(this)),pe(this,Ki).set("scale",new Re(this)),pe(this,Ki).set("scaleX",new Is(this)),pe(this,Ki).set("object",new Ns(this)),pe(this,Ki).set("selected",new Us(this))},ce=function(){pe(this,Ki).forEach((t=>null==t?void 0:t.destroy()))},le=async function(){pe(this,se).call(this);const t=3*this.count();try{const{timezoneShift:i,dayLightMode:e,ticksDelay:s,bars:h}=this;await hs(h,t,s,i,e,this.loadBars)}catch(i){i instanceof Error&&this.setError(`Failed to load bars - ${i.message}`)}};class js extends Fe{_draw(){const t=this.chart.bars;3===this.chart.chartType&&t.real?super._draw():this.clear()}_drawGraph(t,i){const{state:e,colors:s}=this.chart,h=this.chart.bars,r=e.getFrom();let a=e.startX();const n=h.length-1;let o=!1;t.lineStyle(2,s.chart.graph.lineColor);for(let c=r,l=r+e.getCount()+1;c<l;c++){if(c>=0){let e=h.close(c);if(c===n&&i&&(e=i.close),e){const i=this.valueToY(e);o?t.lineTo(a,i):(t.moveTo(a,i),o=!0)}}a+=e.getStep()}}}export{Ms as Area,Ss as AskPrice,ps as AxisX,Ds as AxisY,gs as Background,je as Bars,vs as BarsGraph,Fe as BaseIndicator,Bs as Chart,Se as Component,He as ComponentContainer,Ts as CrosshairX,_s as CrosshairY,Ye as EmptySettings,ys as Line,Ws as LineSettings,js as Lines,De as MAX_STEP,Fs as NativeManager,us as Price,ms as Quotes,Ie as SCALE_STEP,Ps as Section,Rs as SectionManager,ws as SelectedX,As as SelectedY,Pe as State,Cs as VolumeIndicator,Ve as addDblClick,Ke as angle,$e as calcStickingPosition,qe as center,Je as dashedLine,Qe as degreesToRadians,Ze as distance,Ne as fillIndicator,Be as getLastBarDate,ts as intersection,ks as isLeftClick,bs as isMiddleClick,xs as isRightClick,hs as last,as as next,rs as prev,is as projection,Ae as randomHex,_e as toJSON,es as updateChartStyle};
