var t,i,e,s,n,o,a,r,h,c,d,l,x,p,u,v,y,g,T,f,w,m,P,b,L,_,M,Y,S,k,C,X,K,I,U,F,V,D,A,W,j,E,R,B,O,H,G,z,q,N,Q,J,$,Z,tt,it,et,st,nt,ot,at,rt,ht,ct,dt,lt,xt,pt,ut,vt,yt=t=>{throw TypeError(t)},gt=(t,i,e)=>i.has(t)||yt("Cannot "+e),Tt=(t,i,e)=>(gt(t,i,"read from private field"),e?e.call(t):i.get(t)),ft=(t,i,e)=>i.has(t)?yt("Cannot add the same private member more than once"):i instanceof WeakSet?i.add(t):i.set(t,e),wt=(t,i,e,s)=>(gt(t,i,"write to private field"),s?s.call(t,e):i.set(t,e),e),mt=(t,i,e)=>(gt(t,i,"access private method"),e);import{a as Pt,b as bt}from"./B6FSvflP.js";import{l as Lt,h as _t}from"./HcGwWu0z.js";import{B as Mt,O as Yt,g as St,r as kt,a as Ct,i as Xt,b as Kt,c as It,d as Ut,e as Ft,H as Vt,f as Dt,h as At,C as Wt,l as jt}from"./BtviGlP5.js";import{b as Et,R as Rt,S as Bt,a as Ot}from"./CQ67ee1G.js";import"./d_ed_6Ut.js";import{g as Ht,c as Gt}from"./BAEQURWy.js";import{p as zt,d as qt,a as Nt,j as Qt,i as Jt,l as $t,k as Zt}from"./Bp5cWvCe.js";class ti extends Mt{constructor(t,i=7e3,e){super(t,i,e),this.onDown=this.onDown.bind(this),this.onMove=this.onMove.bind(this),this.onUp=this.onUp.bind(this)}start(t){this.draw(),this.settings.setVisible(!0);const i=this.chart.bars,{x:e,y:s}=this._mouse(t),n=i.time(this.chart.state.xToIndex(e)),o=this.yToValue(s);return this.settings.setCoordinates({date1:n,date2:n,price1:o,price2:o}),this.onDown(t),this.activePoint=2,window.addEventListener("pointermove",this.onMove),window.addEventListener("pointerup",this.onUp),this}setSection(t){this.section=t,this._before()}_draw(){const t=this._createGraphics("object");this._mask=this._createMask(),t.x=this._mask.x,t.y=this._mask.y,t.mask=this._mask,this._drawObject(t),this.container.addChild(t)}_drawObject(t){const{date1:i,date2:e,price1:s,price2:n}=this.settings.coordinates;if(!(i&&e&&s&&n))return;const o=this.chart.bars,a=this.chart.state.indexToX(o.index(i)),r=this.chart.state.indexToX(o.index(e)),h=this.valueToY(s),c=this.valueToY(n);this._drawRectangle(t,a,h,r,c)}_drawRectangle(t,i,e,s,n){const{background:o,lines:a}=this.settings.style,r=s>i?i:s,h=n>e?e:n,c=s>i?s-i:i-s,d=n>e?n-e:e-n;o.visible&&(t.beginFill(o.color,o.alpha),t.drawRect(r,h,c,d),t.endFill()),t.lineStyle(a.thickness,a.color),t.drawRect(r,h,c,d)}onDown(t){this._moveStartPoint={x:t.clientX,y:t.clientY},this._moveStartCoordinates=Lt(this.settings.coordinates)}onMove(t){if(2===this.activePoint){if(!this._moveStartCoordinates)return;const i=this._moveStartCoordinates.date2,e=this._moveStartCoordinates.price2;if(void 0===i||void 0===e)return;const s=t.clientX-this._moveStartPoint.x,n=t.clientY-this._moveStartPoint.y,o=this.chart.bars,a=this.chart.state.indexToX(o.index(i))+s,r=this.valueToY(e)+n,h=o.time(this.chart.state.xToIndex(a)),c=this.yToValue(r);this.settings.setCoordinates({date2:h,price2:c}),this.draw()}}onUp(t){this.activePoint=void 0,this.settings.setVisible(!1),this.draw(),this.chart.objects.trigger("700",{event:t}),window.removeEventListener("pointermove",this.onMove),window.removeEventListener("pointerup",this.onUp)}selectIfInArea(){return!1}}class ii extends Yt{constructor(t){super(t,{date1:0,date2:0,price1:0,price2:0},{lines:{color:2712319,thickness:0,visible:!0,alpha:1},background:{color:2712319,alpha:.35,visible:!0}},23,6,0,!1)}}class ei extends Mt{constructor(i,e=7e3,s){super(i,e,s),ft(this,t),this.onLinePointerDown=this.onLinePointerDown.bind(this),this.onLinePointerMove=this.onLinePointerMove.bind(this),this.onLinePointerUp=this.onLinePointerUp.bind(this)}start(t){this.draw();const{settings:i,chart:e}=this,{state:s}=e,n=this.chart.bars,{x:o,y:a}=this._mouse(t),r=n.time(s.xToIndex(o)),h=n.time(s.xToIndex(o+200)),c=this.yToValue(a);i.setCoordinates({date1:r,date2:r,date3:h,price1:c,price2:c,price3:c}),super.start(t),this.active=!0,this.activePoint=2;const{stage:d}=this.chart.app;return d.addEventListener("pointermove",this.onLinePointerMove),d.addEventListener("pointerup",this.onLinePointerUp),this}_drawObject(s,n){const{chart:o,settings:a}=this,{state:r}=o,{coordinates:h}=a,c=this.chart.bars,{date1:d,date2:l,date3:x,price1:p,price2:u,price3:v}=h;if(!(d&&l&&x&&p&&u&&v))return;const y=r.indexToX(c.index(d)),g=r.indexToX(c.index(l)),T=r.indexToX(c.index(x)),f=this.valueToY(p),w=this.valueToY(u),m=this.valueToY(v);mt(this,t,i).call(this,s,n,y,f,g,w,T,m),mt(this,t,e).call(this,s,y,f,g,w,T,m),s.off("pointerdown",this.onLinePointerDown).on("pointerdown",this.onLinePointerDown)}onLinePointerDown(t){const{chart:i,settings:e}=this,{state:s}=i,{coordinates:n}=e,o=this.chart.bars,{date1:a,date2:r,date3:h,price1:c,price2:d,price3:l}=n;if(!(a&&r&&h&&c&&d&&l))return;const x=s.indexToX(o.index(a)),p=s.indexToX(o.index(r)),u=s.indexToX(o.index(h)),v=this.valueToY(c),y=this.valueToY(d),g=this.valueToY(l),{x:T,y:f}=this._mouse(t);qt(T,f,u,g)<7?this.activePoint=3:qt(T,f,p,y)<7?this.activePoint=2:qt(T,f,x,v)<7&&(this.activePoint=1);const{stage:w}=this.chart.app;w&&(w.removeEventListener("pointermove",this.onLinePointerMove),w.removeEventListener("pointerup",this.onLinePointerUp)),this.activePoint&&(this._moveStartPoint={x:T,y:f},this._moveStartCoordinates=Lt(n),this.draw(),this.chart.objects.trigger("3006",{ctrlKey:t.ctrlKey,metaKey:t.metaKey,uid:this.settings.uid}),!t.doubleClick&&w&&(w.addEventListener("pointermove",this.onLinePointerMove),w.addEventListener("pointerup",this.onLinePointerUp)))}onLinePointerMove(t){const{activePoint:i}=this;if(i){this.active=!0;const{settings:e,chart:s}=this,{state:n}=s,o=this.chart.bars,a=this._moveStartCoordinates;if(!a)return;const r=this._moveStartPoint,{x:h,y:c}=this._mouse(t),d=h-r.x,l=c-r.y;let x,p;if(1===i?(x=a.date1,p=a.price1):2===i?(x=a.date2,p=a.price2):3===i&&(x=a.date3,p=a.price3),!x||!p)return;let u=n.indexToX(o.index(x)),v=this.valueToY(p);u+=d,v+=l;const y=o.time(n.xToIndex(u)),g=this.yToValue(v);1===i?e.setCoordinates({date1:y,price1:g}):2===i?e.setCoordinates({date2:y,price2:g}):3===i&&e.setCoordinates({date3:y,price3:g}),this.draw()}}onLinePointerUp(){this.active=!1,this.activePoint=void 0,this.draw();const{stage:t}=this.chart.app;t&&(t.removeEventListener("pointermove",this.onLinePointerMove),t.removeEventListener("pointerup",this.onLinePointerUp))}selectIfInArea(t,i){const{date1:e,date2:s,date3:n,price1:o,price2:a,price3:r}=this.settings.coordinates;if(!(e&&s&&n&&o&&a&&r))return!1;const h=this.chart.bars,c=this.chart.state.indexToX(h.index(e)),d=this.chart.state.indexToX(h.index(s)),l=this.chart.state.indexToX(h.index(n)),x=this.valueToY(o),p=this.valueToY(a),u=this.valueToY(r),{x4:v,y4:y}=si(0,0,d,p,l,u),g=Nt(c,x,v,y),T=zt(5e3,g),f=Nt(v,y,d,p),w=qt(v,y,d,p);let m=0;this.settings.style.levels.forEach((t=>{t.visible&&t.value>m&&(m=t.value)}));const P=w*m,b=zt(P,f),L=v+b.x,_=y+b.y,M=L+T.x,Y=_+T.y,S=zt(P,f+180),k=v+S.x,C=y+S.y,X=k+T.x,K=C+T.y,I={x1:this.chart.state.indexToX(h.index(i.date1??0)),x2:this.chart.state.indexToX(h.index(i.date2??0)),y1:this.valueToY(i.price1??0),y2:this.valueToY(i.price2??0)},U={x1:c,x2:c+T.x,y1:x,y2:x+T.y},F={x1:d,x2:l,y1:p,y2:u},V={x1:L,x2:M,y1:_,y2:Y},D={x1:k,x2:X,y1:C,y2:K},A={x1:L,x2:k,y1:_,y2:C},W=kt(I,{x1:L,x2:M,x3:X,x4:k,y1:_,y2:Y,y3:K,y4:C}),j=Ct(I,U),E=Ct(I,F),R=Ct(I,V),B=Ct(I,D),O=Ct(I,A);return!!(W||j||E||R||B||O)&&(this.focused=!0,this.draw(),this.chart.objects.trigger("3006",{ctrlKey:t.ctrlKey,metaKey:t.metaKey,uid:this.settings.uid}),!0)}}function si(t,i,e,s,n,o){return{x4:Math.min(e,n)+.5*(Math.max(e,n)-Math.min(e,n)),y4:Math.min(s,o)+.5*(Math.max(s,o)-Math.min(s,o))}}t=new WeakSet,i=function(t,i,e,s,n,o,a,r){const{levels:h,median:c,background:d}=this.settings.style,{thickness:l,color:x,alpha:p}=c,{x4:u,y4:v}=si(0,0,n,o,a,r),y=Nt(e,s,u,v),g=zt(5e3,y);this._drawLineSegment(t,e,s,e+g.x,s+g.y,l,x,p,!0),this._drawLineSegment(t,n,o,a,r,l,x,p,!0);const T=Nt(u,v,n,o),f=qt(u,v,n,o);let w=u,m=v,P=e+g.x,b=s+g.y,L=u,_=v,M=e+g.x,Y=s+g.y;h.forEach((e=>{if(e.visible){const s=f*e.value,n=zt(s,T),o=u+n.x,a=v+n.y,r=o+g.x,h=a+g.y;this._drawLineSegment(t,o,a,r,h,e.thickness,e.color,void 0,!0),d.visible&&(i.lineStyle(0,0,0),i.beginFill(e.color,d.alpha),i.moveTo(o,a),i.lineTo(r,h),i.lineTo(P,b),i.lineTo(w,m),i.endFill(),w=o,m=a,P=r,b=h);const c=zt(s,T+180),l=u+c.x,x=v+c.y,p=l+g.x,y=x+g.y;this._drawLineSegment(t,l,x,p,y,e.thickness,e.color,void 0,!0),d.visible&&(i.lineStyle(0,0,0),i.beginFill(e.color,d.alpha),i.moveTo(l,x),i.lineTo(p,y),i.lineTo(M,Y),i.lineTo(L,_),i.endFill(),L=l,_=x,M=p,Y=y)}}))},e=function(t,i,e,s,n,o,a){const{hover:r,focused:h,active:c,activePoint:d}=this;if(r||h||c){const r=St(this);r&&(c&&1===d||this._drawPoint(t,r,i,e),c&&2===d||this._drawPoint(t,r,s,n),c&&3===d||this._drawPoint(t,r,o,a))}};class ni extends Yt{constructor(t){super(t,{date1:0,date2:0,date3:0,price1:0,price2:0,price3:0},{median:{color:10813440,thickness:1,alpha:.15},levels:[{value:.25,visible:!0,color:10513152,thickness:1},{value:.382,visible:!0,color:6921728,thickness:1},{value:.5,visible:!0,color:39680,thickness:1},{value:.618,visible:!0,color:39269,thickness:1},{value:.75,visible:!0,color:26009,thickness:1},{value:1,visible:!0,color:153,thickness:1},{value:1.5,visible:!0,color:6684825,thickness:1},{value:1.75,visible:!0,color:10027110,thickness:1},{value:2,visible:!0,color:10813440,thickness:1}],background:{visible:!0,alpha:.1}},1,2,0,!0)}}class oi extends Mt{constructor(t,i=7e3,e){super(t,i,e),ft(this,n),ft(this,s),this.onLinePointerDown=this.onLinePointerDown.bind(this),this.onLinePointerMove=this.onLinePointerMove.bind(this),this.onLinePointerUp=this.onLinePointerUp.bind(this)}start(t){var i;this.draw();const{settings:e,chart:n}=this,{state:o}=n,a=this.chart.bars,{x:r,y:h}=this._mouse(t),c=a.time(o.xToIndex(r)),d=this.yToValue(h);return e.setCoordinates({date1:c,price1:d,date2:c,price2:d,price3:d}),super.start(t),this.active=!0,this.activePoint=2,null==(i=this.chart.app.stage)||i.on("pointermove",this.onLinePointerMove).on("pointerup",this.onLinePointerUp),wt(this,s,!0),this}_drawObject(t,i){const{chart:e,settings:s}=this,{state:r}=e,{coordinates:h,style:c}=s,d=this.chart.bars,{date1:l,date2:x,price1:p,price2:u,price3:v}=h;if(!(l&&x&&p&&u&&v))return;const y=r.indexToX(d.index(l));let g=y;const T=r.indexToX(d.index(x));let f=T;const w=this.valueToY(p);let m=w;const P=this.valueToY(u);let b=P;const L=this.valueToY(v),_=Nt(y,w,T,P),M=qt(y,w,T,P),Y=P-L,{extend:S}=c;if(S.left||S.right){if(S.left){const t=zt(5e3,_+180);g+=t.x,m+=t.y}if(S.right){const t=zt(5e3,_);f+=t.x,b+=t.y}}mt(this,n,o).call(this,t,i,g,m,f,b,Y),mt(this,n,a).call(this,t,y,w,T,P,Y,_,M),t.off("pointerdown",this.onLinePointerDown).on("pointerdown",this.onLinePointerDown)}onLinePointerDown(t,i=!1){var e,s;const{chart:n,settings:o}=this,{state:a}=n,{coordinates:r}=o,h=this.chart.bars,{date1:c,date2:d,price1:l,price2:x,price3:p}=r;if(!(c&&d&&l&&x&&p))return;const u=a.indexToX(h.index(c)),v=a.indexToX(h.index(d)),y=this.valueToY(l),g=this.valueToY(x);let T=0,f=this.valueToY(p);const w=Nt(u,y,v,g),m=qt(u,y,v,g),P=zt(.5*m,w),b=g-f;T=u+P.x,f=y+P.y-b;const{x:L,y:_}=this._mouse(t);i||qt(L,_,T,f)<7?this.activePoint=3:qt(L,_,v,g)<7?this.activePoint=2:qt(L,_,u,y)<7&&(this.activePoint=1),null==(e=this.chart.app.stage)||e.off("pointermove",this.onLinePointerMove).off("pointerup",this.onLinePointerUp),this.activePoint&&(this._moveStartPoint={x:L,y:_},this._moveStartCoordinates=Lt(r),this.draw(),this.chart.objects.trigger("3006",{ctrlKey:t.ctrlKey,metaKey:t.metaKey,uid:this.settings.uid}),t.doubleClick||null==(s=this.chart.app.stage)||s.on("pointermove",this.onLinePointerMove).on("pointerup",this.onLinePointerUp))}onLinePointerMove(t){const{activePoint:i}=this;if(i){this.active=!0;const{settings:e,chart:s}=this,{state:n}=s,o=s.bars,a=this._moveStartCoordinates,r=this._moveStartPoint,{x:h,y:c}=this._mouse(t),d=h-r.x,l=c-r.y;if(!(a&&a.date1&&a.date2&&a.price1&&a.price2&&a.price3))return;if(1===i){let t=n.indexToX(o.index(a.date1)),i=this.valueToY(a.price1);t+=d,i+=l,e.setCoordinates({date1:o.time(n.xToIndex(t)),price1:this.yToValue(i)})}else if(2===i){let t=n.indexToX(o.index(a.date2)),i=this.valueToY(a.price2),s=this.valueToY(a.price3);t+=d,i+=l,s+=l,e.setCoordinates({date2:o.time(n.xToIndex(t)),price2:this.yToValue(i),price3:this.yToValue(s)})}else if(3===i){let t=this.valueToY(a.price3);t+=l,e.setCoordinates({price3:this.yToValue(t)})}this.draw()}}onLinePointerUp(t){var i;this.active=!1,this.activePoint=void 0,this.draw(),null==(i=this.chart.app.stage)||i.off("pointermove",this.onLinePointerMove).off("pointerup",this.onLinePointerUp),Tt(this,s)&&(wt(this,s,!1),this.onLinePointerDown(t,!0))}selectIfInArea(t,i){const{date1:e,date2:s,price1:n,price2:o,price3:a}=this.settings.coordinates;if(!(e&&s&&n&&o&&a))return!1;const r=this.chart.bars;let h=this.chart.state.indexToX(r.index(e)),c=this.chart.state.indexToX(r.index(s)),d=this.valueToY(n),l=this.valueToY(o),x=this.valueToY(a);const p=Nt(h,d,c,l),u=l-x;let v=d-u;if(this.settings.style.extend.left){const t=zt(5e3,p+180);h+=t.x,d+=t.y,v=d-u}if(this.settings.style.extend.right){const t=zt(5e3,p);c+=t.x,l+=t.y,x=l-u}const y={x1:this.chart.state.indexToX(r.index(i.date1??0)),x2:this.chart.state.indexToX(r.index(i.date2??0)),y1:this.valueToY(i.price1??0),y2:this.valueToY(i.price2??0)},g=Kt(y,{x1:h,x2:c,x3:c,x4:h,y1:d,y2:l,y3:x,y4:v}),T=kt(y,{x1:h,x2:c,x3:c,x4:h,y1:d,y2:l,y3:x,y4:v}),f=Ct(y,{x1:h,x2:c,y1:d,y2:l}),w=Ct(y,{x1:c,x2:c,y1:l,y2:x}),m=Ct(y,{x1:c,x2:h,y1:x,y2:v}),P=Ct(y,{x1:h,x2:h,y1:v,y2:d});return!!(g||T||f||w||m||P)&&(this.focused=!0,this.draw(),this.chart.objects.trigger("3006",{ctrlKey:t.ctrlKey,metaKey:t.metaKey,uid:this.settings.uid}),!0)}}s=new WeakMap,n=new WeakSet,o=function(t,i,e,s,n,o,a){const{style:r}=this.settings,{channel:h,middle:c,background:d}=r;if(d.visible&&d.alpha&&(i.lineStyle(0),i.beginFill(d.color,d.alpha),i.moveTo(e,s),i.lineTo(n,o),i.lineTo(n,o-a||0),i.lineTo(e,s-a||0),i.endFill()),Xt(t,e,s,n,o),t.lineStyle(h.thickness,h.color,h.alpha),t.moveTo(e,s),t.lineTo(n,o),a&&(t.moveTo(e,s-a),t.lineTo(n,o-a),Xt(t,e,s-a,n,o-a),c.visible)){const i=s-Math.round(.5*a)+.5,r=o-Math.round(.5*a)+.5;t.lineStyle(c.thickness,c.color,c.alpha),t.moveTo(e,i),t.lineTo(n,r),Xt(t,e,i,n,r)}},a=function(t,i,e,s,n,o,a,r){const{hover:h,focused:c,active:d,activePoint:l}=this;if(h||c||d){const h=St(this);if(h&&(d&&1===l||this._drawPoint(t,h,i,e),d&&2===l||this._drawPoint(t,h,s,n),o&&(!d||3!==l))){const s=zt(.5*r,a);this._drawPoint(t,h,i+s.x,e+s.y-o)}}};class ai extends Yt{constructor(t){super(t,{date1:0,date2:0,price1:0,price2:0,price3:0},{channel:{color:7812249,thickness:1,alpha:1},middle:{visible:!1,color:7812249,thickness:1,alpha:.5},background:{visible:!0,color:11839446,alpha:.1},extend:{left:!1,right:!1}},2,2,0,!0)}}class ri extends Mt{constructor(t,i=7e3,e){super(t,i,e),ft(this,r),this.onLinePointerDown=this.onLinePointerDown.bind(this),this.onLinePointerMove=this.onLinePointerMove.bind(this),this.onLinePointerUp=this.onLinePointerUp.bind(this)}start(t){var i;this.draw();const{settings:e,chart:s}=this,{state:n}=s,o=this.chart.bars,{x:a}=this._mouse(t),r=o.time(n.xToIndex(a));return e.setCoordinates({date1:r,date2:r}),super.start(t),this.active=!0,this.activePoint=2,null==(i=this.chart.app.stage)||i.on("pointermove",this.onLinePointerMove).on("pointerup",this.onLinePointerUp),this}_drawObject(t,i){const{chart:e,settings:s}=this,{state:n}=e,{coordinates:o}=s,{date1:a,date2:l}=o;if(!(a&&l&&this.dataValue1&&this.dataValue2&&this.dataValue1&&this.dataMax))return;const{index1:x,index2:p}=this.getBarsIndex(a,l),u=n.indexToX(x),v=n.indexToX(p),y=this.valueToY(this.dataValue1),g=this.valueToY(this.dataValue2),T=this.valueToY(this.dataValue1-this.dataMax),f=Math.max(T,y)-Math.min(T,y);mt(this,r,h).call(this,t,i,u,y,v,g,f),mt(this,r,c).call(this,t,u,y,v,g,f),mt(this,r,d).call(this,t,u,y,v,g),t.off("pointerdown",this.onLinePointerDown).on("pointerdown",this.onLinePointerDown)}onLinePointerDown(t){var i,e;const{chart:s,settings:n}=this,{state:o}=s,{coordinates:a,flip:r}=n,{date1:h,date2:c}=a;if(!(h&&c&&this.dataValue1&&this.dataValue2))return;const{index1:d,index2:l}=this.getBarsIndex(h,c),x=o.indexToX(d),p=o.indexToX(l),u=this.valueToY(this.dataValue1),v=this.valueToY(this.dataValue2),{x:y,y:g}=this._mouse(t);qt(y,g,p,v)<7?this.activePoint=r?1:2:qt(y,g,x,u)<7&&(this.activePoint=r?2:1),null==(i=this.chart.app.stage)||i.off("pointermove",this.onLinePointerMove).off("pointerup",this.onLinePointerUp),this.activePoint&&(this._moveStartPoint={x:y,y:g},this._moveStartCoordinates=Lt(a),this.draw(),this.chart.objects.trigger("3006",{ctrlKey:t.ctrlKey,metaKey:t.metaKey,uid:this.settings.uid}),t.doubleClick||null==(e=this.chart.app.stage)||e.on("pointermove",this.onLinePointerMove).on("pointerup",this.onLinePointerUp))}onLinePointerMove(t){const{activePoint:i}=this;if(i){this.active=!0;const{settings:e,chart:s}=this,{state:n}=s,o=this.chart.bars,a=this._moveStartCoordinates;if(!a)return;const r=this._moveStartPoint,{x:h}=this._mouse(t),c=h-r.x;let d;if(1===i?d=a.date1:2===i?d=a.date2:3===i&&(d=a.date3),!d)return;let l=n.indexToX(o.index(d));l+=c;const x=o.time(n.xToIndex(l));1===i?e.setCoordinates({date1:x}):2===i&&e.setCoordinates({date2:x}),this.draw()}}onLinePointerUp(){var t;this.active=!1,this.activePoint=void 0,this.draw(),null==(t=this.chart.app.stage)||t.off("pointermove",this.onLinePointerMove).off("pointerup",this.onLinePointerUp)}getBarsIndex(t,i){const e=this.chart.bars;let s=e.index(t),n=e.index(i);return s>n?([s,n]=[n,s],this.settings.flip=!0):this.settings.flip=!1,s<0&&(s=0),n>=e.length&&(n=e.length-1),0===s&&s>=n&&(n=s+1),n===e.length-1&&s>=n&&(s=n-1),{index1:s,index2:n}}selectIfInArea(t,i){const{date1:e,date2:s}=this.settings.coordinates;if(!(e&&s&&this.dataValue1&&this.dataValue2&&this.dataValue1&&this.dataMax))return!1;const{index1:n,index2:o}=this.getBarsIndex(e,s);let a=this.chart.state.indexToX(n),r=this.chart.state.indexToX(o),h=this.valueToY(this.dataValue1),c=this.valueToY(this.dataValue2);const d=this.valueToY(this.dataValue1-this.dataMax),l=Math.max(d,h)-Math.min(d,h);if(this.settings.style.extend.left){const t=Nt(r,c,a,h),i=zt(5e3,t);a+=i.x,h+=i.y}if(this.settings.style.extend.right){const t=Nt(a,h,r,c),i=zt(5e3,t);r+=i.x,c+=i.y}const{y1i:x,y2i:p,y1j:u,y2j:v}=hi(a,h,r,c,l),y=this.chart.bars,g={x1:this.chart.state.indexToX(y.index(i.date1??0)),x2:this.chart.state.indexToX(y.index(i.date2??0)),y1:this.valueToY(i.price1??0),y2:this.valueToY(i.price2??0)},T=Kt(g,{x1:a,x2:r,x3:r,x4:a,y1:x,y2:p,y3:v,y4:u}),f=kt(g,{x1:a,x2:r,x3:r,x4:a,y1:x,y2:p,y3:v,y4:u}),w=Ct(g,{x1:a,x2:r,y1:x,y2:p}),m=Ct(g,{x1:a,x2:r,y1:u,y2:v}),P=Ct(g,{x1:a,x2:a,y1:x,y2:u}),b=Ct(g,{x1:r,x2:r,y1:p,y2:v});return!!(T||f||w||b||m||P)&&(this.focused=!0,this.draw(),this.chart.objects.trigger("3006",{ctrlKey:t.ctrlKey,metaKey:t.metaKey,uid:this.settings.uid}),!0)}}function hi(t,i,e,s,n){return{x1i:t,y1i:i-n,x2i:e,y2i:s-n,x1j:t,y1j:i+n,x2j:e,y2j:s+n}}r=new WeakSet,h=function(t,i,e,s,n,o,a){const{base:r,up:h,down:c,extend:d,background:l}=this.settings.style;let x=e,p=s,u=n,v=o;if(d.left){const t=Nt(u,v,e,s),i=zt(5e3,t);x+=i.x,p+=i.y}if(d.right){const t=Nt(x,p,u,v),i=zt(5e3,t);u+=i.x,v+=i.y}const{x1i:y,y1i:g,x2i:T,y2i:f,x1j:w,y1j:m,x2j:P,y2j:b}=hi(x,p,u,v,a);l.visible&&(r.visible?c.visible?(i.lineStyle(0),i.beginFill(r.color,l.alpha),i.moveTo(x,p),i.lineTo(u,v),i.lineTo(P,b),i.lineTo(w,m),i.endFill(),h.visible&&(i.lineStyle(0),i.beginFill(h.color,l.alpha),i.moveTo(x,p),i.lineTo(u,v),i.lineTo(T,f),i.lineTo(y,g),i.endFill())):(i.lineStyle(0),i.beginFill(r.color,l.alpha),i.moveTo(x,p),i.lineTo(u,v),i.lineTo(T,f),i.lineTo(y,g),i.endFill()):h.visible&&c.visible&&(i.lineStyle(0),i.beginFill(c.color,l.alpha),i.moveTo(y,g),i.lineTo(T,f),i.lineTo(P,b),i.lineTo(w,m),i.endFill())),r.visible&&(t.lineStyle(r.thickness,r.color,r.alpha),t.moveTo(x,p),t.lineTo(u,v),Xt(t,x,p,u,v)),h.visible&&(t.lineStyle(h.thickness,h.color,h.alpha),t.moveTo(y,g),t.lineTo(T,f),Xt(t,y,g,T,f)),c.visible&&(t.lineStyle(c.thickness,c.color,c.alpha),t.moveTo(w,m),t.lineTo(P,b),Xt(t,w,m,P,b))},c=function(t,i,e,s,n,o){var a;const{section:r,settings:h}=this,{down:c,pearson:d}=h.style;if(!d.visible)return;const{x1j:l,y1j:x}=hi(i,e,s,n,o),p=this.createText((null==(a=this.dataMax)?void 0:a.toFixed(r.digits))??"");c.color&&(p.tint=c.color),this.pearsonWidth&&!this.changed("pearson",Math.floor(this.dataMax??0),r.digits)||(this.pearsonWidth=p.textWidth),p.x=Math.round(l-.5*this.pearsonWidth),p.y=x+8,t.addChild(p)},d=function(t,i,e,s,n){const{hover:o,focused:a,active:r,activePoint:h}=this;if(o||a||r){const o=St(this);o&&(r&&1===h||this._drawPoint(t,o,i,e),r&&2===h||this._drawPoint(t,o,s,n))}};class ci extends ri{_before(){super._before();const{settings:t}=this,{coordinates:i}=t,e=this.chart.bars,{date1:s,date2:n}=i;if(!s||!n)return;this.dataValue1=0,this.dataValue2=0,this.dataMax=0;const{index1:o,index2:a}=this.getBarsIndex(s,n),r=a-o+1;let h=0,c=0,d=0,l=0;for(let T=0;T<r;T++){const t=e.close(o+T)||0;h+=t,d+=t*T,c+=T,l+=T*T}const x=l*r-c*c;if(0===x)return void(this.dataMax=0);const p=(d*r-c*h)/x,u=(h-c*p)/r;this.dataValue1=u||0,this.dataValue2=u+p*(r-1)||0;let v=0,y=0,g=u;for(let T=0;T<r;T++){const t=e.close(o+T)||0;g+=p,y=Math.abs(t-g),v<=y&&(v=y)}this.dataMax=v}}class di extends Yt{constructor(t){super(t,{date1:0,date2:0,deviations:2},{base:{visible:!0,color:16711680,thickness:1,alpha:.35},up:{visible:!0,color:255,thickness:1,alpha:.35},down:{visible:!0,color:255,thickness:1,alpha:.35},extend:{left:!1,right:!1},pearson:{visible:!0},background:{visible:!0,alpha:.1}},3,2,1,!0),this.flip=!1}}class li extends Mt{constructor(t,i=7e3,e){super(t,i,e),ft(this,x),ft(this,l,new Map),this.active=!1,this.onLinePointerDown=this.onLinePointerDown.bind(this),this.onLinePointerMove=this.onLinePointerMove.bind(this),this.onLinePointerUp=this.onLinePointerUp.bind(this)}start(t){this.draw();const{settings:i,chart:e}=this,{state:s}=e,n=this.chart.bars,{x:o,y:a}=this._mouse(t),r=n.time(s.xToIndex(o)),h=this.yToValue(a);return i.setCoordinates({date1:r,date2:r,price1:h,price2:h}),super.start(t),this.active=!0,this.activePoint=2,this.chart.app.stage&&(this.chart.app.stage.addEventListener("pointermove",this.onLinePointerMove),this.chart.app.stage.addEventListener("pointerup",this.onLinePointerUp)),this}_drawObject(t,i){const{chart:e,settings:s}=this,{state:n}=e,{coordinates:o}=s,a=this.chart.bars,{date1:r,date2:h,price1:c,price2:d}=o;if(!(r&&h&&c&&d))return;const l=n.indexToX(a.index(r)),u=n.indexToX(a.index(h)),y=this.valueToY(c),g=this.valueToY(d);mt(this,x,p).call(this,t,i,l,y,u,g),mt(this,x,v).call(this,t,l,y,u,g),t.removeEventListener("pointerdown",this.onLinePointerDown),t.addEventListener("pointerdown",this.onLinePointerDown)}onLinePointerDown(t){var i;const{chart:e,settings:s}=this,{state:n}=e,{coordinates:o}=s,a=this.chart.bars,{date1:r,date2:h,price1:c,price2:d}=o;if(!(r&&h&&c&&d))return;const l=n.indexToX(a.index(r)),x=n.indexToX(a.index(h)),p=this.valueToY(c),u=this.valueToY(d),{x:v,y:y}=this._mouse(t);qt(v,y,x,u)<7?this.activePoint=2:qt(v,y,l,p)<7&&(this.activePoint=1),null==(i=this.chart.app.stage)||i.off("pointermove",this.onLinePointerMove).off("pointerup",this.onLinePointerUp),this.activePoint&&(this._moveStartPoint={x:v,y:y},this.draw(),this.chart.objects.trigger("3006",{ctrlKey:t.ctrlKey,metaKey:t.metaKey,uid:this.settings.uid}),t.doubleClick||this.chart.app.stage&&(this.chart.app.stage.addEventListener("pointermove",this.onLinePointerMove),this.chart.app.stage.addEventListener("pointerup",this.onLinePointerUp)))}onLinePointerMove(t){const{activePoint:i}=this;if(i){this.active=!0;const{settings:e,chart:s}=this,{state:n}=s,o=this.chart.bars,a=this._moveStartCoordinates;if(!a)return;const r=this._moveStartPoint,{x:h,y:c}=this._mouse(t),d=h-r.x,l=c-r.y;let x,p;if(1===i?(x=a.date1,p=a.price1):2===i?(x=a.date2,p=a.price2):3===i&&(x=a.date3,p=a.price3),!x||!p)return;let u=n.indexToX(o.index(x)),v=this.valueToY(p);u+=d,v+=l,1===i?e.setCoordinates({date1:o.time(n.xToIndex(u)),price1:this.yToValue(v)}):2===i&&e.setCoordinates({date2:o.time(n.xToIndex(u)),price2:this.yToValue(v)}),this.draw()}}onLinePointerUp(){this.active=!1,this.activePoint=void 0,this.draw(),this.chart.app.stage&&(this.chart.app.stage.removeEventListener("pointermove",this.onLinePointerMove),this.chart.app.stage.removeEventListener("pointerup",this.onLinePointerUp))}selectIfInArea(t,i){const e=this.chart.bars,{date1:s,date2:n,price1:o,price2:a}=this.settings.coordinates,{level:r,levels:h,reverse:c}=this.settings.style;if(!(s&&n&&o&&a))return!1;const d=this.valueToY(o),l=this.valueToY(a),x=d-l;let p=0,u=0;return h.forEach((t=>{t.visible&&t.value>p&&(p=t.value,u=l+x*t.value,c&&(u=d-x*t.value))})),!!It({x1:this.chart.state.indexToX(e.index(i.date1??0)),x2:this.chart.state.indexToX(e.index(i.date2??0)),y1:this.valueToY(i.price1??0),y2:this.valueToY(i.price2??0)},{x1:this.chart.state.indexToX(e.index(Math.min(s,n))),x2:r.extended?this.chart.state.graphWidth:this.chart.state.indexToX(e.index(Math.max(s,n))),y1:c?this.valueToY(Math.max(o,a)):u,y2:c?u:this.valueToY(Math.min(o,a))})&&(this.focused=!0,this.draw(),this.chart.objects.trigger("3006",{ctrlKey:t.ctrlKey,metaKey:t.metaKey,uid:this.settings.uid}),!0)}}l=new WeakMap,x=new WeakSet,p=function(t,i,e,s,n,o){const{chart:a,settings:r}=this,{state:h}=a,{level:c,trend:d,reverse:l,background:p,labels:v,levels:y}=r.style;if(this._drawLineSegment(t,e,s,n,o,d.thickness,d.color,void 0,!0),c.visible){const a=s-o;let r,d=Math.max(e,n)-Math.min(e,n);c.extended&&(d=h.graphWidth-Math.min(e,n)),y.sort(((t,i)=>t.value-i.value)).forEach((h=>{const{value:c,color:y,visible:g}=h;if(g){let g=o+a*c;if(l&&(g=s-a*c),p.visible&&r){const t=Math.max(g,r)-Math.min(g,r);i.lineStyle(0,0,0),i.beginFill(y,p.alpha),i.drawRect(Math.min(e,n),Math.min(g,r),d,t),i.endFill()}this._drawLineSegment(t,Math.round(Math.min(e,n))+.5,Math.round(g)+.5,Math.round(Math.min(e,n)+d)+.5,Math.round(g)+.5,h.thickness,y,void 0,!0),v.visible&&mt(this,x,u).call(this,t,e,n,g,c,y),r=g}}))}},u=function(t,i,e,s,n,o){const{section:a,settings:r,chart:h}=this,{state:c}=h,{labels:d,level:x}=r.style;let p=n.toFixed(3),u=n.toFixed(0);if(d.price){const t=this.yToValue(s);p+=` (${t.toFixed(a.digits)})`,u+=` ${t.toFixed(0)}`}const v=this.createText(p);v.tint=o;let y=Tt(this,l).get(u);switch(y||(y=v.textWidth,Tt(this,l).set(u,y)),d.align){case 1:x.extended?v.x=c.graphWidth-y-5:v.x=Math.max(i,e)+5;break;case 2:v.x=i+(e-i)/2-y/2;break;default:v.x=Math.min(i,e)-y-5}switch(d.valign){case 0:v.y=s-18;break;case 2:v.y=s-8;break;default:v.y=s+3}t.addChild(v)},v=function(t,i,e,s,n){const{hover:o,focused:a,active:r,activePoint:h}=this;if(o||a||r){const o=St(this);o&&(r&&1===h||this._drawPoint(t,o,i,e),r&&2===h||this._drawPoint(t,o,s,n))}};class xi extends Yt{constructor(t){super(t,{date1:0,date2:0,price1:0,price2:0},{trend:{color:8432304,thickness:1},level:{extended:!1,visible:!0,thickness:1},levels:[{visible:!0,thickness:1,value:0,color:8421504},{visible:!0,thickness:1,value:.236,color:13379624},{visible:!0,thickness:1,value:.382,color:9817128},{visible:!0,thickness:1,value:.5,color:2673704},{visible:!0,thickness:1,value:.618,color:2673813},{visible:!0,thickness:1,value:.786,color:2659788},{visible:!0,thickness:1,value:1,color:8421504},{visible:!0,thickness:1,value:1.618,color:2631884},{visible:!0,thickness:1,value:2.618,color:13379624},{visible:!0,thickness:1,value:3.618,color:9775308},{visible:!0,thickness:1,value:4.236,color:13379733}],background:{visible:!0,alpha:.1},labels:{visible:!0,price:!0,align:0,valign:2},reverse:!1},5,4,0,!0)}}class pi extends Mt{constructor(t,i=7e3,e){super(t,i,e),this.onLinePointerDown=this.onLinePointerDown.bind(this),this.onLinePointerMove=this.onLinePointerMove.bind(this),this.onLinePointerUp=this.onLinePointerUp.bind(this)}start(t){var i;this.draw();const{settings:e,chart:s}=this,{state:n}=s,o=this.chart.bars,{x:a,y:r}=this._mouse(t),h=o.time(n.xToIndex(a)),c=this.yToValue(r);return e.setCoordinates({date1:h,price1:c,date2:h,price2:c}),super.start(t),this.active=!0,this.activePoint=2,null==(i=this.chart.app.stage)||i.on("pointermove",this.onLinePointerMove).on("pointerup",this.onLinePointerUp),this}_drawObject(t,i){const{chart:e,settings:s}=this,{state:n}=e,{coordinates:o}=s,a=this.chart.bars,{date1:r,price1:h,date2:c,price2:d}=o;if(!(r&&c&&h&&d))return;const l=n.indexToX(a.index(r)),x=n.indexToX(a.index(c)),p=this.valueToY(h),u=this.valueToY(d);this._drawLine(t,i,l,p,x,u),this._drawSelected(t,l,p,x,u),t.off("pointerdown",this.onLinePointerDown).on("pointerdown",this.onLinePointerDown)}_drawSelected(t,i,e,s,n){const{hover:o,focused:a,active:r,activePoint:h}=this;if(o||a||r){const o=St(this);o&&(r&&1===h||this._drawPoint(t,o,i,e),r&&2===h||this._drawPoint(t,o,s,n))}}_calcPrice2(t=1){const{settings:i}=this,{price1:e,price2:s,pips:n}=i.coordinates;return e&&s&&n?s+(s-e)*(t>1?t:t-1):null}onLinePointerDown(t){var i,e;const{chart:s,settings:n}=this,{state:o}=s,{coordinates:a}=n,r=this.chart.bars,{date1:h,price1:c,date2:d,price2:l}=a;if(!(h&&d&&c&&l))return;const x=o.indexToX(r.index(h)),p=o.indexToX(r.index(d)),u=this.valueToY(c),v=this.valueToY(l),{x:y,y:g}=this._mouse(t);qt(y,g,p,v)<7?this.activePoint=2:qt(y,g,x,u)<7&&(this.activePoint=1),null==(i=this.chart.app.stage)||i.off("pointermove",this.onLinePointerMove).off("pointerup",this.onLinePointerUp),this.activePoint&&(this._moveStartPoint={x:y,y:g},this._moveStartCoordinates={...Lt(a),price2:l},this.draw(),this.chart.objects.trigger("3006",{ctrlKey:t.ctrlKey,metaKey:t.metaKey,uid:this.settings.uid}),t.doubleClick||null==(e=this.chart.app.stage)||e.on("pointermove",this.onLinePointerMove).on("pointerup",this.onLinePointerUp))}onLinePointerMove(t){const{activePoint:i}=this;if(i){this.active=!0;const{settings:e,chart:s}=this,{state:n}=s,o=this.chart.bars,a=this._moveStartCoordinates;if(!a)return;const r=this._moveStartPoint,{x:h,y:c}=this._mouse(t),d=h-r.x,l=c-r.y;if(1===i){if(!a.date1||!a.price1)return;let t=n.indexToX(o.index(a.date1)),i=this.valueToY(a.price1);t+=d,i+=l,e.setCoordinates({date1:o.time(n.xToIndex(t)),price1:this.yToValue(i)})}if(2===i){if(!a.date2||!a.price2)return;let t=n.indexToX(o.index(a.date2)),i=this.valueToY(a.price2);t+=d,i+=l,e.setCoordinates({date2:o.time(n.xToIndex(t)),price2:this.yToValue(i)})}this.draw()}}onLinePointerUp(){var t;this.active=!1,this.activePoint=void 0,this.draw(),null==(t=this.chart.app.stage)||t.off("pointermove",this.onLinePointerMove).off("pointerup",this.onLinePointerUp)}}class ui extends pi{_drawLine(t,i,e,s,n){const{levels:o,background:a,label:r}=this.settings.style;let h;o.forEach((o=>{const{thickness:c,color:d,alpha:l,value:x}=o,p=this._calcPrice2(x);if(null===p)return;const u=this.valueToY(p);if(a.visible&&a.alpha&&h){i.lineStyle(0,0,0),i.beginFill(d,a.alpha),i.moveTo(e,s);const t=zt(5e3,Nt(e,s,n,u));i.lineTo(e+t.x,s+t.y);const o=zt(5e3,Nt(e,s,n,h));i.lineTo(e+o.x,s+o.y),i.endFill()}if(r.visible){const i=this.createText(x.toFixed(2));i.tint=d,i.x=n+6,i.y=u-20,t.addChild(i)}const v=zt(5e3,Nt(e,s,n,u));t.lineTo(e+v.x,s+v.y),this._drawLineSegment(t,e,s,e+v.x,s+v.y,c,d,l,!0),h=u}))}selectIfInArea(t,i){const{date1:e,price1:s,date2:n}=this.settings.coordinates;if(!e||!n||!s)return!1;const o=this.chart.bars,a=this.chart.state.indexToX(o.index(e)),r=this.chart.state.indexToX(o.index(n)),h=this.valueToY(s),c={x1:this.chart.state.indexToX(o.index(i.date1??0)),x2:this.chart.state.indexToX(o.index(i.date2??0)),y1:this.valueToY(i.price1??0),y2:this.valueToY(i.price2??0)};let d=!1;return this.settings.style.levels.forEach((t=>{const i=this._calcPrice2(t.value);if(null!==i&&!d){const t=this.valueToY(i),e=zt(5e3,Nt(a,h,r,t));d=Ct(c,{x1:a,x2:a+e.x,y1:h,y2:h+e.y})}})),!!d&&(this.focused=!0,this.draw(),this.chart.objects.trigger("3006",{ctrlKey:t.ctrlKey,metaKey:t.metaKey,uid:this.settings.uid}),!0)}}class vi extends Yt{constructor(t){super(t,{date1:0,date2:0,price1:0,price2:0,pips:1,down:0},{levels:[{value:8,color:10813440,thickness:1},{value:4,color:6684825,thickness:1},{value:3,color:153,thickness:1},{value:2,color:26009,thickness:1},{value:1,color:8421504,thickness:1},{value:.5,color:39269,thickness:1},{value:.3,color:39680,thickness:1},{value:.25,color:6921728,thickness:1},{value:.125,color:10513152,thickness:1}],label:{visible:!0},background:{visible:!0,alpha:.1}},6,3,0,!0)}}class yi extends pi{onLinePointerMove(t){const{activePoint:i}=this;if(i){this.active=!0;const{settings:e,chart:s}=this,{state:n}=s,o=this.chart.bars,a=this._moveStartCoordinates;if(!a)return;const r=this._moveStartPoint,{x:h,y:c}=this._mouse(t),d=h-r.x,l=c-r.y;if(!(a.date1&&a.price1&&a.date2&&a.price2))return;let x=n.indexToX(o.index(a.date1)),p=this.valueToY(a.price1),u=n.indexToX(o.index(a.date2)),v=this.valueToY(a.price2);1===i&&(p=Math.max(p+l,v+10),x=Math.min(x+d,u-10),e.setCoordinates({date1:o.time(n.xToIndex(x)),price1:this.yToValue(p)})),2===i&&(v=Math.min(v+l,p-10),u=Math.max(u+d,x+10),e.setCoordinates({date2:o.time(n.xToIndex(u)),price2:this.yToValue(v)})),this.draw()}}_drawLine(t,i,e,s,n){let o=n;const{chart:a,settings:r}=this,{state:h}=a,{line:c,background:d}=r.style,{down:l}=r.coordinates,x=this._calcPrice2();if(null===x)return;let p=this.valueToY(x);p>s-10&&(p=s-10),e>o-10&&(o=e+10);const u=Nt(e,s,o,p);if(this._drawLineSegment(t,e,s,o,p,c.thickness,c.color,1,!0),d.visible){const t=zt(5e4,-u),e=zt(5e4,u);i.lineStyle(0,0,0),i.beginFill(d.color,d.alpha),i.moveTo(o-t.x,p-t.y),i.lineTo(o+t.x,p+t.y),i.lineTo(o+e.x+t.x,p+e.y+t.y),i.lineTo(o+e.x-t.x,p+e.y-t.y),i.endFill()}if(c.visible){const i=Math.max(e,o)-Math.min(e,o);let n=Math.max(s,p)-Math.min(s,p);if(l&&(n*=-1),Math.abs(i)>5&&Math.abs(n)>5){let e=zt(5e4,u),s=o,a=p;for(;s<h.graphWidth;){const o=s+e.x,r=a+e.y;this._drawLineSegment(t,s,a,o,r,c.thickness,c.color,1,!0),s+=i,a+=n}s=o-i,a=p-n;let r=!0;for(;a>0&&r;){const o=s+e.x,d=a+e.y;this._drawLineSegment(t,s,a,o,d,c.thickness,c.color,1,!0),s-=i,a-=n;const x=l?Qt(s,a,o,d,0,h.graphHeight,5e4,h.graphHeight):Qt(s,a,o,d,0,0,5e4,0);s<0&&!x.line2&&(r=!1)}for(e=zt(5e4,-u),s=h.graphWidth,a=p+Math.tan(Jt(-u))*(s-o);!l&&a>0||l&&a<h.graphHeight;){const i=s-e.x,o=a-e.y;this._drawLineSegment(t,s,a,i,o,c.thickness,c.color,1,!0),a-=n}}}}selectIfInArea(t,i){const{date1:e,price1:s,date2:n}=this.settings.coordinates;if(!e||!n||!s)return!1;const o=this.chart.bars,{down:a}=this.settings.coordinates,r=this.chart.state.indexToX(o.index(e));let h=this.chart.state.indexToX(o.index(n));const c=this.valueToY(s),d=this._calcPrice2();if(null===d)return!1;let l=this.valueToY(d);l>c-10&&(l=c-10),r>h-10&&(h=r+10);const x={x1:this.chart.state.indexToX(o.index(i.date1??0)),x2:this.chart.state.indexToX(o.index(i.date2??0)),y1:this.valueToY(i.price1??0),y2:this.valueToY(i.price2??0)},p=Ct(x,{x1:r,x2:h,y1:c,y2:l});let u=!1;if(this.settings.style.line.visible&&!p){const t=Nt(r,c,h,l),i=Math.max(r,h)-Math.min(r,h);let e=Math.max(c,l)-Math.min(c,l);if(a&&(e*=-1),Math.abs(i)>5&&Math.abs(e)>5){let s=zt(5e4,t),n=h,o=l;for(;n<this.chart.state.graphWidth&&!u;){const t=n+s.x,a=o+s.y;u=Ct(x,{x1:n,x2:t,y1:o,y2:a}),n+=i,o+=e}n=h-i,o=l-e;let r=!0;for(;o>0&&r&&!u;){const t=n+s.x,h=o+s.y;u=Ct(x,{x1:n,x2:t,y1:o,y2:h}),n-=i,o-=e;const c=a?Qt(n,o,t,h,0,this.chart.state.graphHeight,5e4,this.chart.state.graphHeight):Qt(n,o,t,h,0,0,5e4,0);n<0&&!c.line2&&(r=!1)}for(s=zt(5e4,-t),n=this.chart.state.graphWidth,o=l+Math.tan(Jt(-t))*(n-h);(!a&&o>0||a&&o<this.chart.state.graphHeight)&&!u;){const t=n-s.x,i=o-s.y;u=Ct(x,{x1:n,x2:t,y1:o,y2:i}),o-=e}}}return!(!p&&!u||(this.focused=!0,this.draw(),this.chart.objects.trigger("3006",{ctrlKey:t.ctrlKey,metaKey:t.metaKey,uid:this.settings.uid}),0))}}class gi extends Yt{constructor(t){super(t,{date1:0,date2:0,price1:0,price2:0,pips:0,down:0},{line:{color:10813440,thickness:1,alpha:1,visible:!0},background:{color:10813440,alpha:.05,visible:!0}},7,3,0,!0)}}class Ti extends Mt{constructor(t,i=7e3,e){super(t,i,e),this.active=!1,this.onLinePointerDown=this.onLinePointerDown.bind(this),this.onLinePointerMove=this.onLinePointerMove.bind(this),this.onLinePointerUp=this.onLinePointerUp.bind(this)}start(t){this.draw();const i=this.chart.bars;this.activePoint=1;const{x:e,y:s}=this._mouse(t),n=i.time(this.chart.state.xToIndex(e)),o=this.yToValue(s);return this.settings.setCoordinates({date1:n,date2:n,price1:o,price2:o}),super.start(t),this.active=!0,this.activePoint=2,this.chart.app.stage.addEventListener("pointermove",this.onLinePointerMove),this.chart.app.stage.addEventListener("pointerup",this.onLinePointerUp),this}_drawObject(t,i){const{date1:e,date2:s,price1:n,price2:o}=this.settings.coordinates;if(!(e&&s&&n&&o))return;const a=this.chart.bars,r=a.index(e),h=a.index(s),c=this.chart.state.indexToX(r),d=this.chart.state.indexToX(h),l=this.valueToY(n),x=this.valueToY(o);this._drawTrend(t,c,l,d,x),this._drawSelected(t,c,l,d,x),t.removeEventListener("pointerdown",this.onLinePointerDown),t.addEventListener("pointerdown",this.onLinePointerDown)}_drawSelected(t,i,e,s,n){if(this.hover||this.focused||this.active){const o=St(this);o&&(this.active&&1===this.activePoint||this._drawPoint(t,o,i,e),this.active&&2===this.activePoint||this._drawPoint(t,o,s,n))}}_drawTrend(t,i,e,s,n){}onLinePointerDown(t){const{date1:i,date2:e,price1:s,price2:n}=this.settings.coordinates;if(!(i&&e&&s&&n))return;const o=this.chart.bars,a=this.chart.state.indexToX(o.index(i)),r=this.chart.state.indexToX(o.index(e)),h=this.valueToY(s),c=this.valueToY(n),{x:d,y:l}=this._mouse(t);qt(d,l,r,c)<9?this.activePoint=2:qt(d,l,a,h)<9&&(this.activePoint=1),this.chart.app.stage.removeEventListener("pointermove",this.onLinePointerMove),this.chart.app.stage.removeEventListener("pointerup",this.onLinePointerUp),this.activePoint&&(this._moveStartPoint={x:d,y:l},this.draw(),this.chart.objects.trigger("3006",{ctrlKey:t.ctrlKey,metaKey:t.metaKey,uid:this.settings.uid}),t.doubleClick||(this.chart.app.stage.addEventListener("pointermove",this.onLinePointerMove),this.chart.app.stage.addEventListener("pointerup",this.onLinePointerUp)))}onLinePointerMove(t){if(this.activePoint){if(this.active=!0,!this._moveStartCoordinates)return;const i=this.chart.bars,{x:e,y:s}=this._mouse(t),n=e-this._moveStartPoint.x,o=s-this._moveStartPoint.y;let a,r;if(1===this.activePoint?(a=this._moveStartCoordinates.date1,r=this._moveStartCoordinates.price1):2===this.activePoint&&(a=this._moveStartCoordinates.date2,r=this._moveStartCoordinates.price2),!a||!r)return;let h=this.chart.state.indexToX(i.index(a)),c=this.valueToY(r);if(h+=n,c+=o,1===this.activePoint){let e=h,s=c;if(t.shiftKey){const{date2:t=0,price2:n=0}=this.settings.coordinates,o=this.chart.state.indexToX(i.index(t)),a=this.valueToY(n),r=$t(o,a,h,c);e=r.x,s=r.y}this.settings.setCoordinates({date1:i.time(this.chart.state.xToIndex(e)),price1:this.yToValue(s)})}else if(2===this.activePoint){let e=h,s=c;if(t.shiftKey){const{date1:t=0,price1:n=0}=this.settings.coordinates,o=this.chart.state.indexToX(i.index(t)),a=this.valueToY(n),r=$t(o,a,h,c);e=r.x,s=r.y}this.settings.setCoordinates({date2:i.time(this.chart.state.xToIndex(e)),price2:this.yToValue(s)})}this.draw()}}onLinePointerUp(){this.active=!1,this.activePoint=void 0,this.draw(),this.chart.app.stage.removeEventListener("pointermove",this.onLinePointerMove),this.chart.app.stage.removeEventListener("pointerup",this.onLinePointerUp)}}const fi=Ht();let wi=null;const mi=new Map;class Pi extends Ti{constructor(t,i=7e3,e){if(super(t,i,e),ft(this,T),ft(this,y),ft(this,g),wi)bi(wi);else{const t="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEgAAAAYCAYAAABZY7uwAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAAZdEVYdFNvZnR3YXJlAHBhaW50Lm5ldCA0LjAuMTczbp9jAAACPklEQVRYR+2YMUoEQRBFNTEw0MjUyEgwFiPBTBAzEwO9gqGRiXgBA0/gCbyBKBoYGYuRoGBkIhqI4y+p38xU9e7sdPfusrDBg+r61b+6mhl2dKaqqil9cIm9ne0qB+s36bhEbOguWL9JxyUwZBbWb9JxidjQXbB+oyJ2lhYWwT24q+UC9G00ESDydXGbWhjrK2bO0sY8uAZy5gfNNaBvo4kAsfgFUdO6YmvTY1DmwBUQjyewBFwdfUNAYsVdsH7qGR0wd216DMIsuASy/xWsgFhd8A0BiRV3wfqppx0wl9QLugCy9wOsaS4KfUNAIKYO4w5NqGldCVwvo8c4BbLvE2xqrif0DQGBmDqMOzShpnUlcL2MbjkCsucH7GquL/QNAYkVd8H6qec4L+gA/CqHmmuFviEgseIuWD/1HNcFydMiT43Un2luIOgbAgIxdRh3aEJN60rgehld2ALfgL3fwAaI1TroGwICMXUYd2hCTetK4HoZfR3IL5W8VvLkyPeO7JGf9uh3j4W+ISCx4i5YP/Uc5QWtgnfRwbHm5FKeNXeiub7QNwQkVtwF66eeo7qgZfCi+rnmyD6Q/GMt1xP6hoBATB3GHZpQ07oSuF5Yy1PCV0m+luWrub5nAYj2Vcv1hL4hIBBTh3GHJtS0rgSuF9bylzn75HJD39CAQMzC+qknG7v6RP79TA/5twX75HJL39CAQMzC+qknG7OuyNr2GQYuweapWD+hpjcGzF3bPsPAJdg8Fes36USTU0g18we6NPX4MiPMSwAAAABJRU5ErkJggg==",i=Et.from(t);wi=i,bi(wi),this.draw()}}_drawTrend(t,i,e,s,n){const{style:o}=this.settings;let a=i,r=s,h=e,c=n;const{extend:d}=o.line;if(d.left||d.right){if(d.left){const t=Nt(s,n,i,e),o=zt(5e3,t);a+=o.x,h+=o.y}if(d.right){const t=Nt(i,e,s,n),o=zt(5e3,t);r+=o.x,c+=o.y}}this._drawLineSegment(t,a,h,r,c,o.line.thickness,o.line.color,void 0,!0);const{tips:l}=o.line;if(l.left||l.right){if(l.left){const o=Nt(i,e,s,n);this._drawTip(t,o,i,e)}if(l.right){const o=Nt(s,n,i,e);this._drawTip(t,o,s,n)}}this._drawStatistics(i,e,s,n)}_drawStatistics(t,i,e,s){const{section:n,chart:o}=this,{colors:a}=o,{statistics:r}=this.settings.style;if(this._availableStatistics()){const o=10;let h=10;const c=this._createGraphics("statistics-mask");c.isMask=!0,c.x=Math.round(n.x),c.y=Math.round(n.y),c.beginFill(),c.drawRect(0,0,n.width+1,n.height),c.endFill(),this.container.addChild(c);const d=this._createGraphics("statistics-tooltip");let l,x;if(d.mask=c,this.container.addChild(d),r.range.price&&(this._drawStatisticsPrice(d,o,h),h+=20),(r.range.bars||r.range.date||r.distance)&&(mt(this,T,f).call(this,d,o,h,qt(t,i,e,s)),h+=20),r.angle&&(mt(this,T,w).call(this,d,o,h,Nt(t,i,e,s)),h+=20),d.lineStyle(1,a.chart.gridColor),d.beginFill(a.chart.backgroundColor,.75),d.drawRect(0,0,Math.max(Tt(this,y)||0,Tt(this,g)||0,180)+40,h+3),d.endFill(),0===r.position)l=t,x=i;else if(2===r.position){const n=Nt(t,i,e,s),o=qt(t,i,e,s),a=zt(.5*o,n);l=t+a.x,x=i+a.y}else l=e,x=s;d.x=Math.round(l)+10.5,d.y=n.y+Math.round(s>i?x-h-20:x+13)+.5}}_calcPrice2ForStatistic(){return this.settings.coordinates.price2??void 0}_drawStatisticsPrice(t,i=0,e=0){const{settings:s,section:n}=this,{coordinates:o,style:a}=s,r=Li("price");if(r){r.x=i+.5,r.y=e+.5,t.addChild(r);const{price1:s}=o,h=this._calcPrice2ForStatistic();if(!s||!h)return;const{digits:c}=n,d=Math.max(s,h),l=Math.min(s,h),x=Number(d-l).toFixed(c),p=Number(Number(x)*10**c).toFixed(0),u=`${x} (${Number(l/d*100).toFixed(2)}), ${p}`,v=this.createText(u);a.statistics.color&&(v.tint=a.statistics.color),v.x=i+r.width+4+.5,v.y=e-1+.5,t.addChild(v),Tt(this,g)&&!this.changed("price-width",u)||wt(this,g,v.textWidth)}}_drawTip(t,i,e,s){const{style:n}=this.settings,o=7*n.line.thickness,a=zt(o,i-30),r=zt(o,i+30);t.lineStyle(n.line.thickness,n.line.color),t.moveTo(e,s),t.lineTo(e+a.x,s+a.y),t.moveTo(e,s),t.lineTo(e+r.x,s+r.y)}_availableStatistics(){const{statistics:t}=this.settings.style;return!!(t.distance||t.angle||t.range.price||t.range.date||t.range.bars)&&(t.always||this.focused||this.active||t.always)}selectIfInArea(t,i){const e=this.chart.bars,{date1:s=0,date2:n=0,price1:o=0,price2:a=0}=this.settings.coordinates;if(!(s&&n&&o&&a))return!1;let r=this.chart.state.indexToX(e.index(s)),h=this.chart.state.indexToX(e.index(n)),c=this.valueToY(o),d=this.valueToY(a);if(this.settings.style.line.extend.left){const t=Nt(h,d,r,c),i=zt(5e3,t);r+=i.x,c+=i.y}if(this.settings.style.line.extend.right){const t=Nt(r,c,h,d),i=zt(5e3,t);h+=i.x,d+=i.y}const l={x1:r,x2:h,y1:c,y2:d},x={x1:this.chart.state.indexToX(e.index(i.date1??0)),x2:this.chart.state.indexToX(e.index(i.date2??0)),y1:this.valueToY(i.price1??0),y2:this.valueToY(i.price2??0)},p=Ct(x,l),u=Math.min(x.x1,x.x2)<Math.min(l.x1,l.x2)&&Math.max(x.x1,x.x2)>Math.max(l.x1,l.x2)&&Math.min(x.y1,x.y2)<Math.min(l.y1,l.y2)&&Math.max(x.y1,x.y2)>Math.max(l.y1,l.y2);return!(!p&&!u||(this.focused=!0,this.draw(),this.chart.objects.trigger("3006",{ctrlKey:t.ctrlKey,metaKey:t.metaKey,uid:this.settings.uid}),0))}}function bi(t){const i=Number(fi)+1,e=new Et(t.baseTexture,new Rt(0,0,12*i,12*i));mi.set("price",e);const s=new Et(t.baseTexture,new Rt(12*i,0,12*i,12*i));mi.set("date",s);const n=new Et(t.baseTexture,new Rt(24*i,0,12*i,12*i));mi.set("angle",n)}function Li(t){const i=mi.get(t);if(i){const t=new Bt(i);return fi&&(t.width=i.width/2,t.height=i.height/2),t}return null}y=new WeakMap,g=new WeakMap,T=new WeakSet,f=function(t,i=0,e=0,s=0){const{settings:n}=this,{coordinates:o,style:a}=n,{statistics:r}=a,h=this.chart.bars,c=Li("date");if(c){c.x=i+.5,c.y=e+.5;let{date1:n,date2:d}=o;if(!n||!d)return;const l=Ut(n,d);n=h.index(n),d=h.index(d);const x=Math.max(n,d),p=Math.min(n,d),u=Math.round(x-p);let v="";r.range.bars?(v=`${u} bars`,r.range.date&&l&&(v+=` (${l})`)):r.range.date&&(v+=`${l}`),r.distance&&(v&&(v+=", "),v+=`distance: ${s.toFixed(2)}`);const g=this.createText(v);g.tint=a.statistics.color,g.x=i+c.width+4+.5,g.y=e-1+.5,t.addChild(c,g),Tt(this,y)&&!this.changed("date-width",v)||wt(this,y,g.textWidth)}},w=function(t,i=0,e=0,s=0){const{style:n}=this.settings,o=Li("angle");if(o){o.x=i+.5,o.y=e+.5;const a=this.createText(`${s.toFixed(0)}Â°`);a.tint=n.statistics.color,a.x=i+o.width+4+.5,a.y=e-1+.5,t.addChild(o,a)}};class _i extends Pi{}class Mi extends Yt{constructor(t){super(t,{date1:0,date2:0,price1:0,price2:0},{line:{color:8432304,thickness:2,extend:{left:!1,right:!1},tips:{left:!1,right:!1}},statistics:{color:5603720,position:1,range:{price:!1,bars:!1,date:!1},distance:!1,angle:!1,always:!1}},18,1,0,!0)}}class Yi extends Pi{}class Si extends Yt{constructor(t){super(t,{date1:0,date2:0,price1:0,price2:0},{line:{color:8432304,thickness:2,extend:{left:!1,right:!1},tips:{left:!1,right:!0}},statistics:{color:5603720,position:1,range:{price:!1,bars:!1,date:!1},distance:!1,angle:!1,always:!1}},9,1,0,!0)}}class ki extends Mt{constructor(){super(...arguments),ft(this,b),ft(this,m,0),ft(this,P,0)}start(t){this.draw();const{settings:i,chart:e}=this,{state:s}=e,n=this.chart.bars,{x:o,y:a}=this._mouse(t),r=this.yToValue(a),h=n.time(s.xToIndex(o));return i.setCoordinates({price1:r,date1:h}),super.start(t),this}_drawObject(t){const{section:i,chart:e,settings:s}=this,{state:n}=e,{coordinates:o}=s,a=this.chart.bars,r=o.price1||0,h=o.date1||0;if(!h)return;const c=this.valueToY(r),d=n.indexToX(a.index(h));c<0||c>i.height||d<0||d>i.width||(mt(this,b,L).call(this),mt(this,b,_).call(this,t,r,c),mt(this,b,M).call(this,t,h,d),mt(this,b,Y).call(this,t,d,c))}selectIfInArea(t,i){const e=this.chart.bars,{date1:s=0,price1:n=0}=this.settings.coordinates,o={x1:this.chart.state.indexToX(e.index(i.date1??0)),x2:this.chart.state.indexToX(e.index(i.date2??0)),y1:this.valueToY(i.price1??0),y2:this.valueToY(i.price2??0)},a=this.chart.state.indexToX(e.index(s)),r=this.valueToY(n);return!(!Ft(o,void 0,r)&&!Ft(o,a,void 0)||(this.focused=!0,this.draw(),this.chart.objects.trigger("3006",{ctrlKey:t.ctrlKey,metaKey:t.metaKey,uid:this.settings.uid}),0))}}m=new WeakMap,P=new WeakMap,b=new WeakSet,L=function(){const{chart:t,settings:i}=this,{state:e}=t,{line:s}=i.style;if(s.price||s.time){const i=this._mask;null==i||i.clear(),null==i||i.beginFill(),null==i||i.drawRect(e.yAxisIsLeft?-e.yAxisWidth:0,0,s.price?t.app.screen.width:e.graphWidth,s.time?t.app.screen.height:e.graphHeight),null==i||i.endFill()}},_=function(t,i=0,e=0){const{chart:s,settings:n,section:o}=this,{state:a}=s,r=n.style.line,h=Gt()?16:8;if(t.beginFill(void 0,.01),t.drawRect(0,e-h/2,a.graphWidth+1,h),t.endFill(),t.beginFill(r.color),t.drawRect(0,e-Math.floor(r.thickness/2),a.graphWidth+1,r.thickness),t.endFill(),r.price){const s=this.createText(i.toFixed(o.digits));s.tint=this.chart.invert(r.color,!0);const n=a.yAxisIsLeft?a.yAxisWidth-2:a.yAxisWidth-1,h=a.yAxisIsLeft?1-n:a.graphX+a.graphWidth+1;if(s.y=Math.round(e-9),s.x=Math.round(h+5),a.yAxisIsLeft){let t=Tt(this,m);t&&!this.changed("priceWidth",i.toFixed().length,o.digits)||(wt(this,m,s.textWidth),t=Tt(this,m)),s.x=-t-8}t.beginFill(r.color),t.drawRect(h,e-10,n,18),t.endFill(),t.addChild(s)}},M=function(t,i,e){const{chart:s,settings:n}=this,{state:o,style:a}=s,r=n.style.line,h=Gt()?16:8;if(t.beginFill(void 0,.01),t.drawRect(e-h/2,o.graphY,h,o.graphHeight+1),t.endFill(),t.beginFill(r.color),t.drawRect(e-Math.floor(r.thickness/2),o.graphY,r.thickness,o.graphHeight+1),t.endFill(),r.time){const s=_t(i,"YY.MM.DD hhhh:mm"),n=this.createText(s);n.tint=this.chart.invert(r.color,!0);let h=Tt(this,P);h&&!this.changed("date",s)||(h=n.textWidth);const c=o.graphHeight+a.indent+1,d=100;n.y=Math.round(c),n.x=Math.round(e-.5*h),t.beginFill(r.color),t.drawRect(e-.5*d,c-1,d,18),t.endFill(),t.addChild(n)}},Y=function(t,i=0,e=0){const{hover:s,focused:n,active:o}=this;if(s||n||o){const s=St(this);s&&this._drawPoint(t,s,i,e)}};class Ci extends Mt{constructor(t,i=7e3,e){super(t,i,e),ft(this,k),ft(this,S,!1),this.onLinePointerDown=this.onLinePointerDown.bind(this),this.onLinePointerMove=this.onLinePointerMove.bind(this),this.onLinePointerUp=this.onLinePointerUp.bind(this)}start(t){var i;this.draw();const{settings:e,chart:s}=this,{state:n}=s,o=this.chart.bars,{x:a,y:r}=this._mouse(t),h=o.time(n.xToIndex(a)),c=this.yToValue(r);return e.setCoordinates({date1:h,date2:h,price1:c,price2:c,price3:c}),super.start(t),this.active=!0,this.activePoint=2,null==(i=this.chart.app.stage)||i.on("pointermove",this.onLinePointerMove).on("pointerup",this.onLinePointerUp),wt(this,S,!0),this}_drawObject(t,i){const{chart:e,settings:s}=this,{state:n}=e,{coordinates:o,style:a}=s,r=this.chart.bars,{date1:h,date2:c,price1:d,price2:l,price3:x}=o;if(!(h&&c&&d&&l&&x))return;const p=n.indexToX(r.index(h)),u=n.indexToX(r.index(c)),v=this.valueToY(d),y=this.valueToY(l),g=this.valueToY(x),T=Nt(p,v,u,y),f=qt(p,v,u,y),w=y-g,m=Tt(this,S);mt(this,k,C).call(this,t,i,p,v,u,y,w,T,f,m),mt(this,k,K).call(this,t,p,v,u,y,w,T,f,m),mt(this,k,U).call(this,t,p,v,u,y,w,T,f,m),a.prices.visible&&mt(this,k,X).call(this,t,p,v,u,y,w,T,f,m),t.off("pointerdown",this.onLinePointerDown).on("pointerdown",this.onLinePointerDown)}onLinePointerDown(t,i=!1){var e,s;const{chart:n,settings:o}=this,{state:a}=n,{coordinates:r}=o,h=this.chart.bars,{date1:c,date2:d,price1:l,price2:x,price3:p}=r;if(!(c&&d&&l&&x&&p))return;const u=a.indexToX(h.index(c)),v=a.indexToX(h.index(d)),y=this.valueToY(l),g=this.valueToY(x),T=Nt(u,y,v,g),f=qt(u,y,v,g),w=g-this.valueToY(p),{x3:m,y3:P,x4:b,y4:L}=Xi(v,g,w,f,T),{x:_,y:M}=this._mouse(t);i||qt(_,M,m,P)<7?this.activePoint=3:qt(_,M,b,L)<7?this.activePoint=4:qt(_,M,v,g)<7?this.activePoint=2:qt(_,M,u,y)<7&&(this.activePoint=1),null==(e=this.chart.app.stage)||e.off("pointermove",this.onLinePointerMove).off("pointerup",this.onLinePointerUp),this.activePoint&&(this._moveStartPoint={x:_,y:M},this._moveStartCoordinates=Lt(r),this.draw(),this.chart.objects.trigger("3006",{ctrlKey:t.ctrlKey,metaKey:t.metaKey,uid:this.settings.uid}),t.doubleClick||null==(s=this.chart.app.stage)||s.on("pointermove",this.onLinePointerMove).on("pointerup",this.onLinePointerUp))}onLinePointerMove(t){const{activePoint:i}=this;if(i){this.active=!0;const{settings:e,chart:s}=this,{state:n}=s,o=this.chart.bars,a=this._moveStartCoordinates;if(!(a&&a.date1&&a.date2&&a.price1&&a.price2&&a.price3))return;const r=this._moveStartPoint,{x:h,y:c}=this._mouse(t),d=h-r.x,l=c-r.y;if(1===i){let t=n.indexToX(o.index(a.date1)),i=this.valueToY(a.price1);t+=d,i+=l,e.setCoordinates({date1:o.time(n.xToIndex(t)),price1:this.yToValue(i)})}else if(2===i){let t=n.indexToX(o.index(a.date2)),i=this.valueToY(a.price2),s=this.valueToY(a.price3);t+=d,i+=l,s=Tt(this,S)?s+l:s-l,e.setCoordinates({date2:o.time(n.xToIndex(t)),price2:this.yToValue(i),price3:this.yToValue(s)})}else if(3===i){let t=this.valueToY(a.price3);t+=l,e.setCoordinates({price3:this.yToValue(t)})}else if(4===i){let t=n.indexToX(o.index(a.date1)),i=this.valueToY(a.price1);t+=d,i-=l,e.setCoordinates({date1:o.time(n.xToIndex(t)),price1:this.yToValue(i)})}this.draw()}}onLinePointerUp(t){var i;this.active=!1,this.activePoint=void 0,this.draw(),null==(i=this.chart.app.stage)||i.off("pointermove",this.onLinePointerMove).off("pointerup",this.onLinePointerUp),Tt(this,S)&&(wt(this,S,!1),this.onLinePointerDown(t,!0))}selectIfInArea(t,i){const e=this.chart.bars,{date1:s,date2:n,price1:o,price2:a,price3:r}=this.settings.coordinates;if(!(s&&n&&o&&a&&r))return!1;let h=this.chart.state.indexToX(e.index(s)),c=this.chart.state.indexToX(e.index(n)),d=this.valueToY(o),l=this.valueToY(a);const x=l-this.valueToY(r),p=Nt(h,d,c,l),u=qt(h,d,c,l);let v,{x3:y,y3:g,x4:T,y4:f}=Xi(c,l,x,u,p);this.settings.style.extend.left&&(v=zt(5e3,p+180),h+=v.x,d+=v.y,v=zt(5e3,180-p),T+=v.x,f+=v.y),this.settings.style.extend.right&&(v=zt(5e3,p),c+=v.x,l+=v.y,v=zt(5e3,-p),y+=v.x,g+=v.y);const w={x1:this.chart.state.indexToX(e.index(i.date1??0)),x2:this.chart.state.indexToX(e.index(i.date2??0)),y1:this.valueToY(i.price1??0),y2:this.valueToY(i.price2??0)},m=Kt(w,{x1:h,x2:c,x3:y,x4:T,y1:d,y2:l,y3:g,y4:f}),P=kt(w,{x1:h,x2:c,x3:y,x4:T,y1:d,y2:l,y3:g,y4:f}),b=Ct(w,{x1:h,x2:c,y1:d,y2:l}),L=Ct(w,{x1:c,x2:y,y1:l,y2:g}),_=Ct(w,{x1:y,x2:T,y1:g,y2:f}),M=Ct(w,{x1:T,x2:h,y1:f,y2:d});return!!(m||P||b||L||_||M)&&(this.focused=!0,this.draw(),this.chart.objects.trigger("3006",{ctrlKey:t.ctrlKey,metaKey:t.metaKey,uid:this.settings.uid}),!0)}}function Xi(t,i,e,s,n){const o=zt(s,n),a=i-e;return{x3:t,y3:a,x4:t-o.x,y4:a+o.y}}S=new WeakMap,k=new WeakSet,C=function(t,i,e,s,n,o,a,r,h,c){const{style:d}=this.settings,{lines:l,background:x,extend:p}=d;let u,v=e,y=s,g=n,T=o,{x3:f,y3:w,x4:m,y4:P}=Xi(g,T,a,h,r);if(p.left&&(u=zt(5e3,r+180),v+=u.x,y+=u.y,u=zt(5e3,180-r),m+=u.x,P+=u.y),p.right&&(u=zt(5e3,r),g+=u.x,T+=u.y,u=zt(5e3,-r),f+=u.x,w+=u.y),!c&&x.visible&&x.alpha){i.lineStyle(0);const t=Qt(v,y,g,T,f,w,m,P);t&&t.line1&&t.line2&&t.x&&t.y?(i.beginFill(x.color,x.alpha),i.moveTo(v,y),i.lineTo(t.x,t.y),i.lineTo(m,P),i.endFill(),i.beginFill(x.color,x.alpha),i.moveTo(g,T),i.lineTo(t.x,t.y),i.lineTo(f,w),i.endFill()):(i.beginFill(x.color,x.alpha),i.moveTo(v,y),i.lineTo(g,T),i.lineTo(f,w),i.lineTo(m,P),i.endFill())}t.lineStyle(l.thickness,l.color,l.alpha),t.moveTo(v,y),t.lineTo(g,T),c||(t.moveTo(f,w),t.lineTo(m,P),Xt(t,f,w,m,P)),Xt(t,v,y,g,T)},X=function(t,i,e,s,n,o,a,r,h){const{section:c,settings:d}=this,{prices:l}=d.style,{digits:x}=c,p=this.createText(this.yToValue(e).toFixed(x));p.x=i+6,p.y=e-10;const u=this.createText(this.yToValue(n).toFixed(x));if(u.x=s+6,u.y=n-10,l.color&&(p.tint=l.color,u.tint=l.color),t.addChild(p,u),!h){const{x3:i,y3:e,x4:h,y4:c}=Xi(s,n,o,r,a),d=this.createText(this.yToValue(e).toFixed(x));d.x=i+6,d.y=e-10;const p=this.createText(this.yToValue(c).toFixed(x));p.x=h+6,p.y=c-10,l.color&&(d.tint=l.color,p.tint=l.color),t.addChild(d,p)}},K=function(t,i,e,s,n,o,a,r,h){const{tips:c}=this.settings.style;if(c.left){const o=Nt(i,e,s,n);mt(this,k,I).call(this,t,o,i,e)}if(c.right){const o=Nt(s,n,i,e);mt(this,k,I).call(this,t,o,s,n)}if(!h){const{x3:i,y3:e,x4:h,y4:d}=Xi(s,n,o,r,a);if(c.left){const s=Nt(h,d,i,e);mt(this,k,I).call(this,t,s,h,d)}if(c.right){const s=Nt(i,e,h,d);mt(this,k,I).call(this,t,s,i,e)}}},I=function(t,i,e,s){const{style:n}=this.settings,o=7*n.lines.thickness,a=zt(o,i-30),r=zt(o,i+30);t.lineStyle(n.lines.thickness,n.lines.color),t.moveTo(e,s),t.lineTo(e+a.x,s+a.y),t.moveTo(e,s),t.lineTo(e+r.x,s+r.y)},U=function(t,i,e,s,n,o,a,r,h){const{hover:c,focused:d,active:l,activePoint:x}=this;if(c||d||l){const c=St(this);if(c){const{x3:d,y3:p,x4:u,y4:v}=Xi(s,n,o,r,a);l&&1===x||this._drawPoint(t,c,i,e),l&&2===x||this._drawPoint(t,c,s,n),h||(l&&3===x||this._drawPoint(t,c,d,p),l&&4===x||this._drawPoint(t,c,u,v))}}};class Ki extends Yt{constructor(t){super(t,{date1:0,date2:0,price1:0,price2:0,price3:0},{lines:{color:1220444,thickness:2,alpha:1},background:{visible:!0,color:6989903,alpha:.1},prices:{visible:!0,color:1220444},extend:{left:!1,right:!1},tips:{left:!1,right:!1}},20,1,0,!0)}}class Ii extends Pi{}class Ui extends Yt{constructor(t){super(t,{date1:0,date2:0,price1:0,price2:0},{line:{color:8432304,thickness:2,extend:{left:!0,right:!0},tips:{left:!1,right:!1}},statistics:{color:5603720,position:1,range:{price:!1,bars:!1,date:!1},distance:!1,angle:!1,always:!1}},11,1,0,!0);const{line:i}=this.style;i.extend.left=!0,i.extend.right=!0}}class Fi extends Mt{constructor(t,i=7e3,e){super(t,i,e),ft(this,V),ft(this,F),this.onLinePointerDown=this.onLinePointerDown.bind(this),this.onLinePointerMove=this.onLinePointerMove.bind(this),this.onLinePointerUp=this.onLinePointerUp.bind(this)}start(t){var i;this.draw();const{settings:e,chart:s}=this,{state:n}=s,o=this.chart.bars,{x:a,y:r}=this._mouse(t),h=o.time(n.xToIndex(a)),c=this.yToValue(r);return e.setCoordinates({date1:h,price1:c,date2:h,price2:c,price3:c}),super.start(t),this.active=!0,this.activePoint=2,null==(i=this.chart.app.stage)||i.on("pointermove",this.onLinePointerMove).on("pointerup",this.onLinePointerUp),wt(this,F,!0),this}_drawObject(t,i){const{chart:e,settings:s}=this,{state:n}=e,{coordinates:o,style:a}=s,r=this.chart.bars,{date1:h,date2:c,price1:d,price2:l,price3:x}=o;if(!(h&&c&&d&&l&&x))return;const p=n.indexToX(r.index(h)),u=n.indexToX(r.index(c)),v=this.valueToY(d),y=this.valueToY(l),g=this.valueToY(x),T=Tt(this,F);mt(this,V,D).call(this,t,i,p,v,u,y,g,T),mt(this,V,W).call(this,t,p,v,u,y,g,T),mt(this,V,E).call(this,t,p,v,u,y,g,T),a.prices.visible&&mt(this,V,A).call(this,t,p,v,u,y,g,T),t.off("pointerdown",this.onLinePointerDown).on("pointerdown",this.onLinePointerDown)}onLinePointerDown(t,i=!1){var e,s;const{chart:n,settings:o}=this,{state:a}=n,{coordinates:r}=o,h=this.chart.bars,{date1:c,date2:d,price1:l,price2:x,price3:p}=r;if(!(c&&d&&l&&x&&p))return;const u=a.indexToX(h.index(c)),v=a.indexToX(h.index(d)),y=this.valueToY(l),g=this.valueToY(x),T=this.valueToY(p),{x3:f,x4:w,y4:m}=Vi(u,0,v,0,T),{x:P,y:b}=this._mouse(t);i||qt(P,b,f,T)<7?this.activePoint=3:qt(P,b,w,m)<7?this.activePoint=4:qt(P,b,v,g)<7?this.activePoint=2:qt(P,b,u,y)<7&&(this.activePoint=1),null==(e=this.chart.app.stage)||e.off("pointermove",this.onLinePointerMove).off("pointerup",this.onLinePointerUp),this.activePoint&&(this._moveStartPoint={x:P,y:b},this._moveStartCoordinates=Lt(r),this.draw(),this.chart.objects.trigger("3006",{ctrlKey:t.ctrlKey,metaKey:t.metaKey,uid:this.settings.uid}),t.doubleClick||null==(s=this.chart.app.stage)||s.on("pointermove",this.onLinePointerMove).on("pointerup",this.onLinePointerUp))}onLinePointerMove(t){const{activePoint:i}=this;if(i){this.active=!0;const{settings:e,chart:s}=this,{state:n}=s,o=this.chart.bars,a=this._moveStartCoordinates;if(!a)return;const r=this._moveStartPoint,{x:h,y:c}=this._mouse(t),d=h-r.x,l=c-r.y;if(1===i){if(!a.date1||!a.price1)return;let t=n.indexToX(o.index(a.date1)),i=this.valueToY(a.price1);t+=d,i+=l,e.setCoordinates({date1:o.time(n.xToIndex(t)),price1:this.yToValue(i)})}else if(2===i){if(!a.date2||!a.price2||!a.price3)return;let t=n.indexToX(o.index(a.date2)),i=this.valueToY(a.price2),s=this.valueToY(a.price3);t+=d,i+=l,s+=l,e.setCoordinates({date2:o.time(n.xToIndex(t)),price2:this.yToValue(i)}),Tt(this,F)&&e.setCoordinates({price3:this.yToValue(s)})}else if(3===i){if(!a.price3)return;let t=this.valueToY(a.price3);t+=l,e.setCoordinates({price3:this.yToValue(t)})}else if(4===i){if(!a.date1)return;let t=n.indexToX(o.index(a.date1));t+=d,e.setCoordinates({date1:o.time(n.xToIndex(t))})}this.draw()}}onLinePointerUp(t){var i;this.active=!1,this.activePoint=void 0,this.draw(),null==(i=this.chart.app.stage)||i.off("pointermove",this.onLinePointerMove).off("pointerup",this.onLinePointerUp),Tt(this,F)&&(wt(this,F,!1),this.onLinePointerDown(t,!0))}selectIfInArea(t,i){const e=this.chart.bars,{date1:s,date2:n,price1:o,price2:a,price3:r}=this.settings.coordinates;if(!(s&&n&&o&&a&&r))return!1;let h=this.chart.state.indexToX(e.index(s)),c=this.chart.state.indexToX(e.index(n)),d=this.valueToY(o),l=this.valueToY(a);const x=this.valueToY(r);let{x3:p,x4:u}=Vi(h,0,c,0,x);const{y4:v}=Vi(h,0,c,0,x),y=Nt(h,d,c,l);if(this.settings.style.extend.left){const t=zt(5e3,y+180);h+=t.x,d+=t.y,u+=u<p?-5e3:5e3}if(this.settings.style.extend.right){const t=zt(5e3,y);c+=t.x,l+=t.y,p+=u<p?5e3:-5e3}const g={x1:this.chart.state.indexToX(e.index(i.date1??0)),x2:this.chart.state.indexToX(e.index(i.date2??0)),y1:this.valueToY(i.price1??0),y2:this.valueToY(i.price2??0)},T=Kt(g,{x1:h,x2:c,x3:p,x4:u,y1:d,y2:l,y3:x,y4:v}),f=kt(g,{x1:h,x2:c,x3:p,x4:u,y1:d,y2:l,y3:x,y4:v}),w=Ct(g,{x1:h,x2:c,y1:d,y2:l}),m=Ct(g,{x1:c,x2:p,y1:l,y2:x}),P=Ct(g,{x1:p,x2:u,y1:x,y2:v}),b=Ct(g,{x1:u,x2:h,y1:v,y2:d});return!!(T||f||w||m||P||b)&&(this.focused=!0,this.draw(),this.chart.objects.trigger("3006",{ctrlKey:t.ctrlKey,metaKey:t.metaKey,uid:this.settings.uid}),!0)}}function Vi(t,i,e,s,n){return{x3:e,y3:n,x4:t,y4:n}}F=new WeakMap,V=new WeakSet,D=function(t,i,e,s,n,o,a,r=!1){const{style:h}=this.settings,{lines:c,background:d,extend:l}=h;let x=e,p=s,u=n,v=o,{x3:y,x4:g}=Vi(x,0,u,0,a);const{y4:T}=Vi(x,0,u,0,a),f=Nt(x,p,u,v);let w;if(l.left&&(w=zt(5e3,f+180),x+=w.x,p+=w.y,g+=g<y?-5e3:5e3),l.right&&(w=zt(5e3,f),u+=w.x,v+=w.y,y+=g<y?5e3:-5e3),!r&&d.visible&&d.alpha){i.lineStyle(0);const t=Qt(x,p,u,v,y,a,g,T);t&&t.line1&&t.line2&&t.x&&t.y?(i.beginFill(d.color,d.alpha),i.moveTo(x,p),i.lineTo(t.x,t.y),i.lineTo(g,T),i.endFill(),i.beginFill(d.color,d.alpha),i.moveTo(u,v),i.lineTo(t.x,t.y),i.lineTo(y,a),i.endFill()):(i.beginFill(d.color,d.alpha),i.moveTo(x,p),i.lineTo(u,v),i.lineTo(y,a),i.lineTo(g,T),i.endFill())}t.lineStyle(c.thickness,c.color,c.alpha),t.moveTo(x,p),t.lineTo(u,v),r||(t.moveTo(y,a),t.lineTo(g,T),Xt(t,y,a,g,T)),Xt(t,x,p,u,v)},A=function(t,i,e,s,n,o,a=!1){const{section:r,settings:h}=this,{prices:c}=h.style,{digits:d}=r,l=this.createText(this.yToValue(e).toFixed(d));l.x=i+6,l.y=e-10;const x=this.createText(this.yToValue(n).toFixed(d));if(x.x=s+6,x.y=n-10,c.color&&(l.tint=c.color,x.tint=c.color),t.addChild(l,x),!a){const{x3:e,x4:n,y4:a}=Vi(i,0,s,0,o),r=this.createText(this.yToValue(o).toFixed(d));r.x=e+6,r.y=o-10;const h=this.createText(this.yToValue(a).toFixed(d));h.x=n+6,h.y=a-10,c.color&&(r.tint=c.color,h.tint=c.color),t.addChild(r,h)}},W=function(t,i,e,s,n,o,a=!1){const{tips:r}=this.settings.style;if(r.left){const o=Nt(i,e,s,n);mt(this,V,j).call(this,t,o,i,e)}if(r.right){const o=Nt(s,n,i,e);mt(this,V,j).call(this,t,o,s,n)}if(!a){const{x3:e,x4:n,y4:a}=Vi(i,0,s,0,o);if(r.left){const i=Nt(n,a,e,o);mt(this,V,j).call(this,t,i,n,a)}if(r.right){const i=Nt(e,o,n,a);mt(this,V,j).call(this,t,i,e,o)}}},j=function(t,i,e,s){const{style:n}=this.settings,o=7*n.lines.thickness,a=zt(o,i-30),r=zt(o,i+30);t.lineStyle(n.lines.thickness,n.lines.color),t.moveTo(e,s),t.lineTo(e+a.x,s+a.y),t.moveTo(e,s),t.lineTo(e+r.x,s+r.y)},E=function(t,i,e,s,n,o,a=!1){const{hover:r,focused:h,active:c,activePoint:d}=this;if(r||h||c){const r=St(this);if(r){const{x3:h,x4:l,y4:x}=Vi(i,0,s,0,o);c&&1===d||this._drawPoint(t,r,i,e),c&&2===d||this._drawPoint(t,r,s,n),a||(c&&3===d||this._drawPoint(t,r,h,o),c&&4===d||this._drawPoint(t,r,l,x))}}};class Di extends Yt{constructor(t){super(t,{date1:0,date2:0,price1:0,price2:0,price3:0},{lines:{color:4818407,thickness:2,alpha:1},background:{visible:!0,color:3432405,alpha:.1},prices:{visible:!0,color:4818407},extend:{left:!1,right:!1},tips:{left:!1,right:!1}},21,1,0,!0)}}class Ai extends Vt{_drawObject(t){const{section:i,chart:e}=this,{state:s}=e,n=this.chart.bars,{price1:o=0,date1:a}=this.settings.coordinates,r=this.valueToY(o),h="number"==typeof a,c=h?s.indexToX(n.index(a)):0;r<0||r>i.height||c>i.width||(this._drawMask(),this._drawLine(t,o,c,r),this._drawText(t,c,r),this._drawSelected(t,h?c:.5*s.graphWidth,r),t.off("pointerdown",this.onLinePointerDown).on("pointerdown",this.onLinePointerDown))}selectIfInArea(t,i){const{price1:e=0}=this.settings.coordinates,s={x1:0,x2:0,y1:this.valueToY(i.price1??0),y2:this.valueToY(i.price2??0)},n=this.valueToY(e);return!!Ft(s,void 0,n)&&(this.focused=!0,this.draw(),this.chart.objects.trigger("3006",{ctrlKey:t.ctrlKey,metaKey:t.metaKey,uid:this.settings.uid}),!0)}}class Wi extends Ai{selectIfInArea(t,i){const{date1:e,price1:s=0}=this.settings.coordinates;if(!e)return!1;const n=this.chart.bars,o={x1:this.chart.state.indexToX(n.index(i.date1??0)),x2:this.chart.state.indexToX(n.index(i.date2??0)),y1:this.valueToY(i.price1??0),y2:this.valueToY(i.price2??0)},a=this.chart.state.indexToX(n.index(e)),r=this.valueToY(s);return!(!(o.x1>=a||o.x2>=a)||!Ft(o,void 0,r)||(this.focused=!0,this.draw(),this.chart.objects.trigger("3006",{ctrlKey:t.ctrlKey,metaKey:t.metaKey,uid:this.settings.uid}),0))}}class ji extends Yt{constructor(t){super(t,{date1:0,price1:0},Dt(),12,1,0,!0)}}class Ei extends Pi{}class Ri extends Yt{constructor(t){super(t,{date1:0,date2:0,price1:0,price2:0},{line:{color:8432304,thickness:2,extend:{left:!1,right:!1},tips:{left:!1,right:!1}},statistics:{color:5603720,position:1,range:{price:!0,bars:!0,date:!0},distance:!0,angle:!0,always:!0}},14,1,0,!0)}}class Bi extends Pi{}class Oi extends Yt{constructor(t){super(t,{date1:0,date2:0,price1:0,price2:0},{line:{color:8432304,thickness:2,extend:{left:!1,right:!0},tips:{left:!1,right:!1}},statistics:{color:5603720,position:1,range:{price:!1,bars:!1,date:!1},distance:!1,angle:!1,always:!1}},15,1,0,!0)}}class Hi extends Pi{constructor(t,i=7e3,e){super(t,i,e),ft(this,R),this.onLinePointerDown=this.onLinePointerDown.bind(this),this.onLinePointerMove=this.onLinePointerMove.bind(this),this.onLinePointerUp=this.onLinePointerUp.bind(this)}start(t){var i;this.draw();const{settings:e,chart:s}=this,{state:n}=s,o=this.chart.bars,{x:a,y:r}=this._mouse(t),h=o.time(n.xToIndex(a)),c=this.yToValue(r);return e.setCoordinates({date1:h,price1:c,angle:0,distance:0}),this.active=!0,this.activePoint=2,null==(i=this.chart.app.stage)||i.on("pointermove",this.onLinePointerMove).on("pointerup",this.onLinePointerUp),this}_drawObject(t){const{chart:i,settings:e}=this,{state:s}=i,{coordinates:n,style:o}=e,a=this.chart.bars,{date1:r=0,price1:h=0,distance:c=0,angle:d=0}=n;if(!r||!h||!c)return;const l=s.indexToX(a.index(r));let x=l;const p=this.valueToY(h);let u=p,v=zt(c,-d);const y=l+v.x;let g=y;const T=p+v.y;let f=T;const{extend:w}=o.line;(w.left||w.right)&&(w.left&&(v=zt(5e3,180-d),x+=v.x,u+=v.y),w.right&&(v=zt(5e3,-d),g+=v.x,f+=v.y)),this._drawTrend(t,x,u,g,f),mt(this,R,B).call(this,t,l,p,-d);const{tips:m}=o.line;(m.left||m.right)&&(m.left&&this._drawTip(t,-d,l,p),m.right&&this._drawTip(t,180-d,y,T)),this._drawStatistics(l,p,y,T),this._drawSelected(t,l,p,y,T),t.off("pointerdown",this.onLinePointerDown).on("pointerdown",this.onLinePointerDown)}_availableStatistics(){const{statistics:t}=this.settings.style;return!(!t.distance&&!t.range.price)&&Boolean(t.always||this.focused||this.active||t.always)}onLinePointerDown(t){var i,e;const{chart:s,settings:n}=this,{state:o}=s,{coordinates:a}=n,r=this.chart.bars,{date1:h=0,price1:c=0,distance:d=0,angle:l=0}=a;if(!h||!c||!d)return;const x=o.indexToX(r.index(h)),p=this.valueToY(c),u=zt(d,-l),v=x+u.x,y=p+u.y,{x:g,y:T}=this._mouse(t);qt(g,T,v,y)<7&&(this.activePoint=2,this._moveStartPoint={x:v,y:y}),null==(i=this.chart.app.stage)||i.off("pointermove",this.onLinePointerMove).off("pointerup",this.onLinePointerUp),this.activePoint&&(this.draw(),this.chart.objects.trigger("3006",{ctrlKey:t.ctrlKey,metaKey:t.metaKey,uid:this.settings.uid}),t.doubleClick||null==(e=this.chart.app.stage)||e.on("pointermove",this.onLinePointerMove).on("pointerup",this.onLinePointerUp))}onLinePointerMove(t){const{activePoint:i}=this;if(i){this.active=!0;const{settings:i,chart:e}=this,{state:s}=e,n=this.chart.bars,{date1:o,price1:a}=i.coordinates;if(!o||!a)return;const r=s.indexToX(n.index(o)),h=this.valueToY(a),{x:c,y:d}=this._mouse(t),l=Math.round(Nt(r,h,c,d)),x=Math.round(qt(r,h,c,d));i.setCoordinates({angle:-l,distance:x}),this.draw()}}onLinePointerUp(){var t;this.active=!1,this.activePoint=void 0,this.draw(),null==(t=this.chart.app.stage)||t.off("pointermove",this.onLinePointerMove).off("pointerup",this.onLinePointerUp)}_calcPrice2ForStatistic(){const{price1:t=0,distance:i=0,angle:e=0}=this.settings.coordinates;if(i&&e)return this.yToValue(this.valueToY(t)+zt(i,e).y)}selectIfInArea(t,i){const e=this.chart.bars,{date1:s=0,price1:n=0,distance:o=0,angle:a=0}=this.settings.coordinates;if(!s||!n||!o)return!1;let r=this.chart.state.indexToX(e.index(s)),h=this.valueToY(n),c=zt(o,-a),d=r+c.x,l=h+c.y;return this.settings.style.line.extend.left&&(c=zt(5e3,180-a),r+=c.x,h+=c.y),this.settings.style.line.extend.right&&(c=zt(5e3,-a),d+=c.x,l+=c.y),!!Ct({x1:this.chart.state.indexToX(e.index(i.date1??0)),x2:this.chart.state.indexToX(e.index(i.date2??0)),y1:this.valueToY(i.price1??0),y2:this.valueToY(i.price2??0)},{x1:r,x2:d,y1:h,y2:l})&&(this.focused=!0,this.draw(),this.chart.objects.trigger("3006",{ctrlKey:t.ctrlKey,metaKey:t.metaKey,uid:this.settings.uid}),!0)}}R=new WeakSet,B=function(t,i,e,s){const{style:n}=this.settings,{color:o}=n.line;t.endFill(),t.lineStyle(1,o,.5),t.moveTo(i+.5,e+.5),s<0?(t.arc(i+.5,e+.5,50,Jt(s),0),t.lineTo(i+.5,e+.5)):t.arc(i+.5,e+.5,50,0,Jt(s));const a=this.createText(-s+"Â°");n.statistics.color&&(a.tint=n.statistics.color),a.x=i+55,a.y=e-10,t.addChild(a)};class Gi extends Yt{constructor(t){super(t,{date1:0,date2:0,price1:0,price2:0,angle:0,distance:0},{line:{color:8432304,thickness:2,extend:{left:!1,right:!1},tips:{left:!1,right:!1}},statistics:{color:5603720,position:1,range:{price:!1,bars:!1,date:!1},distance:!1,angle:!1,always:!1}},17,1,0,!0)}}class zi extends Mt{constructor(){super(...arguments),ft(this,H),ft(this,O,0)}start(t){this.draw();const{settings:i,chart:e}=this,{state:s}=e,n=this.chart.bars,{x:o}=this._mouse(t),a=n.time(s.xToIndex(o));return i.setCoordinates({date1:a}),super.start(t),this}_drawObject(t){const{section:i,settings:e,chart:s}=this,{state:n}=s,{coordinates:o}=e,a=this.chart.bars,{period:r}=s.bars,h=o.date1||0;if(!h)return;const c=Pt(h,r),d=n.indexToX(a.index(c,!0));d<0||d>i.width||(mt(this,H,G).call(this),mt(this,H,z).call(this,t,h,d),mt(this,H,q).call(this,t,d))}selectIfInArea(t,i){const e=this.chart.bars,{date1:s}=this.settings.coordinates,n={x1:this.chart.state.indexToX(e.index(i.date1??0)),x2:this.chart.state.indexToX(e.index(i.date2??0)),y1:0,y2:0},o=this.chart.state.indexToX(e.index(s??0));return!!Ft(n,o,void 0)&&(this.focused=!0,this.draw(),this.chart.objects.trigger("3006",{ctrlKey:t.ctrlKey,metaKey:t.metaKey,uid:this.settings.uid}),!0)}}O=new WeakMap,H=new WeakSet,G=function(){const{section:t,chart:i,settings:e}=this;if(e.style.line.time){const e=this._mask;null==e||e.clear(),null==e||e.beginFill(),null==e||e.drawRect(0,0,t.width,i.app.screen.height),null==e||e.endFill()}},z=function(t,i,e){const{chart:s,settings:n}=this,{state:o,style:a}=s,r=n.style.line,h=Gt()?16:8;if(t.beginFill(void 0,.01),t.drawRect(e-h/2,o.graphY,h,o.graphHeight+1),t.endFill(),t.beginFill(r.color),t.drawRect(e-Math.floor(r.thickness/2),o.graphY,r.thickness,o.graphHeight+1),t.endFill(),r.time){const s=_t(i,"YY.MM.DD hhhh:mm"),n=this.createText(s);n.tint=this.chart.invert(r.color,!0);let h=Tt(this,O);h&&!this.changed("date",s)||(h=n.textWidth);const c=o.graphHeight+a.indent+1,d=100;n.y=Math.round(c),n.x=Math.round(e-.5*h),t.beginFill(r.color),t.drawRect(e-.5*d,c-1,d,18),t.endFill(),t.addChild(n)}},q=function(t,i){const{state:e}=this.chart,{hover:s,focused:n,active:o}=this;if(s||n||o){const s=St(this);s&&this._drawPoint(t,s,i,.5*e.graphHeight)}};class qi extends Yt{constructor(t){super(t,{date1:0},{line:{color:8432304,thickness:2,time:!0}},19,1,1,!0)}}class Ni extends Pi{constructor(t,i=7e3,e){super(t,i,e),ft(this,N),this.onLinePointerDown=this.onLinePointerDown.bind(this),this.onLinePointerMove=this.onLinePointerMove.bind(this),this.onLinePointerUp=this.onLinePointerUp.bind(this)}start(t){var i;this.draw();const{settings:e,chart:s}=this,{state:n}=s,o=this.chart.bars,{x:a,y:r}=this._mouse(t),h=o.time(n.xToIndex(a)),c=this.yToValue(r);return e.setCoordinates({date1:h,price1:c,angle:0,pips:1}),super.start(t),this.active=!0,this.activePoint=2,null==(i=this.chart.app.stage)||i.on("pointermove",this.onLinePointerMove).on("pointerup",this.onLinePointerUp),this}_drawObject(t){const{chart:i,settings:e}=this,{state:s}=i,{coordinates:n,style:o}=e,a=this.chart.bars,{date1:r,price1:h,date2:c}=n,d=mt(this,N,J).call(this);if(!(r&&h&&c&&d))return;const l=s.indexToX(a.index(r)),x=s.indexToX(a.index(c)),p=this.valueToY(h),u=this.valueToY(d),v=Nt(l,p,x,u);let y=l,g=p,T=x,f=u;const{extend:w}=o.line;if(w.left||w.right){if(w.left){const t=zt(5e3,v+180);y+=t.x,g+=t.y}if(w.right){const t=zt(5e3,v);T+=t.x,f+=t.y}}this._drawTrend(t,y,g,T,f);const{tips:m}=o.line;(m.left||m.right)&&(m.left&&this._drawTip(t,v,l,p),m.right&&this._drawTip(t,v+180,x,u)),this._drawStatistics(l,p,x,u),this._drawSelected(t,l,p,x,u),t.off("pointerdown",this.onLinePointerDown).on("pointerdown",this.onLinePointerDown)}_drawSelected(t,i,e,s,n){super._drawSelected(t,i,e,s,n);const{hover:o,focused:a,active:r}=this;if(o||a||r){const o=St(this);if(o){const a=Zt(i,e,s,n);this._drawPoint(t,o,a.x,a.y,5)}}}_drawStatisticsPrice(t,i=0,e=0){const{coordinates:s}=this.settings,n=s.price2||mt(this,N,J).call(this);super._drawStatisticsPrice(t,i,e),n&&(s.price2=n)}onLinePointerDown(t){var i,e;const{chart:s,settings:n}=this,{state:o}=s,{coordinates:a}=n,r=this.chart.bars,{date1:h,price1:c,date2:d}=a,l=mt(this,N,J).call(this);if(!(h&&d&&c&&l))return;const x=o.indexToX(r.index(h)),p=this.valueToY(c),u=o.indexToX(r.index(d)),v=this.valueToY(l),{x:y,y:g}=this._mouse(t);qt(y,g,u,v)<7?this.activePoint=2:qt(y,g,x,p)<7&&(this.activePoint=1),null==(i=this.chart.app.stage)||i.off("pointermove",this.onLinePointerMove).off("pointerup",this.onLinePointerUp),this.activePoint&&(this._moveStartPoint={x:y,y:g},this._moveStartCoordinates={...a,price2:l},this.draw(),this.chart.objects.trigger("3006",{ctrlKey:t.ctrlKey,metaKey:t.metaKey,uid:this.settings.uid}),t.doubleClick||null==(e=this.chart.app.stage)||e.on("pointermove",this.onLinePointerMove).on("pointerup",this.onLinePointerUp))}onLinePointerMove(t){const{activePoint:i}=this;if(i){this.active=!0;const{settings:e,chart:s}=this,{state:n}=s,o=this.chart.bars,a=this._moveStartCoordinates;if(!a)return;const r=this._moveStartPoint,{x:h,y:c}=this._mouse(t),d=h-r.x,l=c-r.y;if(1===i){if(!(a.date1&&a.date2&&a.price1&&a.price2))return;let t=n.indexToX(o.index(a.date1)),i=this.valueToY(a.price1);if(t+=d,i+=l,o.time(n.xToIndex(t))<a.date2){e.setCoordinates({date1:o.time(n.xToIndex(t)),price1:this.yToValue(i)});const s=mt(this,N,Q).call(this,a.price2);e.setCoordinates({angle:s})}}else if(2===i){if(!a.date1||!a.date2||!a.price2)return;let t=n.indexToX(o.index(a.date2)),i=this.valueToY(a.price2);t+=d,i+=l;const s=mt(this,N,Q).call(this,this.yToValue(i));o.time(n.xToIndex(t))>a.date1&&e.setCoordinates({date2:o.time(n.xToIndex(t)),angle:s})}this.draw()}}onLinePointerUp(){var t;this.active=!1,this.activePoint=void 0,this.draw(),null==(t=this.chart.app.stage)||t.off("pointermove",this.onLinePointerMove).off("pointerup",this.onLinePointerUp)}}N=new WeakSet,Q=function(t){const{section:i,settings:e}=this,{date1:s,price1:n,date2:o,pips:a}=e.coordinates,r=this.chart.bars;if(s&&o&&n&&a){const e=r.index(o)-r.index(s);if(e>=1){let s=(t-n)*10**i.digits/e;return s*=100,s/=a,s<0?s-=.5:s+=.5,s}}},J=function(){const{section:t,settings:i}=this,{date1:e,price1:s,date2:n,pips:o}=i.coordinates;let{angle:a}=i.coordinates;const r=this.chart.bars;if(a&&e&&n&&s&&o){a>1e5&&(a=1e5),a<-1e5&&(a=-1e5);let i=r.index(n)-r.index(e);return i/=10**t.digits,s+i*a*o/100}};class Qi extends Yt{constructor(t){super(t,{date1:0,date2:0,price1:0,price2:0,angle:0,pips:1},{line:{color:8432304,thickness:2,extend:{left:!1,right:!1},tips:{left:!1,right:!1}},statistics:{color:5603720,position:1,range:{price:!1,bars:!1,date:!1},distance:!1,angle:!1,always:!1}},8,3,0,!0)}}class Ji extends Mt{constructor(t,i=7e3,e){super(t,i,e),this.active=!1,this.onLinePointerDown=this.onLinePointerDown.bind(this),this.onLinePointerMove=this.onLinePointerMove.bind(this),this.onLinePointerUp=this.onLinePointerUp.bind(this)}start(t){this.draw();const i=this.chart.bars;this.activePoint=1;const{x:e,y:s}=this._mouse(t),n=i.time(this.chart.state.xToIndex(e)),o=this.yToValue(s);return this.settings.setCoordinates({date1:n,date2:n,price1:o,price2:o}),super.start(t),this.active=!0,this.activePoint=2,this.chart.app.stage.on("pointermove",this.onLinePointerMove).on("pointerup",this.onLinePointerUp),this}_drawObject(t,i){const{date1:e,date2:s,price1:n,price2:o}=this.settings.coordinates;if(!(e&&s&&n&&o))return;const a=this.chart.bars,r=a.index(e,!0),h=a.index(s,!0),c=this.chart.state.indexToX(r),d=this.chart.state.indexToX(h),l=this.valueToY(n),x=this.valueToY(o);this._drawCircle(t,i,c,l,d,x),this._drawSelected(t,c,l,d,x),t.off("pointerdown",this.onLinePointerDown).on("pointerdown",this.onLinePointerDown)}_drawCircle(t,i,e,s,n,o){const{background:a,lines:r}=this.settings.style,h=Math.sqrt((n-e)**2+(o-s)**2);a.visible&&(i.beginFill(a.color,a.alpha),i.drawCircle(e,s,h),i.endFill());const c=this._createGraphics("circle");t.addChild(c),c.lineStyle(r.thickness,r.color),c.drawCircle(e,s,h),t.beginFill(void 0,.01),t.drawCircle(e,s,h+3),h>3&&(t.beginHole(),t.drawCircle(e,s,h-3),t.endHole()),t.endFill()}_drawSelected(t,i,e,s,n){if(this.hover||this.focused||this.active){const o=St(this);if(o){const a=this._createGraphics("points");t.addChild(a),this.active&&1===this.activePoint||this._drawPoint(a,o,i,e),this.active&&2===this.activePoint||this._drawPoint(a,o,s,n)}}}onLinePointerDown(t){const{date1:i,date2:e,price1:s,price2:n}=this.settings.coordinates;if(!(i&&e&&s&&n))return;const o=this.chart.bars,a=this.chart.state.indexToX(o.index(i,!0)),r=this.chart.state.indexToX(o.index(e,!0)),h=this.valueToY(s),c=this.valueToY(n),{x:d,y:l}=this._mouse(t);qt(d,l,a,h)<9?this.activePoint=1:qt(d,l,r,c)<9&&(this.activePoint=2),this.chart.app.stage.off("pointermove",this.onLinePointerMove).off("pointerup",this.onLinePointerUp),this.activePoint&&(this._moveStartPoint={x:d,y:l},this.draw(),this.chart.objects.trigger("3006",{ctrlKey:t.ctrlKey,metaKey:t.metaKey,uid:this.settings.uid}),t.doubleClick||this.chart.app.stage.on("pointermove",this.onLinePointerMove).on("pointerup",this.onLinePointerUp))}onLinePointerMove(t){if(this.activePoint){if(this.active=!0,!this._moveStartCoordinates)return;const{date1:i,price1:e,date2:s,price2:n}=this._moveStartCoordinates,{x:o,y:a}=this._mouse(t),r=o-this._moveStartPoint.x,h=a-this._moveStartPoint.y,c=this.chart.bars;if(1===this.activePoint&&i&&e&&s&&n){const t=this.chart.state.indexToX(c.index(i,!0))+r,o=this.valueToY(e)+h,a=this.chart.state.indexToX(c.index(s,!0))+r,d=this.valueToY(n)+h;this.settings.setCoordinates({date1:c.time(this.chart.state.xToIndex(t)),price1:this.yToValue(o),date2:c.time(this.chart.state.xToIndex(a)),price2:this.yToValue(d)})}else if(2===this.activePoint&&s&&n){const t=this.chart.state.indexToX(c.index(s,!0))+r,i=this.valueToY(n)+h;this.settings.setCoordinates({date2:c.time(this.chart.state.xToIndex(t)),price2:this.yToValue(i)})}this.draw()}}onLinePointerUp(){this.active=!1,this.activePoint=void 0,this.draw(),this.chart.app.stage.off("pointermove",this.onLinePointerMove).off("pointerup",this.onLinePointerUp)}selectIfInArea(t,i){const e=this.chart.bars,{date1:s=0,date2:n=0,price1:o=0,price2:a=0}=this.settings.coordinates,r={x1:this.chart.state.indexToX(e.index(s,!0)),x2:this.chart.state.indexToX(e.index(n,!0)),y1:this.valueToY(o),y2:this.valueToY(a)},h=Math.sqrt((r.x2-r.x1)**2+(r.y2-r.y1)**2),c={left:r.x1-h,right:r.x1+h,top:r.y1-h,bottom:r.y1+h},d={x1:r.x1,x2:r.x1,y1:c.top,y2:c.bottom},l={x1:c.left,x2:c.right,y1:r.y1,y2:r.y1},x={x1:this.chart.state.indexToX(e.index(i.date1??0)),x2:this.chart.state.indexToX(e.index(i.date2??0)),y1:this.valueToY(i.price1??0),y2:this.valueToY(i.price2??0)};return!!(Kt(x,{x1:c.left,y1:c.top,x2:c.right,y2:c.top,x3:c.right,y3:c.bottom,x4:c.left,y4:c.bottom})||Ct(x,d)||Ct(x,l)||$i(r,h,{x:x.x1,y:x.y1})||$i(r,h,{x:x.x1,y:x.y2})||$i(r,h,{x:x.x2,y:x.y1})||$i(r,h,{x:x.x2,y:x.y2}))&&(this.focused=!0,this.draw(),this.chart.objects.trigger("3006",{ctrlKey:t.ctrlKey,metaKey:t.metaKey,uid:this.settings.uid}),!0)}}function $i(t,i,e){return Math.sqrt((e.x-t.x1)**2+(e.y-t.y1)**2)<i}class Zi extends Yt{constructor(t){super(t,{date1:0,date2:0,price1:0,price2:0},{lines:{color:8432304,thickness:2,visible:!0,alpha:1},background:{visible:!0,color:11839446,alpha:.1}},24,6,0,!0)}}class te extends Mt{constructor(t,i=7e3,e){super(t,i,e),ft(this,$),this.active=!1,wt(this,$,!1),this.onLinePointerDown=this.onLinePointerDown.bind(this),this.onLinePointerMove=this.onLinePointerMove.bind(this),this.onLinePointerUp=this.onLinePointerUp.bind(this)}start(t){this.draw();const{x:i,y:e}=this._mouse(t),s=this.chart.bars.time(this.chart.state.xToIndex(i)),n=this.yToValue(e);return this.settings.setCoordinates({date1:s,price1:n,date2:s,price2:n,date3:s,price3:n,date4:s,price4:n,angle:0}),super.start(t),this.active=!0,this.activePoint=2,this.chart.app.stage.on("pointermove",this.onLinePointerMove).on("pointerup",this.onLinePointerUp),wt(this,$,!0),this}_drawObject(t,i){const{date1:e=0,price1:s=0,date2:n=0,price2:o=0,date3:a=0,price3:r=0,date4:h=0,price4:c=0,angle:d=0}=this.settings.coordinates;if(!(e&&n&&s&&o&&a&&r&&h&&c))return;const l=this.chart.bars,x=this.chart.state.indexToX(l.index(e,!0)),p=this.chart.state.indexToX(l.index(n,!0)),u=this.chart.state.indexToX(l.index(a,!0)),v=this.chart.state.indexToX(l.index(h,!0)),y=this.valueToY(s),g=this.valueToY(o),T=this.valueToY(r),f=this.valueToY(c);this._drawEllipse(t,i,x,y,p,g,u,T,v,f,d),this._drawSelected(t,x,y,p,g,u,T,v,f),t.off("pointerdown",this.onLinePointerDown).on("pointerdown",this.onLinePointerDown)}_drawEllipse(t,i,e,s,n,o,a,r,h,c,d){const{background:l,lines:x}=this.settings.style,p=Zt(e,s,n,o),u=qt(e,s,n,o),v=qt(a,r,h,c);if(!p.x||!p.y)return;l.visible&&(i.beginFill(l.color,l.alpha),i.drawEllipse(p.x,p.y,u/2,v/2),i.endFill(),i.x=p.x,i.y=p.y,i.pivot.x=p.x,i.pivot.y=p.y,i.transform.rotation=Jt(d));const y=this._createGraphics("ellipse"),g=this._createGraphics("ellipseInteractive");y.addChild(g),t.addChild(y),y.x=p.x,y.y=p.y,y.pivot.x=p.x,y.pivot.y=p.y,y.transform.rotation=Jt(d),y.lineStyle(x.thickness,x.color),y.drawEllipse(p.x,p.y,u/2,v/2),g.beginFill(void 0,.01),g.drawEllipse(p.x,p.y,u/2+1.5,v/2+1.5),u>3&&v>3&&(g.beginHole(),g.drawEllipse(p.x,p.y,u/2-1.5,v/2-1.5),g.endHole()),g.endFill()}_drawSelected(t,i,e,s,n,o,a,r,h){if(this.hover||this.focused||this.active){const c=St(this);if(c){const d=this._createGraphics("points");t.addChild(d),this.active&&1===this.activePoint||this._drawPoint(d,c,i,e),this.active&&2===this.activePoint||this._drawPoint(d,c,s,n),this.active&&3===this.activePoint||this._drawPoint(d,c,o,a),this.active&&4===this.activePoint||this._drawPoint(d,c,r,h)}}}onLinePointerDown(t,i=!1){var e;const{date1:s,price1:n,date2:o,price2:a,date3:r,price3:h,date4:c,price4:d}=this.settings.coordinates;if(!(s&&o&&n&&a&&r&&h&&c&&d))return;const l=this.chart.bars,x=this.chart.state.indexToX(l.index(s,!0)),p=this.chart.state.indexToX(l.index(o,!0)),u=this.chart.state.indexToX(l.index(r,!0)),v=this.chart.state.indexToX(l.index(c,!0)),y=this.valueToY(n),g=this.valueToY(a),T=this.valueToY(h),f=this.valueToY(d),{x:w,y:m}=this._mouse(t);i||qt(w,m,u,T)<9?this.activePoint=3:qt(w,m,x,y)<9?this.activePoint=1:qt(w,m,p,g)<9?this.activePoint=2:qt(w,m,v,f)<9&&(this.activePoint=4),this.chart.app.stage.off("pointermove",this.onLinePointerMove).off("pointerup",this.onLinePointerUp),this.activePoint&&(this._moveStartPoint={x:w,y:m},this._moveStartCoordinates=Lt(this.settings.coordinates),this.draw(),this.chart.objects.trigger("3006",{ctrlKey:t.ctrlKey,metaKey:t.metaKey,uid:this.settings.uid}),t.doubleClick||null==(e=this.chart.app.stage)||e.on("pointermove",this.onLinePointerMove).on("pointerup",this.onLinePointerUp))}onLinePointerMove(t){if(this.activePoint){if(!this._moveStartCoordinates)return;const{date1:i,price1:e,date2:s,price2:n,date3:o,price3:a,date4:r,price4:h}=this._moveStartCoordinates;if(!(i&&s&&e&&n&&o&&a&&r&&h))return;this.active=!0;const{x:c,y:d}=this._mouse(t),l=c-this._moveStartPoint.x,x=d-this._moveStartPoint.y,p=this.chart.bars;if(1===this.activePoint){const c=this.chart.state.indexToX(p.index(i,!0))+l,d=this.valueToY(e)+x,u=this.chart.state.indexToX(p.index(s,!0)),v=this.valueToY(n),y=this.chart.state.indexToX(p.index(o,!0)),g=this.valueToY(a),T=this.chart.state.indexToX(p.index(r,!0)),f=this.valueToY(h),w=Zt(c,d,u,v),m=qt(y,g,T,f)/2,P=Nt(w.x,w.y,c,d);let b,L,_,M;if(t.shiftKey){const t=qt(c,d,u,v)/2;b=w.x+t*Math.cos(Jt(-90+P)),L=w.y+t*Math.sin(Jt(-90+P)),_=w.x+t*Math.cos(Jt(90+P)),M=w.y+t*Math.sin(Jt(90+P))}else b=w.x+m*Math.cos(Jt(-90+P)),L=w.y+m*Math.sin(Jt(-90+P)),_=w.x+m*Math.cos(Jt(90+P)),M=w.y+m*Math.sin(Jt(90+P));this.settings.setCoordinates({date1:p.time(this.chart.state.xToIndex(c)),price1:this.yToValue(d),date3:p.time(this.chart.state.xToIndex(b)),price3:this.yToValue(L),date4:p.time(this.chart.state.xToIndex(_)),price4:this.yToValue(M),angle:P})}else if(2===this.activePoint){const c=this.chart.state.indexToX(p.index(i,!0)),d=this.valueToY(e),u=this.chart.state.indexToX(p.index(s,!0))+l,v=this.valueToY(n)+x,y=Zt(c,d,u,v),g=Nt(y.x,y.y,u,v);if(o===i&&a===e&&r===i&&h===e)this.settings.setCoordinates({date2:p.time(this.chart.state.xToIndex(u)),price2:this.yToValue(v),angle:g});else{const i=this.chart.state.indexToX(p.index(o,!0)),e=this.valueToY(a),s=this.chart.state.indexToX(p.index(r,!0)),n=this.valueToY(h),l=qt(i,e,s,n)/2;let x,T,f,w;if(t.shiftKey){const t=qt(c,d,u,v)/2;x=y.x+t*Math.cos(Jt(90+g)),T=y.y+t*Math.sin(Jt(90+g)),f=y.x+t*Math.cos(Jt(-90+g)),w=y.y+t*Math.sin(Jt(-90+g))}else x=y.x+l*Math.cos(Jt(90+g)),T=y.y+l*Math.sin(Jt(90+g)),f=y.x+l*Math.cos(Jt(-90+g)),w=y.y+l*Math.sin(Jt(-90+g));this.settings.setCoordinates({date2:p.time(this.chart.state.xToIndex(u)),price2:this.yToValue(v),date3:p.time(this.chart.state.xToIndex(x)),price3:this.yToValue(T),date4:p.time(this.chart.state.xToIndex(f)),price4:this.yToValue(w),angle:g})}}else if(3===this.activePoint){const t=this.chart.state.indexToX(p.index(i,!0)),l=this.valueToY(e),x=this.chart.state.indexToX(p.index(s,!0)),u=this.valueToY(n),v=Zt(t,l,x,u),{angle:y=0}=this.settings.coordinates,g=qt(v.x,v.y,c,d),T=Nt(v.x,v.y,c,d);let f;f=o===i&&a===e&&r===i&&h===e?g*Math.cos(Jt(90-T)):qt(v.x,v.y,c,d);const w=zt(f,90-y),m=v.x-w.x,P=v.y+w.y,b=v.x+w.x,L=v.y-w.y;this.settings.setCoordinates({date3:p.time(this.chart.state.xToIndex(m)),price3:this.yToValue(P),date4:p.time(this.chart.state.xToIndex(b)),price4:this.yToValue(L)})}else if(4===this.activePoint){const t=this.chart.state.indexToX(p.index(i,!0)),o=this.valueToY(e),a=this.chart.state.indexToX(p.index(s,!0)),r=this.valueToY(n),h=Zt(t,o,a,r),{angle:l=0}=this.settings.coordinates,x=qt(h.x,h.y,c,d),u=zt(x,90-l),v=h.x-u.x,y=h.y+u.y,g=h.x+u.x,T=h.y-u.y;this.settings.setCoordinates({date3:p.time(this.chart.state.xToIndex(v)),price3:this.yToValue(y),date4:p.time(this.chart.state.xToIndex(g)),price4:this.yToValue(T)})}this.draw()}}onLinePointerUp(t){this.active=!1,this.activePoint=void 0,this.draw(),this.chart.app.stage.off("pointermove",this.onLinePointerMove).off("pointerup",this.onLinePointerUp),Tt(this,$)&&(wt(this,$,!1),this.onLinePointerDown(t,!0))}selectIfInArea(t,i){const e=this.chart.bars,{date1:s=0,date2:n=0,date3:o=0,date4:a=0,price1:r=0,price2:h=0,price3:c=0,price4:d=0}=this.settings.coordinates,l={x1:this.chart.state.indexToX(e.index(s,!0)),x2:this.chart.state.indexToX(e.index(n,!0)),x3:this.chart.state.indexToX(e.index(o,!0)),x4:this.chart.state.indexToX(e.index(a,!0)),y1:this.valueToY(r),y2:this.valueToY(h),y3:this.valueToY(c),y4:this.valueToY(d)},x={left:Math.min(l.x1,l.x2,l.x3,l.x4),right:Math.max(l.x1,l.x2,l.x3,l.x4),top:Math.min(l.y1,l.y2,l.y3,l.y4),bottom:Math.max(l.y1,l.y2,l.y3,l.y4)},p={x1:l.x1,x2:l.x2,y1:l.y1,y2:l.y2},u={x1:l.x3,x2:l.x4,y1:l.y3,y2:l.y4},v={x1:this.chart.state.indexToX(e.index(i.date1??0)),x2:this.chart.state.indexToX(e.index(i.date2??0)),y1:this.valueToY(i.price1??0),y2:this.valueToY(i.price2??0)};return!!(Kt(v,{x1:x.left,y1:x.top,x2:x.right,y2:x.top,x3:x.right,y3:x.bottom,x4:x.left,y4:x.bottom})||Ct(v,p)||Ct(v,u))&&(this.focused=!0,this.draw(),this.chart.objects.trigger("3006",{ctrlKey:t.ctrlKey,metaKey:t.metaKey,uid:this.settings.uid}),!0)}}$=new WeakMap;class ie extends Yt{constructor(t){super(t,{date1:0,price1:0,date2:0,price2:0,date3:0,price3:0,date4:0,price4:0,angle:0},{lines:{color:8432304,thickness:2,visible:!0,alpha:1},background:{visible:!0,color:11839446,alpha:.1}},26,6,0,!0)}}class ee extends Mt{constructor(t,i=7e3,e){super(t,i,e),this.active=!1,this.onDown=this.onDown.bind(this),this.onMove=this.onMove.bind(this),this.onUp=this.onUp.bind(this)}start(t){this.draw();const i=this.chart.bars,{x:e,y:s}=this._mouse(t),n=i.time(this.chart.state.xToIndex(e)),o=this.yToValue(s);return this.settings.setCoordinates({date1:n,date2:n,price1:o,price2:o}),super.start(t),this.active=!0,this.activePoint=4,this.chart.app.stage.on("pointermove",this.onMove).on("pointerup",this.onUp),this}_drawObject(t,i){const{date1:e,date2:s,price1:n,price2:o}=this.settings.coordinates;if(!(e&&s&&n&&o))return;const a=this.chart.bars,r=a.index(e,!0),h=a.index(s,!0),c=this.chart.state.indexToX(r),d=this.chart.state.indexToX(h),l=this.valueToY(n),x=this.valueToY(o);this._drawRectangle(t,i,c,l,d,x),this._drawSelected(t,c,l,d,x),t.off("pointerdown",this.onDown).on("pointerdown",this.onDown)}_drawRectangle(t,i,e,s,n,o){const{background:a,lines:r,extend:h}=this.settings.style;let c=n>e?e:n;const d=o>s?s:o;let l=n>e?n-e:e-n;const x=o>s?o-s:s-o;let p=c+l;if(h.left||h.right){const t=zt(5e3,0);h.left&&(c-=t.x),h.right&&h.left?l=2*(l+t.x):l+=t.x,p=c+l}if(a.visible&&(i.beginFill(a.color,a.alpha),i.drawRect(c,d,l,x),i.endFill()),t.lineStyle(r.thickness,r.color),t.drawRect(c,d,l,x),!h.left){const i=Math.min(e,n);Xt(t,i,s,i,o)}if(!h.right){const i=Math.max(e,n);Xt(t,i,s,i,o)}Xt(t,c,s,p,s),Xt(t,c,o,p,o)}_drawSelected(t,i,e,s,n){if(this.hover||this.focused||this.active){const o=St(this);o&&(this._drawPoint(t,o,i,e,7,1===this.activePoint),this._drawPoint(t,o,i,n,7,2===this.activePoint),this._drawPoint(t,o,s,e,7,3===this.activePoint),this._drawPoint(t,o,s,n,7,4===this.activePoint),this._drawPoint(t,o,i,e+(n-e)/2,4,5===this.activePoint),this._drawPoint(t,o,s,e+(n-e)/2,4,6===this.activePoint),this._drawPoint(t,o,i+(s-i)/2,e,4,7===this.activePoint),this._drawPoint(t,o,i+(s-i)/2,n,4,8===this.activePoint))}}onDown(t){const{date1:i,date2:e,price1:s,price2:n}=this.settings.coordinates;if(!(i&&e&&s&&n))return;const o=this.chart.bars,a=this.chart.state.indexToX(o.index(i,!0)),r=this.chart.state.indexToX(o.index(e,!0)),h=this.valueToY(s),c=this.valueToY(n),{x:d,y:l}=this._mouse(t);qt(d,l,a,h)<9?this.activePoint=1:qt(d,l,a,c)<9?this.activePoint=2:qt(d,l,r,h)<9?this.activePoint=3:qt(d,l,r,c)<9?this.activePoint=4:qt(d,l,a,h+(c-h)/2)<9?this.activePoint=5:qt(d,l,r,h+(c-h)/2)<9?this.activePoint=6:qt(d,l,a+(r-a)/2,h)<9?this.activePoint=7:qt(d,l,a+(r-a)/2,c)<9&&(this.activePoint=8),this.chart.app.stage.off("pointermove",this.onMove).off("pointerup",this.onUp),this.activePoint&&(this._moveStartPoint={x:d,y:l},this.draw(),this.chart.objects.trigger("3006",{ctrlKey:t.ctrlKey,metaKey:t.metaKey,uid:this.settings.uid}),t.doubleClick||this.chart.app.stage.on("pointermove",this.onMove).on("pointerup",this.onUp))}onMove(t){if(this.activePoint){if(this.active=!0,!this._moveStartCoordinates)return;let i,e;if(1===this.activePoint?(i=this._moveStartCoordinates.date1,e=this._moveStartCoordinates.price1):2===this.activePoint?(i=this._moveStartCoordinates.date1,e=this._moveStartCoordinates.price2):3===this.activePoint?(i=this._moveStartCoordinates.date2,e=this._moveStartCoordinates.price1):4===this.activePoint?(i=this._moveStartCoordinates.date2,e=this._moveStartCoordinates.price2):5===this.activePoint?(i=this._moveStartCoordinates.date1,e=0):6===this.activePoint?(i=this._moveStartCoordinates.date2,e=0):7===this.activePoint?(i=0,e=this._moveStartCoordinates.price1):8===this.activePoint&&(i=0,e=this._moveStartCoordinates.price2),void 0===i||void 0===e)return;const{x:s,y:n}=this._mouse(t),o=s-this._moveStartPoint.x,a=n-this._moveStartPoint.y,r=this.chart.bars,h=this.chart.state.indexToX(r.index(i,!0))+o,c=this.valueToY(e)+a,d=r.time(this.chart.state.xToIndex(h)),l=this.yToValue(c),{date1:x=0,date2:p=0,price1:u=0,price2:v=0}=this.settings.coordinates;if(1===this.activePoint)if(t.shiftKey){const t=this.chart.state.indexToX(r.index(p,!0)),i=this.valueToY(v),e=qt(h,c,t,c),s=qt(h,c,h,i),n=Math.max(e,s),o=h<t?t-n:t+n,a=c<i?i-n:i+n;this.settings.setCoordinates({date1:r.time(this.chart.state.xToIndex(o)),price1:this.yToValue(a)})}else this.settings.setCoordinates({date1:d,price1:l});else if(2===this.activePoint)if(t.shiftKey){const t=this.chart.state.indexToX(r.index(p,!0)),i=this.valueToY(u),e=qt(h,c,t,c),s=qt(h,c,h,i),n=Math.max(e,s),o=h<t?t-n:t+n,a=c<i?i-n:i+n;this.settings.setCoordinates({date1:r.time(this.chart.state.xToIndex(o)),price2:this.yToValue(a)})}else this.settings.setCoordinates({date1:d,price2:l});else if(3===this.activePoint)if(t.shiftKey){const t=this.chart.state.indexToX(r.index(x,!0)),i=this.valueToY(v),e=qt(h,c,t,c),s=qt(h,c,h,i),n=Math.max(e,s),o=h<t?t-n:t+n,a=c<i?i-n:i+n;this.settings.setCoordinates({date2:r.time(this.chart.state.xToIndex(o)),price1:this.yToValue(a)})}else this.settings.setCoordinates({date2:d,price1:l});else if(4===this.activePoint)if(t.shiftKey){const t=this.chart.state.indexToX(r.index(x,!0)),i=this.valueToY(u),e=qt(h,c,t,c),s=qt(h,c,h,i),n=Math.max(e,s),o=h<t?t-n:t+n,a=c<i?i-n:i+n;this.settings.setCoordinates({date2:r.time(this.chart.state.xToIndex(o)),price2:this.yToValue(a)})}else this.settings.setCoordinates({date2:d,price2:l});else 5===this.activePoint?this.settings.setCoordinates({date1:d}):6===this.activePoint?this.settings.setCoordinates({date2:d}):7===this.activePoint?this.settings.setCoordinates({price1:l}):8===this.activePoint&&this.settings.setCoordinates({price2:l});this.draw()}}onUp(){this.active=!1,this.activePoint=void 0,this.draw(),this.chart.app.stage.off("pointermove",this.onMove).off("pointerup",this.onUp)}onPointerMoveObject(t){const i=this.container.getChildByName("object");if(!i)return;const{x:e,y:s}=this._mouse(t),n=this.chart.bars,{date1:o=0,date2:a=0,price1:r=0,price2:h=0}=this.settings.coordinates,c=this.chart.state.indexToX(n.index(Math.min(o,a),!0)),d=this.valueToY(Math.max(r,h)),l=this.chart.state.indexToX(n.index(Math.max(o,a),!0)),x=this.valueToY(Math.min(r,h)),p=Math.abs(e-c)<9,u=Math.abs(s-d)<9,v=Math.abs(e-l)<9,y=Math.abs(s-x)<9,g=p&&u,T=p&&y,f=v&&u,w=v&&y,m=c+(l-c)/2,P=d+(x-d)/2,b=Math.abs(e-m)<6,L=Math.abs(s-P)<6,_=p&&L,M=v&&L,Y=b&&u,S=b&&y;g||w?i.cursor="nwse-resize":T||f?i.cursor="nesw-resize":_||M||5===this.activePoint||6===this.activePoint?i.cursor="ew-resize":Y||S||7===this.activePoint||8===this.activePoint?i.cursor="ns-resize":i.cursor="pointer"}selectIfInArea(t,i){const e=this.chart.bars,{extend:s}=this.settings.style,{date1:n=0,date2:o=0,price1:a=0,price2:r=0}=this.settings.coordinates,h=this.chart.state.indexToX(e.index(n,!0)),c=this.chart.state.indexToX(e.index(o,!0)),d=this.valueToY(a),l=this.valueToY(r),x={x1:this.chart.state.indexToX(e.index(i.date1??0)),x2:this.chart.state.indexToX(e.index(i.date2??0)),y1:this.valueToY(i.price1??0),y2:this.valueToY(i.price2??0)},p=It(x,{x1:h,x2:c,y1:d,y2:l});let u=!1;if(!p&&(s.left||s.right)){let t=c>h?h:c,i=c>h?c-h:h-c,e=t+i;const n=zt(5e3,0);s.left&&(t-=n.x),s.right&&s.left?i=2*(i+n.x):i+=n.x,e=t+i,u=It(x,{x1:t,x2:e,y1:d,y2:l})}return!(!p&&!u||(this.focused=!0,this.draw(),this.chart.objects.trigger("3006",{ctrlKey:t.ctrlKey,metaKey:t.metaKey,uid:this.settings.uid}),0))}}class se extends Yt{constructor(t){super(t,{date1:0,price1:0,date2:0,price2:0},{lines:{color:8432304,thickness:2,visible:!0,alpha:1},background:{visible:!0,color:11839446,alpha:.1},extend:{left:!1,right:!1}},22,6,0,!0)}}class ne extends Mt{constructor(t,i=7e3,e){super(t,i,e),ft(this,Z),this.active=!1,wt(this,Z,!1),this.onLinePointerDown=this.onLinePointerDown.bind(this),this.onLinePointerMove=this.onLinePointerMove.bind(this),this.onLinePointerUp=this.onLinePointerUp.bind(this)}start(t){this.draw();const{x:i,y:e}=this._mouse(t),s=this.chart.bars.time(this.chart.state.xToIndex(i)),n=this.yToValue(e);return this.settings.setCoordinates({date1:s,date2:s,date3:s,price1:n,price2:n,price3:n}),super.start(t),this.active=!0,this.activePoint=2,this.chart.app.stage.on("pointermove",this.onLinePointerMove).on("pointerup",this.onLinePointerUp),wt(this,Z,!0),this}_drawObject(t,i){const{date1:e,date2:s,date3:n,price1:o,price2:a,price3:r}=this.settings.coordinates;if(!(e&&s&&o&&a&&n&&r))return;const h=this.chart.bars,c=h.index(e,!0),d=h.index(s,!0),l=h.index(n,!0),x=this.chart.state.indexToX(c),p=this.chart.state.indexToX(d),u=this.chart.state.indexToX(l),v=this.valueToY(o),y=this.valueToY(a),g=this.valueToY(r);this._drawTriangle(t,i,x,v,p,y,u,g,Tt(this,Z)),this._drawSelected(t,x,v,p,y,u,g),t.off("pointerdown",this.onLinePointerDown).on("pointerdown",this.onLinePointerDown)}_drawTriangle(t,i,e,s,n,o,a,r,h){const{background:c,lines:d}=this.settings.style;c.visible&&(i.beginFill(c.color,c.alpha),i.moveTo(e,s),i.lineTo(n,o),i.lineTo(a,r),i.endFill()),t.lineStyle(d.thickness,d.color),t.moveTo(e,s),t.lineTo(n,o),t.lineTo(a,r),t.lineTo(e,s),h||(Xt(t,e,s,n,o),Xt(t,n,o,a,r),Xt(t,a,r,e,s))}_drawSelected(t,i,e,s,n,o,a){if(this.hover||this.focused||this.active){const r=St(this);r&&(this.active&&1===this.activePoint||this._drawPoint(t,r,i,e),this.active&&2===this.activePoint||this._drawPoint(t,r,s,n),this.active&&3===this.activePoint||this._drawPoint(t,r,o,a))}}onLinePointerDown(t,i=!1){const{date1:e,date2:s,date3:n,price1:o,price2:a,price3:r}=this.settings.coordinates;if(!(e&&s&&n&&o&&a&&r))return;const h=this.chart.bars,c=this.chart.state.indexToX(h.index(e,!0)),d=this.chart.state.indexToX(h.index(s,!0)),l=this.chart.state.indexToX(h.index(n,!0)),x=this.valueToY(o),p=this.valueToY(a),u=this.valueToY(r),{x:v,y:y}=this._mouse(t);i||qt(v,y,l,u)<7?this.activePoint=3:qt(v,y,d,p)<7?this.activePoint=2:qt(v,y,c,x)<7&&(this.activePoint=1),this.chart.app.stage.off("pointermove",this.onLinePointerMove).off("pointerup",this.onLinePointerUp),this.activePoint&&(this._moveStartPoint={x:v,y:y},this._moveStartCoordinates=Lt(this.settings.coordinates),this.draw(),this.chart.objects.trigger("3006",{ctrlKey:t.ctrlKey,metaKey:t.metaKey,uid:this.settings.uid}),t.doubleClick||this.chart.app.stage.on("pointermove",this.onLinePointerMove).on("pointerup",this.onLinePointerUp))}onLinePointerMove(t){if(this.activePoint){if(!this._moveStartCoordinates)return;const{date1:i,date2:e,date3:s,price1:n,price2:o,price3:a}=this._moveStartCoordinates;if(!(i&&e&&s&&n&&o&&a))return;this.active=!0;const r=this.chart.bars,{x:h,y:c}=this._mouse(t),d=this._moveStartPoint,l=h-d.x,x=c-d.y;if(1===this.activePoint){let t=this.chart.state.indexToX(r.index(i,!0)),e=this.valueToY(n);t+=l,e+=x,this.settings.setCoordinates({date1:r.time(this.chart.state.xToIndex(t)),price1:this.yToValue(e)})}else if(2===this.activePoint){let t=this.chart.state.indexToX(r.index(e,!0)),i=this.valueToY(o);t+=l,i+=x,this.settings.setCoordinates({date2:r.time(this.chart.state.xToIndex(t)),price2:this.yToValue(i)})}else if(3===this.activePoint){let t=this.chart.state.indexToX(r.index(s,!0)),h=this.valueToY(a);i===s&&n===a&&(t=this.chart.state.indexToX(r.index(e,!0)),h=this.valueToY(o)),t+=l,h+=x,this.settings.setCoordinates({date3:r.time(this.chart.state.xToIndex(t)),price3:this.yToValue(h)})}this.draw()}}onLinePointerUp(t){this.active=!1,this.activePoint=void 0,this.draw(),this.chart.app.stage.off("pointermove",this.onLinePointerMove).off("pointerup",this.onLinePointerUp),Tt(this,Z)&&(wt(this,Z,!1),this.onLinePointerDown(t,!0))}selectIfInArea(t,i){const e=this.chart.bars,{date1:s=0,date2:n=0,date3:o=0,price1:a=0,price2:r=0,price3:h=0}=this.settings.coordinates,c={x1:this.chart.state.indexToX(e.index(s,!0)),x2:this.chart.state.indexToX(e.index(n,!0)),x3:this.chart.state.indexToX(e.index(o,!0)),y1:this.valueToY(a),y2:this.valueToY(r),y3:this.valueToY(h)},d={x1:this.chart.state.indexToX(e.index(i.date1??0)),x2:this.chart.state.indexToX(e.index(i.date2??0)),y1:this.valueToY(i.price1??0),y2:this.valueToY(i.price2??0)};return!!(Kt(d,c)||kt(d,c)||Ct(d,{x1:c.x1,y1:c.y1,x2:c.x2,y2:c.y2})||Ct(d,{x1:c.x2,y1:c.y2,x2:c.x3,y2:c.y3})||Ct(d,{x1:c.x3,y1:c.y3,x2:c.x1,y2:c.y1}))&&(this.focused=!0,this.draw(),this.chart.objects.trigger("3006",{ctrlKey:t.ctrlKey,metaKey:t.metaKey,uid:this.settings.uid}),!0)}}Z=new WeakMap;class oe extends Yt{constructor(t){super(t,{date1:0,price1:0,date2:0,price2:0,date3:0,price3:0},{lines:{color:8432304,thickness:2,visible:!0,alpha:1},background:{visible:!0,color:11839446,alpha:.1}},25,6,0,!0)}}const ae=15,re=10;class he extends Mt{constructor(t,i=7e3,e){super(t,i,e),this.width=0,this.onLinePointerDown=this.onLinePointerDown.bind(this),this.onLinePointerMove=this.onLinePointerMove.bind(this),this.onLinePointerUp=this.onLinePointerUp.bind(this),this.txt=new Ot(e.style.content,{fontFamily:this.chart.style.fontFamily,fontSize:e.style.fontSize,fill:e.style.color,align:ce(e.style.align),wordWrap:e.style.wordWrap,breakWords:e.style.wordWrap,wordWrapWidth:e.style.width,fontStyle:e.style.italic,fontWeight:e.style.bold})}start(t){this.draw();const{x:i,y:e}=this._mouse(t),s=this.chart.bars;return this.settings.setCoordinates({price1:this.yToValue(e),date1:s.time(this.chart.state.xToIndex(i))}),super.start(t),this}_drawObject(t){const i=this.chart.bars,{coordinates:{price1:e=0,date1:s=0},style:{wordWrap:n,width:o,height:a}}=this.settings,r=this.valueToY(e),h=this.chart.state.indexToX(i.index(s,!0)),c=n?o:this.txt.width+re,d=r-a-ae;h+c/2<0||h-c/2>this.section.width||r<0||d>this.section.height||(this.drawText(t,h,r),this.drawBorder(t,h,r),this.drawSelected(t,h,r),this.drawBackground(t,h,r),t.off("pointerdown",this.onLinePointerDown).on("pointerdown",this.onLinePointerDown))}drawBorder(t,i,e){const{border:s,width:n,height:o,wordWrap:a}=this.settings.style;if(s.visible){const r=a?n:this.txt.width+re;t.lineStyle(s.thickness,s.color),t.drawRect(i-r/2,e-o-ae,r,o)}}drawText(t,i,e){const{style:s}=this.settings,n=this.txt.height+re,o=s.wordWrap?s.width:this.txt.width+re,a=e-n-ae+5,r=ce(s.align);if(this.settings.style.height=n,this.txt.y!==a&&(this.txt.y=a),this.txt.text!==s.content&&(this.txt.text=s.content),this.txt.style.fill!==s.color&&(this.txt.style.fill=s.color),this.txt.style.fontSize!==s.fontSize&&(this.txt.style.fontSize=s.fontSize),this.txt.style.align!==r&&(this.txt.style.align=r),this.txt.style.fontStyle!==s.italic&&(this.txt.style.fontStyle=s.italic),this.txt.style.fontWeight!==s.bold&&(this.txt.style.fontWeight=s.bold),this.txt.style.wordWrapWidth!==o-re&&(this.txt.style.wordWrapWidth=o-re),this.txt.style.wordWrap!==s.wordWrap){const t=this.txt.width;if(s.wordWrap&&t+re>200&&s.width<200){const i=Math.min(Math.max(t/5,200),800);this.settings.style.width=i,this.txt.style.wordWrapWidth=i-re}this.txt.style.wordWrap=s.wordWrap,this.txt.style.breakWords=s.wordWrap}if(0===s.align){const t=i-o/2+5;this.txt.x!==t&&(this.txt.x=t),0!==this.txt.anchor.x&&(this.txt.anchor.x=0)}else if(2===s.align)this.txt.x!==i&&(this.txt.x=i),.5!==this.txt.anchor.x&&(this.txt.anchor.x=.5);else if(1===s.align){const t=i+o/2-5;this.txt.x!==t&&(this.txt.x=t),1!==this.txt.anchor.x&&(this.txt.anchor.x=1)}t.addChild(this.txt)}drawSelected(t,i,e){const{hover:s,focused:n,active:o}=this;if(s||n||o){const s=St(this);if(s){const{border:n,width:o,height:a,wordWrap:r}=this.settings.style;if(n.visible)t.lineStyle(n.thickness,n.color);else{const s=this.chart.colors.chart.object.text.defaultBorderColor,n=r?o:this.txt.width+re;t.lineStyle(1,s),t.drawRect(i-n/2,e-a-ae,n,a)}t.moveTo(i,e),t.lineTo(i,e-ae),this._drawPoint(t,s,i,e),2!==this.activePoint&&r&&this._drawPoint(t,s,i+o/2,e-a/2-ae,5)}}}drawBackground(t,i,e){const{background:s,width:n,height:o,wordWrap:a}=this.settings.style;if(s.visible){const r=a?n:this.txt.width+re;t.lineStyle(void 0),t.beginFill(s.color,s.alpha),t.drawRect(i-r/2,e-o-ae,r,o),t.endFill()}}onLinePointerDown(t){var i,e;const s=this.chart.bars,{date1:n,price1:o}=this.settings.coordinates;if(!o||!n)return;const a=this.chart.state.indexToX(s.index(n,!0)),r=this.valueToY(o),{x:h,y:c}=this._mouse(t),d=this.calcPoint2Position(a,r);qt(h,c,a,r)<9?this.activePoint=1:qt(h,c,d.x,d.y)<9&&(this.activePoint=2,this.width=this.settings.style.width),null==(i=this.chart.app.stage)||i.off("pointermove",this.onLinePointerMove).off("pointerup",this.onLinePointerUp),this.activePoint&&(this._moveStartPoint={x:h,y:c},this.draw(),this.chart.objects.trigger("3006",{ctrlKey:t.ctrlKey,metaKey:t.metaKey,uid:this.settings.uid}),t.doubleClick||null==(e=this.chart.app.stage)||e.on("pointermove",this.onLinePointerMove).on("pointerup",this.onLinePointerUp))}onLinePointerMove(t){if(this.activePoint){if(this.active=!0,!this._moveStartCoordinates)return;const{date1:i,price1:e}=this._moveStartCoordinates,{x:s,y:n}=this._mouse(t),o=s-this._moveStartPoint.x,a=n-this._moveStartPoint.y,r=this.chart.bars;if(1===this.activePoint&&i&&e){const t=this.chart.state.indexToX(r.index(i,!0))+o,s=this.valueToY(e)+a;this.settings.setCoordinates({date1:r.time(this.chart.state.xToIndex(t)),price1:this.yToValue(s)})}if(2===this.activePoint&&i&&e&&this.settings.style.wordWrap){const t=this.width+o;t>50&&(this.settings.style.width=t)}this.draw()}}onLinePointerUp(){var t;this.active=!1,this.activePoint=void 0,this.draw(),null==(t=this.chart.app.stage)||t.off("pointermove",this.onLinePointerMove).off("pointerup",this.onLinePointerUp)}selectIfInArea(t,i){const{date1:e,price1:s}=this.settings.coordinates;if(!e||!s)return!1;const n=this.chart.bars,o=this.chart.state.indexToX(n.index(e,!0)),a=this.valueToY(s),r={x1:this.chart.state.indexToX(n.index(i.date1??0)),x2:this.chart.state.indexToX(n.index(i.date2??0)),y1:this.valueToY(i.price1??0),y2:this.valueToY(i.price2??0)},{wordWrap:h,width:c,height:d}=this.settings.style,l=h?c:this.txt.width+re,x={x1:o-l/2,x2:o+l/2,y1:a-ae,y2:a-ae-d},p=Ft(r,o,a),u=Ct(r,{x1:o,x2:o,y1:a,y2:a-ae}),v=It(r,x);return!!(p||u||v)&&(this.focused=!0,this.draw(),this.chart.objects.trigger("3006",{ctrlKey:t.ctrlKey,metaKey:t.metaKey,uid:this.settings.uid}),!0)}calcPoint2Position(t,i){const{width:e,height:s}=this.settings.style;return{x:t+e/2,y:i-s/2-ae}}}function ce(t){switch(t){case 1:return"right";case 2:return"center";default:return"left"}}class de extends Yt{constructor(t){super(t,{price1:0,date1:0},{color:6262678,fontSize:12,content:"Text",align:0,width:100,height:30,bold:"normal",italic:"normal",wordWrap:!1,background:{visible:!1,color:6262678,alpha:.1},border:{visible:!1,color:6262678,alpha:.1,thickness:1}},27,8,0,!0)}}class le extends Ti{constructor(t,i=7e3,e,s=!1){super(t,i,e),ft(this,tt,!1),s&&(wt(this,tt,s),this.settings.firstCreation=!1,this.settings.history=!1)}start(t){return super.start(t),Tt(this,tt)&&(this.chart.showRulerCrosshair=!1),this}_drawObject(t,i){const{date1:e,date2:s,price1:n,price2:o}=this.settings.coordinates;if(!(e&&s&&n&&o))return;const a=this.chart.bars,r=this.chart.state.indexToX(a.index(e)),h=this.chart.state.indexToX(a.index(s)),c=this.valueToY(n),d=this.valueToY(o);this._drawBackground(i,r,c,h,d),this._drawLine(t,r,c,h,d),this._drawPoints(t,r,c,h,d),this._drawTooltip(i,h,d),t.removeEventListener("pointerdown",this.onLinePointerDown),t.addEventListener("pointerdown",this.onLinePointerDown)}_drawBackground(t,i,e,s,n){const{background:o}=this.settings.style,a=n>e?o.colorDown:o.colorUp,r=s>i?i:s,h=n>e?e:n,c=s>i?s-i:i-s,d=n>e?n-e:e-n;o.visible&&(t.beginFill(a,o.alpha),t.drawRect(r,h,c,d),t.endFill())}_drawLine(t,i,e,s,n){const{lines:o}=this.settings.style,a=n>e?o.colorDown:o.colorUp;t.lineStyle(o.thickness,a,o.alpha),t.moveTo(i,e),t.lineTo(s,n),Xt(t,i,e,s,n)}_drawPoints(t,i,e,s,n){const{lines:o}=this.settings.style;let a=St(this);if(a){const r=Zt(i,e,s,n);a={...a,borderColor:n>e?o.colorDown:o.colorUp},this._drawPoint(t,a,i,e,4),this._drawPoint(t,a,s,n,4),this._drawPoint(t,a,r.x,r.y,4)}}_drawTooltip(t,i,e){const{date1:s,date2:n,price1:o,price2:a}=this.settings.coordinates;if(!(s&&n&&o&&a))return;const{bgColor:r,textColor:h,alpha:c,borderRadius:d,padding:l,margin:x}=this.settings.style.tooltip,{digits:p}=this.section,u=this.chart.bars,v=Math.max(o,a),y=Math.min(o,a),g=a>o?1:-1,T=Number(v-y).toFixed(p),f=Number((100-y/v*100)*g).toFixed(2),w=Ut(s,n),m=u.index(s),P=u.index(n),b=Math.max(m,P),L=Math.min(m,P),_=`${T} (${f}%) \r\n${Math.round(b-L)} bars (${w})`,M=this.createText(_);M.tint!==h&&(M.tint=h);const Y=M.width+l,S=Math.max(M.height,32)+l;let k,C;n>s?(k=i+x,i+x+Y>this.section.width&&(k=i-x-Y)):(k=i-x-Y,i-x-Y<0&&(k=i+x)),a>o?(C=e-x-S,e-x-S<0&&(C=e+x)):(C=e+x,e+x+S>this.section.height&&(C=e-x-S)),M.x=k+l/2,M.y=C+l/2,t.lineStyle(0),t.beginFill(r,c),t.drawRoundedRect(k,C,Y,S,d),t.endFill(),t.addChild(M)}selectIfInArea(t,i){const e=this.chart.bars,{date1:s,date2:n,price1:o,price2:a}=this.settings.coordinates;if(!(s&&n&&o&&a))return!1;const r={x1:this.chart.state.indexToX(e.index(s)),x2:this.chart.state.indexToX(e.index(n)),y1:this.valueToY(o),y2:this.valueToY(a)},h={x1:this.chart.state.indexToX(e.index(i.date1??0)),x2:this.chart.state.indexToX(e.index(i.date2??0)),y1:this.valueToY(i.price1??0),y2:this.valueToY(i.price2??0)},c=Ct(h,r),d=Math.min(h.x1,h.x2)<Math.min(r.x1,r.x2)&&Math.max(h.x1,h.x2)>Math.max(r.x1,r.x2)&&Math.min(h.y1,h.y2)<Math.min(r.y1,r.y2)&&Math.max(h.y1,h.y2)>Math.max(r.y1,r.y2);return!(!c&&!d||(this.focused=!0,this.draw(),this.chart.objects.trigger("3006",{ctrlKey:t.ctrlKey,metaKey:t.metaKey,uid:this.settings.uid}),0))}onLinePointerMove(t){if(this.activePoint){if(this.active=!0,!this._moveStartCoordinates)return;const i=this.chart.bars,{x:e,y:s}=this._mouse(t),n=e-this._moveStartPoint.x,o=s-this._moveStartPoint.y;let a,r;if(1===this.activePoint?(a=this._moveStartCoordinates.date1,r=this._moveStartCoordinates.price1):2===this.activePoint&&(a=this._moveStartCoordinates.date2,r=this._moveStartCoordinates.price2),!a||!r)return;let h=this.chart.state.indexToX(i.index(a)),c=this.valueToY(r);if(h+=n,c+=o,1===this.activePoint){let e=h,s=c;if(t.shiftKey&&!Tt(this,tt)){const{date2:t=0,price2:n=0}=this.settings.coordinates,o=this.chart.state.indexToX(i.index(t)),a=this.valueToY(n),r=$t(o,a,h,c);e=r.x,s=r.y}this.settings.setCoordinates({date1:i.time(this.chart.state.xToIndex(e)),price1:this.yToValue(s)})}else if(2===this.activePoint){let e=h,s=c;if(t.shiftKey&&!Tt(this,tt)){const{date1:t=0,price1:n=0}=this.settings.coordinates,o=this.chart.state.indexToX(i.index(t)),a=this.valueToY(n),r=$t(o,a,h,c);e=r.x,s=r.y}this.settings.setCoordinates({date2:i.time(this.chart.state.xToIndex(e)),price2:this.yToValue(s)})}this.draw()}}onLinePointerUp(){super.onLinePointerUp(),Tt(this,tt)&&this.chart.objects.remove("ruler")}}tt=new WeakMap;class xe extends Yt{constructor(t){super(t,{date1:0,date2:0,price1:0,price2:0},{lines:{colorUp:3245055,colorDown:15354956,thickness:1,visible:!0,alpha:1},background:{colorUp:3245055,colorDown:15354956,alpha:.1,visible:!0},tooltip:{bgColor:5263968,textColor:16777215,alpha:1,visible:!0,borderRadius:5,padding:10,margin:10}},28,1,0,!1)}}it=new WeakMap,et=new WeakMap,st=new WeakSet,nt=function(){this.data.forEach((t=>{t.destroy()})),this.off("3005",Tt(this,ht)),this.off("3002",Tt(this,ct)),this.off("3003",Tt(this,dt)),this.off("3006",Tt(this,at)),this.off("3004",Tt(this,rt)),this.off("3001",Tt(this,lt)),this.off("700",Tt(this,vt)),this.data=[],wt(this,it,{})},ot=function(){wt(this,it,{}),this.data.forEach(((t,i)=>{Tt(this,it)[t.settings.uid]=i}))},at=new WeakMap,rt=new WeakMap,ht=new WeakMap,ct=new WeakMap,dt=new WeakMap,lt=new WeakMap,xt=new WeakMap,pt=function(t){const i=Tt(this,it)[t],e=this.data[i];if(!e)return!1;const{type:s,style:n}=e.settings;return(19===s||10===s)&&n.line.time},ut=function(t,i){let e=t.parent&&this.chart.sections.getByIndicatorUid(t.parent)||void 0;if(i&&!(1&t.flags)){const{x:s,y:n}=i.data.global;e=this.chart.sections.getByCoordinate(s,n),e&&(e.collapsed()?e=void 0:e.indicator&&(t.parent=e.indicator.settings.uid))}return this.chart.createOptions(e)},vt=new WeakMap;const pe=Object.freeze(Object.defineProperty({__proto__:null,AndrewsPitchforkChannel:ei,AndrewsPitchforkChannelSettings:ni,ArrowLine:Yi,ArrowLineSettings:Si,BaseObject:Mt,Circle:Ji,CircleSettings:Zi,CrossLine:ki,CrossLineSettings:Wt,DisjointAngle:Ci,DisjointAngleSettings:Ki,Ellipse:te,EllipseSettings:ie,EquidistantChannel:oi,EquidistantChannelSettings:ai,ExtendedLine:Ii,ExtendedLineSettings:Ui,FibonacciRetracement:li,FibonacciRetracementSettings:xi,FlatTopBottom:Fi,FlatTopBottomSettings:Di,Gann:pi,GannFan:ui,GannFanSettings:vi,GannGrid:yi,GannGridSettings:gi,GannLine:Ni,GannLineSettings:Qi,Horizontal:Vt,HorizontalLine:Ai,HorizontalLineSettings:At,HorizontalRay:Wi,HorizontalRaySettings:ji,InfoLine:Ei,InfoLineSettings:Ri,ObjectManager:class extends bt{constructor(){super(...arguments),ft(this,st),ft(this,it),ft(this,et),ft(this,at),ft(this,rt),ft(this,ht),ft(this,ct),ft(this,dt),ft(this,lt),ft(this,xt),ft(this,vt),this.inited=!1,this.data=[],wt(this,it,{}),wt(this,at,(t=>{const{detail:i}=t;this.trigger("301",{uid:i.uid,ctrlKey:i.ctrlKey,metaKey:i.metaKey,hideSelectedDate:mt(this,st,pt).call(this,i.uid)})})),wt(this,rt,(t=>{const{detail:i}=t;this.trigger("302",i)})),wt(this,ht,(t=>{const{detail:i}=t;this.trigger("303",{uid:i.uid,bar:i.bar,date:i.date,price:i.price,hideSelectedDate:mt(this,st,pt).call(this,i.uid)})})),wt(this,ct,(t=>{const{detail:i}=t;this.trigger("304",i)})),wt(this,dt,(t=>{const{detail:i}=t;this.trigger("305",i),this.trigger("208",i.uid)})),wt(this,lt,(t=>{this.edit(t.detail.uid)})),wt(this,xt,(t=>{const i=t.detail.uid;this.get(i)})),wt(this,vt,(t=>{if(!Tt(this,et))return;const{detail:{event:i}}=t,{coordinates:e}=Tt(this,et).settings;this.data.forEach((t=>{t.settings.lock||t.chart.locked||t.selectIfInArea(i,e)}))}))}get(t){const i=Tt(this,it)[t];return this.data[i]}init(t=[]){this.inited=!1,mt(this,st,nt).call(this),this.on("3005",Tt(this,ht)),this.on("3002",Tt(this,ct)),this.on("3003",Tt(this,dt)),this.on("3006",Tt(this,at)),this.on("3004",Tt(this,rt)),this.on("3001",Tt(this,lt)),this.on("3007",Tt(this,xt)),this.on("700",Tt(this,vt)),this.inited=!0,t.map((t=>this.add(t.type,void 0,t,!0)))}add(t,i,e,s=!1){if(!this.inited)return null;let n,o;switch(t){case 1:n=new ni(e),o=new ei(mt(this,st,ut).call(this,n,i),7e3,n);break;case 2:n=new ai(e),o=new oi(mt(this,st,ut).call(this,n,i),7e3,n);break;case 3:case 4:n=new di(e),o=new ci(mt(this,st,ut).call(this,n,i),7e3,n);break;case 5:n=new xi(e),o=new li(mt(this,st,ut).call(this,n,i),7e3,n);break;case 6:n=new vi(e),o=new ui(mt(this,st,ut).call(this,n,i),7e3,n);break;case 7:n=new gi(e),o=new yi(mt(this,st,ut).call(this,n,i),7e3,n);break;case 8:n=new Qi(e),o=new Ni(mt(this,st,ut).call(this,n,i),7e3,n);break;case 9:n=new Si(e),o=new Yi(mt(this,st,ut).call(this,n,i),7e3,n);break;case 10:n=new Wt(e),o=new ki(mt(this,st,ut).call(this,n,i),7e3,n);break;case 20:n=new Ki(e),o=new Ci(mt(this,st,ut).call(this,n,i),7e3,n);break;case 11:n=new Ui(e),o=new Ii(mt(this,st,ut).call(this,n,i),7e3,n);break;case 21:n=new Di(e),o=new Fi(mt(this,st,ut).call(this,n,i),7e3,n);break;case 13:n=new At(e),o=new Ai(mt(this,st,ut).call(this,n,i),7e3,n);break;case 12:n=new ji(e),o=new Wi(mt(this,st,ut).call(this,n,i),7e3,n);break;case 14:n=new Ri(e),o=new Ei(mt(this,st,ut).call(this,n,i),7e3,n);break;case 15:n=new Oi(e),o=new Bi(mt(this,st,ut).call(this,n,i),7e3,n);break;case 18:n=new Mi(e),o=new _i(mt(this,st,ut).call(this,n,i),7e3,n);break;case 17:n=new Gi(e),o=new Hi(mt(this,st,ut).call(this,n,i),7e3,n);break;case 19:n=new qi(e),o=new zi(mt(this,st,ut).call(this,n,i),7e3,n);break;case 22:n=new se(e),o=new ee(mt(this,st,ut).call(this,n,i),7e3,n);break;case 24:n=new Zi(e),o=new Ji(mt(this,st,ut).call(this,n,i),7e3,n);break;case 25:n=new oe(e),o=new ne(mt(this,st,ut).call(this,n,i),7e3,n);break;case 26:n=new ie(e),o=new te(mt(this,st,ut).call(this,n,i),7e3,n);break;case 27:n=new de(e),o=new he(mt(this,st,ut).call(this,n,i),7e3,n);break;case 28:case 33:n=new xe({...e,uid:"ruler"}),o=new le(mt(this,st,ut).call(this,n,i),7e3,n,33===t);break;default:return null}const a=this.data.length;return this.data.push(o),Tt(this,it)[o.settings.uid]=a,this.trigger("201",n.uid),s&&33!==t||this.trigger("208",n.uid),o}setVisible(t,i){const e=Tt(this,it)[t],s=this.data[e];s&&(s.settings.setVisible(i),this.trigger("208",t))}blurByParentUid(t){this.data.forEach((i=>{i.settings.parent===t&&i.blur()}))}setLock(t,i){const e=Tt(this,it)[t],s=this.data[e];s&&(s.settings.lock=i,s.focused?s.blur():s.draw(),this.trigger("208",t))}create(t,i){const e=this.add(t,i);e&&e.start(i)}remove(t){if(!this.inited)return;const i=Tt(this,it)[t];this.data[i].destroy(),this.data.splice(i,1),mt(this,st,ot).call(this),this.trigger("202",t)}removeByParentUid(t){return this.data.forEach((i=>{i.settings.parent===t&&this.remove(i.settings.uid)})),this}destroy(){mt(this,st,nt).call(this),super.destroy()}selectAreaStart(t){if(!Tt(this,et)){const t=new ii({uid:"select_area",type:23}),i=mt(this,st,ut).call(this,t);wt(this,et,new ti(i,7e3,t))}const i=this.chart.sections.getByCoordinate(t.global.x,t.global.y);i&&i.uid!==Tt(this,et).section.uid&&Tt(this,et).setSection(i),Tt(this,et).start(t)}},ObjectSettings:Yt,RayLine:Bi,RayLineSettings:Oi,Rectangle:ee,RectangleSettings:se,RegressionChannel:ci,RegressionChannelBase:ri,RegressionChannelSettings:di,StdDevChannel:class extends ri{_before(){super._before();const{settings:t}=this,{coordinates:i}=t,e=this.chart.bars,{date1:s,date2:n,deviations:o}=i;if(!s||!n||!o)return;this.dataValue1=0,this.dataValue2=0,this.dataMax=0;const{index1:a,index2:r}=this.getBarsIndex(s,n),h=r-a+1;let c=0,d=0,l=0,x=0;for(let T=0;T<h;T++){const t=e.close(a+T)||0;c+=t,l+=t*T,d+=T,x+=T*T}const p=(l*h-d*c)/(x*h-d*d)||0,u=(c-d*p)/h||0;this.dataValue1=u,this.dataValue2=u+p*(h-1);const v=c/h;let y=0,g=0;for(let T=0;T<h;T++)g=(e.close(a+T)||0)-v,y+=g*g;g=y/h,y=Math.sqrt(g)*o,this.dataMax=y}},Text:he,TextSettings:de,TrendAngle:Hi,TrendAngleSettings:Gi,TrendLine:_i,TrendLineBase:Pi,TrendLineSettings:Mi,Triangle:ne,TriangleSettings:oe,VerticalLine:zi,VerticalLineSettings:qi,defaultCoordinates:()=>({date1:0,date2:0,deviations:2}),defaultStyle:()=>({base:{visible:!0,color:16711680,thickness:1,alpha:.35},up:{visible:!0,color:255,thickness:1,alpha:.35},down:{visible:!0,color:255,thickness:1,alpha:.35},extend:{left:!1,right:!1},pearson:{visible:!0},background:{visible:!0,alpha:.1}}),defaultStyleHorizontalLine:Dt,defaultTrendStyle:()=>({line:{color:8432304,thickness:2,extend:{left:!1,right:!1},tips:{left:!1,right:!1}},statistics:{color:5603720,position:1,range:{price:!1,bars:!1,date:!1},distance:!1,angle:!1,always:!1}}),getBorderStyle:St,getDateDifferent:Ut,increaseHitArea:Xt,lineIntersectsLine:jt,rectCircumscribedShape:Kt,rectInscribedCoordinate:Ft,rectInscribedObject:kt,rectIntersectsLine:Ct,rectIntersectsRect:It},Symbol.toStringTag,{value:"Module"}));export{pe as o};
