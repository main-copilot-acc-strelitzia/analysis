import{_ as t,ag as e,ah as i,ai as s,aj as r}from"./HcGwWu0z.js";import{l as a}from"./BAEQURWy.js";import"./d_ed_6Ut.js";!function(e,i,s,r,a,o,n){var c,l,h,_,d,u,p,m,g,y,f,b,v,w,k,T,M,S,z,B,C,W,I,L,O,x,A,P,E,$,N,D,q,F,R,V,U,H,X,j,G,Y,K,J,Z,Q,tt,et,it,st,rt,at,ot,nt,ct,lt,ht,_t,dt,ut,pt,mt,gt,yt,ft,bt,vt,wt,kt,Tt,Mt,St,zt,Bt,Ct,Wt,It,Lt,Ot,xt,At,Pt,Et,$t,Nt,Dt,qt,Ft,Rt,Vt,Ut,Ht,Xt,jt,Gt,Yt,Kt,Jt,Zt,Qt,te,ee,ie,se,re,ae,oe,ne,ce,le,he,_e,de,ue,pe,me,ge,ye,fe,be,ve,we,ke,Te,Me,Se,ze,Be,Ce,We,Ie,Le,Oe,xe,Ae,Pe,Ee,$e,Ne,De,qe,Fe,Re,Ve,Ue,He,Xe,je,Ge,Ye,Ke,Je,Ze,Qe,ti,ei,ii,si,ri,ai,oi,ni,ci,li,hi,_i,di,ui,pi,mi,gi,yi,fi,bi,vi,wi,ki,Ti,Mi,Si,zi,Bi,Ci,Wi,Ii,Li,Oi,xi,Ai,Pi,Ei,$i,Ni,Di,qi,Fi,Ri,Vi,Ui,Hi,Xi,ji,Gi,Yi,Ki,Ji,Zi,Qi,ts,es,is,ss,rs,as,os,ns,cs,ls,hs,_s,ds,us,ps,ms,gs,ys,fs,bs,vs,ws,ks,Ts,Ms,Ss,zs,Bs,Cs,Ws,Is,Ls,Os,xs,As,Ps,Es,$s,Ns,Ds,qs,Fs,Rs,Vs,Us,Hs,Xs,js,Gs,Ys,Ks,Js,Zs,Qs,tr,er,ir,sr,rr,ar,or,nr,cr,lr,hr,_r,dr,ur,pr,mr,gr,yr,fr,br,vr,wr,kr,Tr,Mr,Sr,zr,Br,Cr,Wr,Ir,Lr,Or,xr,Ar,Pr,Er,$r,Nr,Dr,qr,Fr,Rr,Vr,Ur,Hr,Xr,jr,Gr,Yr,Kr,Jr,Zr,Qr,ta,ea,ia,sa,ra,aa,oa,na,ca,la,ha,_a,da,ua,pa,ma,ga,ya,fa,ba,va,wa,ka,Ta,Ma,Sa,za,Ba,Ca,Wa,Ia,La,Oa,xa,Aa,Pa,Ea,$a,Na,Da,qa,Fa,Ra,Va,Ua,Ha,Xa,ja,Ga,Ya,Ka,Ja,Za,Qa,to,eo,io,so,ro,ao,oo,no,co,lo,ho,_o,uo,po,mo,go,yo,fo,bo,vo,wo,ko,To,Mo,So,zo,Bo,Co,Wo,Io,Lo,Oo,xo,Ao,Po,Eo,$o,No,Do,qo,Fo,Ro,Vo,Uo,Ho,Xo,jo,Go,Yo,Ko,Jo,Zo,Qo,tn,en,sn,rn,an,on,nn,cn,ln,hn,_n,dn,un,pn,mn,gn,yn,fn,bn,vn,wn,kn,Tn,Mn,Sn,zn,Bn,Cn,Wn,In,Ln,On,xn,An,Pn,En,$n,Nn,Dn,qn,Fn,Rn,Vn,Un,Hn,Xn,jn,Gn,Yn,Kn,Jn,Zn,Qn,tc,ec,ic,sc,rc,ac,oc,nc,cc,lc,hc,_c,dc,uc,pc,mc=t=>{throw TypeError(t)},gc=(t,e,i)=>e.has(t)||mc("Cannot "+i),yc=(t,e,i)=>(gc(t,e,"read from private field"),i?i.call(t):e.get(t)),fc=(t,e,i)=>e.has(t)?mc("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(t):e.set(t,i),bc=(t,e,i,s)=>(gc(t,e,"write to private field"),e.set(t,i),i),vc=(t,e,i)=>(gc(t,e,"access private method"),i),wc=(t,e,i,s)=>({set _(i){bc(t,e,i)},get _(){return yc(t,e,s)}});class kc{constructor(t,e){fc(this,c),fc(this,l),fc(this,h),fc(this,_),bc(this,c,!1),this.start=0,this.command=t,this.buffer=e,this.promise=new Promise(((t,e)=>{bc(this,l,t),bc(this,h,e)})),this.promise.request=this}resolvePromise(t){!yc(this,c)&&yc(this,l)&&(bc(this,c,!0),yc(this,l).call(this,t),this.stopTimeout())}rejectPromise(t){!yc(this,c)&&yc(this,h)&&(bc(this,c,!0),yc(this,h).call(this,t),this.stopTimeout())}onTimeout(t){return bc(this,_,globalThis.setTimeout((()=>{t(this)}),3e4)),this}stopTimeout(){return globalThis.clearTimeout(yc(this,_)),bc(this,c,!0),bc(this,_,void 0),bc(this,l,void 0),bc(this,h,void 0),this}}c=new WeakMap,l=new WeakMap,h=new WeakMap,_=new WeakMap;const Tc="close",Mc="error",Sc="open",zc=[0,2,3,4,5,6,7,8,9,10,11,12,13,14,15,17,18,19,20,21,22,23,24,25,27,28,29,30,33,34,37,39,40,41,42,43,44,50,51,52,100,101,102,103,104,105,106,107,108,109,110,111,112],Bc=new Set(zc);d=new WeakMap,u=new WeakMap,p=new WeakMap,m=new WeakMap,g=new WeakMap,y=new WeakMap,f=new WeakMap,b=new WeakMap,v=new WeakMap,w=new WeakMap,k=new WeakMap,T=new WeakMap,M=new WeakMap,S=new WeakMap,z=new WeakMap,B=new WeakSet,C=async function(t){const e=yc(this,p).command(0,t),s=await i.enc(e,yc(this,u));try{const t=await vc(this,B,L).call(this,0,s,!0,!1);if(0!==t.resCode)throw new Error(JSON.stringify([0,t.resCode]));bc(this,d,t.resBody.slice(2,66)),bc(this,u,await i.initKey(t.resBody.slice(66)))}catch(r){throw r}},W=function(t,e){const i=yc(this,w).get(t);i&&i.forEach((t=>{t(e)}))},I=function(){return bc(this,g,new Map),bc(this,y,new Map),bc(this,f,new Map),zc.forEach((t=>{const e=Number(t);isNaN(e)||(yc(this,y).set(e,new Set),yc(this,f).set(e,[]))})),this},L=function(t,e,i,s){var r;if(!this.isReady&&0!==t){const e=new Error(JSON.stringify([t,103]));return vc(this,B,W).call(this,Mc,e),Promise.reject(new Error(e.message))}const a=new kc(t,yc(this,p).pack(t,e));if(i&&a.onTimeout((t=>vc(this,B,E).call(this,t))),s){const e=yc(this,f).get(t);null==e||e.forEach((e=>{e.rejectPromise(new Error(JSON.stringify([t,1e4])))})),yc(this,f).set(t,[a])}else null==(r=yc(this,f).get(t))||r.push(a);return vc(this,B,x).call(this,t),a.promise},O=function(t){yc(this,g).set(t.command,t),yc(this,m).send(t.buffer)},x=function(t){const e=yc(this,f).get(t);if(e&&e.length&&!yc(this,g).get(t)){const t=e.shift();t&&vc(this,B,O).call(this,t)}},A=function(t,e){const i=yc(this,y).get(t);return i&&i.forEach((t=>{t.call(this,e)})),this},P=new WeakMap,E=function(t){t.rejectPromise(new Error(JSON.stringify([t.command,408]))),yc(this,g).delete(t.command),vc(this,B,x).call(this,t.command)};let Cc=class t{constructor(t,e={}){fc(this,B),fc(this,d),fc(this,u),fc(this,p),fc(this,m),fc(this,g),fc(this,y),fc(this,f),fc(this,b),fc(this,v),fc(this,w),fc(this,k),fc(this,T),fc(this,M),fc(this,S),fc(this,z),fc(this,P),this.isReady=!1,bc(this,g,new Map),bc(this,y,new Map),bc(this,f,new Map),bc(this,w,new Map),bc(this,k,0),bc(this,T,(t=>{yc(this,b)&&yc(this,b).call(this,new Error(JSON.stringify([-1,104])))})),bc(this,M,(()=>{vc(this,B,W).call(this,Sc),yc(this,v)&&yc(this,v).call(this,this)})),bc(this,S,(t=>{const e=t.data.slice(yc(this,p).HEADER_BYTE_LENGTH);e.byteLength&&i.dec(e,yc(this,u)).then(Ic).then(yc(this,P))})),bc(this,z,(t=>{yc(this,f).forEach((t=>{t.forEach((t=>t.stopTimeout()))})),bc(this,f,new Map),yc(this,g).forEach((t=>{t.stopTimeout()})),bc(this,g,new Map),this.isReady=!1,vc(this,B,W).call(this,Tc,{count:yc(this,k),token:yc(this,d),event:t}),vc(this,B,I).call(this)})),bc(this,P,(t=>{const{resCommand:e,resCode:i,resBody:s}=t;i>0&&vc(this,B,W).call(this,Mc,new Error(JSON.stringify([i,e])));const r=yc(this,g).get(e);r&&(r.resolvePromise({resCode:i,resBody:s}),r&&8!==r.command&&Wc(r.command),yc(this,g).delete(e)),vc(this,B,x).call(this,e),vc(this,B,A).call(this,e,{resCode:i,resBody:s})})),bc(this,p,t),bc(this,d,e.token??new ArrayBuffer(64)),bc(this,k,e.count??0),bc(this,g,e.requests??yc(this,g)),bc(this,y,e.listeners??yc(this,y)),bc(this,f,e.queues??yc(this,f)),bc(this,w,e.systemListeners??yc(this,w)),vc(this,B,I).call(this)}get readyState(){var t;return null==(t=yc(this,m))?void 0:t.readyState}recreateSocket(){return new t(yc(this,p),{requests:yc(this,g),listeners:yc(this,y),queues:yc(this,f),systemListeners:yc(this,w),token:yc(this,d),count:yc(this,k)+1})}async connectToServer(t){this.isReady=!1,bc(this,u,await i.initKey(s.hexToBuffer(s.obfuscation("13ef13b2b76dd8:5795gdcfb2fdc1ge85bf768f54773d22fff996e3ge75g5:75"))));const e=new Promise(((e,i)=>{bc(this,b,i),bc(this,v,e),bc(this,m,new WebSocket(t)),yc(this,m).binaryType="arraybuffer",yc(this,m).addEventListener("message",yc(this,S)),yc(this,m).addEventListener("close",yc(this,z),{once:!0}),yc(this,m).addEventListener("error",yc(this,T),{once:!0}),yc(this,m).addEventListener("open",yc(this,M),{once:!0}),this.closeMethod=t=>{yc(this,m).removeEventListener("message",yc(this,S)),yc(this,m).removeEventListener("error",yc(this,T)),yc(this,m).removeEventListener("open",yc(this,M)),t&&yc(this,m).removeEventListener("close",yc(this,z))}}));return await e,await vc(this,B,C).call(this,yc(this,d)),this.isReady=!0,this}close(t=!1){return new Promise((e=>{yc(this,f).forEach((t=>{t.forEach((t=>t.stopTimeout()))})),bc(this,f,new Map),yc(this,g).forEach((t=>{t.stopTimeout()})),bc(this,g,new Map),this.closeMethod&&this.closeMethod(t),t?(yc(this,z).call(this),e()):yc(this,m).addEventListener("close",(()=>e())),yc(this,m).close()}))}async sendCommand(t,e,s=!0,r=!1){if(!Wc(t))throw new Error(JSON.stringify([t,102]));const a=yc(this,u),o=yc(this,p).command(t,e),n=await i.enc(o,a);try{const e=await vc(this,B,L).call(this,t,n,s,r);if(0!==e.resCode)throw new Error(JSON.stringify([t,e.resCode]));return e}catch(c){throw c}}on(t,e){var i;return null==(i=yc(this,y).get(t))||i.add(e),this}off(t,e){const i=yc(this,y).get(t);return i&&e&&i.has(e)&&i.delete(e),e||yc(this,y).set(t,new Set),this}subscribe(t,e){let i=yc(this,w).get(t);return i||(i=new Set,yc(this,w).set(t,i)),i.add(e),this}unsubscribe(t,e){if(e){const i=yc(this,w).get(t);i&&i.delete(e)}else yc(this,w).set(t,new Set);return this}};function Wc(t){return Bc.has(t)}function Ic(t){const e=new DataView(t);return{resCommand:e.getUint16(2,!0),resCode:e.getUint8(4),resBody:t.slice(5)}}class Lc{constructor(){fc(this,$,new Map),this.on=this.on.bind(yc(this,$)),this.off=this.off.bind(yc(this,$))}trigger(t,e){const i=yc(this,$).get(t);i&&i.forEach((t=>t(e)))}on(t,e){let i=this.get(t);i||(i=new Set,this.set(t,i)),i.add(e)}off(t,e){if("number"!=typeof t)return void this.clear();if(!e)return void(this.has(t)&&this.delete(t));const i=this.get(t);i&&i.delete(e)}}function Oc(t,e){return`incorrect type ${t}, expected ${e}`}function xc(t,e="",i=0){if(!t)return;const s=new DataView(t);for(let r=0,a=e.length;r<a;r++)s.setInt8(i,e.charCodeAt(r)),i+=1}function Ac(t,e=0,i=0){const s=new Uint8Array(t.slice(e,e+i));return String.fromCharCode(...s)}function Pc(t){let e=0;return t.forEach((t=>{var i,s;switch(t.propType){case 1:case 4:e+=1;break;case 2:case 5:e+=2;break;case 3:case 6:case 7:e+=4;break;case 8:case 9:case 17:case 18:e+=8;break;case 10:t.propLength?e+=t.propLength:"string"==typeof t.propValue&&(e+=t.propValue.length);break;case 11:if(t.propLength)e+=t.propLength;else{if("string"!=typeof t.propValue){const e=Oc(typeof t.propValue,"string");throw new Error(e)}e+=2*t.propValue.length}break;case 12:if(t.propLength)e+=t.propLength;else{if((null==(i=t.propValue)?void 0:i.constructor)!==ArrayBuffer){const e=Oc(typeof t.propValue,"ArrayBuffer");throw new Error(e)}e+=t.propLength||(null==(s=t.propValue)?void 0:s.byteLength)||0}}})),e}$=new WeakMap;const Ec={parse:function(t,e,i=0){const s=[],r=new DataView(t);return e.forEach(((e,a)=>{if(i>=t.byteLength)return;let o=0;switch(e.propType){case 1:o=r.getInt8(i),i+=1;break;case 2:o=r.getInt16(i,!0),i+=2;break;case 3:o=r.getInt32(i,!0),i+=4;break;case 4:o=r.getUint8(i),i+=1;break;case 5:o=r.getUint16(i,!0),i+=2;break;case 6:o=r.getUint32(i,!0),i+=4;break;case 7:o=r.getFloat32(i,!0),i+=4;break;case 8:o=r.getFloat64(i,!0),i+=8;break;case 9:o=function(t,e=0){const i=new Uint8Array(t);let s=0;for(let r=7;r>=0;r--)s=256*s+i[e+r];return s=Math.floor(s/1e4)-116444736e5,s}(t,i),i+=8;break;case 10:o=Ac(t,i,e.propLength),e.propLength&&(i+=e.propLength);break;case 11:o=function(t,e=0,i=0){if(!t)return"";const s=new DataView(t);let r="";for(let a=e,o=e+i;a<o;a+=2){const t=s.getUint16(a,!0);if(0===t)break;r+=String.fromCharCode(t)}return r}(t,i,e.propLength),(null==e?void 0:e.propLength)&&(i+=e.propLength);break;case 12:if(e.propLength||e.propLengthType){if(e.propLengthType)switch(e.propLengthType){case 4:e.propLength=r.getUint8(i),i+=1;break;case 5:e.propLength=r.getUint16(i,!0),i+=2;break;case 6:e.propLength=r.getUint32(i,!0),i+=4}if(!e.propLength)return;o=t.slice(i,i+e.propLength),e.parser&&o instanceof ArrayBuffer&&(o=e.parser(o)),i+=e.propLength}break;case 17:o=r.getBigInt64(i,!0),i+=8;break;case 18:o=r.getBigUint64(i,!0),i+=8}s[a]=o})),s},toHex:function(t){return Array.from(new Uint8Array(t)).map((t=>t.toString(16).padStart(2,"0"))).join("")},serialize:function(t){if(!t.length)return null;const e=new ArrayBuffer(Pc(t.map((t=>({propType:t[0],propValue:t[1],propLength:t[2],propLengthType:t[3]}))))),i=new Uint8Array(e),s=new DataView(e);let r=0;return t.forEach((t=>{var a;switch(t[0]){case 1:if("number"!=typeof t[1]){const e=Oc(typeof t[1],"number");throw new Error(e)}s.setInt8(r,t[1]),r+=1;break;case 2:if("number"!=typeof t[1]){const e=Oc(typeof t[1],"number");throw new Error(e)}s.setInt16(r,t[1],!0),r+=2;break;case 3:if("number"!=typeof t[1]){const e=Oc(typeof t[1],"number");throw new Error(e)}s.setInt32(r,t[1],!0),r+=4;break;case 17:if("bigint"!=typeof t[1]){const e=Oc(typeof t[1],"bigint");throw new Error(e)}s.setBigInt64(r,t[1],!0),r+=8;break;case 4:if("number"!=typeof t[1]){const e=Oc(typeof t[1],"number");throw new Error(e)}s.setUint8(r,t[1]),r+=1;break;case 5:if("number"!=typeof t[1]){const e=Oc(typeof t[1],"number");throw new Error(e)}s.setUint16(r,t[1],!0),r+=2;break;case 6:if("number"!=typeof t[1]){const e=Oc(typeof t[1],"number");throw new Error(e)}s.setUint32(r,t[1],!0),r+=4;break;case 18:if("bigint"!=typeof t[1]){const e=Oc(typeof t[1],"bigint");throw new Error(e)}s.setBigUint64(r,t[1],!0),r+=8;break;case 7:if("number"!=typeof t[1]){const e=Oc(typeof t[1],"number");throw new Error(e)}s.setFloat32(r,t[1],!0),r+=4;break;case 8:if("number"!=typeof t[1]){const e=Oc(typeof t[1],"number");throw new Error(e)}s.setFloat64(r,t[1],!0),r+=8;break;case 9:if("number"!=typeof t[1]){const e=Oc(typeof t[1],"number");throw new Error(e)}!function(t,e,i){if(!t)return;const s=new DataView(t);let r=1e4*(i+116444736e5);for(let a=0;a<8;a++)s.setInt8(e+a,r%256),r/=256}(e,r,t[1]),r+=8;break;case 10:if("string"!=typeof t[1]){const e=Oc(typeof t[1],"string");throw new Error(e)}xc(e,t[1],r),r+=t[2]||t[1].length;break;case 11:if("string"!=typeof t[1]){const e=Oc(typeof t[1],"string");throw new Error(e)}!function(t,e="",i=0){if(!t)return;const s=new DataView(t);for(let r=0,a=e.length;r<a;r++)s.setInt16(i,e.charCodeAt(r),!0),i+=2}(e,t[1],r),r+=t[2]||2*t[1].length;break;case 12:if((null==(a=t[1])?void 0:a.constructor)!==ArrayBuffer){const e=Oc(typeof t[1],"ArrayBuffer");throw new Error(e)}i.set(new Uint8Array(t[1]),r),r+=t[1].byteLength}})),e},getSeriesSize:Pc,setCharString:xc,getCharString:Ac,getString16:function(t,e,i){const s=new Uint8Array(t.slice(e,e+i));return function(t){let e="";const i=t.length;let s=0;for(;s<i;){const i=t.charCodeAt(s);switch(s+=1,i>>4){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:e+=t.charAt(s-1);break;case 12:case 13:{const r=t.charCodeAt(s);s+=1,e+=String.fromCharCode((31&i)<<6|63&r);break}case 14:{const r=t.charCodeAt(s);s+=1;const a=t.charCodeAt(s);s+=1,e+=String.fromCharCode((15&i)<<12|(63&r)<<6|63&a);break}}}return e}(String.fromCharCode(...s))},concat:function(t,e){const i=new Uint8Array(t.byteLength+e.byteLength);return i.set(new Uint8Array(t),0),i.set(new Uint8Array(e),t.byteLength),i.buffer}};function $c(){var t,e;try{let i=null==(t=window.localStorage)?void 0:t.getItem("u");return i||(i=String(Math.round(1e6*Math.random())),null==(e=window.localStorage)||e.setItem("u",i)),i}catch(i){return""}}let Nc=new ArrayBuffer(0);async function Dc(){const{navigator:t}=window,e=t.language||"",i=window.screen,s=[t.platform,window.devicePixelRatio,e,i?`${Math.max(i.width,i.height)}x${Math.min(i.width,i.height)}`:"",$c()].join(";"),r=(new TextEncoder).encode(s);Nc=(await crypto.subtle.digest("SHA-1",r)).slice(0,16)}function qc(){return Nc}const Fc=[{propType:12,propLength:160},{propType:18}];class Rc{constructor(t){this.socket=t}}class Vc extends Rc{constructor(){super(...arguments),fc(this,N,new Set),fc(this,D,(t=>{const e=new Uint32Array(t.resBody)[0];yc(this,N).forEach((t=>t(e)))}))}on(t){yc(this,N).add(t)}off(t){t?yc(this,N).delete(t):yc(this,N).clear()}async login(t,e,i,r,a){const o=function(t){var e,i;const r=new URLSearchParams(window.self.location.search),a=r.get("utm_campaign")??"",o=r.get("utm_source")??"";let n,c="";const l=t.cid||qc();320===(null==(e=t.password)?void 0:e.length)?n=s.hexToBuffer(t.password):(c=(null==(i=t.password)?void 0:i.substring(0,32))??"",n=new ArrayBuffer(160));const h=[[6,t.version||0],[11,c,64],[11,(t.otp||"").substring(0,64),128],[12,l,16],[11,a.substring(0,32),64],[11,o.substring(0,32),64],[18,t.leadCookieId||BigInt(0)],[11,(t.leadAffiliateSite||"").substring(0,64),128],[6,Math.min(t.url?t.url.length:0,128)],[11,(t.url||"").substring(0,128),256],[18,BigInt(t.login??0)],[12,n,160],[18,t.session||BigInt(0)]];return Ec.serialize(h)}({login:t,password:e,url:i,session:r,otp:a});try{const t=(n=(await this.socket.on(15,yc(this,D)).sendCommand(28,o)).resBody,Ec.parse(n,Fc));return[Ec.toHex(t[0]),t[1]??BigInt(0)]}catch(c){throw c}var n}destroy(){this.socket.off(15,yc(this,D)),this.off()}async logout(){return this.destroy(),await this.socket.sendCommand(2)}async changePass(t,e,i=!1){const s=(r={newPassword:t,oldPassword:e,isInvestor:i},Ec.serialize([[4,Number(r.isInvestor??!1)],[11,(r.newPassword??"").substring(0,32),64],[11,(r.oldPassword??"").substring(0,32),64]]));var r;const{resBody:a}=await this.socket.sendCommand(24,s);return new DataView(a).getInt32(0,!0)}async ping(){await this.socket.sendCommand(51)}hasSignalServerConnection(){return 1===this.socket.readyState}closeSocket(){return this.socket.close(!0)}}N=new WeakMap,D=new WeakMap;class Uc{constructor(){fc(this,q),this.state=0,bc(this,q,0)}setState(t){this.state=t}}function Hc(t){return/\d/gm.test(t[0])}function Xc(t){return!Hc(t)&&t[0].toLowerCase()===t[0]}function jc(t,e){let i=0,s=0,r=0,a=0;if(!t)return 2007;if(t.length<e)return 2e3;for(let n=0;n<t.length;n++){const e=t[n],c=Number(Hc(e));let l=Number(!Hc(o=e)&&o[0].toUpperCase()===o[0]),h=Number(Xc(e));const _=Number(l&&h||!c&&!l&&!h);if(l&&h&&(l=0,h=0),i+=c,a+=_,s+=l,r+=h,i&&s&&r&&a)return 0}var o;return r&&s&&i&&a?0:2001}q=new WeakMap;class Gc{constructor(t,e){fc(this,F),fc(this,R),fc(this,V),fc(this,U,0),fc(this,H,0),fc(this,X,null),fc(this,j,null),fc(this,G,(()=>{yc(this,j)&&(window.clearTimeout(yc(this,j)),bc(this,j,null))})),fc(this,Y,(t=>{yc(this,V).setState(t),yc(this,F).trigger(16,t)})),fc(this,K,(()=>{if(yc(this,X)&&bc(this,H,yc(this,U)),yc(this,H)&&Date.now()-yc(this,H)>15e3)return yc(this,R).closeSocket(),bc(this,H,0),void bc(this,U,0);bc(this,X,yc(this,R).ping()),yc(this,X).then((()=>{bc(this,X,null),bc(this,H,0),bc(this,U,Date.now())})).catch((t=>{})),bc(this,j,window.setTimeout(yc(this,K),5e3))})),bc(this,V,new Uc),bc(this,F,t),bc(this,R,e),yc(this,F).on(11,yc(this,G)),yc(this,R).on(yc(this,Y))}async login(t,e,i,s,r){const a=await yc(this,R).login(t,e,i,s,r);return yc(this,j)&&clearTimeout(yc(this,j)),yc(this,K).call(this),a}async changePassword(t,e,i,s){const r=jc(t,i);return 0!==r?r:yc(this,R).changePass(t,e,s)}async logout(){"number"==typeof yc(this,j)&&clearTimeout(yc(this,j)),await yc(this,R).logout(),"number"==typeof yc(this,j)&&clearTimeout(yc(this,j))}destroy(){yc(this,R).destroy()}hasTradeServerConnection(){return 0===yc(this,V).state}hasSignalServerConnection(){return yc(this,R).hasSignalServerConnection()}}F=new WeakMap,R=new WeakMap,V=new WeakMap,U=new WeakMap,H=new WeakMap,X=new WeakMap,j=new WeakMap,G=new WeakMap,Y=new WeakMap,K=new WeakMap;class Yc{constructor(t){fc(this,J),bc(this,J,t)}async logout(){return yc(this,J).logout()}async changePassword(t,e,i,s){return yc(this,J).changePassword(t,e,i,s)}}J=new WeakMap;class Kc{constructor(t,e){this.controller=new Gc(t,new Vc(e)),this.view=new Yc(this.controller)}}const Jc={pack:function(t,e){const i=e&&e.byteLength||0,s=new Uint8Array(8+i);e&&s.set(new Uint8Array(e),8);const r=new DataView(s.buffer);return r.setUint32(0,i,!0),r.setUint32(4,1,!0),s.buffer},command:function(t,e){const i=new Uint8Array(4+(e&&e.byteLength||0));e&&i.set(new Uint8Array(e),4);const s=new DataView(i.buffer);return s.setUint8(0,Math.floor(255*Math.random())),s.setUint8(1,Math.floor(255*Math.random())),s.setUint16(2,t,!0),i.buffer},HEADER_BYTE_LENGTH:8},Zc={NONE:0,FOK:1,IOC:2,BOC:4,ALL:7},Qc={NONE:0,GTC:1,DAY:2,SPECIFIED:4,SPECIFIED_DAY:8,ALL:15},tl={NONE:0,MARKET:1,LIMIT:2,STOP:4,STOP_LIMIT:8,SL:16,TP:32,CLOSEBY:64,ALL:127};class el{constructor(t){this.path=t[0],this.range_mode=t[1],this.range_currency=t[2],this.range_currency_digits=t[3],this.tiers=t[5].map((t=>({range_from:t[0],range_to:t[1],margin_rate_initial:t[2],margin_rate_maintenance:t[3]})))}static createFromResponse(t){return t.map((t=>new el(t)))}}class il{constructor(t){this.path=t[0],this.mode=t[1],this.mode_range=t[2],this.mode_charge=t[3],this.mode_currency=t[4],this.mode_entry=t[5],this.tiers=t[6].map((t=>({mode:t[0],type:t[1],value:t[2],range_from:t[3],range_to:t[4],minimal:t[5],maximal:t[6],currency:t[7]})))}static createFromResponse(t){return t.map((t=>new il(t)))}isAgent(){return 1===this.mode}}Z=new WeakMap;let sl=class t{constructor(t,e){fc(this,Z),this.account_type=0,this.balance=0,this.credit=0,this.account_currency="",this.currency_digits=0,this.margin_leverage=0,this.account_name="",this.server_build=0,this.server_name="",this.company="",this.timezone_shift=0,this.daylightmode=0,this.margin_mode=0,this.margin_free_mode=0,this.margin_so_call=0,this.margin_so_so=0,this.margin_so_mode=0,this.margin_virtual=0,this.margin_free_profit_mode=0,this.commission_daily=0,this.commission_monthly=0,this.acc_profit=0,this.trade_flags=0,this.rights=0,this.permissions_flags=0,this.trade_settings=[],this.margin_free=0,this.margin_level=0,this.profit=0,this.commission=0,this.storage_=0,this.margin=0,this.margin_initial=0,this.margin_maintenance=0,this.floating=0,this.equity=0,this.assets=0,this.liabilities=0,this.collateral=0,this.bad_request=0,this.auth_password_min=8,this.symbols_count=0,this.profit_excluded=0,this.acc_commission=0,this.leverage_flags=0n,this.rules=[],this.commissions=[],this.so_activation=0,this.otp_status=0,this.login=e,bc(this,Z,t),this.updateAccount(t)}updateAccount(t){bc(this,Z,t),this.account_type=t[0],this.rights=t[1],this.permissions_flags=t[2],this.balance=t[3],this.credit=t[4],this.account_currency=t[5],this.currency_digits=t[6],this.margin_leverage=t[7],this.account_name=t[8],this.server_build=t[9],this.server_name=t[10],this.company=t[11],this.timezone_shift=t[12],this.daylightmode=t[13],this.margin_mode=t[14],this.margin_free_mode=t[15],this.margin_so_call=t[16],this.margin_so_so=t[17],this.margin_so_mode=t[18],this.margin_virtual=t[19],this.margin_free_profit_mode=t[20],this.acc_profit=t[21],this.commission_daily=t[22],this.commission_monthly=t[23],this.auth_password_min=t[24],this.otp_status=t[25],this.trade_settings=t[26].map((t=>({...t}))),this.trade_flags=t[27],this.symbols_count=t[28],this.leverage_flags=t[29],this.rules=el.createFromResponse(t[30]),this.commissions=il.createFromResponse(t[31])}copy(){return new t(yc(this,Z),this.login)}isInvestor(){return Boolean(8&this.rights)}isTradeDisabled(){return Boolean(4&this.rights)}isReadOnly(){return Boolean(512&this.rights)}isResetPass(){return!!(1024&this.rights)}isHedgedMargin(){return 2===this.margin_mode}isExchangeMargin(){return 1===this.margin_mode}getServerOffsetTime(){return 3600*this.daylightmode+this.timezone_shift}riskWarning(){return Boolean(16&this.permissions_flags)}};class rl{constructor(t){fc(this,Q),bc(this,Q,t)}getAccount(){return yc(this,Q)}setAccount(t){return bc(this,Q,t),yc(this,Q)}}Q=new WeakMap;class al{constructor(t,e,i,s){fc(this,tt),fc(this,et),fc(this,it),fc(this,st,(t=>{var e;null==(e=yc(this,tt))||e.trigger(14),this.updateAccount(t.detail)})),bc(this,tt,t),bc(this,et,e),bc(this,it,new rl(new sl([...i],s)));const r=yc(this,it).getAccount();yc(this,tt).trigger(13,{isInvestor:r.isInvestor(),isResetPass:r.isResetPass(),isTradeDisabled:r.isTradeDisabled(),isReadOnly:r.isReadOnly(),isHedgedMargin:r.isHedgedMargin()}),yc(this,et).on("800",yc(this,st))}destroy(){yc(this,et).off("800",yc(this,st)),yc(this,et).destroy()}updateAccount(t){this.getAccount().updateAccount(t)}getAccount(){return yc(this,it).getAccount()}setAccount(t){return yc(this,it).setAccount(t)}checkPassword(t){return jc(t,this.getAccount().auth_password_min)}}tt=new WeakMap,et=new WeakMap,it=new WeakMap,st=new WeakMap;class ol{constructor(t){fc(this,rt),bc(this,rt,t)}checkPassword(t){return yc(this,rt).checkPassword(t)}getAccount(){const t=yc(this,rt).getAccount();return{type:t.account_type,isReal:0===t.account_type,isDemo:1===t.account_type,isContest:2===t.account_type,isPreliminary:3===t.account_type,name:t.account_name,login:t.login,company:t.company,timezoneShift:t.timezone_shift,dayLightMode:t.daylightmode,currency:t.account_currency,digits:t.currency_digits,serverBuild:t.server_build,serverName:t.server_name,balance:t.balance,credit:t.credit,profit:t.profit,commission:t.acc_commission,storage:t.storage_,margin:t.margin,marginFree:t.margin_free,marginInitial:t.margin_initial,marginMaintenance:t.margin_maintenance,marginLeverage:t.margin_leverage,marginLevel:a.normalize(t.margin_level,t.currency_digits),floating:t.floating,equity:t.equity,assets:t.assets,liabilities:t.liabilities,collateral:t.collateral,isInvestor:t.isInvestor(),isTradeDisabled:t.isTradeDisabled(),isReadOnly:t.isReadOnly(),isHedgedMargin:t.isHedgedMargin(),isResetPass:t.isResetPass(),passwordMin:t.auth_password_min,serverOffsetTime:t.getServerOffsetTime(),riskWarning:t.riskWarning(),otpStatus:t.otp_status}}}rt=new WeakMap;const nl=[{propType:11,propLength:256},{propType:3},{propType:3},{propType:6},{propType:3},{propType:3},{propType:6},{propType:6},{propType:6},{propType:6},{propType:6},{propType:6},{propType:6},{propType:6},{propType:6},{propType:6},{propType:18},{propType:6},{propType:6},{propType:6},{propType:18},{propType:18},{propType:18},{propType:18},{propType:6},{propType:8},{propType:8},{propType:12,propLength:64,parser:hl},{propType:12,propLength:64,parser:hl},{propType:8},{propType:8},{propType:8},{propType:6},{propType:8},{propType:8},{propType:3},{propType:6},{propType:6},{propType:12,propLength:56,parser:hl}],cl=Ec.getSeriesSize(nl);function ll(t,e=0){return function(t,e=0){const i=Ec.parse(t,nl,e);return{symbol_path:i[0],spread_diff:i[1],spread_diff_balance:i[2],trade_mode:i[3],trade_stops_level:i[4],trade_freeze_level:i[5],trade_exemode:i[6],trade_fill_flags:i[7],trade_time_flags:i[8],trade_order_flags:i[9],trade_request_flags:i[10],trade_request_timeout:i[11],trade_instant_flags:i[12],trade_instant_timeout:i[13],trade_instant_slip_profit:i[14],trade_instant_slip_losing:i[15],trade_instant_volume:i[16],trade_instant_checkmode:i[17],trade_market_flags:i[18],trade_exchange_flags:i[19],volume_min:i[20],volume_max:i[21],volume_step:i[22],volume_limit:i[23],margin_flags:i[24],margin_initial:i[25],margin_maintenance:i[26],margin_rates_initial:i[27],margin_rates_maintenance:i[28],margin_rate_liquidity:i[29],margin_hedged:i[30],margin_rate_currency:i[31],swap_mode:i[32],swap_long:i[33],swap_short:i[34],swap_rollover3days:i[35],permissions_flags:i[36],permissions_bookdepth:i[37],swap_rates:i[38]}}(t,e)}function hl(t){return new Float64Array(t)}const _l=[{propType:11,propLength:256},{propType:6},{propType:6},{propType:6},{propType:11,propLength:32},{propType:6}],dl=Ec.getSeriesSize(_l),ul=[{propType:6},{propType:6},{propType:8},{propType:8},{propType:8},{propType:8},{propType:8},{propType:11,propLength:32}],pl=Ec.getSeriesSize(ul);function ml(t,e){const i=[],s=new DataView(t);let r;if(t.byteLength>e.val){r=s.getUint32(e.val,!0),e.val+=4;for(let s=0;s<r;s++){const s=Ec.parse(t,ul,e.val);e.val+=pl,i.push(s)}}return i}const gl=[{propType:11,propLength:256},{propType:6},{propType:11,propLength:32},{propType:6},{propType:3}],yl=Ec.getSeriesSize(gl),fl=[{propType:8},{propType:8},{propType:8},{propType:8}],bl=Ec.getSeriesSize(fl),vl=[{propType:4},{propType:3},{propType:3},{propType:8},{propType:8},{propType:11,propLength:64},{propType:6},{propType:6},{propType:11,propLength:256},{propType:5},{propType:11,propLength:128},{propType:11,propLength:256},{propType:3},{propType:1},{propType:6},{propType:6},{propType:8},{propType:8},{propType:6},{propType:8},{propType:6},{propType:8},{propType:8},{propType:8},{propType:6},{propType:6}];function wl(t,e,i){const s=[];if(t.byteLength>e.val)for(let r=0;r<i;r++){const i=Ec.parse(t,fl,e.val);e.val+=bl,s.push(i)}return s}const kl=Ec.getSeriesSize(vl);function Tl(t,e=0){const i=Ec.parse(t,vl,e);return i[24]=i[24]||8,Object.values(i)}function Ml(t,e=0){const i=new DataView(t);let s=e;const r=[...Tl(t,s)];s=kl;const a=[];if(t.byteLength>s){const e=i.getUint32(s,!0);if(e){s+=4;for(let i=0;i<e;i++)a.push(ll(t,s)),s+=cl}}let o=0;t.byteLength>s&&(o=i.getInt32(s,!0),s+=4);let n=0;t.byteLength>s&&(n=i.getInt32(s,!0),s+=4);let c=0n;t.byteLength>s&&(c=i.getBigUint64(s,!0),s+=8);const l={val:s},h=function(t,e){const i=new DataView(t);let s=0;const r=[];if(t.byteLength>e.val){s=i.getInt32(e.val,!0),e.val+=4;for(let i=0;i<s;i++){const i=Ec.parse(t,gl,e.val);e.val+=yl;const s=wl(t,e,i[4]);r.push([...i,s])}}return r}(t,l),_=function(t,e){const i=new DataView(t);let s=0;const r=[];if(t.byteLength>e.val){s=i.getUint32(e.val,!0),e.val+=4;for(let i=0;i<s;i++){const i=Ec.parse(t,_l,e.val);e.val+=dl;const s=ml(t,e);r.push([...i,s])}}return r}(t,l);return[...r,a,o,n,c,h,_]}class Sl{constructor(t=""){fc(this,ct),fc(this,at),fc(this,ot),fc(this,nt,new Map),bc(this,ot,t),bc(this,at,new EventTarget)}on(t,e){vc(this,ct,lt).call(this,t,e),yc(this,at).addEventListener(t,e)}once(t,e){yc(this,at).addEventListener(t,e,{once:!0})}off(t,e){vc(this,ct,ht).call(this,t,e),yc(this,at).removeEventListener(t,e)}trigger(t,e){return yc(this,at).dispatchEvent(new CustomEvent(t,{detail:e,cancelable:!0}))}destroy(){yc(this,nt).forEach(((t,e)=>{t.forEach((t=>{t&&yc(this,at).removeEventListener(e,t)}))})),yc(this,nt).clear()}}at=new WeakMap,ot=new WeakMap,nt=new WeakMap,ct=new WeakSet,lt=function(t,e){const i=yc(this,nt).get(t)||new Set;i.add(e),yc(this,nt).set(t,i)},ht=function(t,e){const i=yc(this,nt).get(t);i&&i.delete(e)};class zl extends Sl{constructor(t){super("api_account"),fc(this,_t),fc(this,dt,(t=>{const e=Ml(t.resBody);this.trigger("800",e)})),bc(this,_t,t),yc(this,_t).on(14,yc(this,dt))}async getAccount(){return Ml((await yc(this,_t).sendCommand(3)).resBody)}}_t=new WeakMap,dt=new WeakMap;class Bl{constructor(t,e,i,s){this.controller=new al(t,e,i,s),this.view=new ol(this.controller)}static async createModule(t,e,i){const s=new zl(e),r=await s.getAccount();return new Bl(t,s,r,i)}}class Cl{constructor(t){fc(this,ut),bc(this,ut,t)}async sendNotify(t){await yc(this,ut).sendNotify(t)}}ut=new WeakMap;class Wl extends Rc{async sendNotify(t){await this.socket.sendCommand(42,function(t){return Ec.serialize([[6,t??0]])}(t))}}class Il{constructor(t){fc(this,pt),bc(this,pt,t)}async send(t){await yc(this,pt).sendNotify(t)}}pt=new WeakMap;class Ll{constructor(t){this.controller=new Cl(new Wl(t)),this.view=new Il(this.controller)}}class Ol{constructor(){fc(this,mt,new Map),fc(this,gt,{count:0,path:"",label:"",children:new Map})}getAllTypes(){return new Map(yc(this,mt))}getTree(){return{...yc(this,gt)}}calcCounts(t){t.forEach((t=>{let e=yc(this,gt).children;for(let i=0;i<t.path_category_list.length;i++){const s=t.path_category_list[i],r=e.get(s);if(!r)return;r.count+=1,e=r.children}}))}clearStorage(){yc(this,mt).clear(),yc(this,gt).children.clear(),yc(this,gt).count=0}setType(t,e){yc(this,mt).set(t,e.group_name),this.setTree(e.group_name)}setTree(t){const e=t.split("\\");let i=yc(this,gt).children;e.forEach(((t,s)=>{let r=i.get(t);r||(r={count:0,children:new Map,path:e.slice(0,s+1).join("\\"),label:t},i.set(t,r)),i=r.children}))}}mt=new WeakMap,gt=new WeakMap;class xl{constructor(t){fc(this,yt),fc(this,ft,new Ol),fc(this,bt,(t=>{t.forEach(((t,e)=>{yc(this,ft).setType(e,t)}))})),bc(this,yt,t),this.init()}async init(){this.destroy();const t=await yc(this,yt).loadTypes();yc(this,bt).call(this,t)}destroy(){yc(this,ft).clearStorage()}calcCounts(t){t.forEach((t=>{let e=yc(this,ft).getTree().children;for(let i=0;i<t.path_category_list.length;i++){const s=t.path_category_list[i],r=e.get(s);if(!r)return;r.count+=1,e=r.children}}))}getAllTypes(){return yc(this,ft).getAllTypes()}getTree(){return yc(this,ft).getTree()}}yt=new WeakMap,ft=new WeakMap,bt=new WeakMap;const Al=[{propType:11,propLength:256}],Pl=Ec.getSeriesSize(Al);function El(t,e=0){return{group_name:Ec.parse(t,Al,e)[0]}}class $l extends Rc{async loadTypes(){return function(t){const e=[],i=new DataView(t).getUint32(0,!0);let s=4;for(let r=0;r<i;r++)e.push(El(t,s)),s+=Pl;return e}((await this.socket.sendCommand(9)).resBody)}}class Nl{constructor(t,e,i=!0){this.catagories=[];const s=e.split("\\");s.forEach((e=>{const i=t.children.get(e);i&&(t=i)})),this.parentPath=s.slice(0,s.length-1).join("\\"),i&&(this.catagories=Array.from(t.children).filter((t=>t[1].count)).map((e=>new Nl(t,e[1].path,!1)))),this.label=t.label,this.count=t.count,this.path=t.path}}class Dl{constructor(t){fc(this,vt),bc(this,vt,t)}getBranch(t=""){return new Nl(yc(this,vt).getTree(),t)}getTypes(){return yc(this,vt).getAllTypes()}}vt=new WeakMap;class ql{constructor(t){this.controller=new xl(new $l(t)),this.view=new Dl(this.controller)}}class Fl{constructor(t){this.legs_a=[],this.legs_b=[],this.spread_id=t[0],this.flag_mask=t[1],this.margin_initial=t[2],this.margin_maintenance=t[3],this.margin_type=t[4]}preferable(t){return!(2!==this.margin_type&&3!==this.margin_type||2!==t&&3!==t)&&this.margin_type>t}}class Rl{constructor(t,e){this.spread_id=t.spread_id,this.spread=t,this.spread_mode=e[0],this.flag_mask=e[1],this.trade_symbol=e[2],this.time_from=e[3],this.time_to=e[4],this.spread_ratio=e[5]}checkSymbol(t,e,i){if(i<0)return!1;switch(this.spread_mode){case 0:return this.trade_symbol===t;case 1:return(!this.time_from||i>=this.time_from)&&(!this.time_to||i<=this.time_to)&&this.trade_symbol===e;default:return!1}}}const Vl=[{propType:6},{propType:6},{propType:11,propLength:64},{propType:6},{propType:6},{propType:8}],Ul=Ec.getSeriesSize(Vl);function Hl(t,e){return 4+new DataView(t).getUint32(e,!0)*Ul}function Xl(t,e,i=0){const s=Ec.parse(e,Vl,i);return new Rl(t,s)}function jl(t,e,i=0){const s=[];let r=i;const a=new DataView(e).getUint32(r,!0);r+=4;for(let o=0;o<a;o++)s.push(Xl(t,e,r)),r+=Ul;return s}const Gl=[{propType:6},{propType:6},{propType:8},{propType:8},{propType:6}],Yl=Ec.getSeriesSize(Gl);function Kl(t,e=0){const i=Ec.parse(t,Gl,e);return new Fl(i)}function Jl(t){const e=[],i=new DataView(t),s=t.byteLength;let r=0;for(;r<s;){r+=4;const s=i.getUint32(r,!0);r+=4;for(let i=0;i<s;i++){const i=Kl(t,r);r+=Yl,0!==i.spread_id&&(i.legs_a=jl(i,t,r),r+=Hl(t,r),i.legs_b=jl(i,t,r),r+=Hl(t,r),e.push(i))}}return e}function Zl(t){return Uint32Array.from([t.length].concat(t)).buffer}class Ql extends Rc{constructor(){super(...arguments),fc(this,kt),fc(this,wt,new WeakMap)}async getSpreads(t){const e=Zl(t);return Jl((await this.socket.sendCommand(20,e)).resBody)}on(t){let e=yc(this,wt).get(t);return e||(e=vc(this,kt,Tt).bind(this,t),yc(this,wt).set(t,e)),this.socket.on(20,e),this}off(t){const e=yc(this,wt).get(t);return e&&this.socket.off(20,e),this}}wt=new WeakMap,kt=new WeakSet,Tt=function(t,e){t(Jl(e.resBody))};class th{constructor(){fc(this,Mt),fc(this,St),fc(this,zt),fc(this,Bt),fc(this,Ct),bc(this,Mt,[]),bc(this,St,{}),bc(this,zt,[]),bc(this,Bt,[]),this.path="",bc(this,Ct,[])}legsGetAll(){return[...yc(this,Ct)]}legsClear(){bc(this,Ct,[])}legsAdd(t){yc(this,Ct).push(t)}legsTotal(){return yc(this,Ct).length}legsGetBySymbol(t){return yc(this,Ct).filter((e=>e.trade_symbol===t))}legsSort(t){yc(this,Ct).sort(t)}legsSymbolGetAll(){return[...yc(this,zt)]}legsSymbolClear(){bc(this,zt,[])}legsSymbolAdd(t){yc(this,zt).push(t)}legsBasisGetAll(){return[...yc(this,Bt)]}legsBasisClear(){bc(this,Bt,[])}legsBasisAdd(t){yc(this,Bt).push(t)}spreadsReset(t){this.spreadsClear(),t.forEach((t=>{this.spreadsAdd(t)}))}spreadsAdd(t){yc(this,Mt).push(t),yc(this,St)[t.spread_id]=t}spreadsClear(){bc(this,Mt,[]),bc(this,St,{})}spreadsGetAll(){return[...yc(this,Mt)]}spreadsGet(t){return yc(this,St)[t]??yc(this,Mt).find((e=>e.spread_id===t))}spreadsTotal(){return yc(this,Mt).length}spreadsForEach(t){yc(this,Mt).forEach(t)}legsSymbolSort(t){yc(this,zt).sort(t)}legsBasisSort(t){yc(this,Bt).sort(t)}getBySymbolId(t){return[]}}Mt=new WeakMap,St=new WeakMap,zt=new WeakMap,Bt=new WeakMap,Ct=new WeakMap;class eh{constructor(t,e){fc(this,Wt),fc(this,It,new th),fc(this,Lt),bc(this,Wt,t),bc(this,Lt,e)}async loadSpreads(t){if(!t.length)return;const e=[],i=[];if(t.forEach((t=>{const s=yc(this,Lt).getSymbolByName(t);s&&(i.push(s.symbol_id),yc(this,Lt).getFullSymbolByName(t)||e.push(s.symbol_id))})),!i.length)return;e.length&&await yc(this,Lt).loadConfig(i);const s=await yc(this,Wt).getSpreads(i);this.accountUpdate(i),yc(this,It).spreadsReset(s),this.buildSpreadsLegs()}getSpreadBySymbolId(t){return yc(this,It).getBySymbolId(t)}legsGetBySymbol(t){return yc(this,It).legsGetBySymbol(t)}getById(t){return yc(this,It).spreadsGet(t)}getLegs(){return yc(this,It).legsGetAll()}legsTotal(){return yc(this,It).legsTotal()}accountUpdate(t){const e=[];t.forEach((t=>{const i=yc(this,Lt).getFullSymbolById(t);i&&e.push(i)})),yc(this,It).legsClear(),e.forEach((t=>{this.buildSpreadsLegsAccount(yc(this,It).legsSymbolGetAll(),t,t.trade_symbol),this.buildSpreadsLegsAccount(yc(this,It).legsBasisGetAll(),t,t.basis)}))}spreadsTotal(){return yc(this,It).spreadsTotal()}findBySymbol(t){return[...sh(yc(this,It).legsSymbolGetAll(),t,t.trade_symbol),...sh(yc(this,It).legsBasisGetAll(),t,t.basis)]}buildSpreadsLegs(){yc(this,It).legsSymbolClear(),yc(this,It).legsBasisClear(),yc(this,It).spreadsForEach((t=>{t.legs_a.forEach((t=>{0===t.spread_mode?yc(this,It).legsSymbolAdd(t):1===t.spread_mode&&yc(this,It).legsBasisAdd(t)})),t.legs_b.forEach((t=>{0===t.spread_mode?yc(this,It).legsSymbolAdd(t):1===t.spread_mode&&yc(this,It).legsBasisAdd(t)}))})),yc(this,It).legsSymbolSort(ih),yc(this,It).legsBasisSort(ih)}buildSpreadsLegsAccount(t,e,i){i&&(t.filter((t=>t.trade_symbol===i)).forEach((t=>{t.checkSymbol(e.trade_symbol,e.basis,e.time_expiration)&&yc(this,It).legsAdd(t)})),yc(this,It).legsSort(ih))}}function ih(t,e){return t.trade_symbol>e.trade_symbol?1:t.trade_symbol<e.trade_symbol?-1:t.spread_id>e.spread_id?1:t.spread_id<e.spread_id?-1:0}function sh(t,e,i){const s=t.filter((({trade_symbol:t})=>i===t)),r=[];return s.forEach((t=>{t.checkSymbol(e.trade_symbol,e.basis,e.time_expiration)&&r.push(t.spread)})),r}Wt=new WeakMap,It=new WeakMap,Lt=new WeakMap;class rh{constructor(t,e){this.controller=new eh(new Ql(t),e)}}function ah(t){return 0===t||5===t}class oh{constructor(t){this.basis="",this.digits=0,this.symbol_description="",this.symbol_id=0,this.symbol_path="",this.path_list=[],this.path_category_list=[],this.path_category="",this.trade_symbol="",this.trade_calc_mode=0,this.sector=0,this.trade_symbol=t[0]??this.trade_symbol,this.symbol_description=t[1]??this.symbol_description,this.digits=t[2]??this.digits,this.symbol_id=t[3]??this.symbol_id,this.setPath(t[4]??this.symbol_path),this.trade_calc_mode=t[5]??this.trade_calc_mode,this.basis=t[6]??this.basis,this.sector=t[7]??this.sector}setPath(t=""){this.symbol_path=t,this.path_list=this.symbol_path.split("\\"),this.path_category_list=this.path_list.slice(0,this.path_list.length-1),this.path_category=this.path_category_list.join("\\")}updateSymbol(t){this.basis=t.basis??this.basis,this.digits=t.digits??this.digits,this.symbol_description=t.symbol_description??this.symbol_description,this.symbol_id=t.symbol_id??this.symbol_id,this.trade_calc_mode=t.trade_calc_mode??this.trade_calc_mode,this.trade_symbol=t.trade_symbol??this.trade_symbol,this.sector=t.sector??this.sector,this.setPath((null==t?void 0:t.symbol_path)??this.symbol_path)}isValueBased(){return Boolean(32===this.trade_calc_mode||35===this.trade_calc_mode||37===this.trade_calc_mode||38===this.trade_calc_mode||39===this.trade_calc_mode)}isForex(){return ah(this.trade_calc_mode)}isFORTS(){return 34===this.trade_calc_mode}isBond(){return 37===this.trade_calc_mode||39===this.trade_calc_mode}isStock(){return 32===this.trade_calc_mode||38===this.trade_calc_mode}isCollateral(){return 64===this.trade_calc_mode}isDerivative(){return 33===this.trade_calc_mode||34===this.trade_calc_mode||35===this.trade_calc_mode||36===this.trade_calc_mode}isOption(){return 35===this.trade_calc_mode||36===this.trade_calc_mode}isFuture(){return 1===this.trade_calc_mode||33===this.trade_calc_mode||34===this.trade_calc_mode}}class nh extends oh{constructor(t){super([t[0],t[2],t[21],t[24],t[46].symbol_path,t[35],t[4],t[10]]),fc(this,Ot),this.time_expiration=0,this.isin="",this.international="",this.symbol_source="",this.symbol_page="",this.category="",this.trade_exchange="",this.cfi="",this.industry=0,this.country="",this.currency_base="",this.currency_profit="",this.currency_margin="",this.currency_base_digits=0,this.currency_profit_digits=0,this.currency_margin_digits=0,this.symbol_color=0,this.color_background=0,this.point=0,this.symbol_multiply=0,this.ticks_flags=0,this.ticks_bookdepth=0,this.ticks_chart_mode=0,this.trade_flags=0,this.trade_spread=0,this.trade_spread_balance=0,this.trade_tick_value=0,this.trade_tick_size=0,this.trade_contract_size=0,this.trade_gtc_mode=0,this.trade_price_settle=0,this.trade_price_limit_min=0,this.trade_price_limit_max=0,this.trade_price_strike=0,this.trade_option_mode=0,this.trade_face_value=0,this.trade_accrued_interest=0,this.time_flags=0,this.time_start=0,this.setPath(t[46].symbol_path||this.symbol_path),this.isin=t[1]??this.isin,this.international=t[3]??this.international,this.symbol_source=t[5]??this.symbol_source,this.symbol_page=t[6]??this.symbol_page,this.category=t[7]??this.category,this.trade_exchange=t[8]??this.trade_exchange,this.cfi=t[9]??this.cfi,this.industry=t[11]??this.industry,this.country=t[12]??this.country,this.currency_base=t[13]??this.currency_base,this.currency_profit=t[14]??this.currency_profit,this.currency_margin=t[15]??this.currency_margin,this.currency_base_digits=t[16]??this.currency_base_digits,this.currency_profit_digits=t[17]??this.currency_profit_digits,this.currency_margin_digits=t[18]??this.currency_margin_digits,this.symbol_color=t[19]??this.symbol_color,this.color_background=t[20]??this.color_background,this.point=t[22]??this.point,this.symbol_multiply=t[23]??this.symbol_multiply,this.ticks_flags=t[25]??this.ticks_flags,this.ticks_bookdepth=t[26]??this.ticks_bookdepth,this.ticks_chart_mode=t[27]??this.ticks_chart_mode,this.trade_flags=t[28]??this.trade_flags,this.trade_spread=t[29]??this.trade_spread,this.trade_spread_balance=t[30]??this.trade_spread_balance,this.trade_tick_value=t[31]??this.trade_tick_value,this.trade_tick_size=t[32]??this.trade_tick_size,this.trade_contract_size=t[33]??this.trade_contract_size,this.trade_gtc_mode=t[34]??this.trade_gtc_mode,this.trade_price_settle=t[36]??this.trade_price_settle,this.trade_price_limit_min=t[37]??this.trade_price_limit_min,this.trade_price_limit_max=t[38]??this.trade_price_limit_max,this.trade_price_strike=t[39]??this.trade_price_strike,this.trade_option_mode=t[40]??this.trade_option_mode,this.trade_face_value=t[41]??this.trade_face_value,this.trade_accrued_interest=t[42]??this.trade_accrued_interest,this.time_flags=t[43]??this.time_flags,this.time_start=t[44]??this.time_start,this.time_expiration=t[45]??this.time_expiration,this.trade={...t[46]},this.schedule={quote_sessions:[...t[47].quote_sessions],trade_sessions:[...t[47].trade_sessions]},this.prevTrade={...t[46]},this.subscription=t[48]}updateSymbol(t){var e;super.updateSymbol(t),this.setPath(t.symbol_path||(null==(e=t.trade)?void 0:e.symbol_path)||this.symbol_path),this.isin=t.isin??this.isin,this.international=t.international??this.international,this.symbol_source=t.symbol_source??this.symbol_source,this.symbol_page=t.symbol_page??this.symbol_page,this.category=t.category??this.category,this.trade_exchange=t.trade_exchange??this.trade_exchange,this.cfi=t.cfi??this.cfi,this.industry=t.industry??this.industry,this.country=t.country??this.country,this.currency_base=t.currency_base??this.currency_base,this.currency_profit=t.currency_profit??this.currency_profit,this.currency_margin=t.currency_margin??this.currency_margin,this.currency_base_digits=t.currency_base_digits??this.currency_base_digits,this.currency_profit_digits=t.currency_profit_digits??this.currency_profit_digits,this.currency_margin_digits=t.currency_margin_digits??this.currency_margin_digits,this.symbol_color=t.symbol_color??this.symbol_color,this.color_background=t.color_background??this.color_background,this.point=t.point??this.point,this.symbol_multiply=t.symbol_multiply??this.symbol_multiply,this.ticks_flags=t.ticks_flags??this.ticks_flags,this.ticks_bookdepth=t.ticks_bookdepth??this.ticks_bookdepth,this.ticks_chart_mode=t.ticks_chart_mode??this.ticks_chart_mode,this.trade_flags=t.trade_flags??this.trade_flags,this.trade_spread=t.trade_spread??this.trade_spread,this.trade_spread_balance=t.trade_spread_balance??this.trade_spread_balance,this.trade_tick_value=t.trade_tick_value??this.trade_tick_value,this.trade_tick_size=t.trade_tick_size??this.trade_tick_size,this.trade_contract_size=t.trade_contract_size??this.trade_contract_size,this.trade_gtc_mode=t.trade_gtc_mode??this.trade_gtc_mode,this.trade_price_settle=t.trade_price_settle??this.trade_price_settle,this.trade_price_limit_min=t.trade_price_limit_min??this.trade_price_limit_min,this.trade_price_limit_max=t.trade_price_limit_max??this.trade_price_limit_max,this.trade_price_strike=t.trade_price_strike??this.trade_price_strike,this.trade_option_mode=t.trade_option_mode??this.trade_option_mode,this.trade_face_value=t.trade_face_value??this.trade_face_value,this.trade_accrued_interest=t.trade_accrued_interest??this.trade_accrued_interest,this.time_flags=t.time_flags??this.time_flags,this.time_start=t.time_start??this.time_start,this.trade={...t.trade},this.prevTrade={...t.trade},this.trade={...t.trade??this.trade},this.schedule={quote_sessions:[...t.schedule.quote_sessions],trade_sessions:[...t.schedule.trade_sessions]},this.subscription=t.subscription??this.subscription}cacheTradeSettings(){const{trade:t}=this;return t&&(this.prevTrade={...t}),this}resetTradeSettings(){this.trade&&this.prevTrade&&Object.assign(this.trade,this.prevTrade)}orderRate(t,e){const i=this.trade;let s=0,r=0,a=0;if(i)switch(t){case 0:r=i.margin_rates_initial[0],a=i.margin_rates_maintenance[0];break;case 1:r=i.margin_rates_initial[1],a=i.margin_rates_maintenance[1];break;case 2:r=i.margin_rates_initial[2],a=i.margin_rates_maintenance[2];break;case 4:r=i.margin_rates_initial[4],a=i.margin_rates_maintenance[4];break;case 6:r=i.margin_rates_initial[6],a=i.margin_rates_maintenance[6];break;case 3:r=i.margin_rates_initial[3],a=i.margin_rates_maintenance[3];break;case 5:r=i.margin_rates_initial[5],a=i.margin_rates_maintenance[5];break;case 7:r=i.margin_rates_initial[7],a=i.margin_rates_maintenance[7];break;default:r=0,a=0}else r=0,a=0;return s=e?r:a||r,s}isLargeLeg(){return Boolean(4&this.trade.margin_flags)}isMarginExcludePL(){return Boolean(8&this.trade.margin_flags)}isNegativePrices(){return Boolean(8&this.ticks_flags)}isTradeEnabled(){const{trade:t}=this;return!!t&&0!==t.trade_mode&&(64!==this.trade_calc_mode||3===t.trade_mode)}isOrderEnabled(t){const{trade:e}=this;return!!e&&!!(e.trade_order_flags&t)}isSubscribed(){return 2===this.subscription.status}isUnsubscribed(){return 1===this.subscription.status}isDelayed(){return vc(this,Ot,xt).call(this)&&0===this.subscription.level}isChartByLast(){return 1===this.ticks_chart_mode||255===this.ticks_chart_mode}hasBook(){const{trade:t}=this;return!t||void 0===t.permissions_flags||!!(1&t.permissions_flags)}hasInitialMargin(){var t;return Boolean((null==(t=this.trade)?void 0:t.margin_initial)&&this.trade.margin_maintenance&&this.trade.margin_initial!==this.trade.margin_maintenance)}}Ot=new WeakSet,xt=function(){return 1===this.subscription.status||2===this.subscription.status};class ch{constructor(){fc(this,At,new Map),fc(this,Pt,[]),fc(this,Et,[]),fc(this,$t,new Map)}clearStorage(){bc(this,At,new Map),bc(this,$t,new Map),bc(this,Pt,[]),bc(this,Et,[])}addShort(t,e=!1){const i=yc(this,At).has(t.trade_symbol);yc(this,At).set(t.trade_symbol,t);let s=yc(this,$t).get(t.path_category);s||(s=[],yc(this,$t).set(t.path_category,s)),s.push(t),i&&e&&this.sortRecords()}addFull(t,e=!1){const i=yc(this,At).has(t.trade_symbol);yc(this,At).set(t.trade_symbol,t);let s=yc(this,$t).get(t.path_category);s||(s=[],yc(this,$t).set(t.path_category,s)),s.push(t),t.setPath(t.trade.symbol_path),i&&e&&this.sortRecords()}concatSymbols(t){t&&t.forEach((t=>this.addShort(t))),this.sortRecords()}updateSymbol(t){const e=t.trade_symbol;if(e){const i=this.getByName(e);if(!i)return this.addFull(t),!0;!(i instanceof nh)&&t instanceof nh?this.addFull(t,!0):i.updateSymbol(t)}return!1}sortRecords(){bc(this,Pt,[...yc(this,At).values()].sort(lh)),bc(this,Et,[...yc(this,At).values()].sort(hh))}getByName(t){return yc(this,At).get(t)}getFull(t){const e=yc(this,At).get(t);return e instanceof nh?e:null}getById(t){let e=0,i=yc(this,Pt).length;for(;e<=i;){const s=Math.floor(e+(i-e)/2),r=yc(this,Pt)[s]&&yc(this,Pt)[s].symbol_id;if(r===t)return yc(this,Pt)[s];r>t?i=s-1:e=s+1}return null}getFullById(t){let e=0,i=yc(this,Pt).length;for(;e<=i;){const s=Math.floor(e+(i-e)/2),r=yc(this,Pt)[s],a=null==r?void 0:r.symbol_id;if(a===t&&r instanceof nh)return r;a>t?i=s-1:e=s+1}return null}getAllSymbols(){return[...yc(this,At).values()]}allFull(){const t=[];return yc(this,At).forEach((e=>{e instanceof nh&&t.push(e)})),t}getAllByType(t){return yc(this,$t).get(t)||[]}allByName(){return yc(this,Et)&&yc(this,Et).slice()||[]}allById(){return yc(this,Pt)&&yc(this,Pt).slice()||[]}}function lh(t,e){return t.symbol_id>e.symbol_id?1:t.symbol_id<e.symbol_id?-1:0}function hh(t,e){return t.trade_symbol>e.trade_symbol?1:t.trade_symbol<e.trade_symbol?-1:0}function _h(t,e){e.forEach((e=>{uh(e.symbol_path,t.trade.symbol_path)&&dh(e,t)}))}function dh(t,e){e.resetTradeSettings();const{trade:i}=e;if(i){t.spread_diff!==a.INT32_MAX&&(i.spread_diff=t.spread_diff),t.spread_diff_balance!==a.INT32_MAX&&(i.spread_diff_balance=t.spread_diff_balance),t.trade_mode<a.UINT32_MAX&&(i.trade_mode=t.trade_mode),t.trade_stops_level<a.INT32_MAX&&(i.trade_stops_level=t.trade_stops_level),t.trade_freeze_level<a.INT32_MAX&&(i.trade_freeze_level=t.trade_freeze_level),t.trade_exemode<a.UINT32_MAX&&(i.trade_exemode=t.trade_exemode),t.trade_fill_flags!==a.UINT32_MAX&&(i.trade_fill_flags=t.trade_fill_flags),t.trade_time_flags!==a.UINT32_MAX&&(i.trade_time_flags=t.trade_time_flags),t.trade_order_flags!==a.UINT32_MAX&&(i.trade_order_flags=t.trade_order_flags),t.trade_request_flags!==a.UINT32_MAX&&(i.trade_request_flags=t.trade_request_flags),t.trade_request_timeout!==a.UINT32_MAX&&(i.trade_request_timeout=t.trade_request_timeout),t.trade_instant_flags!==a.UINT32_MAX&&(i.trade_instant_flags=t.trade_instant_flags),t.trade_instant_timeout!==a.UINT32_MAX&&(i.trade_instant_timeout=t.trade_instant_timeout),t.trade_instant_slip_profit!==a.UINT32_MAX&&(i.trade_instant_slip_profit=t.trade_instant_slip_profit),t.trade_instant_slip_losing!==a.UINT32_MAX&&(i.trade_instant_slip_losing=t.trade_instant_slip_losing),t.trade_instant_volume&&t.trade_instant_volume!==a.INT64_MAX_UNSIGNED&&(i.trade_instant_volume=t.trade_instant_volume),t.trade_instant_checkmode!==a.UINT32_MAX&&(i.trade_instant_checkmode=t.trade_instant_checkmode),t.trade_market_flags!==a.UINT32_MAX&&(i.trade_market_flags=t.trade_market_flags),t.trade_exchange_flags!==a.UINT32_MAX&&(i.trade_exchange_flags=t.trade_exchange_flags),t.volume_min&&t.volume_min!==a.INT64_MAX_UNSIGNED&&(i.volume_min=t.volume_min),t.volume_max&&t.volume_max!==a.INT64_MAX_UNSIGNED&&(i.volume_max=t.volume_max),t.volume_step&&t.volume_step!==a.INT64_MAX_UNSIGNED&&(i.volume_step=t.volume_step),t.volume_limit&&t.volume_limit!==a.INT64_MAX_UNSIGNED&&(i.volume_limit=t.volume_limit),t.margin_flags!==a.UINT32_MAX&&(i.margin_flags=t.margin_flags),t.margin_initial!==a.FLOAT64_MAX&&(i.margin_initial=t.margin_initial),t.margin_maintenance!==a.FLOAT64_MAX&&(i.margin_maintenance=t.margin_maintenance);for(let e=0;e<t.margin_rates_initial.length;e++)t.margin_rates_initial[e]!==a.FLOAT64_MAX&&(i.margin_rates_initial[e]=t.margin_rates_initial[e]);for(let e=0;e<t.margin_rates_maintenance.length;e++)t.margin_rates_maintenance[e]!==a.FLOAT64_MAX&&(i.margin_rates_maintenance[e]=t.margin_rates_maintenance[e]);for(let e=0;e<t.swap_rates.length;e++)t.swap_rates[e]!==a.FLOAT64_MAX&&(i.swap_rates[e]=t.swap_rates[e]);t.margin_rate_liquidity!==a.FLOAT64_MAX&&(i.margin_rate_liquidity=t.margin_rate_liquidity),t.margin_hedged!==a.FLOAT64_MAX&&(i.margin_hedged=t.margin_hedged),t.margin_rate_currency!==a.FLOAT64_MAX&&(i.margin_rate_currency=t.margin_rate_currency),t.swap_mode<a.UINT32_MAX&&(i.swap_mode=t.swap_mode),t.swap_long!==a.FLOAT64_MAX&&(i.swap_long=t.swap_long),t.swap_short!==a.FLOAT64_MAX&&(i.swap_short=t.swap_short),t.swap_rollover3days!==a.INT32_MAX&&(i.swap_rollover3days=t.swap_rollover3days),t.permissions_flags<a.UINT32_MAX&&(i.permissions_flags=t.permissions_flags),t.permissions_bookdepth!==a.UINT32_MAX&&(i.permissions_bookdepth=t.permissions_bookdepth)}}function uh(t,e){if(!t||!e)return!1;const i=t.split(",").map((t=>t.trim()));let s=!1;if(i.length)for(let r=0;r<i.length;r++){const t=i[r];if("!"===t.charAt(0)&&ph(t,e))return!1;ph(t,e)&&(s=!0)}return s}function ph(t,e){let i=t,s=e;if(!i||!s)return!1;for(;"!"===i[0];)i=i.substring(1);let r=!1,a="",o="";for(;i&&"*"===i[0];)r=!0,a=i,i=i.substring(1);for(;s.length&&i.length;)if(s[0]===i[0]){for(;i.length&&s.length;){if("*"===i[0]){o=`_${s}`;break}if(s[0]!==i[0]){if(!r)return!1;i=a;break}o||(o=s),i=i.substring(1),s=s.substring(1)}if(!i.length&&!s.length)return!0;if(!i.length){if(!r)return!1;i=a}if(!s.length){if(i.length&&"*"!==i[0])return!1;for(;i.length&&"*"===i[0];)i=i.substring(1);return 0===i.length}for(;i.length&&"*"===i[0];)a=i,i=i.substring(1);if(!i.length)return!0;r=!0,s=o,o="",s=s.substring(1)}else{if(!r)return!1;s=s.substring(1)}return!i.length}At=new WeakMap,Pt=new WeakMap,Et=new WeakMap,$t=new WeakMap;const mh={applyConfig:_h,upgrade:function(t,e){return t.forEach((t=>{_h(t,e)})),!0},apply:dh,check:uh,checkMask:ph};class gh{constructor(t,e,i,s){fc(this,Nt),fc(this,Dt,new ch),fc(this,qt),fc(this,Ft),fc(this,Rt),fc(this,Vt,(t=>{const e=yc(this,Ft).getAccount(),i=[];null==t||t.forEach((t=>{const s=new nh(t);i.push(s.trade_symbol),yc(this,Dt).updateSymbol(s);const r=yc(this,Dt).getFull(s.trade_symbol);return r&&mh.applyConfig(r,e.trade_settings),s})),yc(this,Nt).trigger(17,i)})),fc(this,Ut,(()=>{const t=yc(this,Ft).getAccount();mh.upgrade(this.getAllFullSymbols(),t.trade_settings)})),bc(this,Nt,t),bc(this,qt,e),bc(this,Ft,i),bc(this,Rt,s),yc(this,qt).on(yc(this,Vt)),yc(this,Nt).on(14,yc(this,Ut))}async init(){this.destroy();const t=yc(this,Ft).getAccount(),e=await yc(this,qt).loadSymbols(t.symbols_count>256);this.onList(e)}destroy(){yc(this,Dt).clearStorage()}async loadConfig(t){if(!t.length)return;const e=await yc(this,qt).loadFullSymbols(t),i=yc(this,Ft).getAccount();e&&e.forEach((t=>{const e=new nh(t);yc(this,Dt).updateSymbol(e);const s=yc(this,Dt).getFull(e.trade_symbol);return s&&mh.applyConfig(s,i.trade_settings),e}))}onList(t){const e=t.map((t=>new oh(t)));yc(this,Dt).concatSymbols(e),yc(this,Rt).calcCounts(e)}getSymbolByName(t){return yc(this,Dt).getByName(t)}getFullSymbolByName(t){return yc(this,Dt).getFull(t)}getSymbolById(t){return yc(this,Dt).getById(t)}getFullSymbolById(t){return yc(this,Dt).getFullById(t)}getAllSymbols(){return yc(this,Dt).getAllSymbols()}getAllFullSymbols(){return yc(this,Dt).allFull()}getSymbolsByType(t){return yc(this,Dt).getAllByType(t)}getAllSymbolsByName(){return yc(this,Dt).allByName()}}function yh(t,e){const i=t.toString();if(i.length<=e)return a.normalize(parseFloat(`0.${i.padStart(e,"0")}`),e);const s=i.length-e;return a.normalize(parseFloat(`${i.substring(0,s)}.${i.substring(s)}`),e)}Nt=new WeakMap,Dt=new WeakMap,qt=new WeakMap,Ft=new WeakMap,Rt=new WeakMap,Vt=new WeakMap,Ut=new WeakMap;class fh{static toDouble(t){return yh(t,8)}static toSize(t,e){return a.normalize(fh.toDouble(t)*e,8)}static toInt(t){const e=a.normalize(t,8).toFixed(8).split(".").join("");return BigInt(e)}static toDigits(t){let e=fh.toDouble(t);e=a.normalize(e,8);let i=e.toFixed(8);const s=i.indexOf(".");if(-1!==s){for(i=i.substring(s+1).split("").reverse();i.length&&"0"===i[0];)i.splice(0,1);return i.length}return 0}static toNewPrice(t){return BigInt(t)*BigInt(1e8)}}function bh(t,e=!0){if(e&&t>=1e6){let e=a.normalize(Number(t/1e6),14).toFixed(14);return e=s.trimZeros(e,12),e+="M",e}if(e&&t>=1e3){let e=a.normalize(Number(t/1e3),11).toFixed(11);return e=s.trimZeros(e,9),e+="K",e}let i=a.normalize(t,8).toFixed(8);return i=s.trimZeros(i,6),i}function vh(t,e=!0){return bh(fh.toDouble(t),e)}function wh(t=0,e=0,i=0){let r=a.normalize(t,e+i).toFixed(e+i);return r=s.trimZeros(r,i),r}function kh(t,e){let i=a.normalize(t,e).toFixed(e);return i=s.trimZeros(i,e),i}function Th(t,e){return a.multiplyFloat(t,e)}function Mh(t,e=!1,i=!1,s=!0){if(!t)return"";const r=new Date(t);let a="";return a+=r.getUTCFullYear(),a+=".",a+=(r.getUTCMonth()+1).toString().padStart(2,"0"),a+=".",a+=r.getUTCDate().toString().padStart(2,"0"),e&&(a+=" ",a+=r.getUTCHours().toString().padStart(2,"0"),a+=":",a+=r.getUTCMinutes().toString().padStart(2,"0"),s&&(a+=":",a+=r.getUTCSeconds().toString().padStart(2,"0"),i&&(a+=r.getUTCMilliseconds().toString().padStart(3,"0")))),a}Ht=new WeakMap,Xt=new WeakMap;let Sh=class t{constructor(t,e,i){if(fc(this,Ht),fc(this,Xt),this.stopsLevel=0,this.lotsMin=0,this.lotsMax=0,this.maxInstantVolume=0,this.lotsStep=1,this.swapRates=[],this.id=t.symbol_id,this.symbol=t.trade_symbol,this.description=t.symbol_description,this.digits=t.digits,this.sector=t.sector,this.path=t.symbol_path,this.pathList=t.path_list,this.pathCategory=t.path_category,this.delay=0,bc(this,Xt,i),bc(this,Ht,e),this.currencyBase="",t instanceof nh){this.requestTimeout=t.trade.trade_request_timeout,this.requoteTimeout=t.trade.trade_instant_timeout,this.ticksBookDepth=t.ticks_bookdepth,this.schedule=t.schedule,this.international=t.international,this.isFull=!0,this.multiply=t.symbol_multiply;const{trade:e}=t;if(this.contractSize=t.trade_contract_size,this.page=t.symbol_page,this.isin=t.isin||"",this.category=t.category||"",this.exchange=t.trade_exchange||"",this.isNegativePrices=t.isNegativePrices(),t.isCollateral()||(t.trade_spread&&t.trade_spread>0?this.spread=t.trade_spread:this.spread="floating",this.stopsLevel=e.trade_stops_level,this.currencyMargin=t.currency_margin,this.currencyBase=t.currency_base),this.currencyProfit=t.currency_profit,this.calcMode=t.trade_calc_mode,this.tradeMode=e.trade_mode,t.isCollateral())this.marginRateLiqudity=e.margin_rate_liquidity,this.tickChartMode=t.ticks_chart_mode;else{if((t.isFuture()||t.isOption())&&(t.basis&&(this.basis=t.basis),this.tradePriceLimitMin=t.trade_price_limit_min,this.tradePriceLimitMax=t.trade_price_limit_max),t.isOption()&&(this.optionType=function(t){switch(t){case 0:case 2:return"Call";case 1:case 3:return"Put";default:return""}}(t.trade_option_mode),this.optionMode=function(t){switch(t.trade_option_mode){case 0:case 1:return"European";case 2:case 3:return"American";default:return""}}(t),this.priceStrike=t.trade_price_strike),t.isForex()||(this.tickSize=t.trade_tick_size,"number"==typeof t.trade_tick_value&&(this.tickValue=kh(t.trade_tick_value,8))),t.isBond()&&(t.trade_face_value&&t.trade_face_value>0&&(this.faceValue=Number(t.trade_face_value.toFixed(t.currency_base_digits))),t.trade_accrued_interest&&t.trade_accrued_interest>0&&(this.accruedInterest=Number(t.trade_accrued_interest.toFixed(t.currency_base_digits)))),e.margin_initial>0&&(this.marginInitial=kh(e.margin_initial,8)),e.margin_maintenance>0&&(this.marginMaintenance=kh(e.margin_maintenance,8)),yc(this,Xt)&&(4&e.margin_flags?this.marginLargeLeg=!0:e.margin_hedged>0&&(this.marginHedged=kh(e.margin_hedged,8))),this.chartMode=t.ticks_chart_mode,this.marginRate=function(t){switch(t){case 0:return"By bid price";case 1:return"By last price";case 255:return"By default";default:return""}}(t.ticks_chart_mode),e.margin_rate_liquidity>0&&(this.trade=e.trade_mode),e.trade_mode>0){switch(this.isRequestExecution=0===e.trade_exemode,this.isInstantExecution=1===e.trade_exemode,this.isMarketExecution=2===e.trade_exemode,this.isExchangeExecution=3===e.trade_exemode,this.gtc=function(t){switch(t){case 0:return"Good till cancelled";case 1:return"Good till today including SL/TP";case 2:return"Good till today excluding SL/TP";default:return""}}(t.trade_gtc_mode),this.isFillingFOK=Boolean(e.trade_fill_flags&Zc.FOK),this.isFillingIOC=Boolean(e.trade_fill_flags&Zc.IOC),this.isFillingBOC=Boolean(e.trade_fill_flags&Zc.BOC),e.trade_fill_flags&Zc.ALL){case Zc.NONE:this.filling="None";break;case Zc.ALL:this.filling="All";break;default:this.filling=[Zc.FOK,Zc.IOC,Zc.BOC].filter((t=>e&&e.trade_fill_flags&t)).map((t=>function(t){switch(t){case Zc.NONE:return"None";case Zc.ALL:return"All";case Zc.FOK:return"Fill or Kill";case Zc.IOC:return"Immediate or Cancel";case Zc.BOC:return"Book or Cancel";default:return""}}(t))).join(",")}switch(this.isGTCExpiration=Boolean(e.trade_time_flags&Qc.GTC),this.isDayExpiration=Boolean(e.trade_time_flags&Qc.DAY),this.isSpecifiedExpiration=Boolean(e.trade_time_flags&Qc.SPECIFIED),this.isSpecifiedDayExpiration=Boolean(e.trade_time_flags&Qc.SPECIFIED_DAY),e.trade_time_flags&Qc.ALL){case Qc.NONE:this.expiration="None";break;case Qc.ALL:this.expiration="All";break;default:this.expiration=[Qc.GTC,Qc.DAY,Qc.SPECIFIED,Qc.SPECIFIED_DAY].filter((t=>e&&e.trade_time_flags&t)).map((t=>function(t){switch(t){case Qc.GTC:return"GTC";case Qc.DAY:return"Today";case Qc.SPECIFIED:return"Specified";case Qc.SPECIFIED_DAY:return"Specified day";default:return""}}(t))).join(", ")}switch(e.trade_order_flags&tl.ALL){case tl.NONE:this.orders="None";break;case tl.ALL:this.orders="All";break;default:this.orders=[tl.MARKET,tl.LIMIT,tl.STOP,tl.STOP_LIMIT,tl.SL,tl.TP].filter((t=>e&&e.trade_order_flags&t)).map((t=>function(t){switch(t){case tl.MARKET:return"Market";case tl.LIMIT:return"Limit";case tl.STOP:return"Stop";case tl.STOP_LIMIT:return"Stop Limit";case tl.SL:return"Stop Loss";case tl.TP:return"Take Profit";default:return""}}(t))).join(",")}(null==e?void 0:e.trade_order_flags)&&(e.trade_order_flags&tl.MARKET&&(this.isOrderMarketAllowed=!0),e.trade_order_flags&tl.LIMIT&&(this.isOrderLimitAllowed=!0),e.trade_order_flags&tl.STOP&&(this.isOrderStopAllowed=!0),e.trade_order_flags&tl.STOP_LIMIT&&(this.isOrderStopLimitAllowed=!0),e.trade_order_flags&tl.SL&&(this.isOrderSlAllowed=!0),e.trade_order_flags&tl.TP&&(this.isOrderTpAllowed=!0)),this.lotsMin=fh.toDouble(e.volume_min),this.lotsMax=fh.toDouble(e.volume_max),this.maxInstantVolume=fh.toDouble(e.trade_instant_volume),this.lotsStep=fh.toDouble(e.volume_step),e.volume_limit>0&&(this.lotsLimit=vh(e.volume_limit,!0))}if(e.swap_mode>0){let i=function(t){switch(t.swap_mode){case 1:return"In points";case 2:case 3:case 4:default:return"";case 5:return"In percentage terms, using current price";case 6:return"In percentage terms, using open price";case 7:return"In points, reopen position by close price";case 8:return"In points, reopen position by bid price"}}(e);3===e.swap_mode&&t.currency_margin&&(i=t.currency_margin),2===e.swap_mode&&t.currency_base&&(i=t.currency_base),this.swapType=i,this.swapLong=kh(e.swap_long,8),this.swapShort=kh(e.swap_short,8),e.swap_rollover3days>=0&&e.swap_rollover3days<=7&&(this.swap3Day="Sunday Monday Tuesday Wednesday Thursday Friday Saturday Disabled".split(" ")[e.swap_rollover3days])}t.time_start&&(this.timeStart=Mh(1e3*t.time_start,!0,!1,!1));for(let e=0;e<t.trade.swap_rates.length;e++)this.swapRates.push(t.trade.swap_rates[e]);t.time_expiration&&(this.timeExpiration=Mh(1e3*t.time_expiration,!0,!1,!1))}this.isCollateral=t.isCollateral(),this.isFuture=t.isFuture(),this.isFORTS=t.isFORTS(),this.isOption=t.isOption(),this.isForex=t.isForex(),this.isBond=t.isBond(),this.isTradeEnabled=t.isTradeEnabled(),this.isCloseByOrderEnabled=t.isOrderEnabled(tl.CLOSEBY),t.isDelayed()&&(this.delay=t.subscription.delay)}}static from(e,i,s){return new t(e,i,s)}isMarketClosed(t=new Date){const{schedule:e}=this;if(e){const i=yc(this,Ht)- -60*t.getTimezoneOffset();let s=new Date(t.getTime());s=new Date(s.getTime()+1e3*i);const r=e.trade_sessions[s.getDay()]||[],a=s.getMinutes()+60*s.getHours();return!r.some((t=>a>=t[0]&&a<t[1]))}return!1}marketOpenTime(){const{schedule:t}=this;if(t){let e;if(!this.isMarketClosed())return 0;const i=yc(this,Ht)/60,s=new Date;s.setUTCMilliseconds(0),s.setUTCSeconds(0);const r=s.getUTCMinutes()+60*s.getUTCHours(),a=t.trade_sessions;for(let t=0;t<7;t++){const o=a[s.getUTCDay()];if(o)if(0===t){if(e=o.find((t=>t[0]-i>r)),e)return s.setUTCHours(Math.floor((e[0]-i)/60)),s.setUTCMinutes(e[0]-i-60*s.getUTCHours()),s.getTime()}else if(e=o.find((t=>t[0]-i>=0&&t[1]-i>=0)),e)return s.setUTCHours(Math.floor((e[0]-i)/60)),s.setUTCMinutes(e[0]-i-60*s.getUTCHours()),s.getTime();s.setUTCDate(s.getUTCDate()+1)}}return 0}};class zh{constructor(t,e){fc(this,jt),fc(this,Gt),bc(this,jt,t),bc(this,Gt,e)}async get(t){const e=yc(this,jt).getSymbolByName(t),i=yc(this,Gt);if(e){if(e instanceof nh)return new Promise((t=>{t(Sh.from(e,i.getServerOffsetTime(),i.isExchangeMargin()))}));await yc(this,jt).loadConfig([e.symbol_id]);const s=yc(this,jt).getSymbolByName(t);if(s)return new Sh(s,i.getServerOffsetTime(),i.isExchangeMargin())}return new Promise((t=>{t(null)}))}all(){const t=yc(this,Gt);return yc(this,jt).getAllSymbols().map((e=>Sh.from(e,t.getServerOffsetTime(),t.isExchangeMargin())))}async getMany(t){const e=[],i=[],s=[];t.forEach(((t,r)=>{const a=yc(this,jt).getSymbolByName(t);a&&(a instanceof nh?i.push(a):(i.push(null),s.push({idx:r,symbol:t}),e.push(a.symbol_id)))})),e.length&&(await yc(this,jt).loadConfig(e),s.forEach((({idx:t,symbol:e})=>{const s=yc(this,jt).getSymbolByName(e);s&&s instanceof nh&&(i[t]=s)})));const r=[];for(let a=0;a<i.length;a++){const t=i[a];null!==t&&r.push(new Sh(t,yc(this,Gt).getServerOffsetTime(),yc(this,Gt).isExchangeMargin()))}return r}}jt=new WeakMap,Gt=new WeakMap;const Bh=[{propType:11,propLength:64},{propType:11,propLength:128},{propType:6},{propType:6},{propType:11,propLength:256},{propType:6},{propType:11,propLength:64},{propType:5}],Ch=Ec.getSeriesSize(Bh);function Wh(t,e=0){return Ec.parse(t,Bh,e)}function Ih(t){const e=[],i=new DataView(t).getUint32(0,!0);let s=4;for(let r=0;r<i;r++)e.push(Wh(t,s)),s+=Ch;return e}const Lh=[{propType:5},{propType:5}],Oh=Ec.getSeriesSize(Lh);function xh(t,e=0){return function(t,e=0){return Ec.parse(t,Lh,e)}(t,e)}const Ah=16*Oh*7*2,Ph=[{propType:6},{propType:4},{propType:4},{propType:5}],Eh=Ec.getSeriesSize(Ph),$h=[{propType:11,propLength:64},{propType:11,propLength:32},{propType:11,propLength:128},{propType:11,propLength:128},{propType:11,propLength:64},{propType:11,propLength:64},{propType:11,propLength:512},{propType:11,propLength:128},{propType:11,propLength:128},{propType:11,propLength:16},{propType:5},{propType:5},{propType:11,propLength:8},{propType:11,propLength:32},{propType:11,propLength:32},{propType:11,propLength:32},{propType:6},{propType:6},{propType:6},{propType:6},{propType:6},{propType:6},{propType:8},{propType:8},{propType:6},{propType:6},{propType:6},{propType:6},{propType:6},{propType:3},{propType:3},{propType:8},{propType:8},{propType:8},{propType:6},{propType:6},{propType:8},{propType:8},{propType:8},{propType:8},{propType:6},{propType:8},{propType:8},{propType:6},{propType:3},{propType:3},{propType:12,propLength:cl,parser:ll},{propType:12,propLength:Ah,parser:function(t,e=0){let i=e;const s={quote_sessions:[],trade_sessions:[]};for(let r=0;r<7;r++){s.quote_sessions[r]=[];for(let e=0;e<16;e++)s.quote_sessions[r][e]=xh(t,i),i+=Oh}for(let r=0;r<7;r++){s.trade_sessions[r]=[];for(let e=0;e<16;e++)s.trade_sessions[r][e]=xh(t,i),i+=Oh}return s}},{propType:12,propLength:Eh,parser:function(t,e){const i=Ec.parse(t,Ph,e);return{delay:i[0],status:i[1],level:i[2],reserved:i[3]}}}],Nh=Ec.getSeriesSize($h);function Dh(t,e=0){return Ec.parse(t,$h,e)}class qh extends Rc{constructor(){super(...arguments),fc(this,Kt),fc(this,Yt,new WeakMap)}async loadSymbols(t=!0){return t?vc(this,Kt,Zt).call(this):vc(this,Kt,Jt).call(this)}async loadFullSymbols(t){return function(t){const e=[],i=new DataView(t).getUint32(0,!0);let s=4;for(let r=0;r<i;r++)e.push(Dh(t,s)),s+=Nh;return e}((await this.socket.sendCommand(18,Zl(t))).resBody)}on(t){let e=yc(this,Yt).get(t);return e||(e=vc(this,Kt,Qt).bind(this,t),yc(this,Yt).set(t,e)),this.socket.on(13,e),this}off(t){const e=yc(this,Yt).get(t);return e&&this.socket.off(13,e),this}}Yt=new WeakMap,Kt=new WeakSet,Jt=async function(){return Ih((await this.socket.sendCommand(6)).resBody)},Zt=async function(){const e=await this.socket.sendCommand(34);try{const i=await async function(){return t((()=>import("./DtUlhiPz.js")),[])}(),s=function(t,e){const i=t.slice(4),s=new Uint8Array(i);return e.ungzip(s).buffer}(e.resBody,i);return Ih(s)}catch(i){return vc(this,Kt,Jt).call(this)}},Qt=function(t,e){t(function(t){const e=[],i=Math.floor(t.byteLength/Nh);let s=0;for(let r=0;r<i;r++)e.push(Dh(t,s)),s+=Nh;return e}(e.resBody))};class Fh{constructor(t,e,i,s){this.controller=new gh(t,new qh(e),s,i),this.view=new zh(this.controller,s.getAccount())}}const Rh=[{propType:6},{propType:17},{propType:3},{propType:6},{propType:8},{propType:8},{propType:8},{propType:8},{propType:8},{propType:8},{propType:8},{propType:8},{propType:8},{propType:17},{propType:17},{propType:17},{propType:6},{propType:18},{propType:6},{propType:6},{propType:6},{propType:17},{propType:6},{propType:17},{propType:8},{propType:8},{propType:8},{propType:8},{propType:8},{propType:8},{propType:17},{propType:17},{propType:17},{propType:17},{propType:17},{propType:17},{propType:17},{propType:17},{propType:5}],Vh=Ec.getSeriesSize(Rh);function Uh(t,e=0){const i=Ec.parse(t,Rh,e);return{symbol_id:i[0],fields:i[1],lasttime:1e3*i[2],digits:i[3],bid_last:i[4],bid_high:i[5],bid_low:i[6],ask_last:i[7],ask_high:i[8],ask_low:i[9],last_last:i[10],last_high:i[11],last_low:i[12],vol_last:i[13],vol_high:i[14],vol_low:i[15],trade_deals:i[16],trade_volume:i[17],trade_turnover:i[18],trade_interest:i[19],trade_buy_orders:i[20],trade_buy_volume:i[21],trade_sell_orders:i[22],trade_sell_volume:i[23],price_open:i[24],price_close:i[25],price_aw:i[26],price_change:i[27],price_volatility:i[28],price_theoretical:i[29],lasttime_msc:i[30],price_greeks_delta:i[31],price_greeks_theta:i[32],price_greeks_gamma:i[33],price_greeks_vega:i[34],price_greeks_rho:i[35],price_greeks_omega:i[36],price_sensitivity:i[37],flags:i[38]}}class Hh extends Rc{constructor(){super(...arguments),fc(this,ee),fc(this,te,new WeakMap)}on(t){let e=yc(this,te).get(t);e||(e=vc(this,ee,ie).bind(this,t),yc(this,te).set(t,e)),this.socket.on(17,e)}off(t){const e=yc(this,te).get(t);e&&this.socket.off(17,e)}}te=new WeakMap,ee=new WeakSet,ie=function(t,e){t(function(t){const e=[],i=Math.floor(t.byteLength/Vh);let s=0;for(let r=0;r<i;r++)e.push(Uh(t,s)),s+=Vh;return e}(e.resBody))};const Xh=[{propType:6},{propType:3},{propType:6},{propType:8},{propType:8},{propType:8},{propType:17},{propType:6},{propType:5}],jh=Ec.getSeriesSize(Xh);function Gh(t,e=0){const i=Ec.parse(t,Xh,e);return{symbol_id:i[0],tick_time:1e3*i[1],fields:i[2],bid:i[3],ask:i[4],last:i[5],tick_volume:i[6],time_ms_delta:i[7],flags:i[8],tick_time_ms:1e3*i[1]+i[7]}}class Yh extends Rc{constructor(){super(...arguments),fc(this,re),fc(this,se,new WeakMap)}subscribe(t){const e=Zl(t);return this.socket.sendCommand(7,e,!1)}on(t){let e=yc(this,se).get(t);e||(e=vc(this,re,ae).bind(this,t),yc(this,se).set(t,e)),this.socket.on(8,e)}off(t){const e=yc(this,se).get(t);e&&this.socket.off(8,e)}}se=new WeakMap,re=new WeakSet,ae=function(t,e){t(function(t){const e=[],i=Math.floor(t.byteLength/jh);for(let s=0;s<i;s++)e.push(Gh(t,s*jh));return e}(e.resBody))};class Kh{constructor(t){this.tick_time=0,this.tick_time_ms=0,this.m_direction_up=BigInt(0),this.m_direction_down=BigInt(0),this.id=t.id,this.trade_symbol=t.trade_symbol,this.digits=t.digits,this.high=t.high,this.low=t.low,this.bid=t.bid,this.ask=t.ask,this.last_last=t.last_last,this.vol_last=t.vol_last,this.delayed=t.delayed??!1}setTrend(t,e){switch(e){case 0:this.m_direction_up|=t,this.m_direction_down&=~t;break;case 1:this.m_direction_down|=t,this.m_direction_up&=~t;break;default:this.m_direction_up&=~t,this.m_direction_down&=~t}}getTrend(t){return this.m_direction_up&t?0:this.m_direction_down&t?1:2}}class Jh{constructor(){fc(this,oe,new Map),fc(this,ne,new Map),fc(this,ce,new Set),fc(this,le,new Set),fc(this,he,new Map),fc(this,_e,new Map)}setTradeList(t){yc(this,le).clear(),t.forEach((t=>yc(this,le).add(t)))}getTradeList(){return[...yc(this,le)]}signed(t){return Boolean(yc(this,ce).has(t))}setSelect(t,e){e?yc(this,ce).add(t):yc(this,ce).delete(t)}getAllSelected(){return[...yc(this,ce)]}clearStorage(){yc(this,oe).clear(),yc(this,ne).clear(),yc(this,he).clear(),yc(this,ce).clear()}getBySymbol(t,e){return e?yc(this,ne).get(t):yc(this,oe).get(t)}last(t,e=!1){return e?yc(this,_e).get(t):yc(this,he).get(t)}getTickByConfig(t,e=!1){let i;return i=e?yc(this,ne).get(t.trade_symbol):yc(this,oe).get(t.trade_symbol),i||(i=new Kh({trade_symbol:t.trade_symbol,digits:t.digits,id:t.symbol_id,high:0,low:0,bid:0,ask:0,last_last:0,vol_last:BigInt(0),delayed:e}),e?yc(this,ne).set(t.trade_symbol,i):yc(this,oe).set(t.trade_symbol,i)),i}setTick(t,e=!1){e?yc(this,ne).set(t.trade_symbol,t):yc(this,oe).set(t.trade_symbol,t)}getHistoryByConfig(t,e=!1){let i;return i=e?yc(this,_e).get(t):yc(this,he).get(t),i||(i=new Set,e?yc(this,_e).set(t,i):yc(this,he).set(t,i)),i}}function Zh(t,e,i){let s=t;return e&&(s=a.normalize(t/e,0)*e),a.normalize(s,i)}function Qh(t,e,i,s,r,o){let n=r,c=o;if(!t)return{result:!0,bid:n,ask:c};if(!n||!c)return{result:!0,bid:n,ask:c};const l=a.normalize((c-n)/i+t,0);return n=t>0?a.normalize(n-i*(t-Math.trunc(t/2)-e),s):a.normalize(n-i*(t-Math.trunc(t/2)+e),s),c=a.normalize(n+i*l,s),{bid:n,ask:c,result:n<=c}}function t_(t,e,i,s,r){return t>0?a.normalize(r-i*(t-Math.trunc(t/2)-e),s):a.normalize(r-i*(t-Math.trunc(t/2)+e),s)}function e_(t,e,i,s,r){return t>0?a.normalize(r+i*(Math.trunc(t/2)+e),s):a.normalize(r+i*(Math.trunc(t/2)-e),s)}function i_(t,e,i){let s=t;return i?s|=e:s&=~e,s}oe=new WeakMap,ne=new WeakMap,ce=new WeakMap,le=new WeakMap,he=new WeakMap,_e=new WeakMap;class s_{constructor(t,e,i,s,r){fc(this,Te),fc(this,de,0),fc(this,ue,new Map),fc(this,pe),fc(this,me),fc(this,ge),fc(this,ye,new Jh),fc(this,fe),fc(this,be),fc(this,ve,(()=>{const t=new Set,e=new Set;[...yc(this,ye).getAllSelected(),...yc(this,ye).getTradeList()].forEach((i=>{const s=yc(this,fe).getSymbolByName(i);s&&(t.add(s.symbol_id),s instanceof nh||e.add(s.symbol_id))}));const i=[...t],s=[...e];yc(this,me).subscribe(i),yc(this,fe).loadConfig(s)})),fc(this,we,(t=>{vc(this,Te,Me).call(this,t)})),fc(this,ke,(t=>{vc(this,Te,Se).call(this,t)})),bc(this,pe,t),bc(this,me,e),bc(this,ge,i),bc(this,fe,s),bc(this,be,r),bc(this,ve,yc(this,ve).bind(this)),yc(this,me).on(yc(this,we)),yc(this,ge).on(yc(this,ke))}setTradeList(t=[]){yc(this,ye).setTradeList(t),yc(this,be).loadSpreads(t)}destroy(){yc(this,me).off(yc(this,we)),yc(this,ge).off(yc(this,ke)),yc(this,ye).clearStorage(),yc(this,ue).clear()}sign(t){t&&yc(this,fe).getSymbolByName(t)&&(yc(this,ye).signed(t)||(yc(this,ye).setSelect(t,!0),clearTimeout(yc(this,de)),bc(this,de,window.setTimeout(yc(this,ve),500))))}unSign(t){t&&yc(this,ye).signed(t)&&(yc(this,ye).setSelect(t,!1),clearTimeout(yc(this,de)),bc(this,de,window.setTimeout(yc(this,ve),500)))}on(t,e){let i=yc(this,ue).get(t);i||(i=new Set,yc(this,ue).set(t,i)),i.add(e)}off(t,e){if(yc(this,ue).has(t))if(void 0===e)yc(this,ue).delete(t);else{const i=yc(this,ue).get(t);i?i.delete(e):yc(this,ue).delete(t)}}getTick(t,e){return yc(this,ye).getBySymbol(t,e)}getLast(t){yc(this,ye).last(t)}getTicksHistory(t){return yc(this,ye).last(t)}isSigned(t){return yc(this,ye).signed(t)}}function r_(t=0,e=0){return 0===e||t===e?2:t>=e?0:1}function a_(t=BigInt(0),e=BigInt(0)){return e&&e!==t?t>=e?0:1:2}function o_(t,e){switch(t.getTrend(e)){case 1:return-1;case 0:return 1}return 0}function n_(t){const e=t.digits,i=t.ask_last,s=t.bid_last;return i&&s?Math.round((i-s)*10**e):null}de=new WeakMap,ue=new WeakMap,pe=new WeakMap,me=new WeakMap,ge=new WeakMap,ye=new WeakMap,fe=new WeakMap,be=new WeakMap,ve=new WeakMap,we=new WeakMap,ke=new WeakMap,Te=new WeakSet,Me=function(t){t&&t.forEach((t=>{const e=Boolean(512&t.flags),i=t.symbol_id,s=yc(this,fe).getSymbolById(i);if(!s)return;const r=yc(this,ye).getTickByConfig(s,e);if(!r)return;const o=s.digits,n=t.fields;if(r.lasttime_bidask&&t.tick_time_ms<r.lasttime_bidask&&(1&n||2&n))return;if(r.lasttime_last&&t.tick_time_ms<r.lasttime_last&&4&n)return;if(r.tick_time=t.tick_time,r.tick_time_ms=t.tick_time_ms,r.is_state=!1,null==r.fields&&(r.fields=0),r.fields=i_(r.fields,1,!1),r.fields=i_(r.fields,2,!1),r.fields=i_(r.fields,4,!1),r.fields=i_(r.fields,8,!1),1&n&&0!==t.bid){const e=a.toDouble(t.bid,o);s instanceof nh&&s.isChartByLast()||r.setTrend(BigInt(64),r_(e,r.bid_src)),s instanceof nh&&r.price_close&&(r.price_change=(c=r.bid,l=r.price_close,a.normalize((c-l)/l*100,2))),r.setTrend(BigInt(1),r_(e,r.bid_src)),r.bid_src=e,r.lasttime_bidask=t.tick_time_ms,r.fields=i_(r.fields,1,!0)}var c,l;if(2&n&&0!==t.ask){const e=a.toDouble(t.ask,o);s instanceof nh&&s.isChartByLast()||r.setTrend(BigInt(64),r_(e,r.ask_src)),r.setTrend(BigInt(8),r_(e,r.ask_src)),r.ask_src=e,r.lasttime_bidask=t.tick_time_ms,r.fields=i_(r.fields,2,!0)}if(4&n&&0!==t.last){const e=a.toDouble(t.last,o);r.setTrend(BigInt(64),r_(e,r.last_last)),r.last_last=e,r.lasttime_last=t.tick_time_ms,r.fields=i_(r.fields,4,!0)}if(8&n){const e=t.tick_volume;r.setTrend(BigInt(512),a_(e,r.vol_last)),r.vol_last=e,r.fields=i_(r.fields,8,!0)}if(r.bid=(null==r?void 0:r.bid_src)??r.bid,r.ask=(null==r?void 0:r.ask_src)??r.ask,r.last=(null==r?void 0:r.last_last)??r.last,s instanceof nh&&s.trade.spread_diff){const{trade:t}=s,e=Qh(t.spread_diff,t.spread_diff_balance,s.point||0,s.digits,r.bid,r.ask);if(!e.result)return;r.bid=e.bid,r.ask=e.ask}r.bid_last=r.bid,r.ask_last=r.ask;const h=yc(this,ye).getHistoryByConfig(s.trade_symbol,e);if(h&&(h.add({bid:r.bid_last,ask:r.ask_last,last:r.last_last}),h.size>125)){const t=h.values().next();t.done||h.delete(t.value)}yc(this,ye).setTick(r,e),vc(this,Te,ze).call(this,s.trade_symbol,r),yc(this,pe).trigger(0,[s.trade_symbol,e])}))},Se=function(t){t&&t.forEach((t=>{const e=t.symbol_id,i=Boolean(1&t.flags),s=yc(this,fe).getSymbolById(e);if(!(s&&s instanceof nh))return;const r=yc(this,ye).getTickByConfig(s,i),{digits:o}=r,{trade:n}=s,c=t.fields;r.fields=0,r.tick_time=r.tick_time?Math.max(t.lasttime,r.tick_time):t.lasttime;const l=t.lasttime+Number(t.lasttime_msc);if(r.tick_time_ms=r.tick_time_ms?Math.max(l,r.tick_time_ms):l,r.is_state=!0,r.has_stat=!0,c&BigInt(1)){const e=a.toDouble(t.bid_last,o);r.setTrend(BigInt(1),r_(e,r.bid_last)),r.bid_last=e,r.bid_src=e,r.bid=e,r.fields|=1}if(c&BigInt(2)){const e=a.toDouble(t.bid_high,o);r.setTrend(BigInt(2),r_(e,r.bid_high)),r.bid_high=e,n&&n.spread_diff&&(r.bid_high=t_(n.spread_diff,n.spread_diff_balance,s.point||0,s.digits,r.bid_high),r.bid_high<=0&&(r.bid_high=e))}if(c&BigInt(4)){const e=a.toDouble(t.bid_low,o);r.setTrend(BigInt(4),r_(e,r.bid_low)),r.bid_low=e,n&&n.spread_diff&&(r.bid_low=t_(n.spread_diff,n.spread_diff_balance,s.point||0,s.digits,r.bid_low),r.bid_low<=0&&(r.bid_low=e))}if(c&BigInt(8)){const e=a.toDouble(t.ask_last,o);r.setTrend(BigInt(8),r_(e,r.ask_last)),r.ask_last=e,r.ask_src=e,r.ask=e,r.fields|=2}if(c&BigInt(16)){const e=a.toDouble(t.ask_high,o);r.setTrend(BigInt(16),r_(e,r.ask_high)),r.ask_high=e,n&&n.spread_diff&&(r.ask_high=e_(n.spread_diff,n.spread_diff_balance,s.point||0,s.digits,r.ask_high),r.ask_high<=0&&(r.ask_high=e))}if(c&BigInt(32)){const e=a.toDouble(t.ask_low,o);r.setTrend(BigInt(32),r_(e,r.ask_low)),r.ask_low=e,n&&n.spread_diff&&(r.ask_low=e_(n.spread_diff,n.spread_diff_balance,s.point||0,s.digits,r.ask_low),r.ask_low<=0&&(r.ask_low=e))}if(c&BigInt(64)){const e=a.toDouble(t.last_last,o);r.setTrend(BigInt(64),r_(e,r.last_last)),r.last_last=e,r.fields|=4}if(c&BigInt(128)){const e=a.toDouble(t.last_high,o);r.setTrend(BigInt(128),r_(e,r.last_high)),r.last_high=e}if(c&BigInt(256)){const e=a.toDouble(t.last_low,o);r.setTrend(BigInt(256),r_(e,r.last_low)),r.last_low=e}if(c&BigInt(512)&&(r.setTrend(BigInt(512),a_(t.vol_last,r.vol_last)),r.vol_last=t.vol_last,r.fields|=8),c&BigInt(1024)&&(r.setTrend(BigInt(1024),a_(t.vol_high,r.vol_high)),r.vol_high=t.vol_high),c&BigInt(2048)&&(r.setTrend(BigInt(2048),a_(t.vol_low,r.vol_low)),r.vol_low=t.vol_low),c&BigInt(65536)&&(r.trade_deals=t.trade_deals),c&BigInt(131072)&&(r.trade_volume=t.trade_volume),c&BigInt(262144)&&(r.trade_turnover=t.trade_turnover),c&BigInt(524288)&&(r.trade_interest=t.trade_interest),c&BigInt(16384)&&(r.setTrend(BigInt(16384),r_(t.trade_buy_orders,r.trade_buy_orders)),r.trade_buy_orders=t.trade_buy_orders),c&BigInt(4096)&&(r.setTrend(BigInt(4096),a_(t.trade_buy_volume,r.trade_buy_volume)),r.trade_buy_volume=t.trade_buy_volume),c&BigInt(32768)&&(r.setTrend(BigInt(32768),r_(t.trade_sell_orders,r.trade_sell_orders)),r.trade_sell_orders=t.trade_sell_orders),c&BigInt(8192)&&(r.setTrend(BigInt(8192),a_(t.trade_sell_volume,r.trade_sell_volume)),r.trade_sell_volume=t.trade_sell_volume),c&BigInt(1048576)&&(r.setTrend(BigInt(1048576),2),r.price_open=a.toDouble(t.price_open,o)),c&BigInt(2097152)&&(r.setTrend(BigInt(2097152),2),r.price_close=a.toDouble(t.price_close,o)),c&BigInt(4194304)){const e=a.toDouble(t.price_aw,o);r.setTrend(BigInt(4194304),r_(e,r.price_aw)),r.price_aw=e}if(c&BigInt(8388608)){r.price_change=a.toDouble(t.price_change,2);const e=r.price_change<0?1:2;r.setTrend(BigInt(8388608),r.price_change>0?0:e)}if(c&BigInt(16777216)){const e=a.toDouble(t.price_volatility,3);r.setTrend(BigInt(16777216),r_(e,r.price_volatility)),r.price_volatility=e}if(c&BigInt(33554432)){const e=a.toDouble(t.price_theoretical,o);r.setTrend(BigInt(33554432),r_(e,r.price_theoretical)),r.price_theoretical=e}if(c&BigInt(17179869184)){const e=a.toDouble(Number(t.price_greeks_delta),5);r.setTrend(BigInt(17179869184),r_(e,r.price_greeks_delta)),r.price_greeks_delta=e}if(c&BigInt(34359738368)){const e=a.toDouble(Number(t.price_greeks_theta),5);r.setTrend(BigInt(34359738368),r_(e,r.price_greeks_theta)),r.price_greeks_theta=e}if(c&BigInt(68719476736)){const e=a.toDouble(Number(t.price_greeks_gamma),5);r.setTrend(BigInt(68719476736),r_(e,r.price_greeks_gamma)),r.price_greeks_gamma=e}if(c&BigInt(137438953472)){const e=a.toDouble(Number(t.price_greeks_vega),5);r.setTrend(BigInt(137438953472),r_(e,r.price_greeks_vega)),r.price_greeks_vega=e}if(c&BigInt(274877906944)){const e=a.toDouble(Number(t.price_greeks_rho),5);r.setTrend(BigInt(274877906944),r_(e,r.price_greeks_rho)),r.price_greeks_rho=e}if(c&BigInt(549755813888)){const e=a.toDouble(Number(t.price_greeks_omega),5);r.setTrend(BigInt(549755813888),r_(e,r.price_greeks_omega)),r.price_greeks_omega=e}if(c&BigInt(1099511627776)){const e=a.toDouble(Number(t.price_sensitivity),5);r.setTrend(BigInt(1099511627776),r_(e,r.price_sensitivity)),r.price_sensitivity=e}if(r.bid_last&&r.ask_last&&(t.bid_last||t.ask_last)&&n&&n.spread_diff){r.bid_last=r.bid_src,r.ask_last=r.ask_src;const t=Qh(n.spread_diff,n.spread_diff_balance,s.point||0,s.digits,r.bid_last,r.ask_last);t.result&&(r.bid_last=t.bid,r.ask_last=t.ask)}yc(this,ye).setTick(r,i),yc(this,pe).trigger(0,[s.trade_symbol,i])}))},ze=function(t,e){const i=yc(this,ue).get(t);i&&i.forEach((t=>t(e)))};class c_{constructor(t){fc(this,Ce),fc(this,Be),bc(this,Be,t)}getTick(t,e){const i=yc(this,Be).getTick(t,e);return vc(this,Ce,We).call(this,i)}subscribe(t){yc(this,Be).sign(t)}unSubscribe(t){yc(this,Be).unSign(t)}signed(t){return yc(this,Be).isSigned(t)}}Be=new WeakMap,Ce=new WeakSet,We=function(t){if(!t)return null;let e;if(t.tick_time_ms)e=t.tick_time_ms;else{const t=new Date;t.setUTCHours(0),t.setUTCMinutes(0,0,0),e=t.getTime()}return{symbol:t.trade_symbol,time:t.tick_time,timeMs:e,change:t.price_change??0,bid:t.bid??0,bidTrend:o_(t,BigInt(1)),bidLast:t.bid_last??0,bidHigh:t.bid_high??0,bidHighTrend:o_(t,BigInt(2)),bidLow:t.bid_low??0,bidLowTrend:o_(t,BigInt(4)),bidOriginal:t.bid_src??0,ask:t.ask??0,askTrend:o_(t,BigInt(8)),askLast:t.ask_last??0,askHigh:t.ask_high??0,askHighTrend:o_(t,BigInt(16)),askLow:t.ask_low??0,askLowTrend:o_(t,BigInt(32)),askOriginal:t.ask_src??0,last:t.last??0,lastLast:t.last_last||0,lastHigh:t.last_high||0,lastLow:t.last_low||0,lastTrend:o_(t,BigInt(64)),volume:vh(t.vol_last),volumeTrend:o_(t,BigInt(512)),spread:n_(t),fields:t.fields||0,volLast:vh(t.vol_last),delayed:t.delayed,priceOpen:t.price_open??0,priceClose:t.price_close??0,low:t.low??0,high:t.high??0}};class l_{constructor(t,e,i,s){this.controller=new s_(t,new Yh(e),new Hh(e),i,s),this.view=new c_(this.controller)}}class h_{constructor(t,e){fc(this,Ae),fc(this,Ie,new Map),fc(this,Le,new Set),fc(this,Oe),fc(this,xe),bc(this,xe,e),bc(this,Oe,t)}marginSymbol(t){const e=yc(this,Oe).getSymbolByName(t);if(e){const i=yc(this,Oe).getFullSymbolByName(t);return i||yc(this,Oe).loadConfig([e.symbol_id]),i}return null}clearAll(){yc(this,Ie).clear(),yc(this,Le).clear()}rateBuy(t,e,i,s){if(!e||!i)return 0;if(vc(this,Ae,Pe).call(this,e,i))return 1;const r=vc(this,Ae,Ee).call(this,e,i,t,s);if(r)return r;const a=vc(this,Ae,Ee).call(this,e,"USD",t,s),o=vc(this,Ae,Ee).call(this,"USD",i,t,s);return a&&o?o*a:0}rateSell(t,e,i,s){if(!e||!i)return 0;if(vc(this,Ae,Pe).call(this,e,i))return 1;const r=vc(this,Ae,$e).call(this,e,i,t,s);if(r)return r;const a=vc(this,Ae,$e).call(this,e,"USD",t,s),o=vc(this,Ae,$e).call(this,"USD",i,t,s);return a&&o?o*a:0}rateBuyMargin(t,e,i){const s=t.currency_margin;if(!s||!e)return 0;if(vc(this,Ae,Pe).call(this,s,e))return 1;const r=vc(this,Ae,Ne).call(this,s,e,t,i);if(r)return r;const a=vc(this,Ae,Ne).call(this,s,"USD",t,i),o=vc(this,Ae,Ne).call(this,"USD",e,t,i);return a&&o?o*a:0}rateSellMargin(t,e,i){const s=t.currency_margin;if(!s||!e)return 0;if(vc(this,Ae,Pe).call(this,s,e))return 1;const r=vc(this,Ae,De).call(this,s,e,t,i);if(r)return r;const a=vc(this,Ae,De).call(this,s,"USD",t,i),o=vc(this,Ae,De).call(this,"USD",e,t,i);return a&&o?o*a:0}rateBuySell(t,e,i,s){if(!t||!e)return[{rate_buy:0,rate_sell:0},!1];if(vc(this,Ae,Pe).call(this,t,e))return[{rate_buy:1,rate_sell:1},!0];const r=vc(this,Ae,Fe).call(this,t,e,i,s);let[{rate_buy:a,rate_sell:o}]=r;const[n]=r;if(n)return 0!==a&&0!==o?[{rate_buy:a,rate_sell:o},!0]:[{rate_buy:0,rate_sell:0},!1];const[{rate_buy:c,rate_sell:l},h]=vc(this,Ae,Fe).call(this,t,"USD",i,s);if(h){const[{rate_buy:t,rate_sell:r},n]=vc(this,Ae,Fe).call(this,"USD",e,i,s);if(n)return a=c*t,o=l*r,0!==a&&0!==o?[{rate_buy:a,rate_sell:o},!0]:[{rate_buy:0,rate_sell:0},!1]}return[{rate_buy:0,rate_sell:0},!1]}findBid(t,e=!1){let i=0;if(e&&(i=this.findBidExact(t,!1)),i<=0){const e=vc(this,Ae,qe).call(this,t);e&&(i=this.findBidExact(e,!0))}return i}findAsk(t,e=!1){let i=0;if(e&&(i=vc(this,Ae,Ue).call(this,t,!1)),i<=0){const e=vc(this,Ae,qe).call(this,t);e&&(i=vc(this,Ae,Ue).call(this,e,!0))}return i}findBidExact(t,e){vc(this,Ae,Ge).call(this,t);const[i,s]=this.findPrices(t);return 0===s&&ah(i.calc_mode)?i.bid:(e&&13===s&&yc(this,Le).add(t),0)}marginCurrentPrices(t,e,i){const[s,r]=vc(this,Ae,He).call(this,t);return[s,0===r]}findPrices(t){const e=yc(this,Oe).getSymbolByName(t);if(!e)return[{ask:0,bid:0,last:0,calc_mode:0},13];const i=yc(this,Oe).getFullSymbolByName(t);if(!i)return yc(this,Oe).loadConfig([e.symbol_id]),[{ask:0,bid:0,last:0,calc_mode:0},1e3];const s=yc(this,xe).getTick(i.trade_symbol,!1);return s?[{ask:s.ask,bid:s.bid,last:s.last_last,calc_mode:i.trade_calc_mode},0]:[{ask:0,bid:0,last:0,calc_mode:i.trade_calc_mode},10021]}}Ie=new WeakMap,Le=new WeakMap,Oe=new WeakMap,xe=new WeakMap,Ae=new WeakSet,Pe=function(t,e){if(t===e)return!0;const i=[["RUB","RUR"]];for(let s=0,r=i.length;s<r;s++){const r=i[s];if(r&&-1!==r.indexOf(t)&&-1!==r.indexOf(e))return!0}return!1},Ee=function(t,e,i,s){let[{symbol_name:r,full_name:a},o]=vc(this,Ae,Xe).call(this,t,e,i);if(o){if(s&&i&&i.isForex()&&!(1&i.trade_flags)&&r===i.trade_symbol)return s;const t=this.findAsk(r,a);if(0!==t)return t}if([{symbol_name:r,full_name:a},o]=vc(this,Ae,Xe).call(this,e,t,i),o){if(i&&s&&i.isForex()&&!(1&i.trade_flags)&&r===i.trade_symbol)return 1/s;const t=this.findBid(r,a);if(t>0)return 1/t}return 0},$e=function(t,e,i,s){let[{symbol_name:r,full_name:a},o]=vc(this,Ae,Xe).call(this,t,e,i);if(o){if(i&&s&&i.isForex()&&!(1&i.trade_flags)&&r===i.trade_symbol)return s;const t=this.findBid(r,a);if(t>0)return t}if([{symbol_name:r,full_name:a},o]=vc(this,Ae,Xe).call(this,e,t,i),o){if(i&&s&&i.isForex()&&!(1&i.trade_flags)&&r===i.trade_symbol)return 1/s;const t=this.findAsk(r,a);if(t>0)return 1/t}return 0},Ne=function(t,e,i,s){let[{symbol_name:r,full_name:a},o]=vc(this,Ae,Xe).call(this,t,e,i);if(o){if(s&&i.isForex()&&r===i.trade_symbol)return s;const t=this.findAsk(r,a);if(t>0)return t}if([{symbol_name:r,full_name:a},o]=vc(this,Ae,Xe).call(this,e,t,i),o){if(s&&i.isForex()&&r===i.trade_symbol)return 1/s;const t=this.findBid(r,a);if(t>0)return 1/t}return 0},De=function(t,e,i,s){let[{symbol_name:r,full_name:a},o]=vc(this,Ae,Xe).call(this,t,e,i);if(o){if(s&&i.isForex()&&r===i.trade_symbol)return s;const t=this.findBid(r,a);if(t>0)return t}if([{symbol_name:r,full_name:a},o]=vc(this,Ae,Xe).call(this,e,t,i),o){if(s&&i.isForex()&&r===i.trade_symbol)return 1/s;const t=this.findAsk(r,a);if(t>0)return 1/t}return 0},qe=function(t){const e=yc(this,Ie).get(t);if(e)return e;if(yc(this,Le).has(t))return null;const i=yc(this,Oe).getAllSymbols().filter((e=>vc(this,Ae,je).call(this,t,e)));if(i.sort(((t,e)=>t.trade_symbol>e.trade_symbol?1:t.trade_symbol<e.trade_symbol?-1:0)),i&&i.length){const e=i[0].trade_symbol;return yc(this,Ie).set(t,e),e}return yc(this,Le).add(t),null},Fe=function(t,e,i,s){let[{symbol_name:r,full_name:a},o]=vc(this,Ae,Xe).call(this,t,e,i);if(o){if(i&&s&&i.isForex()&&!(1&i.trade_flags)&&r===i.trade_symbol)return[{rate_buy:s,rate_sell:s},!0];const[{bid_rate:t,ask_rate:e},o]=vc(this,Ae,Re).call(this,r,a);if(o&&0!==t&&0!==e)return[{rate_buy:e,rate_sell:t},!0]}if([{symbol_name:r,full_name:a},o]=vc(this,Ae,Xe).call(this,e,t,i),o){if(i&&s&&i.isForex()&&!(1&i.trade_flags)&&r===i.trade_symbol)return[{rate_buy:1/s,rate_sell:1/s},!0];const[{bid_rate:t,ask_rate:e},o]=vc(this,Ae,Re).call(this,r,a);if(o&&0!==t&&0!==e)return[{rate_buy:1/t,rate_sell:1/e},!0]}return[{rate_buy:0,rate_sell:0},!1]},Re=function(t,e){if(e){const[{bid_rate:e,ask_rate:i},s]=vc(this,Ae,Ve).call(this,t,!1);if(s)return[{bid_rate:e,ask_rate:i},s]}const i=vc(this,Ae,qe).call(this,t);return i?vc(this,Ae,Ve).call(this,i,!0):[{bid_rate:0,ask_rate:0},!1]},Ve=function(t,e){vc(this,Ae,Ge).call(this,t);const i=yc(this,xe).getTick(t,!1);if(i&&0!==i.bid&&0!==i.ask)return[{bid_rate:i.bid,ask_rate:i.ask},!0];yc(this,xe).sign(t);const[{bid:s,ask:r,calc_mode:a},o]=this.findPrices(t);return o&&ah(a)?[{bid_rate:s,ask_rate:r},!0]:(e&&13===o&&yc(this,Le).add(t),[{bid_rate:0,ask_rate:0},!1])},Ue=function(t,e){vc(this,Ae,Ge).call(this,t);const[i,s]=this.findPrices(t);return 0===s&&ah(i.calc_mode)?i.ask:(e&&13===s&&yc(this,Le).add(t),yc(this,xe).sign(t),0)},He=function(t){const[e,i]=this.findPrices(t);return 0===i?[e,0]:yc(this,Oe).getSymbolByName(t)?(yc(this,xe).sign(t),[{ask:0,bid:0,last:0,calc_mode:0},10021]):[{ask:0,bid:0,last:0,calc_mode:0},13]},Xe=function(t,e,i){let s="",r=!1;return t&&e&&i?(s+=t.substring(0,3),s+=e.substring(0,3),i&&i.isForex()&&(r=!0,i.trade_symbol[6]&&(s+=i.trade_symbol.substring(6))),[{symbol_name:s,full_name:r},!yc(this,Le).has(s)]):[{symbol_name:s,full_name:r},!1]},je=function(t,e){return e.isForex()&&0===e.trade_symbol.indexOf(t.substring(0,6))},Ge=function(t){if(!yc(this,Oe).getFullSymbolByName(t)){const e=yc(this,Oe).getSymbolByName(t);e&&yc(this,Oe).loadConfig([e.symbol_id])}yc(this,xe).sign(t)};class __{constructor(t,e){this.controller=new h_(t,e)}}function d_(t,e,i){return Math.abs(t-e)<10**-(i+1)?0:t>e?1:-1}class u_{constructor(t,e){this.account=t,this.prices=e}isFloatingMarginOrder(){return!1}calcTickManager(t,e){return this.calcTick(t,e)}}class p_{constructor(t,e,i,s){this.equity_floating=0,this.margins_exchange=t,this.margins_moex=e,this.margins_option=i,this.margins_retail=s}clearStorage(){this.margins_exchange.clearMarginList(),this.margins_moex.clearMarginList(),this.margins_option.clearMarginList(),this.margins_retail.clearMarginList(),delete this.new_order,delete this.new_position,this.equity_floating=0}}class m_{constructor(t,e){fc(this,Ze),fc(this,Ye),fc(this,Ke),fc(this,Je,[]),bc(this,Ye,t),bc(this,Ke,e),bc(this,Je,[])}clearStorage(){bc(this,Je,[])}addSymbol(t){return!(yc(this,Ke)&&!mh.check(yc(this,Ke).path,t.getPath())||(t.setLeverageRule(yc(this,Ke)),yc(this,Je).push(t),0))}calc(){if(yc(this,Ke)&&yc(this,Ke).tiers.length)switch(yc(this,Ke).range_mode){case 0:return vc(this,Ze,Qe).call(this,yc(this,Ke));case 1:return vc(this,Ze,ti).call(this,yc(this,Ke));case 2:return vc(this,Ze,ei).call(this,yc(this,Ke));case 3:return vc(this,Ze,ii).call(this,yc(this,Ke));default:return 0}const t=yc(this,Ye).currency_digits;return yc(this,Je).reduce(((e,i)=>{const s=i.calc();return a.normalize(e+s,t)}),0)}}function g_(t,e,i,s,r,o,n){let c=s,l=0;for(let h=0;h<t.tiers.length;h++){const e=t.tiers[h];if(e.range_to===a.FLOAT64_MAX||e.range_from===a.FLOAT64_MAX)break;let _=e.range_to-e.range_from;if(_>0){i&&(_=Math.min(i,_)),c<_?(i=_-c,_=c):i=0;const t=r*(_/s),h=o?t*e.margin_rate_initial:t*e.margin_rate_maintenance;if(l=a.normalize(l+h,n),_>=c){c=0;break}c-=_}}if(c){const e=r*(c/s)*(o?t.tiers[t.tiers.length-1].margin_rate_initial:t.tiers[t.tiers.length-1].margin_rate_maintenance);l=a.normalize(l+e,n)}return l}Ye=new WeakMap,Ke=new WeakMap,Je=new WeakMap,Ze=new WeakSet,Qe=function(t){const e=yc(this,Ye);let i,s,r=0,o=0,n=0;yc(this,Je).forEach((t=>{t.calc(),i=fh.toDouble(t.leveragePositionsVolume()),o+=i,n+=t.leveragePositionsMargin(),t.leverageCalcVolume(i)})),o&&n&&(s=vc(this,Ze,si).call(this,t,0,0,o,n,!1,e.currency_digits),r+=a.normalize(r+s,e.currency_digits));let c=0,l=0;yc(this,Je).forEach((t=>{i=fh.toDouble(t.leveragePositionsOrderVolume()),c+=i,l+=t.leveragePositionsOrderMargin(),t.leverageCalcVolume(i)})),c&&l&&(s=vc(this,Ze,si).call(this,t,0,0,c,l,!0,e.currency_digits),r=a.normalize(r+s,e.currency_digits));let h=0,_=0;return yc(this,Je).forEach((t=>{i=fh.toDouble(t.leverageOrdersVolume()),h+=i,_+=t.leverageOrdersMargin(),t.leverageCalcVolume(i)})),h&&_&&(s=vc(this,Ze,si).call(this,t,0,0,h,_,!0,e.currency_digits),r=a.normalize(r+s,e.currency_digits)),r},ti=function(t){const e=yc(this,Ye);let i,s=0;return yc(this,Je).forEach((r=>{r.calc(),r.leveragePositionsVolume()&&r.leveragePositionsMargin()&&(i=g_(t,0,0,fh.toDouble(r.leveragePositionsVolume()),r.leveragePositionsMargin(),!1,e.currency_digits),s=a.normalize(s+i,e.currency_digits)),r.leveragePositionsOrderVolume()&&r.leveragePositionsOrderMargin()&&(i=g_(t,0,0,fh.toDouble(r.leveragePositionsOrderVolume()),r.leveragePositionsOrderMargin(),!0,e.currency_digits),s=a.normalize(s+i,e.currency_digits)),r.leverageOrdersVolume()&&r.leverageOrdersMargin()&&(i=g_(t,0,0,fh.toDouble(r.leverageOrdersVolume()),r.leverageOrdersMargin(),!0,e.currency_digits),s=a.normalize(s+i,e.currency_digits))})),s},ei=function(t){const e=yc(this,Ye);let i,s,r=0,o=0,n=0;yc(this,Je).forEach((t=>{t.calc(),i=t.leveragePositionsValue(),o+=i,n+=t.leveragePositionsMargin(),t.leverageCalcVolume(i)})),o&&n&&(s=vc(this,Ze,si).call(this,t,0,0,o,n,!1,e.currency_digits),r=a.normalize(r+s,e.currency_digits));let c=0,l=0;yc(this,Je).forEach((t=>{i=t.leveragePositionsOrderValue(),c+=i,l+=t.leveragePositionsOrderMargin(),t.leverageCalcVolume(i)})),c&&l&&(s=vc(this,Ze,si).call(this,t,0,0,c,l,!0,e.currency_digits),r=a.normalize(r+s,e.currency_digits));let h=0,_=0;return yc(this,Je).forEach((t=>{i=t.leverageOrdersValue(),h+=i,_+=t.leverageOrdersMargin(),t.leverageCalcVolume(i)})),h&&_&&(s=vc(this,Ze,si).call(this,t,0,0,h,_,!0,e.currency_digits),r=a.normalize(r+s,e.currency_digits)),r},ii=function(t){const e=yc(this,Ye);let i,s=0;return yc(this,Je).forEach((r=>{r.calc(),r.leveragePositionsValue()&&r.leveragePositionsMargin()&&(i=g_(t,0,0,r.leveragePositionsValue(),r.leveragePositionsMargin(),!1,e.currency_digits),s=a.normalize(s+i,e.currency_digits)),r.leveragePositionsOrderValue()&&r.leveragePositionsOrderMargin()&&(i=g_(t,0,0,r.leveragePositionsOrderValue(),r.leveragePositionsOrderMargin(),!0,e.currency_digits),s=a.normalize(s+i,e.currency_digits)),r.leverageOrdersValue()&&r.leverageOrdersMargin()&&(i=g_(t,0,0,r.leverageOrdersValue(),r.leverageOrdersMargin(),!0,e.currency_digits),s=a.normalize(s+i,e.currency_digits))})),s},si=function(t,e,i,s,r,o,n){let c=1;yc(this,Je).forEach(((t,e)=>{if(t.leverageCalcVolume())if(e<yc(this,Je).length-1){const e=t.leverageCalcVolume()/s;t.leverageCalcRateSymbol(e),c-=e}else t.leverageCalcRateSymbol(c);else t.leverageCalcRateSymbol(0)}));let l=s,h=0;for(let _=0;_<t.tiers.length;_++){const e=t.tiers[_];if(e.range_to===a.FLOAT64_MAX||e.range_from===a.FLOAT64_MAX)break;let c=e.range_to-e.range_from;if(c>0){i&&(c=Math.min(i,c)),l<c?(i=c-l,c=l):i=0;const t=r*(c/s);let _=0;if(yc(this,Je).forEach((i=>{if(i.leverageCalcRateSymbol()){const s=t*i.leverageCalcRateSymbol()*(o?e.margin_rate_initial:e.margin_rate_maintenance);_+=s}})),h=a.normalize(h+_,n),c>=l){l=0;break}l-=c}}if(l){const e=o?t.tiers[t.tiers.length-1].margin_rate_initial:t.tiers[t.tiers.length-1].margin_rate_maintenance,i=r*(l/s)*e;h=a.normalize(h+i,n)}return h};class y_{constructor(t,e){fc(this,oi),fc(this,ri),fc(this,ai),bc(this,ri,[]),bc(this,ai,{}),this.leverage_rules=[],this.account=t,this.prices=e,this.leverage_default=new m_(this.account)}at(t){return yc(this,ri)[t]}forEachMargins(t){yc(this,ri).forEach(t)}addMargin(t){yc(this,ri).push(t),yc(this,ai)[t.getName()]=t}getAllMargins(){return[...yc(this,ri)]}getOrCreate(t){if(t)return this.findMargin(t)??vc(this,oi,ni).call(this,t)}createMargin(t){const e=this.createEntity(t);return this.addMargin(e),vc(this,oi,li).call(this,e),e}findMargin(t){return yc(this,ai)[t]??yc(this,ri).find((e=>e.getName()===t))}resetMarginList(){bc(this,ri,[]),bc(this,ai,{}),this.leverage_rules=[],this.leverage_default.clearStorage()}clearMarginList(){this.resetMarginList()}getTotal(){return yc(this,ri).length}calcMargin(){let t=this.leverage_default.calc();for(let e=0;e<this.leverage_rules.length;e++)t=a.normalize(t+this.leverage_rules[e].calc(),this.account.currency_digits);return t}}ri=new WeakMap,ai=new WeakMap,oi=new WeakSet,ni=function(t){const e=this.prices.marginSymbol(t);if(e)return this.createMargin(e)},ci=function(){this.leverage_rules=this.account.rules.map((t=>new m_(this.account,t))),this.leverage_default=new m_(this.account)},li=function(t){!this.leverage_rules.length&&this.account.rules.length&&vc(this,oi,ci).call(this);for(let e=0;e<this.leverage_rules.length;e++)if(this.leverage_rules[e].addSymbol(t))return;this.leverage_default.addSymbol(t)};class f_{constructor(t,e,i){this.leverage_positions_volume=0n,this.leverage_positions_order_volume=0n,this.leverage_positions_price=0,this.leverage_positions_value=0,this.leverage_positions_order_value=0,this.leverage_positions_margin=0,this.leverage_positions_order_margin=0,this.leverage_positions_margin_rate=0,this.leverage_orders_volume=0n,this.leverage_orders_price=0,this.leverage_orders_value=0,this.leverage_orders_margin=0,this.leverage_orders_margin_rate=0,this.leverage_calc_rate_symbol=0,this.leverage_calc_volume=0,this.account=t,this.symbol=e,this.prices=i}getName(){return this.symbol.trade_symbol}getPath(){return this.symbol.symbol_path}basis(){return this.symbol.basis}getId(){return this.symbol.symbol_id}getExpiration(){return this.symbol.time_expiration}orderRate(t,e){return this.symbol.orderRate(t,e)}isCollateral(){return this.symbol.isCollateral()}isLargeLeg(){return this.symbol.isLargeLeg()}isFORTS(){return this.symbol.isFORTS()}isBond(){return this.symbol.isBond()}isMarginExcludePL(){return this.symbol.isMarginExcludePL()}isFloatingLeverage(){return Boolean(this.leverage_rule)}setLeverageRule(t){this.leverage_rule=t}leverageTotalVolume(){return this.leverage_positions_volume+this.leverage_positions_order_volume+this.leverage_orders_volume}leverageTotalMargin(){return this.leverage_positions_margin+this.leverage_positions_order_margin+this.leverage_orders_margin}everageTotalValue(){return this.leveragePositionsValue()+this.leveragePositionsOrderValue()+this.leverageOrdersValue()}leveragePositionsVolume(){return this.leverage_positions_volume}leveragePositionsMargin(){return this.leverage_positions_margin}leveragePositionsValue(){return this.leverage_positions_value||(this.leverage_positions_value=this.leverageCalcValue(this.leverage_positions_volume,this.leverage_positions_margin,this.leverage_positions_price,this.leverage_positions_margin_rate)),this.leverage_positions_value}leveragePositionsOrderVolume(){return this.leverage_positions_order_volume}leveragePositionsOrderMargin(){return this.leverage_positions_order_margin}leveragePositionsOrderValue(){return this.leverage_positions_order_value||(this.leverage_positions_order_value=this.leverageCalcValue(this.leverage_positions_order_volume,this.leverage_positions_order_margin,this.leverage_positions_price,this.leverage_positions_margin_rate)),this.leverage_positions_order_value}leverageOrdersVolume(){return this.leverage_orders_volume}leverageOrdersMargin(){return this.leverage_orders_margin}leverageOrdersValue(){return this.leverage_orders_value||(this.leverage_orders_value=this.leverageCalcValue(this.leverage_orders_volume,this.leverage_orders_margin,this.leverage_orders_price,this.leverage_orders_margin_rate)),this.leverage_orders_value}leverageCalcRateSymbol(t){if("number"!=typeof t)return this.leverage_calc_rate_symbol;this.leverage_calc_rate_symbol=t}leverageCalcVolume(t){if(!t)return this.leverage_calc_volume;this.leverage_calc_volume=t}leverageCalcValue(t,e,i,s){if(!t||!e)return 0;let r=this.calcValue(0,t,fh.toSize(t,this.symbol.trade_contract_size),i),o=1,n=this.account.currency_digits;return this.leverage_rule&&(this.symbol.currency_base!==this.symbol.currency_margin||""!==this.leverage_rule.range_currency&&this.account.account_currency!==this.leverage_rule.range_currency?(o=this.leverage_rule.range_currency[0]?this.prices.rateBuy(this.symbol,this.symbol.currency_base,this.leverage_rule.range_currency):this.prices.rateBuy(this.symbol,this.symbol.currency_base,this.account.account_currency),n=this.leverage_rule.range_currency_digits):o=s),r=a.normalize(r*o,n),r}calcValue(t,e,i,s){const{symbol:r,prices:o}=this;let n=0,c=0,l=0;switch(r.trade_calc_mode){case 0:case 5:n=i;break;case 1:case 33:case 34:r.trade_tick_size&&r.trade_tick_value&&(n=fh.toDouble(e),n=a.normalize(n*s*r.trade_tick_value/r.trade_tick_size,r.currency_base_digits));break;case 2:case 3:case 4:case 32:case 38:case 35:case 36:case 64:n=a.normalize(i*s,r.currency_profit_digits);break;case 37:case 39:n=a.normalize(i*r.trade_face_value*s/100,r.currency_base_digits),l=0===t?o.rateBuy(r,r.currency_base,r.currency_profit):o.rateSell(r,r.currency_base,r.currency_profit),n=a.normalize(n*l,r.currency_profit_digits),c=a.normalize(i*r.trade_accrued_interest,r.currency_profit_digits),n=a.normalize(n+c,r.currency_profit_digits);break;default:n=0}return n}}class b_ extends f_{isProfitEquity(){return 32!==this.symbol.trade_calc_mode&&35!==this.symbol.trade_calc_mode&&36!==this.symbol.trade_calc_mode&&37!==this.symbol.trade_calc_mode&&38!==this.symbol.trade_calc_mode&&39!==this.symbol.trade_calc_mode}}function v_(t,e,i,s,r){let a=0,o=0;const[n]=s.marginCurrentPrices(t,e,i);if(n&&(a=n.last,o=n.ask),a||(a=r),!a&&"_TOD"===t.substring(t.length-4)){const e=`${t.substring(0,t.length-4)}_TOM`,[i]=s.findPrices(e);i&&(a=i.last,o=i.ask)}return o||(o=a),[a,o]}class w_ extends b_{constructor(){super(...arguments),fc(this,hi,0),fc(this,_i,0),fc(this,di,0),fc(this,ui,0n),fc(this,pi,0),fc(this,mi,0),fc(this,gi,0),fc(this,yi,0),fc(this,fi,0),fc(this,bi,a.FLOAT64_MAX),fc(this,vi,0),fc(this,wi,0),fc(this,ki,0),fc(this,Ti,0),fc(this,Mi,0),fc(this,Si,0),fc(this,zi,0),fc(this,Bi,0)}addOrder(t,e){let i=t.order_type,s=t.price_order;if(e&&(1===t.activation_mode&&t.isStop()&&(i=t.isBuy()?0:1),2===t.activation_mode&&t.isStopLimit()&&(i=t.isBuy()?2:3,s=t.price_trigger)),0!==i&&1!==i&&2!==i&&3!==i)return!0;if(yc(this,hi)||([wc(this,hi)._,wc(this,_i)._]=v_(this.symbol.trade_symbol,this.symbol.trade_spread,this.symbol.trade_spread_balance,this.prices,t.price_current)),0===i||2===i){const e=fh.toSize(t.volume_current,t.contract_size);let r=0,o=0;return bc(this,gi,a.normalize(yc(this,gi)+e,8)),o=0===i?yc(this,_i):s,r=this.calcValue(0,t.volume_current,e,o),bc(this,yi,a.normalize(yc(this,yi)+r,this.symbol.currency_base_digits)),o=0===i?yc(this,hi):s<=yc(this,hi)?s:yc(this,hi),r=this.calcValue(0,t.volume_current,e,o),bc(this,fi,a.normalize(yc(this,fi)+r,this.symbol.currency_base_digits)),bc(this,bi,Math.min(yc(this,bi),o)),!0}if(1===i||3===i){const e=fh.toSize(t.volume_current,t.contract_size);let r=0,o=0;return bc(this,vi,a.normalize(yc(this,vi)+e,8)),o=1===i?yc(this,hi):s>=yc(this,hi)?s:yc(this,hi),r=this.calcValue(1,t.volume_current,e,o),bc(this,wi,a.normalize(yc(this,wi)+r,this.symbol.currency_base_digits)),bc(this,ki,Math.max(yc(this,ki),o)),!0}return!1}addPosition(t){return yc(this,hi)||([wc(this,hi)._,wc(this,_i)._]=v_(this.symbol.trade_symbol,this.symbol.trade_spread,this.symbol.trade_spread_balance,this.prices,t.price_close)),bc(this,di,0===t.trade_action?0:1),bc(this,ui,t.trade_volume),bc(this,pi,fh.toSize(t.trade_volume,t.contract_size)),bc(this,mi,this.calcValue(yc(this,di),yc(this,ui),yc(this,pi),yc(this,hi))),!0}calc(){const{account:t}=this;let e=0,i=0,s=0;if(!yc(this,pi)&&!yc(this,gi)&&!yc(this,vi))return 0;const r=this.prices.rateBuy(this.symbol,this.symbol.currency_profit,this.account.account_currency),o=this.prices.rateSell(this.symbol,this.symbol.currency_profit,this.account.account_currency);if(this.symbol.isCollateral()){if(bc(this,Si,0),bc(this,Mi,0),bc(this,Ti,0),bc(this,zi,0),bc(this,Bi,0),0n!==yc(this,ui)){if(0===yc(this,di)){let e=0;e=a.normalize(yc(this,pi)*yc(this,hi),this.account.currency_digits),e*=this.symbol.trade.margin_rate_liquidity,e=a.normalize(e*r,this.account.currency_digits),bc(this,zi,e),t.assets=a.normalize(t.assets+e,this.account.currency_digits),t.collateral=a.normalize(t.collateral+e,this.account.currency_digits)}if(1===yc(this,di)){let e=0;e=a.normalize(yc(this,pi)*yc(this,hi),this.account.currency_digits),e=a.normalize(e*o,this.account.currency_digits),bc(this,Bi,-e),t.liabilities=a.normalize(t.liabilities-e,this.account.currency_digits),t.collateral=a.normalize(t.collateral-e,this.account.currency_digits)}}return yc(this,Ti)}if(yc(this,pi)?(bc(this,Si,this.calcMargin(yc(this,di),yc(this,pi),yc(this,mi),!1)),bc(this,Mi,this.calcMargin(yc(this,di),yc(this,pi),yc(this,mi),!0)),bc(this,Ti,yc(this,Mi)),0===yc(this,di)&&(bc(this,Si,a.normalize(yc(this,Si)*r,this.account.currency_digits)),bc(this,Mi,a.normalize(yc(this,Mi)*r,this.account.currency_digits)),bc(this,Ti,yc(this,Mi)),this.symbol.trade.margin_rate_liquidity&&(bc(this,zi,yc(this,mi)*this.symbol.trade.margin_rate_liquidity),bc(this,zi,a.normalize(yc(this,zi)*r,this.account.currency_digits))),s=yc(this,pi)),1===yc(this,di)&&(bc(this,Si,a.normalize(yc(this,Si)*o,this.account.currency_digits)),bc(this,Mi,a.normalize(yc(this,Mi)*o,this.account.currency_digits)),bc(this,Ti,yc(this,Mi)),bc(this,Bi,a.normalize(yc(this,mi)*o,this.account.currency_digits)),s=-yc(this,pi))):(bc(this,Si,0),bc(this,Mi,0),bc(this,Ti,0),bc(this,zi,0),bc(this,Bi,0)),yc(this,gi))if(s+yc(this,gi)<=0)e=0;else{let t=Math.min(yc(this,bi),yc(this,hi)),i=yc(this,hi);const o=this.symbol.orderRate(0,!0);if(o){if(this.symbol.isBond()){const{trade_face_value:e,trade_accrued_interest:s}=this.symbol;t=e*t/100+s,i=e*i/100+s}e=s*(i-t)+(s+yc(this,gi))*t*o+(yc(this,fi)-yc(this,gi)*t),e=a.normalize(e*r,this.account.currency_digits)}else e=a.normalize(yc(this,yi)*r,this.account.currency_digits)}else e=yc(this,Mi);if(yc(this,vi))if(s-yc(this,vi)>=0)i=0;else{let t=Math.max(yc(this,ki),yc(this,hi)),e=yc(this,hi);const r=this.symbol.orderRate(1,!0);if(r){if(this.symbol.isBond()){const{trade_face_value:i,trade_accrued_interest:s}=this.symbol;t=i*t/100+s,e=i*e/100+s}const n=yc(this,vi);i=-s*(t-e)-(s-n)*t*r+(n*t-yc(this,wi)),i=a.normalize(i*o,this.account.currency_digits)}else i=a.normalize(yc(this,Mi)*o,this.account.currency_digits)}else i=yc(this,Mi);(e||i)&&bc(this,Ti,Math.max(e,i));const n=this.account.currency_digits;return t.margin=a.normalize(t.margin+yc(this,Ti),n),t.margin_initial=a.normalize(t.margin_initial+yc(this,Mi),n),t.margin_maintenance=a.normalize(t.margin_maintenance+yc(this,Si),n),t.assets=a.normalize(t.assets+yc(this,zi),n),t.liabilities=a.normalize(t.liabilities-yc(this,Bi),n),yc(this,Ti)}calcMargin(t,e,i,s){let r=0,o=0;return s?o=this.symbol.trade.margin_initial:(o=this.symbol.trade.margin_initial,this.symbol.trade.margin_maintenance&&(o=this.symbol.trade.margin_maintenance)),r=o>0?o*e/this.symbol.trade_contract_size*this.symbol.orderRate(t,s):i*this.symbol.orderRate(t,s),a.normalize(r,this.symbol.currency_margin_digits)}}hi=new WeakMap,_i=new WeakMap,di=new WeakMap,ui=new WeakMap,pi=new WeakMap,mi=new WeakMap,gi=new WeakMap,yi=new WeakMap,fi=new WeakMap,bi=new WeakMap,vi=new WeakMap,wi=new WeakMap,ki=new WeakMap,Ti=new WeakMap,Mi=new WeakMap,Si=new WeakMap,zi=new WeakMap,Bi=new WeakMap;class k_ extends y_{createEntity(t){return new w_(this.account,t,this.prices)}}class T_ extends b_{constructor(){super(...arguments),fc(this,Ci,0),fc(this,Wi,0),fc(this,Ii,0),fc(this,Li,0n),fc(this,Oi,0),fc(this,xi,0),fc(this,Ai,0),fc(this,Pi,0),fc(this,Ei,0),fc(this,$i,0),fc(this,Ni,0),fc(this,Di,0),fc(this,qi,0),fc(this,Fi,0)}addOrder(t,e){let i=t.order_type,s=t.price_order;if(e&&(1===t.activation_mode&&t.isStop()&&(i=t.isBuy()?0:1),2===t.activation_mode&&t.isStopLimit()&&(i=t.isBuy()?2:3,s=t.price_trigger)),0!==i&&1!==i&&2!==i&&3!==i)return!0;if(yc(this,Ci)||([wc(this,Ci)._,wc(this,Wi)._]=v_(this.symbol.trade_symbol,this.symbol.trade_spread,this.symbol.trade_spread_balance,this.prices,t.price_current)),0===i||2===i){const e=fh.toSize(t.volume_current,t.contract_size);bc(this,Ai,a.normalize(yc(this,Ai)+e,8));let r=0;r=0===i?yc(this,Wi):s;const o=this.calcValue(0,t.volume_current,e,r);return bc(this,Pi,a.normalize(yc(this,Pi)+o,this.symbol.currency_base_digits)),!0}if(1===i||3===i){const e=fh.toSize(t.volume_current,t.contract_size);return bc(this,Ei,a.normalize(yc(this,Ei)+e,8)),!0}return!1}addPosition(t){return yc(this,Ci)||([wc(this,Ci)._,wc(this,Wi)._]=v_(this.symbol.trade_symbol,this.symbol.trade_spread,this.symbol.trade_spread_balance,this.prices,t.price_close)),bc(this,Ii,0===t.trade_action?0:1),bc(this,Li,t.trade_volume),bc(this,Oi,fh.toSize(t.trade_volume,t.contract_size)),bc(this,xi,this.calcValue(yc(this,Ii),yc(this,Li),yc(this,Oi),yc(this,Ci))),!0}calc(){const t=this.account,e=t.currency_digits;let i=0,s=0,r=0;if(!yc(this,Oi)&&!yc(this,Ai)&&!yc(this,Ei))return 0;const o=this.prices.rateBuy(this.symbol,this.symbol.currency_profit,t.account_currency),n=this.prices.rateSell(this.symbol,this.symbol.currency_profit,t.account_currency);if(this.symbol.isCollateral()){if(bc(this,Di,0),bc(this,Ni,0),bc(this,$i,0),bc(this,qi,0),bc(this,Fi,0),0n!==yc(this,Li)){if(0===yc(this,Ii)){let i=0;i=a.normalize(yc(this,Oi)*yc(this,Ci),e),i*=this.symbol.trade.margin_rate_liquidity,i=a.normalize(i*o,e),bc(this,qi,i),t.assets=a.normalize(t.assets+i,e),t.collateral=a.normalize(t.collateral+i,e)}if(1===yc(this,Ii)){let i=0;i=a.normalize(yc(this,Oi)*yc(this,Ci),e),i=a.normalize(i*n,e),bc(this,Fi,-i),t.liabilities=a.normalize(t.liabilities-i,e),t.collateral=a.normalize(t.collateral-i,e)}}return yc(this,$i)}if(yc(this,Oi)?(bc(this,Di,this.calcMarginPosition(0===yc(this,Ii)?0:1,yc(this,Oi),yc(this,xi),!1)),bc(this,Ni,this.calcMarginPosition(0===yc(this,Ii)?0:1,yc(this,Oi),yc(this,xi),!0)),bc(this,$i,yc(this,Ni)),0===yc(this,Ii)&&(bc(this,Di,a.normalize(yc(this,Di)*o,e)),bc(this,Ni,a.normalize(yc(this,Ni)*o,e)),bc(this,$i,yc(this,Ni)),this.symbol.trade.margin_rate_liquidity&&(bc(this,qi,yc(this,xi)*this.symbol.trade.margin_rate_liquidity),bc(this,qi,a.normalize(yc(this,qi)*o,e))),r=yc(this,Oi)),1===yc(this,Ii)&&(bc(this,Di,a.normalize(yc(this,Di)*n,e)),bc(this,Ni,a.normalize(yc(this,Ni)*n,e)),bc(this,$i,yc(this,Ni)),bc(this,Fi,a.normalize(yc(this,xi)*n,e)),r=-yc(this,Oi))):(bc(this,Di,0),bc(this,Ni,0),bc(this,$i,0),bc(this,qi,0),bc(this,Fi,0)),yc(this,Ai))if(r+yc(this,Ai)<=0)i=0;else{const t=this.symbol.orderRate(0,!0);if(t){let e=yc(this,Ci);const{trade_face_value:s,trade_accrued_interest:a}=this.symbol;this.symbol.isBond()&&(e=s*e/100+a),i=(r+yc(this,Ai))*t*e}else i=yc(this,Pi);i=a.normalize(i*o,e)}else i=yc(this,Ni);if(yc(this,Ei))if(r-yc(this,Ei)>=0)s=0;else{let t=yc(this,Ci);const i=this.symbol.orderRate(1,!0);if(this.symbol.isBond()){const{trade_face_value:e,trade_accrued_interest:i}=this.symbol;t=e*t/100+i}s=i?(-r+yc(this,Ei))*i*t:(-r+yc(this,Ei))*t,s=a.normalize(s*n,e)}else s=yc(this,Ni);return(i||s)&&bc(this,$i,Math.max(i,s)),t.margin=a.normalize(t.margin+yc(this,$i),e),t.margin_initial=a.normalize(t.margin_initial+yc(this,Ni),e),t.margin_maintenance=a.normalize(t.margin_maintenance+yc(this,Di),e),t.assets=a.normalize(t.assets+yc(this,qi),e),t.liabilities=a.normalize(t.liabilities-yc(this,Fi),this.account.currency_digits),yc(this,$i)}calcMarginPosition(t,e,i,s){let r=0,o=0;return s?o=this.symbol.trade.margin_initial:(o=this.symbol.trade.margin_initial,this.symbol.trade.margin_maintenance&&(o=this.symbol.trade.margin_maintenance)),r=o>0?o*e/this.symbol.trade_contract_size:this.symbol.orderRate(t,s)?i*this.symbol.orderRate(t,s):1===t?i:0,a.normalize(r,this.account.currency_digits)}calcMargin(t,e,i,s,r){const{symbol:o}=this;let n=0,c=0;switch(r?c=o.trade.margin_initial:(c=o.trade.margin_initial,o.trade.margin_maintenance&&(c=o.trade.margin_maintenance)),o.trade_calc_mode){case 32:case 35:case 36:case 37:case 38:case 39:n=c>0?c*i/o.trade_contract_size:this.calcValue(t,e,i,s)*o.orderRate(t,r);break;default:n=0}return a.normalize(n,o.currency_margin_digits)}}Ci=new WeakMap,Wi=new WeakMap,Ii=new WeakMap,Li=new WeakMap,Oi=new WeakMap,xi=new WeakMap,Ai=new WeakMap,Pi=new WeakMap,Ei=new WeakMap,$i=new WeakMap,Ni=new WeakMap,Di=new WeakMap,qi=new WeakMap,Fi=new WeakMap;class M_ extends y_{createEntity(t){return new T_(this.account,t,this.prices)}}class S_ extends b_{constructor(){super(...arguments),fc(this,Ri,0),fc(this,Vi,0),fc(this,Ui,0),fc(this,Hi,0),fc(this,Xi,0n),fc(this,ji,0),fc(this,Gi,0),fc(this,Yi,0),fc(this,Ki,0),fc(this,Ji,0),fc(this,Zi,0),fc(this,Qi,0),fc(this,ts,0),fc(this,es,0),fc(this,is,0),fc(this,ss,0)}addOrder(t,e=!1){let i=t.order_type,s=t.price_order;if(e&&(1===t.activation_mode&&t.isStop()&&(i=t.isBuy()?0:1),2===t.activation_mode&&t.isStopLimit()&&(i=t.isBuy()?2:3,s=t.price_trigger)),0!==i&&1!==i&&2!==i&&3!==i)return!0;if(0===i||2===i){const e=fh.toSize(t.volume_current,t.contract_size);let r=0,o=0;if(bc(this,Yi,a.normalize(yc(this,Yi)+e,8)),0===i){if(!yc(this,Vi)){const e=v_(this.symbol.trade_symbol,this.symbol.trade_spread,this.symbol.trade_spread_balance,this.prices,t.price_current);bc(this,Vi,e[1])}o=yc(this,Vi)}else o=s;return r=this.calcValue(0,t.volume_current,e,o),bc(this,Ki,a.normalize(yc(this,Ki)+r,this.symbol.currency_base_digits)),!0}if(1===i||3===i){const e=fh.toSize(t.volume_current,t.contract_size);let r=0,o=0;return bc(this,Ji,a.normalize(yc(this,Ji)+e,8)),1===i?(yc(this,Ui)||([wc(this,Ui)._]=v_(this.symbol.trade_symbol,this.symbol.trade_spread,this.symbol.trade_spread_balance,this.prices,t.price_current)),o=yc(this,Ui)):o=s,r=this.calcValue(1,t.volume_current,e,o),bc(this,Zi,a.normalize(yc(this,Zi)+r,this.symbol.currency_base_digits)),!0}return!1}addPosition(t){return yc(this,Ri)||([wc(this,Ri)._,wc(this,Vi)._]=v_(this.symbol.trade_symbol,this.symbol.trade_spread,this.symbol.trade_spread_balance,this.prices,t.price_close)),bc(this,Hi,0===t.trade_action?0:1),bc(this,Xi,t.trade_volume),bc(this,ji,fh.toSize(t.trade_volume,t.contract_size)),bc(this,Gi,this.calcValue(yc(this,Hi),yc(this,Xi),yc(this,ji),yc(this,Ri))),!0}calc(){const{account:t}=this;let e=0,i=0,s=0;if(!yc(this,ji)&&!yc(this,Yi)&&!yc(this,Ji))return 0;const r=this.prices.rateBuy(this.symbol,this.symbol.currency_profit,this.account.account_currency),o=this.prices.rateSell(this.symbol,this.symbol.currency_profit,this.account.account_currency);if(this.symbol.isCollateral()){if(bc(this,es,0),bc(this,ts,0),bc(this,Qi,0),bc(this,is,0),bc(this,ss,0),0n!==yc(this,Xi)){if(0===yc(this,Hi)){let e=0;e=a.normalize(yc(this,ji)*yc(this,Ri),this.account.currency_digits),e*=this.symbol.trade.margin_rate_liquidity,e=a.normalize(e*r,this.account.currency_digits),bc(this,is,e),t.assets=a.normalize(t.assets+e,this.account.currency_digits),t.collateral=a.normalize(t.collateral+e,this.account.currency_digits)}if(1===yc(this,Hi)){let e=0;e=a.normalize(yc(this,ji)*yc(this,Ri),this.account.currency_digits),e=a.normalize(e*o,this.account.currency_digits),bc(this,ss,-e),t.liabilities=a.normalize(t.liabilities-e,this.account.currency_digits),t.collateral=a.normalize(t.collateral-e,this.account.currency_digits)}}return yc(this,Qi)}if(yc(this,ji)?(bc(this,es,this.calcMargin(yc(this,Hi),yc(this,ji),yc(this,Gi),!1)),bc(this,ts,this.calcMargin(yc(this,Hi),yc(this,ji),yc(this,Gi),!0)),bc(this,Qi,yc(this,ts)),0===yc(this,Hi)&&(bc(this,es,a.normalize(yc(this,es)*r,this.account.currency_digits)),bc(this,ts,a.normalize(yc(this,ts)*r,this.account.currency_digits)),bc(this,Qi,yc(this,ts)),this.symbol.trade.margin_rate_liquidity&&(bc(this,is,yc(this,Gi)*this.symbol.trade.margin_rate_liquidity),bc(this,is,a.normalize(yc(this,is)*r,this.account.currency_digits))),s=yc(this,ji)),1===yc(this,Hi)&&(bc(this,es,a.normalize(yc(this,es)*o,this.account.currency_digits)),bc(this,ts,a.normalize(yc(this,ts)*o,this.account.currency_digits)),bc(this,Qi,yc(this,ts)),this.symbol.trade.margin_rate_liquidity&&(bc(this,ss,yc(this,Gi)*this.symbol.trade.margin_rate_liquidity),bc(this,ss,a.normalize(yc(this,ss)*o,this.account.currency_digits))),s=-yc(this,ji))):(bc(this,es,0),bc(this,ts,0),bc(this,Qi,0),bc(this,is,0),bc(this,ss,0)),yc(this,Yi)){const t=s+yc(this,Yi);if(t<=0)e=0;else{let i=0;this.symbol.orderRate(0,!0)?(i=this.calcMargin(0,yc(this,Yi),yc(this,Ki),!0),i=a.normalize(i*r,this.account.currency_digits)):i=a.normalize(yc(this,Ki)*r,this.account.currency_digits),e=s>0?a.normalize(yc(this,Qi)+i,this.account.currency_digits):a.normalize(t*i/yc(this,Yi),this.account.currency_digits)}}else e=yc(this,ts);if(yc(this,Ji)){const t=s-yc(this,Ji);if(t>=0)i=0;else{let e=0;this.symbol.orderRate(1,!0)?(e=this.calcMargin(1,yc(this,Ji),yc(this,Zi),!0),e=a.normalize(e*o,this.account.currency_digits)):e=a.normalize(yc(this,ts)*o,this.account.currency_digits),i=a.normalize(yc(this,Qi)+e,this.account.currency_digits),i=s<0?a.normalize(yc(this,Qi)+e,this.account.currency_digits):a.normalize(-t*e/yc(this,Ji),this.account.currency_digits)}}else i=yc(this,ts);return(e||i)&&bc(this,Qi,Math.max(e,i)),t.margin=a.normalize(t.margin+yc(this,Qi),this.account.currency_digits),t.margin_initial=a.normalize(t.margin_initial+yc(this,ts),this.account.currency_digits),t.margin_maintenance=a.normalize(t.margin_maintenance+yc(this,es),this.account.currency_digits),t.assets=a.normalize(t.assets+yc(this,is),this.account.currency_digits),t.liabilities=a.normalize(t.liabilities-yc(this,ss),this.account.currency_digits),yc(this,Qi)}calcMargin(t,e,i,s){let r=0,o=0;return s?o=this.symbol.trade.margin_initial:(o=this.symbol.trade.margin_initial,this.symbol.trade.margin_maintenance&&(o=this.symbol.trade.margin_maintenance)),r=o>0?o*e/this.symbol.trade_contract_size*this.symbol.orderRate(t,s):i*this.symbol.orderRate(t,s),a.normalize(r,this.account.currency_digits)}}Ri=new WeakMap,Vi=new WeakMap,Ui=new WeakMap,Hi=new WeakMap,Xi=new WeakMap,ji=new WeakMap,Gi=new WeakMap,Yi=new WeakMap,Ki=new WeakMap,Ji=new WeakMap,Zi=new WeakMap,Qi=new WeakMap,ts=new WeakMap,es=new WeakMap,is=new WeakMap,ss=new WeakMap;class z_ extends y_{createEntity(t){return new S_(this.account,t,this.prices)}}function B_(t,e,i,s,r,o,n){let c=0,l=0;switch(o?l=t.trade.margin_initial:(l=t.trade.margin_initial,t.trade.margin_maintenance&&(l=t.trade.margin_maintenance)),t.trade_calc_mode){case 0:c=l>0?l*s/t.trade_contract_size/e:s/e;break;case 5:c=l>0?l*s/t.trade_contract_size:s;break;case 2:case 32:case 38:case 35:case 36:c=l>0?l*s/t.trade_contract_size:s*r;break;case 1:case 33:c=l*s/t.trade_contract_size;break;case 3:l>0?c=l*s/t.trade_contract_size:t.trade_tick_size&&(c=s*r/t.trade_tick_size*t.trade_tick_value);break;case 64:c=0;break;case 4:c=l>0?l*s/t.trade_contract_size/e:s*r/e;break;case 34:if(t.trade_tick_size)switch(i){case 0:{const{trade_contract_size:e,trade_price_settle:i,trade_tick_value:a,trade_tick_size:o,trade_price_limit_max:l,trade:h}=t,{margin_initial:_,margin_rate_currency:d}=h;c=n?s/e*(_+a/o*(r-i)*(1+.01*d)):s/e*(_+a/o*(l-i)*(1+.01*d));break}case 1:{const{trade_contract_size:e,trade_price_settle:i,trade_tick_value:a,trade_tick_size:o,trade_price_limit_min:l,trade:h}=t,{margin_rate_currency:_,margin_maintenance:d}=h;c=n?s/e*(d+a/o*(i-r)*(1+.01*_)):s/e*(d+a/o*(i-l)*(1+.01*_));break}case 2:case 6:{const{trade_contract_size:e,trade_price_settle:i,trade_tick_value:a,trade_tick_size:o,trade:n}=t,{margin_rate_currency:l,margin_initial:h}=n;c=s/e*(h+a/o*(r-i)*(1+.01*l));break}case 3:case 7:{const{trade_contract_size:e,trade_price_settle:i,trade_tick_value:a,trade_tick_size:o,trade:n}=t,{margin_rate_currency:l,margin_maintenance:h}=n;c=s/e*(h+a/o*(i-r)*(1+.01*l));break}case 4:{const{trade_contract_size:e,trade_price_settle:i,trade_tick_value:r,trade_tick_size:a,trade_price_limit_max:o,trade:n}=t,{margin_rate_currency:l,margin_initial:h}=n;c=s/e*(h+r/a*(o-i)*(1+.01*l))}break;case 5:{const{trade_contract_size:e,trade_price_settle:i,trade_tick_value:r,trade_tick_size:a,trade_price_limit_min:o,trade:n}=t,{margin_rate_currency:l,margin_maintenance:h}=n;c=s/e*(h+r/a*(i-o)*(1+.01*l));break}default:c=l*s/t.trade_contract_size}break;case 37:case 39:c=l>0?l*s/t.trade_contract_size:a.normalize(s*t.trade_face_value*r/100,t.currency_base_digits)}return c}class C_ extends b_{constructor(){super(...arguments),fc(this,ws),fc(this,rs),fc(this,as,1),fc(this,os,0),fc(this,ns,0n),fc(this,cs,0),fc(this,ls,0),fc(this,hs,0),fc(this,_s,0),fc(this,ds,0),fc(this,us,0),fc(this,ps,0n),fc(this,ms,0n),fc(this,gs,!1),fc(this,ys,0),fc(this,fs,0n),fc(this,bs,0),fc(this,vs,0)}addOrder(t,e){let i,s=0,r=t.order_type;if(this.symbol.isCollateral())return!1;const o=fh.toSize(t.volume_current,t.contract_size);if(o<=0)return!0;e&&(bc(this,gs,!0),1===t.activation_mode&&(t.isLimit()||t.isStop())&&(r=t.isBuy()?0:1),2===t.activation_mode&&t.isStopLimit()&&(r=t.isBuy()?2:3));const n=this.symbol.orderRate(r,!0);if(n<=0)return!0;let c=t.price_order;return c||0!==r&&1!==r||(c=t.price_current),6!==r&&7!==r||(c=t.price_trigger),0===r||2===r||4===r||6===r?(t.margin_rate?s=t.margin_rate:this.prices.marginSymbol(this.symbol.trade_symbol)&&(s=this.prices.rateBuyMargin(this.symbol,this.account.account_currency,c)),s<=0||(i=B_(this.symbol,yc(this,as),r,o,c,!0,!1),i=s,i=n,bc(this,ds,a.normalize(yc(this,ds)+i,this.account.currency_digits)),bc(this,ps,yc(this,ps)+t.volume_current)),!0):(1===r||3===r||5===r||7===r)&&(t.margin_rate?s=t.margin_rate:this.prices.marginSymbol(this.symbol.trade_symbol)&&(s=this.prices.rateSellMargin(this.symbol,this.account.account_currency,c)),s<=0||(i=B_(this.symbol,yc(this,as),r,o,c,!0,!1),i*=s,i*=n,bc(this,us,a.normalize(yc(this,us)+i,this.account.currency_digits)),bc(this,ms,yc(this,ms)+t.volume_current)),!0)}addPosition(t){let e=0;return t.isBuy()&&bc(this,os,0),t.isSell()&&bc(this,os,1),bc(this,cs,fh.toSize(t.trade_volume,t.contract_size)),bc(this,ls,t.price_open),bc(this,hs,t.price_close),e=B_(this.symbol,yc(this,as),yc(this,os),yc(this,cs),yc(this,ls),!1,!0),e*=t.rate_margin,e*=this.symbol.orderRate(yc(this,os),!1),bc(this,_s,a.normalize(e,this.account.currency_digits)),bc(this,ns,t.trade_volume),!0}calc(){const{account:t}=this;let e=yc(this,ds),i=yc(this,us);if(this.symbol.isCollateral()){let e=0,i=0;if(bc(this,ys,0),bc(this,fs,0n),bc(this,bs,0),bc(this,vs,0),0n!==yc(this,ns)){if(0===yc(this,os)){const i=this.prices.rateBuy(this.symbol,this.symbol.currency_profit,this.account.account_currency),s=vc(this,ws,ks).call(this,yc(this,hs),yc(this,os));e=a.normalize(yc(this,cs)*s,this.account.currency_digits),e*=this.symbol.trade.margin_rate_liquidity,e=a.normalize(e*i,this.account.currency_digits),t.assets=a.normalize(t.assets+e,this.account.currency_digits),t.collateral=a.normalize(t.collateral+e,this.account.currency_digits)}if(1===yc(this,os)){const e=this.prices.rateSell(this.symbol,this.symbol.currency_profit,this.account.account_currency),s=vc(this,ws,ks).call(this,yc(this,hs),yc(this,os));i=a.normalize(yc(this,cs)*s,this.account.currency_digits),i=a.normalize(i*e,this.account.currency_digits),t.liabilities=a.normalize(t.liabilities-i,this.account.currency_digits),t.collateral=a.normalize(t.collateral-i,this.account.currency_digits)}}return yc(this,ys)}if(bc(this,ys,0),0n!==yc(this,ns)){if(0===yc(this,os))if(e+=yc(this,_s),this.symbol.isFORTS()){const t=B_(this.symbol,yc(this,as),1,yc(this,cs),yc(this,ls),!1,!0);i=a.normalize(i-t,this.account.currency_digits)}else yc(this,us)&&yc(this,ms)&&(i-=a.normalize(yc(this,us)/Number(yc(this,ms))*Number(yc(this,ns)),this.account.currency_digits));if(1===yc(this,os))if(i+=yc(this,_s),this.symbol.isFORTS()){const t=B_(this.symbol,yc(this,as),0,yc(this,cs),yc(this,ls),!1,!0);e=a.normalize(e-t,this.account.currency_digits)}else yc(this,ds)&&yc(this,ps)&&(e-=a.normalize(yc(this,ds)/Number(yc(this,ps))*Number(yc(this,ns)),this.account.currency_digits))}bc(this,ys,Math.max(e,i));let s=yc(this,ps),r=yc(this,ms);return bc(this,fs,0n),bc(this,vs,0),bc(this,bs,0),0n!==yc(this,ns)&&(0===yc(this,os)&&(s+=yc(this,ns)),1===yc(this,os)&&(r+=yc(this,ns))),s>r?(bc(this,fs,s),bc(this,bs,0)):s<r?(bc(this,fs,r),bc(this,bs,1)):(bc(this,fs,s),bc(this,bs,yc(this,os))),yc(this,fs)?bc(this,vs,yc(this,ys)/Number(yc(this,fs))):bc(this,vs,0),t.liabilities=a.normalize(t.liabilities-yc(this,ys),this.account.currency_digits),yc(this,ys)}checkNew(t,e,i){const{account:s}=this;if((i.isBuy()&&e.isSell()||i.isSell()&&e.isBuy())&&i.trade_volume&&e.volume_current){const r=i.trade_volume-e.volume_current;if((r>=0||a.bMath.abs(r)<i.trade_volume)&&t.margin<=s.margin)return!0}return!1}spreadLeg(t){return t&&bc(this,rs,t),yc(this,rs)}getVolume(){return yc(this,fs)}}rs=new WeakMap,as=new WeakMap,os=new WeakMap,ns=new WeakMap,cs=new WeakMap,ls=new WeakMap,hs=new WeakMap,_s=new WeakMap,ds=new WeakMap,us=new WeakMap,ps=new WeakMap,ms=new WeakMap,gs=new WeakMap,ys=new WeakMap,fs=new WeakMap,bs=new WeakMap,vs=new WeakMap,ws=new WeakSet,ks=function(t,e){return t||(0===e?this.prices.findBid(this.symbol.trade_symbol):1===e?this.prices.findAsk(this.symbol.trade_symbol):0)};class W_ extends y_{createEntity(t){return new C_(this.account,t,this.prices)}}class I_ extends u_{constructor(t,e){super(t,e),fc(this,Ms),fc(this,Ts),bc(this,Ts,new p_(new k_(t,e),new M_(t,e),new z_(t,e),new W_(t,e)))}resetCalc(){yc(this,Ts).clearStorage()}isFloatingMarginOrder(){return!0}calcTick(t,e){this.calcAccount(t,e)}calcAccount(t,e,i,s=!1){const{account:r}=this;r.profit=0,r.storage_=0,r.margin=0,r.margin_level=0,r.margin_initial=0,r.margin_maintenance=0,r.floating=0,r.equity=0,r.assets=0,r.liabilities=0,r.collateral=0,r.acc_commission=a.normalize(r.commission_daily+r.commission_monthly,r.currency_digits),yc(this,Ts).clearStorage(),this.collectPositions(t,i),this.collectOrders(e,i,s),vc(this,Ms,Ss).call(this),this.calcFloating()}checkStopOut(){const{account:t}=this;return t.so_activation=0,!(t.margin_maintenance<=0||t.margin<=0)&&t.equity<t.margin_initial&&(t.so_activation=1,t.equity<t.margin_maintenance)&&(t.so_activation=2,!0)}calcFloating(){vc(this,Ms,Bs).call(this),vc(this,Ms,zs).call(this),vc(this,Ms,Cs).call(this)}marginsGet(t){let e=this.marginsFind(t);if(e)return e;const i=this.prices.marginSymbol(t);if(i){switch(i.trade_calc_mode){case 32:case 37:e=yc(this,Ts).margins_exchange.createMargin(i);break;case 38:case 39:e=yc(this,Ts).margins_moex.createMargin(i);break;case 35:case 36:e=yc(this,Ts).margins_option.createMargin(i);break;default:e=yc(this,Ts).margins_retail.createMargin(i)}return e}}marginsFind(t){return yc(this,Ts).margins_exchange.findMargin(t)??yc(this,Ts).margins_moex.findMargin(t)??yc(this,Ts).margins_option.findMargin(t)??yc(this,Ts).margins_retail.findMargin(t)}collectPositions(t,e){const{account:i}=this;t.forEach((t=>{if(!t||0n===t.trade_volume)return;const s=this.marginsGet(t.trade_symbol);s&&s.addPosition(t)&&(s.isCollateral()||(e&&e.trade_symbol===t.trade_symbol&&(yc(this,Ts).new_position=t),i.profit=a.normalize(i.profit+t.profit,i.currency_digits),t.storage_&&(i.storage_=a.normalize(i.storage_+t.storage_,i.currency_digits)),s.isProfitEquity()&&(yc(this,Ts).equity_floating=a.normalize(yc(this,Ts).equity_floating+t.profit,i.currency_digits),t.storage_&&(yc(this,Ts).equity_floating=a.normalize(yc(this,Ts).equity_floating+t.storage_,i.currency_digits)))))})),i.floating=i.profit,i.storage_&&(i.floating=a.normalize(i.floating+i.storage_,i.currency_digits))}collectOrders(t,e,i=!1){const{account:s}=this,r=s.currency_digits,o=Boolean(e);if(t.forEach((t=>{const n=this.marginsGet(t.trade_symbol);if(n)if(e&&e.trade_order===t.trade_order){if(i)return void(e=null);n.addOrder(e,o),0!==d_(t.commission_daily,e.commission_daily,r)&&(s.acc_commission=a.normalize(s.acc_commission+(e.commission_daily-t.commission_daily),r)),0!==d_(t.commission_monthly,e.commission_monthly,r)&&(s.acc_commission=a.normalize(s.acc_commission+(e.commission_monthly-t.commission_monthly),r)),yc(this,Ts).new_order=e,e=null}else n.addOrder(t,o)})),e){const t=this.marginsGet(e.trade_symbol);t&&(t.addOrder(e,o),e.commission_daily&&(s.acc_commission=a.normalize(s.acc_commission+e.commission_daily,r)),e.commission_monthly&&(s.acc_commission=a.normalize(s.acc_commission+e.commission_monthly,r)),yc(this,Ts).new_order=e)}}}Ts=new WeakMap,Ms=new WeakSet,Ss=function(){const{account:t}=this;t.margin=0,t.margin_initial=0,t.margin_maintenance=0,t.assets=0,t.liabilities=0,t.collateral=0,yc(this,Ts).margins_exchange.forEachMargins((t=>t.calc())),yc(this,Ts).margins_moex.forEachMargins((t=>t.calc())),yc(this,Ts).margins_option.forEachMargins((t=>t.calc())),yc(this,Ts).margins_retail.forEachMargins((t=>t.calc()))},zs=function(){const{account:t}=this;t.margin_free=a.normalize(t.equity-t.margin,t.currency_digits)},Bs=function(){const{account:t}=this;t.equity=t.balance,t.equity=a.normalize(t.equity+yc(this,Ts).equity_floating,t.currency_digits),t.credit&&(t.equity=a.normalize(t.equity+t.credit,t.currency_digits)),t.assets&&(t.equity=a.normalize(t.equity+t.assets,t.currency_digits)),t.liabilities&&(t.equity=a.normalize(t.equity+t.liabilities,t.currency_digits)),t.acc_commission&&(t.equity=a.normalize(t.equity+t.acc_commission,t.currency_digits))},Cs=function(){const{account:t}=this;0!==t.margin_maintenance?t.margin_level=t.equity/t.margin_maintenance*100:t.margin_level=0};class L_{constructor(t){this.margins=t}clearStorage(){this.margins.clearMarginList()}}function O_(t){return 0===t||4===t||2===t||6===t}function x_(t){return 1===t||3===t||5===t||7===t}function A_(t){return 0===t||1===t}function P_(t){return 4===t||5===t||2===t||3===t||6===t||7===t}function E_(t){return 2===t||3===t}function $_(t){return 4===t||5===t}function N_(t){return 6===t||7===t}function D_(t){switch(t){case 0:return"buy";case 1:return"sell";case 2:return"buy limit";case 3:return"sell limit";case 4:return"buy stop";case 5:return"sell stop";case 6:return"buy stop limit";case 7:return"sell stop limit";case 8:return"close by";default:return"unknown"}}function q_(t){switch(t){case 0:return"buy";case 1:return"sell";case 2:return"balance";case 3:return"credit";case 4:return"charge";case 5:return"correction";case 6:return"bonus";case 7:return"commission";case 8:return"daily commission";case 9:return"monthly commission";case 10:return"daily agent commission";case 11:return"monthly agent commission";case 12:return"interest rate";case 13:return"canceled buy";case 14:return"canceled sell";case 15:return"dividend";case 16:return"franked dividend";case 17:return"tax";default:return""}}function F_(t){return 0===t}function R_(t){return 1===t}function V_(t){return 2===t||3===t||4===t||5===t||6===t||7===t||8===t||9===t||10===t||11===t||12===t||15===t||16===t||17===t||18===t}function U_(t){return 2===t||3===t||4===t||5===t||6===t||7===t||15===t||16===t||17===t||18===t}class H_ extends f_{constructor(){super(...arguments),fc(this,$s),fc(this,Ws,{volume:0n,volume_orders:0n,price:0,price_close:0,margin_rate:0,order_rate:0}),fc(this,Is,{volume:0n,volume_orders:0n,price:0,price_close:0,margin_rate:0,order_rate:0}),fc(this,Ls,[{volume:0n,volume_orders:0n,price:0,price_close:0,margin_rate:0,order_rate:0},{volume:0n,volume_orders:0n,price:0,price_close:0,margin_rate:0,order_rate:0},{volume:0n,volume_orders:0n,price:0,price_close:0,margin_rate:0,order_rate:0},{volume:0n,volume_orders:0n,price:0,price_close:0,margin_rate:0,order_rate:0},{volume:0n,volume_orders:0n,price:0,price_close:0,margin_rate:0,order_rate:0},{volume:0n,volume_orders:0n,price:0,price_close:0,margin_rate:0,order_rate:0},{volume:0n,volume_orders:0n,price:0,price_close:0,margin_rate:0,order_rate:0},{volume:0n,volume_orders:0n,price:0,price_close:0,margin_rate:0,order_rate:0},{volume:0n,volume_orders:0n,price:0,price_close:0,margin_rate:0,order_rate:0}]),fc(this,Os,0),fc(this,xs,0n),fc(this,As,0n),fc(this,Ps,0n),fc(this,Es,0)}addOrder(t,e){let i=0,s=t.order_type;if(this.symbol.isCollateral())return!1;if(t.isClose()||t.isCloseBy())return!0;e&&(1===t.activation_mode&&(t.isLimit()||t.isStop())&&(s=t.isBuy()?0:1),2===t.activation_mode&&t.isStopLimit()&&(s=t.isBuy()?2:3));const r=this.symbol.orderRate(s,!0);if(r<=0)return!0;let a=t.price_order;return!a&&A_(s)&&(a=t.price_current),N_(s)&&(a=t.price_trigger),O_(s)?(t.margin_rate?i=t.margin_rate:this.prices.marginSymbol(this.symbol.trade_symbol)&&(i=this.prices.rateBuyMargin(this.symbol,this.account.account_currency,a)),i<=0||(e&&0===s?(yc(this,Ws).volume+=t.volume_current,yc(this,Ws).price+=a*Number(t.volume_current),yc(this,Ws).margin_rate+=i*Number(t.volume_current),yc(this,Ws).price_close=a,yc(this,Ws).volume_orders=t.volume_current,yc(this,Ws).order_rate=r):(yc(this,Ls)[s].volume+=t.volume_current,yc(this,Ls)[s].price+=a*Number(t.volume_current),yc(this,Ls)[s].margin_rate+=i*Number(t.volume_current),yc(this,Ls)[s].order_rate=r)),!0):!!x_(s)&&(t.margin_rate?i=t.margin_rate:this.prices.marginSymbol(this.symbol.trade_symbol)&&(i=this.prices.rateSellMargin(this.symbol,this.account.account_currency,a)),i<=0||(e&&1===s?(yc(this,Is).volume+=t.volume_current,yc(this,Is).price+=a*Number(t.volume_current),yc(this,Is).margin_rate+=i*Number(t.volume_current),yc(this,Is).price_close=a,yc(this,Is).volume_orders=t.volume_current,yc(this,Is).order_rate=r):(yc(this,Ls)[s].volume+=t.volume_current,yc(this,Ls)[s].price+=a*Number(t.volume_current),yc(this,Ls)[s].margin_rate+=i*Number(t.volume_current),yc(this,Ls)[s].order_rate=r)),!0)}addPosition(t){return F_(t.trade_action)?(yc(this,Ws).volume+=t.trade_volume,yc(this,Ws).price+=t.price_open*Number(t.trade_volume),yc(this,Ws).margin_rate+=t.rate_margin*Number(t.trade_volume),yc(this,Ws).price_close=t.price_close,yc(this,Ws).order_rate=this.symbol.orderRate(0,!1),!0):!!R_(t.trade_action)&&(yc(this,Is).volume+=t.trade_volume,yc(this,Is).price+=t.price_open*Number(t.trade_volume),yc(this,Is).margin_rate+=t.rate_margin*Number(t.trade_volume),yc(this,Is).price_close=t.price_close,yc(this,Is).order_rate=this.symbol.orderRate(1,!1),!0)}calc(){return bc(this,Os,0),j_(yc(this,Ws)),j_(yc(this,Is)),this.symbol.isCollateral()?vc(this,$s,Ns).call(this):this.isLargeLeg()?vc(this,$s,Ds).call(this):vc(this,$s,Fs).call(this)}hasCollateral(){return Boolean((yc(this,Ws).volume||yc(this,Is).volume)&&this.symbol.isCollateral())}hasInitialMargin(){return Boolean(this.symbol.trade.margin_initial&&this.symbol.trade.margin_maintenance&&this.symbol.trade.margin_initial!==this.symbol.trade.margin_maintenance)}calcMargin(t,e,i,s,r){const{symbol:o,account:n}=this;let c=0,l=0,h=fh.toSize(e,o.trade_contract_size);const _=yh(e,8);switch(s?l=o.trade.margin_initial:(l=o.trade.margin_initial,o.trade.margin_maintenance&&(l=o.trade.margin_maintenance)),r&&(l&&(l=o.trade.margin_hedged),h=fh.toSize(e,o.trade.margin_hedged)),o.trade_calc_mode){case 0:c=l>0?l*_/n.margin_leverage:h/n.margin_leverage;break;case 5:c=l>0?l*_:h;break;case 2:case 32:case 38:case 35:case 36:c=l>0?l*_:h*i;break;case 1:case 33:case 34:c=l*_;break;case 3:l>0?c=l*_:o.trade_tick_size&&(c=h*i/o.trade_tick_size*o.trade_tick_value);break;case 64:c=0;break;case 4:c=l>0?l*_/n.margin_leverage:h*i/n.margin_leverage;break;case 37:case 39:c=l>0?l*_:a.normalize(h*o.trade_face_value*i/100,o.currency_base_digits)}return c}}function X_(t,e){const i=Number(t.volume+e.volume);return[Number(t.price*Number(t.volume)+e.price*Number(e.volume))/i,(t.margin_rate*Number(t.volume)+e.margin_rate*Number(e.volume))/i]}function j_(t){t.volume&&(t.price/=Number(t.volume),t.margin_rate/=Number(t.volume))}Ws=new WeakMap,Is=new WeakMap,Ls=new WeakMap,Os=new WeakMap,xs=new WeakMap,As=new WeakMap,Ps=new WeakMap,Es=new WeakMap,$s=new WeakSet,Ns=function(){const{account:t}=this,e=t.currency_digits;let i=0,s=0;if(yc(this,Ws).volume){const s=this.prices.rateBuy(this.symbol,this.symbol.currency_profit,t.account_currency),r=vc(this,$s,Us).call(this,yc(this,Ws).price_close,0);i=a.normalize(fh.toSize(yc(this,Ws).volume,this.symbol.trade_contract_size)*r,e),i*=this.symbol.trade.margin_rate_liquidity,i=a.normalize(i*s,e),t.assets=a.normalize(t.assets+i,e),t.collateral=a.normalize(t.collateral+i,e)}if(yc(this,Is).volume){const i=this.prices.rateSell(this.symbol,this.symbol.currency_profit,t.account_currency),r=vc(this,$s,Us).call(this,yc(this,Is).price_close,1);s=a.normalize(fh.toSize(yc(this,Is).volume,this.symbol.trade_contract_size)*r,e),s=a.normalize(s*i,e),t.liabilities=a.normalize(t.liabilities-s,e),t.collateral=a.normalize(t.collateral-s,e)}return yc(this,Os)},Ds=function(){let t=0,e=0,i=0,s=0,r=0,a=0,o=0,n=BigInt(0),c=BigInt(0);for(let _=0;_<yc(this,Ls).length;_++){const s=yc(this,Ls)[_];s.volume&&(j_(s),0!==_&&2!==_&&4!==_&&6!==_||(t=this.calcMargin(_,s.volume,s.price,!0,!1),t*=s.margin_rate,t*=s.order_rate,e+=t),1!==_&&3!==_&&5!==_&&7!==_||(t=this.calcMargin(_,s.volume,s.price,!0,!1),t*=s.margin_rate,t*=s.order_rate,i+=t))}if(yc(this,Ws).volume){if(n=yc(this,Ws).volume_orders,n){const t=yc(this,Ws).volume>n?yc(this,Ws).volume-n:BigInt(0);s=this.calcMargin(0,n,yc(this,Ws).price,!0,!1),a=s,t&&(s+=this.calcMargin(0,t,yc(this,Ws).price,!1,!1))}else s=this.calcMargin(0,yc(this,Ws).volume,yc(this,Ws).price,!1,!1);s*=yc(this,Ws).margin_rate,s*=yc(this,Ws).order_rate,a*=yc(this,Ws).margin_rate,a*=yc(this,Ws).order_rate}if(yc(this,Is).volume){if(c=yc(this,Is).volume_orders,yc(this,Is).volume_orders){const t=yc(this,Is).volume>c?yc(this,Is).volume-c:BigInt(0);r=this.calcMargin(1,c,yc(this,Is).price,!0,!1),o=r,t&&(r+=this.calcMargin(1,t,yc(this,Is).price,!1,!1))}else r=this.calcMargin(1,yc(this,Is).volume,yc(this,Is).price,!1,!1);r*=yc(this,Is).margin_rate,r*=yc(this,Is).order_rate,o*=yc(this,Is).margin_rate,o*=yc(this,Is).order_rate}const l=s+e,h=r+i;return l>=h?(bc(this,Os,l),bc(this,Es,a),bc(this,Ps,n)):(bc(this,Os,h),bc(this,Es,o),bc(this,Ps,c)),vc(this,$s,qs).call(this,l,h,s,e,r,i),yc(this,Os)},qs=function(t,e,i,s,r,a){if(this.isFloatingLeverage())if(t>=e){if(this.leverage_positions_volume=yc(this,Ws).volume-yc(this,Ps),this.leverage_positions_order_volume=yc(this,Ps),this.leverage_positions_price=yc(this,Ws).price,this.leverage_positions_margin=i-yc(this,Es),this.leverage_positions_order_margin=yc(this,Es),this.leverage_positions_margin_rate=yc(this,Ws).margin_rate,this.leverage_orders_margin=s,this.leverage_orders_margin){for(let t=0;t<yc(this,Ls).length;t++){const e=yc(this,Ls)[t];e.volume&&(0!==t&&2!==t&&4!==t&&6!==t||(this.leverage_orders_volume+=e.volume,this.leverage_orders_price+=e.price*Number(e.volume),this.leverage_orders_margin_rate+=e.margin_rate*Number(e.volume)))}this.leverage_orders_price/=Number(this.leverage_orders_volume),this.leverage_orders_margin_rate/=Number(this.leverage_orders_volume)}}else if(this.leverage_positions_volume=yc(this,Is).volume-yc(this,Ps),this.leverage_positions_order_volume=yc(this,Ps),this.leverage_positions_price=yc(this,Is).price,this.leverage_positions_margin=r-yc(this,Es),this.leverage_positions_order_margin=yc(this,Es),this.leverage_positions_margin_rate=yc(this,Is).margin_rate,this.leverage_orders_margin=a,this.leverage_orders_margin){for(let t=0;t<yc(this,Ls).length;t++){const e=yc(this,Ls)[t];e.volume&&(1!==t&&3!==t&&5!==t&&7!==t||(this.leverage_orders_volume+=e.volume,this.leverage_orders_price+=e.price*Number(e.volume),this.leverage_orders_margin_rate+=e.margin_rate*Number(e.volume)))}this.leverage_orders_price/=Number(this.leverage_orders_volume),this.leverage_orders_margin_rate/=Number(this.leverage_orders_volume)}},Fs=function(){let t=0,e=0,i=0,s=vc(this,$s,Vs).call(this);for(let r=0;r<yc(this,Ls).length;r++){const s=yc(this,Ls)[r];s.volume&&(j_(s),2!==r&&4!==r&&6!==r||(t=this.calcMargin(r,s.volume,s.price,!0,!1),t*=s.margin_rate,t*=s.order_rate,e+=t),3!==r&&5!==r&&7!==r||(t=this.calcMargin(r,s.volume,s.price,!0,!1),t*=s.margin_rate,t*=s.order_rate,i+=t))}if(yc(this,Ls)[0].volume){yc(this,Ws).order_rate||(yc(this,Ws).order_rate=yc(this,Ls)[0].order_rate);const[t,e]=X_(yc(this,Ws),yc(this,Ls)[0]);yc(this,Ws).price=t,yc(this,Ws).margin_rate=e,yc(this,Ws).volume+=yc(this,Ls)[0].volume,yc(this,Ws).volume_orders+=yc(this,Ls)[0].volume}if(yc(this,Ls)[1].volume){yc(this,Is).order_rate||(yc(this,Is).order_rate=yc(this,Ls)[1].order_rate);const[t,e]=X_(yc(this,Is),yc(this,Ls)[1]);yc(this,Is).price=t,yc(this,Is).margin_rate=e,yc(this,Is).volume+=yc(this,Ls)[1].volume,yc(this,Is).volume_orders+=yc(this,Ls)[1].volume}if(yc(this,Ls)[0].volume||yc(this,Ls)[1].volume){const t=vc(this,$s,Vs).call(this);s=Math.max(s,t)}return bc(this,Os,s+e+i),vc(this,$s,Rs).call(this,s,e,i),yc(this,Os)},Rs=function(t,e,i){if(!this.isFloatingLeverage())return;const{trade_contract_size:s,trade:r}=this.symbol,{margin_hedged:a}=r;yc(this,xs)>yc(this,Ps)?(this.leverage_positions_volume=yc(this,xs)-yc(this,Ps),yc(this,As)&&this.symbol.trade.margin_hedged&&this.symbol.trade_contract_size&&(this.leverage_positions_volume+=BigInt(Number(yc(this,As))*a/s)),this.leverage_positions_order_volume=yc(this,Ps),t>yc(this,Es)?this.leverage_positions_margin=t-yc(this,Es):this.leverage_positions_margin=0,this.leverage_positions_order_margin=yc(this,Es)):(this.leverage_positions_volume=0n,yc(this,As)&&this.symbol.trade.margin_hedged&&this.symbol.trade_contract_size&&(this.leverage_positions_volume+=BigInt(Number(yc(this,As))*a/s)),this.leverage_positions_order_volume=yc(this,xs),t>yc(this,Es)?this.leverage_positions_margin=t-yc(this,Es):this.leverage_positions_margin=0,this.leverage_positions_order_margin=yc(this,Es));const[o,n]=X_(yc(this,Ws),yc(this,Is));if(this.leverage_positions_price=o,this.leverage_positions_margin_rate=n,this.leverage_orders_margin=e+i,this.leverage_orders_margin){for(let t=0;t<yc(this,Ls).length;t++){const e=yc(this,Ls)[t];e.volume&&(this.leverage_orders_volume+=e.volume,this.leverage_orders_price+=e.price*Number(e.volume),this.leverage_orders_margin_rate+=e.margin_rate*Number(e.volume))}this.leverage_orders_price/=Number(this.leverage_orders_volume),this.leverage_orders_margin_rate/=Number(this.leverage_orders_volume)}},Vs=function(){let t=0,e=0;if(bc(this,xs,0n),bc(this,As,0n),bc(this,Ps,0n),bc(this,Es,0),yc(this,Ws).volume>yc(this,Is).volume){if(bc(this,xs,yc(this,Ws).volume-yc(this,Is).volume),bc(this,Ps,yc(this,Ws).volume_orders),yc(this,Ps))if(yc(this,xs)>yc(this,Ps)){const t=yc(this,xs)-yc(this,Ps);e=this.calcMargin(0,yc(this,Ps),yc(this,Ws).price,!0,!1),bc(this,Es,e),t&&(e+=this.calcMargin(0,t,yc(this,Ws).price,!1,!1))}else e=this.calcMargin(0,yc(this,xs),yc(this,Ws).price,!0,!1),bc(this,Es,e);else e=this.calcMargin(0,yc(this,xs),yc(this,Ws).price,!1,!1);e*=yc(this,Ws).margin_rate,e*=yc(this,Ws).order_rate,bc(this,Es,yc(this,Es)*yc(this,Ws).margin_rate),bc(this,Es,yc(this,Es)*yc(this,Ws).order_rate)}if(yc(this,Ws).volume<yc(this,Is).volume){if(bc(this,xs,yc(this,Is).volume-yc(this,Ws).volume),bc(this,Ps,yc(this,Is).volume_orders),yc(this,Ps))if(yc(this,xs)>yc(this,Ps)){const t=yc(this,xs)-yc(this,Ps);e=this.calcMargin(1,yc(this,Ps),yc(this,Is).price,!0,!1),bc(this,Es,e),t&&(e+=this.calcMargin(1,t,yc(this,Is).price,!1,!1))}else e=this.calcMargin(1,yc(this,xs),yc(this,Is).price,!0,!1),bc(this,Es,e);else e=this.calcMargin(1,yc(this,xs),yc(this,Is).price,!1,!1);e*=yc(this,Is).margin_rate,e*=yc(this,Is).order_rate,bc(this,Es,yc(this,Es)*yc(this,Is).margin_rate),bc(this,Es,yc(this,Es)*yc(this,Is).order_rate)}if(bc(this,As,a.bMath.min(yc(this,Ws).volume,yc(this,Is).volume)),yc(this,As)>0){let e=0;const[i,s]=X_(yc(this,Ws),yc(this,Is));e=(yc(this,Ws).order_rate+yc(this,Is).order_rate)/2,t=this.calcMargin(0,yc(this,As),i,!1,!0),t*=s,t*=e}return e+t},Us=function(t,e){return t||(0===e?this.prices.findBid(this.symbol.trade_symbol):1===e?this.prices.findAsk(this.symbol.trade_symbol):0)};class G_ extends y_{createEntity(t){return new H_(this.account,t,this.prices)}}class Y_ extends u_{constructor(t,e){super(t,e),fc(this,Xs),fc(this,Hs),bc(this,Hs,new L_(new G_(t,e)))}resetCalc(){yc(this,Hs).clearStorage()}calcTick(t,e){const{account:i}=this,s=i.currency_digits;this.calcAccount(t,e),i.profit=0,i.storage_=0,i.floating=0,t.forEach((t=>{i.profit=a.normalize(i.profit+t.profit,s),t.storage_&&(i.storage_=a.normalize(i.storage_+t.storage_,s)),i.floating=i.profit,i.storage_&&(i.floating=a.normalize(i.floating+i.storage_,s))})),this.calcFloating()}calcTickManager(t,e){const{account:i}=this,s=i.currency_digits;if(this.calcAccount(t,e),i.profit=0,i.storage_=0,i.floating=0,t.length){let e=0,r=0;t.forEach((t=>{e+=t.profit,r+=t.storage_})),i.profit=a.normalize(e,s),i.floating=i.profit,0!==r&&(i.storage_=a.normalize(r,s),i.floating=a.normalize(i.floating+i.storage_,s))}this.calcFloating()}calcAccount(t,e,i,s=!1){const{account:r}=this;r.profit=0,r.storage_=0,r.margin=0,r.margin_initial=0,r.margin_maintenance=0,r.floating=0,r.equity=0,r.assets=0,r.liabilities=0,r.collateral=0,r.profit_excluded=0,r.acc_commission=a.normalize(r.commission_daily+r.commission_monthly,r.currency_digits),yc(this,Hs).margins.clearMarginList(),vc(this,Xs,Js).call(this,t),vc(this,Xs,Zs).call(this,e,i,s),vc(this,Xs,js).call(this),this.calcFloating()}checkStopOut(){const{account:t}=this;if(t.so_activation=0,0===t.margin_so_mode){if(0!==t.margin){if(t.margin_level<t.margin_so_call&&(t.so_activation=1,t.margin_level<t.margin_so_so))return t.so_activation=2,!0}else if(128&t.trade_flags&&t.equity<0&&(t.profit||t.storage_))return!0;return!1}if(1===t.margin_so_mode){if(0!==t.margin){if(t.equity<t.margin_so_call&&(t.so_activation=1,t.equity<t.margin_so_so))return t.so_activation=2,!0}else if(128&this.account.trade_flags&&t.equity<0&&(t.profit||t.storage_))return t.so_activation=2,!0;return!1}return!1}calcFloating(){vc(this,Xs,Gs).call(this),vc(this,Xs,Ys).call(this),vc(this,Xs,Ks).call(this)}}Hs=new WeakMap,Xs=new WeakSet,js=function(){const{account:t}=this;t.assets=0,t.liabilities=0,t.collateral=0,t.margin=yc(this,Hs).margins.calcMargin()},Gs=function(){const{account:t}=this,e=t.currency_digits;switch(t.margin_free=t.balance,t.margin_free=a.normalize(t.margin_free-t.margin,e),t.credit&&(t.margin_free=a.normalize(t.margin_free+t.credit,e)),t.assets&&(t.margin_free=a.normalize(t.margin_free+t.assets,e)),t.liabilities&&(t.margin_free=a.normalize(t.margin_free+t.liabilities,e)),t.acc_commission&&(t.margin_free=a.normalize(t.margin_free+t.acc_commission,e)),t.margin_free_mode){case 1:t.margin_free=a.normalize(t.margin_free+t.floating,e);break;case 2:t.floating>0&&(t.margin_free=a.normalize(t.margin_free+t.floating,e));break;case 3:t.floating<0&&(t.margin_free=a.normalize(t.margin_free+t.floating,e))}t.profit_excluded&&(t.margin_free=a.normalize(t.margin_free-t.profit_excluded,e)),3===t.margin_free_profit_mode&&t.acc_profit>0&&(t.margin_free=a.normalize(t.margin_free-t.acc_profit,e))},Ys=function(){const{account:t}=this,e=t.currency_digits;t.equity=t.balance,t.equity=a.normalize(t.equity+t.floating,e),t.credit&&(t.equity=a.normalize(t.equity+t.credit,e)),t.assets&&(t.equity=a.normalize(t.equity+t.assets,e)),t.liabilities&&(t.equity=a.normalize(t.equity+t.liabilities,e)),t.acc_commission&&(t.equity=a.normalize(t.equity+t.acc_commission,e)),3===t.margin_free_profit_mode&&t.acc_profit>0&&(t.equity=a.normalize(t.equity-t.acc_profit,e))},Ks=function(){const{account:t}=this;t.margin>0?t.margin_level=(t.equity-t.profit_excluded)/t.margin*100:t.margin_level=0},Js=function(t){const{account:e}=this,i=e.currency_digits;t.length&&(t.forEach((t=>{if(!t||!t.trade_volume)return;const s=yc(this,Hs).margins.getOrCreate(t.trade_symbol);s&&s.addPosition(t)&&(s.isCollateral()||(e.profit=a.normalize(e.profit+t.profit,i),t.storage_&&(e.storage_=a.normalize(e.storage_+t.storage_,i)),s.isMarginExcludePL()&&t.isBuy()&&(e.profit_excluded=a.normalize(e.profit_excluded+t.profit,i))))})),e.floating=e.profit,e.storage_&&(e.floating=a.normalize(e.floating+e.storage_,i)))},Zs=function(t,e,i=!1){const{account:s}=this,r=s.currency_digits,o=Boolean(e);if(t.forEach((t=>{const n=yc(this,Hs).margins.getOrCreate(t.trade_symbol);if(n)if(e&&e.trade_order===t.trade_order){if(i)return void(e=void 0);n.addOrder(e),0!==d_(t.commission_daily,e.commission_daily,r)&&(s.acc_commission=a.normalize(s.acc_commission+e.commission_daily-t.commission_daily,r)),0!==d_(t.commission_monthly,e.commission_monthly,r)&&(s.acc_commission=a.normalize(s.acc_commission+e.commission_monthly-t.commission_monthly,r)),e=void 0}else n.addOrder(t,o)})),e){const t=yc(this,Hs).margins.getOrCreate(e.trade_symbol);t&&(t.addOrder(e,o),e.commission_daily&&(s.acc_commission=a.normalize(s.acc_commission+e.commission_daily,r)),e.commission_monthly&&(s.acc_commission=a.normalize(s.acc_commission+e.commission_monthly,r)))}};class K_{constructor(t,e,i){this.spreads=[],this.spreads_volumes_buy=[],this.spreads_volumes_sell=[],this.new_order_type=0,this.new_order_volume=0n,this.new_position_type=0,this.new_position_volume=0n,this.margins=t,this.margins_buy=e,this.margins_sell=i}clearStorage(){this.margins.clearMarginList(),this.margins_buy.clearMarginList(),this.margins_sell.clearMarginList(),this.spreads=[],this.spreads_volumes_buy=[],this.spreads_volumes_sell=[],this.new_order_type=0,this.new_order_volume=0n,this.new_position_type=0,this.new_position_volume=0n}}function J_(t,e,i,s,r,o,n){let c=0,l=0;switch(o?l=t.trade.margin_initial:(l=t.trade.margin_initial,t.trade.margin_maintenance&&(l=t.trade.margin_maintenance)),t.trade_calc_mode){case 0:c=l>0?l*s/t.trade_contract_size/e.margin_leverage:s/e.margin_leverage;break;case 5:c=l>0?l*s/t.trade_contract_size:s;break;case 2:case 32:case 38:case 35:case 36:c=l>0?l*s/t.trade_contract_size:s*r;break;case 1:case 33:c=l*s/t.trade_contract_size;break;case 3:l>0?c=l*s/t.trade_contract_size:t.trade_tick_size&&(c=s*r/t.trade_tick_size*t.trade_tick_value);break;case 64:c=0;break;case 4:c=l>0?l*s/t.trade_contract_size/e.margin_leverage:s*r/e.margin_leverage;break;case 34:if(t.trade_tick_size)switch(i){case 0:c=n?s/t.trade_contract_size*(t.trade.margin_initial+(r-t.trade_price_settle)*(t.trade_tick_value/t.trade_tick_size)*(1+.01*t.trade.margin_rate_currency)):s/t.trade_contract_size*(t.trade.margin_initial+(t.trade_price_limit_max-t.trade_price_settle)*(t.trade_tick_value/t.trade_tick_size)*(1+.01*t.trade.margin_rate_currency));break;case 1:c=n?s/t.trade_contract_size*(t.trade.margin_maintenance+(t.trade_price_settle-r)*(t.trade_tick_value/t.trade_tick_size)*(1+.01*t.trade.margin_rate_currency)):s/t.trade_contract_size*(t.trade.margin_maintenance+(t.trade_price_settle-t.trade_price_limit_min)*(t.trade_tick_value/t.trade_tick_size)*(1+.01*t.trade.margin_rate_currency));break;case 2:case 6:c=s/t.trade_contract_size*(t.trade.margin_initial+(r-t.trade_price_settle)*(t.trade_tick_value/t.trade_tick_size)*(1+.01*t.trade.margin_rate_currency));break;case 3:case 7:c=s/t.trade_contract_size*(t.trade.margin_maintenance+(t.trade_price_settle-r)*(t.trade_tick_value/t.trade_tick_size)*(1+.01*t.trade.margin_rate_currency));break;case 4:c=s/t.trade_contract_size*(t.trade.margin_initial+(t.trade_price_limit_max-t.trade_price_settle)*(t.trade_tick_value/t.trade_tick_size)*(1+.01*t.trade.margin_rate_currency));break;case 5:c=s/t.trade_contract_size*(t.trade.margin_maintenance+(t.trade_price_settle-t.trade_price_limit_min)*(t.trade_tick_value/t.trade_tick_size)*(1+.01*t.trade.margin_rate_currency));break;default:c=l*s/t.trade_contract_size}break;case 37:case 39:c=l>0?l*s/t.trade_contract_size:a.normalize(s*t.trade_face_value*r/100,t.currency_base_digits)}return c}class Z_ extends f_{constructor(){super(...arguments),fc(this,wr),fc(this,Qs),fc(this,tr,0),fc(this,er,0n),fc(this,ir,0),fc(this,sr,0),fc(this,rr,0),fc(this,ar,0),fc(this,or,0),fc(this,nr,0n),fc(this,cr,0n),fc(this,lr,0),fc(this,hr,0),fc(this,_r,0),fc(this,dr,0),fc(this,ur,0),fc(this,pr,0),fc(this,mr,!1),fc(this,gr,0),fc(this,yr,0n),fc(this,fr,0n),fc(this,br,0),fc(this,vr,0)}addOrder(t,e){if(this.symbol.isCollateral())return!1;const i=fh.toSize(t.volume_current,t.contract_size);if(i<=0)return!0;let s=0,r=t.order_type;e&&(bc(this,mr,!0),1===t.activation_mode&&(t.isLimit()||t.isStop())&&(r=t.isBuy()?0:1),2===t.activation_mode&&t.isStopLimit()&&(r=t.isBuy()?2:3));const o=this.symbol.orderRate(r,!0);if(o<=0)return!0;let n=t.price_order;if(n||0!==r&&1!==r||(n=t.price_current),6!==r&&7!==r||(n=t.price_trigger),0===r||2===r||4===r||6===r){if(s=t.margin_rate?t.margin_rate:this.prices.rateBuyMargin(this.symbol,this.account.account_currency,n),s<=0)return!0;let e=J_(this.symbol,this.account,r,i,n,!0,!1);return e*=s,e*=o,bc(this,_r,a.normalize(yc(this,_r)+e,this.account.currency_digits)),bc(this,nr,yc(this,nr)+t.volume_current),bc(this,lr,yc(this,lr)+n*Number(t.volume_current)),bc(this,ur,yc(this,ur)+s*Number(t.volume_current)),!0}if(1===r||3===r||5===r||7===r){if(s=t.margin_rate?t.margin_rate:this.prices.rateSellMargin(this.symbol,this.account.account_currency,n),s<=0)return!0;let e=J_(this.symbol,this.account,r,i,n,!0,!1);return e*=s,e*=o,bc(this,dr,a.normalize(yc(this,dr)+e,this.account.currency_digits)),bc(this,cr,yc(this,cr)+t.volume_current),bc(this,hr,yc(this,hr)+n*Number(t.volume_current)),bc(this,pr,yc(this,pr)+s*Number(t.volume_current)),!0}return!1}addPosition(t){let e=0;return t.isBuy()&&bc(this,tr,0),t.isSell()&&bc(this,tr,1),bc(this,ir,fh.toSize(t.trade_volume,t.contract_size)),bc(this,sr,t.price_open),bc(this,rr,t.price_close),bc(this,or,t.rate_margin),e=J_(this.symbol,this.account,yc(this,tr),yc(this,ir),yc(this,sr),!1,!0),e*=t.rate_margin,e*=this.symbol.orderRate(yc(this,tr),!1),bc(this,ar,a.normalize(e,this.account.currency_digits)),bc(this,er,t.trade_volume),!0}calc(){let t=yc(this,_r),e=yc(this,dr);if(this.symbol.isCollateral())return vc(this,wr,kr).call(this,this.account);if(bc(this,gr,0),0n!==yc(this,er)){if(0===yc(this,tr))if(t+=yc(this,ar),this.symbol.isFORTS()){const t=J_(this.symbol,this.account,1,yc(this,ir),yc(this,sr),!1,!0);e=a.normalize(e-t,this.account.currency_digits)}else yc(this,dr)&&yc(this,cr)&&(e-=a.normalize(yc(this,dr)/Number(yc(this,cr))*Number(yc(this,er)),this.account.currency_digits));if(1===yc(this,tr))if(e+=yc(this,ar),this.symbol.isFORTS()){const e=J_(this.symbol,this.account,0,yc(this,ir),yc(this,sr),!1,!0);t=a.normalize(t-e,this.account.currency_digits)}else yc(this,_r)&&yc(this,nr)&&(t-=a.normalize(yc(this,_r)/Number(yc(this,nr))*Number(yc(this,er)),this.account.currency_digits))}bc(this,gr,Math.max(t,e));let i=yc(this,nr),s=yc(this,cr);return bc(this,yr,0n),bc(this,vr,0),bc(this,br,0),0n!==yc(this,er)&&(0===yc(this,tr)&&(i+=yc(this,er)),1===yc(this,tr)&&(s+=yc(this,er))),i>s?(bc(this,yr,i),bc(this,br,0)):i<s?(bc(this,yr,s),bc(this,br,1)):(bc(this,yr,i),bc(this,br,yc(this,tr))),yc(this,yr)?bc(this,vr,yc(this,gr)/Number(yc(this,yr))):bc(this,vr,0),vc(this,wr,Tr).call(this,t,e),yc(this,gr)}getSpreadLeg(){return yc(this,Qs)}setSpreadLeg(t){bc(this,Qs,t)}setSpreadVolume(t){bc(this,fr,t)}getSpreadVolume(){return yc(this,fr)}getVolume(){return yc(this,yr)}getVolumeType(){return yc(this,br)}getVolumeRate(){return yc(this,vr)}volumeDecrease(t){bc(this,yr,yc(this,yr)-a.bMath.min(yc(this,yr),t))}hasNewOrder(){return yc(this,mr)}hasCollateral(){return Boolean(yc(this,er)&&this.symbol.isCollateral())}}Qs=new WeakMap,tr=new WeakMap,er=new WeakMap,ir=new WeakMap,sr=new WeakMap,rr=new WeakMap,ar=new WeakMap,or=new WeakMap,nr=new WeakMap,cr=new WeakMap,lr=new WeakMap,hr=new WeakMap,_r=new WeakMap,dr=new WeakMap,ur=new WeakMap,pr=new WeakMap,mr=new WeakMap,gr=new WeakMap,yr=new WeakMap,fr=new WeakMap,br=new WeakMap,vr=new WeakMap,wr=new WeakSet,kr=function(t){let e=0,i=0;if(bc(this,gr,0),bc(this,yr,0n),bc(this,br,0),bc(this,vr,0),0n!==yc(this,er)){if(0===yc(this,tr)){const i=this.prices.rateBuy(this.symbol,this.symbol.currency_profit,this.account.account_currency),s=vc(this,wr,Mr).call(this,yc(this,rr),yc(this,tr));e=a.normalize(yc(this,ir)*s,this.account.currency_digits),e*=this.symbol.trade.margin_rate_liquidity,e=a.normalize(e*i,this.account.currency_digits),t.assets=a.normalize(t.assets+e,this.account.currency_digits),t.collateral=a.normalize(t.collateral+e,this.account.currency_digits)}if(1===yc(this,tr)){const e=this.prices.rateSell(this.symbol,this.symbol.currency_profit,this.account.account_currency),s=vc(this,wr,Mr).call(this,yc(this,rr),yc(this,tr));i=a.normalize(yc(this,ir)*s,this.account.currency_digits),i=a.normalize(i*e,this.account.currency_digits),t.liabilities=a.normalize(t.liabilities-i,this.account.currency_digits),t.collateral=a.normalize(t.collateral-i,this.account.currency_digits)}}return yc(this,gr)},Tr=function(t,e){this.isFloatingLeverage()&&(t>=e?(0===yc(this,tr)&&(this.leverage_positions_volume=yc(this,er),this.leverage_positions_order_volume=0n,this.leverage_positions_price=yc(this,sr),this.leverage_positions_margin=yc(this,ar),this.leverage_positions_order_margin=0,this.leverage_positions_margin_rate=yc(this,or)),this.leverage_orders_volume=yc(this,nr),this.leverage_orders_margin=yc(this,_r),yc(this,nr)&&(this.leverage_orders_price=yc(this,lr)/Number(yc(this,nr)),this.leverage_orders_margin_rate=yc(this,ur)/Number(yc(this,nr)))):(1===yc(this,tr)&&(this.leverage_positions_volume=yc(this,er),this.leverage_positions_order_volume=0n,this.leverage_positions_price=yc(this,sr),this.leverage_positions_margin=yc(this,ar),this.leverage_positions_order_margin=0,this.leverage_positions_margin_rate=yc(this,or)),this.leverage_orders_volume=yc(this,cr),this.leverage_orders_margin=yc(this,dr),yc(this,nr)&&(this.leverage_orders_price=yc(this,hr)/Number(yc(this,cr)),this.leverage_orders_margin_rate=yc(this,pr)/Number(yc(this,cr)))))},Mr=function(t,e){return t||(0===e?this.prices.findBid(this.symbol.trade_symbol):1===e?this.prices.findAsk(this.symbol.trade_symbol):0)};class Q_ extends y_{createEntity(t){return new Z_(this.account,t,this.prices)}}const td=1e8;class ed extends u_{constructor(t,e,i){super(t,e),fc(this,Br),fc(this,Sr),fc(this,zr),bc(this,zr,i),bc(this,Sr,new K_(new Q_(t,e),new Q_(t,e),new Q_(t,e)))}resetCalc(){yc(this,Sr).clearStorage()}calcTick(t,e){const{account:i}=this;this.calcAccount(t,e),i.profit=0,i.storage_=0,i.floating=0,t.forEach((t=>{i.profit=a.normalize(i.profit+t.profit,i.currency_digits),t.storage_&&(i.storage_=a.normalize(i.storage_+t.storage_,i.currency_digits))})),i.floating=i.profit,i.storage_&&(i.floating=a.normalize(i.floating+i.storage_,i.currency_digits)),this.calcFloating()}calcAccount(t,e,i,s=!1){const{account:r}=this;r.profit=0,r.storage_=0,r.margin=0,r.margin_initial=0,r.margin_maintenance=0,r.floating=0,r.equity=0,r.assets=0,r.liabilities=0,r.collateral=0,r.profit_excluded=0,r.acc_commission=a.normalize(r.commission_daily+r.commission_monthly,r.currency_digits),vc(this,Br,Cr).call(this),vc(this,Br,Dr).call(this,t,i),vc(this,Br,qr).call(this,e,i,s),vc(this,Br,Wr).call(this),this.calcFloating()}checkStopOut(){const{account:t}=this;return this.account.so_activation=0,0===this.account.margin_so_mode?0!==t.margin&&t.margin_level<this.account.margin_so_call&&(t.so_activation=1,t.margin_level<this.account.margin_so_so)&&(t.so_activation=2,!0):1===this.account.margin_so_mode&&0!==t.margin&&this.account.equity<this.account.margin_so_call&&(this.account.so_activation=1,t.equity<this.account.margin_so_so)&&(t.so_activation=2,!0)}calcFloating(){vc(this,Br,Ir).call(this),vc(this,Br,Lr).call(this),vc(this,Br,Or).call(this)}}function id(t,e){e.length=0,t.forEachMargins(((t,i)=>{e[i]=t.getSpreadVolume()}))}function sd(t,e,i,s){if(s.volume_ratio=Number.MAX_VALUE,!e.getTotal()&&!i.length)return!0;let r;for(r=0;r<i.length;r++){const o=i[r];let n=!1;const c=e.getAllMargins();for(let e=0;e<c.length;e++){const i=c[e];if(o.checkSymbol(i.getName(),i.basis(),i.getExpiration())){if(i.setSpreadLeg(o),o.spread_ratio){const t=i.getVolume()/BigInt(o.spread_ratio);s.volume_ratio=Number(a.bMath.min(BigInt(s.volume_ratio),t))}if(n=!0,1===t.margin_type&&1===o.spread_mode)continue;break}}if(!n)break}return!(r<i.length&&(e.forEachMargins((t=>t.setSpreadLeg())),1))}Sr=new WeakMap,zr=new WeakMap,Br=new WeakSet,Cr=function(){yc(this,Sr).margins.clearMarginList(),yc(this,Sr).new_order_type=0,yc(this,Sr).new_order_volume=0n,yc(this,Sr).new_position_type=0,yc(this,Sr).new_position_volume=0n},Wr=function(){this.account.assets=0,this.account.liabilities=0,this.account.collateral=0,this.account.margin=yc(this,Sr).margins.calcMargin(),vc(this,Br,xr).call(this)},Ir=function(){const{account:t}=this;switch(t.margin_free=t.balance,t.margin_free=a.normalize(t.margin_free-t.margin,t.currency_digits),t.credit&&(t.margin_free=a.normalize(t.margin_free+t.credit,t.currency_digits)),t.assets&&(t.margin_free=a.normalize(t.margin_free+t.assets,t.currency_digits)),t.liabilities&&(t.margin_free=a.normalize(t.margin_free+t.liabilities,t.currency_digits)),t.acc_commission&&(t.margin_free=a.normalize(t.margin_free+t.acc_commission,t.currency_digits)),this.account.margin_free_mode){case 1:t.margin_free=a.normalize(t.margin_free+t.floating,t.currency_digits);break;case 2:t.floating>0&&(t.margin_free=a.normalize(t.margin_free+t.floating,t.currency_digits));break;case 3:t.floating<0&&(t.margin_free=a.normalize(t.margin_free+t.floating,t.currency_digits))}t.profit_excluded&&(t.margin_free=a.normalize(t.margin_free-t.profit_excluded,t.currency_digits)),1===this.account.margin_free_profit_mode&&t.acc_profit>0&&(t.margin_free=a.normalize(t.margin_free-t.acc_profit,t.currency_digits))},Lr=function(){const{account:t}=this;t.equity=t.balance,t.equity=a.normalize(t.equity+t.floating,t.currency_digits),t.credit&&(t.equity=a.normalize(t.equity+t.credit,t.currency_digits)),t.assets&&(t.equity=a.normalize(t.equity+t.assets,t.currency_digits)),t.liabilities&&(t.equity=a.normalize(t.equity+t.liabilities,t.currency_digits)),t.acc_commission&&(t.equity=a.normalize(t.equity+t.acc_commission,t.currency_digits)),1===t.margin_free_profit_mode&&t.acc_profit>0&&(t.equity=a.normalize(t.equity-t.acc_profit,t.currency_digits))},Or=function(){const{account:t}=this;t.margin>0?t.margin_level=(t.equity-t.profit_excluded)/t.margin*100:t.margin_level=0},xr=function(){const{account:t}=this;if(!yc(this,zr).legsTotal())return;yc(this,Sr).spreads=[],yc(this,Sr).margins.forEachMargins((t=>{const e=t.getName();yc(this,Sr).spreads=yc(this,zr).legsGetBySymbol(e)}));let e=0;const i={value:0};for(;vc(this,Br,Ar).call(this,i);)d_(i.value,0,t.currency_digits)>0&&(e=a.normalize(e+i.value,t.currency_digits));e=Math.min(t.margin,e),t.margin=a.normalize(t.margin-e,t.currency_digits)},Ar=function(t){var e,i;let s,r=0,a=0,o=0;const n={volume_ratio:0};let c;const l={volume_ratio:0};let h;t.value=0;for(let _=0;_<yc(this,Sr).spreads.length;_++){const t=yc(this,Sr).spreads[_].spread;if(!vc(this,Br,Nr).call(this))break;c=sd(t,yc(this,Sr).margins_buy,t.legs_a,n),h=sd(t,yc(this,Sr).margins_sell,t.legs_b,l),c&&h&&(s=Math.min(n.volume_ratio,l.volume_ratio),s>0)?(r=vc(this,Br,Pr).call(this,t,t.legs_a,t.legs_b,s,yc(this,Sr).margins_buy,yc(this,Sr).margins_sell),d_(r,0,this.account.currency_digits)>0&&(r>a||t.preferable(o))&&(a=r,o=t.margin_type,id(yc(this,Sr).margins_buy,yc(this,Sr).spreads_volumes_buy),id(yc(this,Sr).margins_sell,yc(this,Sr).spreads_volumes_sell))):(c=sd(t,yc(this,Sr).margins_sell,t.legs_a,n),h=sd(t,yc(this,Sr).margins_buy,t.legs_b,l),c&&h&&(s=Math.min(n.volume_ratio,l.volume_ratio),s>0)&&(r=vc(this,Br,Pr).call(this,t,t.legs_a,t.legs_b,s,yc(this,Sr).margins_sell,yc(this,Sr).margins_buy),d_(r,0,this.account.currency_digits)>0&&(r>a||t.preferable(o))&&(a=r,o=t.margin_type,id(yc(this,Sr).margins_buy,yc(this,Sr).spreads_volumes_buy),id(yc(this,Sr).margins_sell,yc(this,Sr).spreads_volumes_sell))))}if(t.value=Math.min(this.account.margin,a),t.value>0){if(yc(this,Sr).spreads_volumes_buy.length===yc(this,Sr).margins_buy.getTotal())for(let t=0;t<yc(this,Sr).spreads_volumes_buy.length;t++)null==(e=yc(this,Sr).margins_buy.at(t))||e.volumeDecrease(yc(this,Sr).spreads_volumes_buy[t]);if(yc(this,Sr).spreads_volumes_sell.length===yc(this,Sr).margins_sell.getTotal())for(let t=0;t<yc(this,Sr).spreads_volumes_sell.length;t++)null==(i=yc(this,Sr).margins_sell.at(t))||i.volumeDecrease(yc(this,Sr).spreads_volumes_sell[t]);return!0}return!1},Pr=function(t,e,i,s,r,o){switch(t.margin_type){case 0:{const a={new_order:!1};return vc(this,Br,Er).call(this,e,r,s,a)+vc(this,Br,Er).call(this,i,o,s,a)-t.margin_initial*s/td}case 1:{const t={new_order:!1},e=vc(this,Br,$r).call(this,r,t),i=vc(this,Br,$r).call(this,o,t);return(e>=i?o:r).forEachMargins((t=>{t.getSpreadLeg()&&t.setSpreadVolume(t.getVolume())})),Math.min(e,i)}case 2:{const n={new_order:!1},c=vc(this,Br,Er).call(this,e,r,s,n),l=vc(this,Br,Er).call(this,i,o,s,n),h=!n.new_order&&t.margin_maintenance?t.margin_maintenance:t.margin_initial,_=c*h/100+l*h/100;return a.normalize(_,this.account.currency_digits)}case 3:{const n={new_order:!1},c=vc(this,Br,Er).call(this,e,r,s,n),l=vc(this,Br,Er).call(this,i,o,s,n),h=!n.new_order&&t.margin_maintenance?t.margin_maintenance:t.margin_initial,_=Math.abs(c-l)+h*s/td;return a.normalize(c+l-_,this.account.currency_digits)}}return 0},Er=function(t,e,i,s){let r=0,o=0n;const n=e.getAllMargins();for(let c=0;c<n.length;c++){const e=n[c],l=e.getSpreadLeg();if(!l)continue;let h=0;for(h=0;h<t.length&&t[h]!==l;h++)t.length;const _=e.getVolume();o=BigInt(l.spread_ratio*i),o=a.bMath.min(_,o),r=a.normalize(r+e.getVolumeRate()*Number(o),this.account.currency_digits),e.setSpreadVolume(o),s.new_order=s.new_order||e.hasNewOrder()}return r},$r=function(t,e){let i=0;return t.forEachMargins((t=>{const s=t.getSpreadLeg(),r=t.getVolume();s&&(i=a.normalize(i+t.getVolumeRate()*Number(r),this.account.currency_digits),e.new_order=e.new_order||t.hasNewOrder())})),i},Nr=function(){return yc(this,Sr).margins_buy.clearMarginList(),yc(this,Sr).margins_sell.clearMarginList(),yc(this,Sr).margins.forEachMargins((t=>{t.setSpreadLeg(),t.setSpreadVolume(0n),t.getVolume()&&(0===t.getVolumeType()?yc(this,Sr).margins_buy.addMargin(t):yc(this,Sr).margins_sell.addMargin(t))})),Boolean(yc(this,Sr).margins_buy.getTotal()||yc(this,Sr).margins_sell.getTotal())},Dr=function(t,e){const{account:i}=this,s=i.currency_digits;t.forEach((t=>{if(!t||0n===t.trade_volume)return;const r=yc(this,Sr).margins.getOrCreate(t.trade_symbol);r&&r.addPosition(t)&&(r.isCollateral()||(e&&e.trade_symbol===t.trade_symbol&&(yc(this,Sr).new_position_type=t.trade_action,yc(this,Sr).new_position_volume=t.trade_volume),i.profit=a.normalize(i.profit+t.profit,s),i.storage_=a.normalize(i.storage_+t.storage_,s),r.isMarginExcludePL()&&t.isBuy()&&(i.profit_excluded=a.normalize(i.profit_excluded+t.profit,s))))})),i.floating=i.profit,i.floating=a.normalize(i.floating+i.storage_,s)},qr=function(t,e=null,i){const{account:s}=this,{currency_digits:r}=this.account;let o=e;const n=Boolean(o);if(t.forEach((t=>{if(!t)return;const e=yc(this,Sr).margins.getOrCreate(t.trade_symbol);if(e)if(o&&o.trade_order===t.trade_order){if(i)return void(o=null);e.addOrder(o,n),0!==d_(t.commission_daily,o.commission_daily,r)&&(s.acc_commission=a.normalize(s.acc_commission+o.commission_daily-t.commission_daily,r)),0!==d_(t.commission_monthly,o.commission_monthly,r)&&(s.acc_commission=a.normalize(s.acc_commission+(o.commission_monthly-t.commission_monthly),r)),yc(this,Sr).new_order_type=o.order_type,yc(this,Sr).new_order_volume=o.volume_current,o=null}else e.addOrder(t,n)})),o){const t=yc(this,Sr).margins.getOrCreate(o.trade_symbol);t&&(t.addOrder(o,n),o.commission_daily&&(s.acc_commission=a.normalize(s.acc_commission+o.commission_daily,s.currency_digits)),o.commission_monthly&&(s.acc_commission=a.normalize(s.acc_commission+o.commission_monthly,r)),yc(this,Sr).new_order_type=o.order_type,yc(this,Sr).new_order_volume=o.volume_current)}};class rd{constructor(t,e,i){fc(this,Fr),fc(this,Rr),fc(this,Vr),fc(this,Ur),fc(this,Hr),fc(this,Xr),bc(this,Xr,i),bc(this,Fr,t),bc(this,Rr,e),bc(this,Vr,new I_(yc(this,Xr),yc(this,Fr))),bc(this,Ur,new Y_(yc(this,Xr),yc(this,Fr))),bc(this,Hr,new ed(yc(this,Xr),yc(this,Fr),yc(this,Rr)))}calcAccount(t,e,i,s){const r=yc(this,Xr).margin_mode;1!==r?2!==r?yc(this,Hr).calcAccount(e,t,i,s):yc(this,Ur).calcAccount(e,t,i,s):yc(this,Vr).calcAccount(e,t,i,s)}checkStopOut(t){const e=t.margin_mode;1!==e?2!==e?yc(this,Hr).checkStopOut():yc(this,Ur).checkStopOut():yc(this,Vr).checkStopOut()}static isHedgedMargin(t){return 2===t.margin_mode}}Fr=new WeakMap,Rr=new WeakMap,Vr=new WeakMap,Ur=new WeakMap,Hr=new WeakMap,Xr=new WeakMap;class ad{constructor(){this.trade_order=BigInt(0),this.order_id="",this.trade_symbol="",this.time_setup=0,this.time_expiration=0,this.time_done=0,this.order_type=0,this.type_filling=0,this.type_time=0,this.type_reason=0,this.price_order=0,this.price_trigger=0,this.price_current=0,this.price_sl=0,this.price_tp=0,this.volume_initial=BigInt(0),this.volume_current=BigInt(0),this.order_state=0,this.expert=BigInt(0),this.position_id=BigInt(0),this.comment="",this.contract_size=0,this.digits=0,this.digits_currency=0,this.commission_daily=0,this.commission_monthly=0,this.margin_rate=0,this.activation_mode=0}copy(){const t=new ad;return t.trade_order=this.trade_order,t.order_id=this.order_id,t.trade_symbol=this.trade_symbol,t.time_setup=this.time_setup,t.time_expiration=this.time_expiration,t.time_done=this.time_done,t.order_type=this.order_type,t.type_filling=this.type_filling,t.type_time=this.type_time,t.type_reason=this.type_reason,t.price_order=this.price_order,t.price_trigger=this.price_trigger,t.price_current=this.price_current,t.price_sl=this.price_sl,t.price_tp=this.price_tp,t.volume_initial=this.volume_initial,t.volume_current=this.volume_current,t.order_state=this.order_state,t.expert=this.expert,t.position_id=this.position_id,t.comment=this.comment,t.contract_size=this.contract_size,t.digits=this.digits,t.digits_currency=this.digits_currency,t.commission_daily=this.commission_daily,t.commission_monthly=this.commission_monthly,t.margin_rate=this.margin_rate,t.activation_mode=this.activation_mode,t}isBuy(){return O_(this.order_type)}isSell(){return x_(this.order_type)}isMarket(){return A_(this.order_type)}isPending(){return P_(this.order_type)}isLimit(){return E_(this.order_type)}isStop(){return $_(this.order_type)}isStopLimit(){return N_(this.order_type)}isMarketPrice(){return this.isMarket()&&!this.price_order}isCloseBy(){return 8===this.order_type}isClose(){return Boolean(this.isMarket()&&this.position_id)}}class od{constructor(t,e){this.val=0,this.result=t??1,this.val=e??0}isValid(){return 0===this.result}isEmpty(){return!this.val}applyLeverageTier(t,e){this.isEmpty()||(this.val=a.normalize(this.val*t,e))}}class nd{constructor(t,e){this.rate=0,this.money=new od,this.rate=t??0,this.money=e??new od}isEmpty(){return(!this.rate||this.money.isValid())&&this.money.isEmpty()}applyLeverageTier(t,e){this.rate&&(this.rate=a.normalize(this.rate*t,7),this.money.applyLeverageTier(t,e))}}class cd{constructor(t,e){this.initial=t??new nd,this.maintenance=e??new nd}isEmpty(){return this.initial.isEmpty()&&this.maintenance.isEmpty()}applyLeverageTier(t,e){this.initial.applyLeverageTier(t.margin_rate_initial,e),this.maintenance.applyLeverageTier(t.margin_rate_maintenance,e)}}class ld{constructor(t,e,i,s,r){fc(this,Zr),fc(this,jr),fc(this,Gr),fc(this,Yr),fc(this,Kr),fc(this,Jr),bc(this,jr,t),bc(this,Gr,e),bc(this,Yr,i),bc(this,Kr,s),bc(this,Jr,r)}calculateMargins(t){const{margin_rates_initial:e,margin_rates_maintenance:i}=yc(this,Jr).trade;return t>=e.length||t>=i.length?new cd:new cd(new nd(e[t],vc(this,Zr,Qr).call(this,t,!0)),new nd(i[t],vc(this,Zr,Qr).call(this,t,!1)))}getLeverages(t){const{rules:e}=yc(this,Kr);if(e.length&&e[0].tiers.length)for(let s=0;s<e.length;s++){const i=e[s];if(!mh.check(i.path,yc(this,Jr).trade.symbol_path))continue;const r={floating:!0,mode:_d(t,i.range_mode),list:[]};if(Object.values({BUY:0,SELL:1,BUY_LIMIT:2,SELL_LIMIT:3,BUY_STOP:4,SELL_STOP:5,BUY_STOP_LIMIT:6,SELL_STOP_LIMIT:7}).forEach((t=>{const e=[];i.tiers.forEach((i=>{var s;const r=this.calculateMargins(t);r.applyLeverageTier(i,yc(this,Kr).currency_digits);const o=r.maintenance.rate||r.initial.rate,n=r.initial.money.val,c=(null==(s=r.maintenance.money)?void 0:s.isEmpty())?n:r.maintenance.money.val;var l;e.push({from:i.range_from,to:(l=i.range_to,l!==a.FLOAT64_MAX?l:1/0),initial:{rate:r.initial.rate,money:n},maintenance:{rate:o,money:c}})})),r.list[t]=e})),r.list.length)return r}const i={floating:!1,mode:_d(t),list:[]};return Object.values({BUY:0,SELL:1,BUY_LIMIT:2,SELL_LIMIT:3,BUY_STOP:4,SELL_STOP:5,BUY_STOP_LIMIT:6,SELL_STOP_LIMIT:7}).forEach((t=>{const e=[],s=this.calculateMargins(t);e.push({initial:{rate:s.initial.rate,money:s.initial.money.val},maintenance:{rate:s.maintenance.rate,money:s.maintenance.money.val}}),i.list[t]=e})),i}}jr=new WeakMap,Gr=new WeakMap,Yr=new WeakMap,Kr=new WeakMap,Jr=new WeakMap,Zr=new WeakSet,Qr=function(t,e=!1){const i=yc(this,Jr),s=yc(this,Kr).copy();s.rules=[];const{currency_digits:r,account_currency:a}=s,o=new rd(yc(this,jr),yc(this,Gr),s),n=new ad;n.trade_symbol=i.trade_symbol,n.order_type=t,n.volume_initial=1n*BigInt(10**8),n.volume_current=n.volume_initial,n.contract_size=i.trade_contract_size,n.order_state=0,n.digits=i.digits,n.digits_currency=r;const c=yc(this,Yr).getTick(i.trade_symbol,!1);return c?(n.price_order=function(t,e){return 0===e?t.ask:1===e?t.bid:0}(c,t),n.price_order<=0?new od(10021):(n.isBuy()?n.margin_rate=yc(this,jr).rateBuyMargin(i,a,n.price_order):n.margin_rate=yc(this,jr).rateSellMargin(i,a,n.price_order),n.margin_rate<=0?new od(10021):(e?o.calcAccount([],[],n,!1):o.calcAccount([n],[]),new od(0,s.margin)))):new od(10021)};class hd{constructor(t,e,i,s,r){fc(this,ta),fc(this,ea),fc(this,ia),fc(this,sa),fc(this,ra),bc(this,ta,t),bc(this,ea,e),bc(this,ia,i),bc(this,sa,s),bc(this,ra,r)}calcLeverageForSymbol(t,e){const i=yc(this,ta).getFullSymbolByName(e);return i?new ld(yc(this,ea),yc(this,ia),yc(this,sa),yc(this,ra),i).getLeverages(t):null}}function _d(t,e=2){switch(e){case 0:return t.volume;case 1:return t.volumePerSymbol;case 3:return t.valuePerSymbol;default:return t.value}}ta=new WeakMap,ea=new WeakMap,ia=new WeakMap,sa=new WeakMap,ra=new WeakMap;class dd{constructor(t){fc(this,aa),bc(this,aa,t)}getLeveragesBySymbol(t,e){const i=yc(this,aa).calcLeverageForSymbol(t,e);return i?{mode:i.mode,floating:null==i?void 0:i.floating,list:i.list.map((t=>t.map((t=>({from:t.from,to:t.to,initial:{rate:t.initial.rate,money:t.initial.money},maintenance:{rate:t.maintenance.rate,money:t.maintenance.money}})))))}:null}}aa=new WeakMap;class ud{constructor(t,e,i,s,r){this.controller=new rd(i,s,r.getAccount()),this.leverageController=new hd(t,i,s,e,r.getAccount()),this.view=new dd(this.leverageController)}}class pd{constructor(t){fc(this,oa),bc(this,oa,t)}load(t){return yc(this,oa).getRates(t)}}function md(t){switch(t){case 1:return 1;case 5:return 5;case 15:return 15;case 30:return 30;case 60:return 16385;case 240:return 16388;case 1440:return 16408;case 10080:return 32769;case 43200:return 49153;default:return 0}}oa=new WeakMap;class gd extends Rc{async getRates(t){try{const e=await this.socket.sendCommand(11,function(t){return Ec.serialize([[11,(t.symbol||"").substring(0,32),64],[5,md(t.period)],[3,Math.floor(((null==t?void 0:t.from)??0)/1e3)],[3,Math.floor(((null==t?void 0:t.to)??0)/1e3)]])}(t));return e.resBody}catch(e){throw e}}}class yd{constructor(t){fc(this,na),bc(this,na,t)}getRates(t,e,i,s){return yc(this,na).load({from:i,to:s,symbol:t,period:e})}}na=new WeakMap;class fd{constructor(t){this.controller=new pd(new gd(t)),this.ratesView=new yd(this.controller)}}class bd{constructor(){this.balance=0,this.profit=0,this.swap=0,this.commission=0,this.commissionFee=0,this.buysell=0,this.credit=0,this.deposit=0,this.withdrawal=0}clearEntity(){return this.balance=0,this.profit=0,this.swap=0,this.commission=0,this.commissionFee=0,this.buysell=0,this.credit=0,this.deposit=0,this.withdrawal=0,this}positionAdd(t){const e=t.digits_currency;return this.balance=a.normalize(this.balance+t.profit,e),t.isCredit()?(this.credit=a.normalize(this.credit+t.profit,e),this):2===t.trade_action&&t.profit>0?(this.deposit=a.normalize(this.deposit+t.profit,e),this):2===t.trade_action&&t.profit<0?(this.withdrawal=a.normalize(this.withdrawal+t.profit,e),this):t.isBalance()?(this.profit=a.normalize(this.profit+t.profit,e),this.buysell=a.normalize(this.buysell+t.profit,e),this):(this.profit=a.normalize(this.profit+t.profit,e),this.buysell=a.normalize(this.buysell+t.profit,e),this.swap=a.normalize(this.swap+t.storage_,e),this.balance=a.normalize(this.balance+t.storage_,e),this.buysell=a.normalize(this.buysell+t.storage_,e),this.commission=a.normalize(this.commission+t.commission,e),this.commissionFee=a.normalize(this.commissionFee+t.commission_fee,e),this.balance=a.normalize(this.balance+t.commission,e),this.buysell=a.normalize(this.buysell+t.commission,e),this.balance=a.normalize(this.balance+t.commission_fee,e),this.buysell=a.normalize(this.buysell+t.commission_fee,e),this)}}class vd{constructor(t={}){this.deal=BigInt(0),this.deal_id="",this.trade_order=BigInt(0),this.time_create=0,this.time_update=0,this.trade_action=0,this.trade_symbol="",this.trade_volume=BigInt(0),this.trade_reason=0,this.entry=0,this.price_open=0,this.price_close=0,this.digits=0,this.digits_currency=0,this.sl=0,this.tp=0,this.profit=0,this.rate_profit=0,this.rate_margin=0,this.commission=0,this.storage_=0,this.expert=BigInt(0),this.comment="",this.contract_size=0,this.commission_fee=0,this.external_id="",this.position_id=BigInt(0),this.expert_position_id=BigInt(0),this.value=0,this.__isCollateral=!1,this.trade_volume=t.trade_volume??BigInt(0),this.deal=t.deal??this.deal,this.deal_id=t.deal_id??this.deal_id,this.trade_symbol=t.trade_symbol??this.trade_symbol,this.entry=t.entry??this.entry,this.price_close=t.price_close??this.price_close,this.trade_order=t.trade_order??this.trade_order,this.time_update=t.time_update??this.time_update,this.time_create=t.time_create??this.time_create,this.trade_action=t.trade_action??this.trade_action,this.trade_reason=t.trade_reason??this.trade_reason,this.digits=t.digits??this.digits,this.sl=t.sl??this.sl,this.tp=t.tp??this.tp,this.profit=t.profit??this.profit,this.rate_profit=t.rate_profit??this.rate_profit,this.rate_margin=t.rate_margin??this.rate_margin,this.commission=t.commission??this.commission,this.price_open=t.price_open??this.price_open,this.storage_=t.storage_??this.storage_,this.expert=t.expert??this.expert,this.position_id=t.position_id??this.position_id,this.comment=t.comment??this.comment,this.contract_size=t.contract_size??this.contract_size,this.digits_currency=t.digits_currency??this.digits_currency,this.commission_fee=t.commission_fee??this.commission_fee,this.external_id=t.external_id??this.external_id,this.expert_position_id=t.expert_position_id??this.expert_position_id}copy(){return new vd({trade_volume:this.trade_volume,deal:this.deal,deal_id:this.deal_id,trade_symbol:this.trade_symbol,entry:this.entry,price_close:this.price_close,trade_order:this.trade_order,time_update:this.time_update,time_create:this.time_create,trade_action:this.trade_action,trade_reason:this.trade_reason,digits:this.digits,sl:this.sl,tp:this.tp,profit:this.profit,rate_profit:this.rate_profit,rate_margin:this.rate_margin,commission:this.commission,price_open:this.price_open,storage_:this.storage_,expert:this.expert,position_id:this.position_id,comment:this.comment,contract_size:this.contract_size,digits_currency:this.digits_currency,commission_fee:this.commission_fee,external_id:this.external_id,expert_position_id:this.expert_position_id,__isCollateral:this.__isCollateral})}isIn(){return 0===this.entry}isOut(){return 1===this.entry}isInOut(){return 2===this.entry}isOutBy(){return 3===this.entry}hasProfit(){return 1===this.entry||2===this.entry}isBuy(){return F_(this.trade_action)}isSell(){return R_(this.trade_action)}isTrade(){return 0===this.trade_action||1===this.trade_action}isCredit(){return 3===this.trade_action||6===this.trade_action}isCanceled(){return 13===this.trade_action||14===this.trade_action}isService(){const t=this.trade_reason;return 6===t||8===t||11===t||12===t||13===t||14===t}isBalance(){return V_(this.trade_action)}isBalanceAllowed(){return U_(this.trade_action)}isCommission(){const t=this.trade_action;return 7===t||8===t||9===t}isCollateral(t){return void 0!==this.__isCollateral||t&&(this.__isCollateral=t.isCollateral()),this.__isCollateral}}class wd extends vd{constructor(){super(...arguments),this.position_id=BigInt(0),this.trade_symbol="",this.trade_type=0,this.trade_reason=0,this.expert=BigInt(0),this.open_volume=BigInt(0),this.open_time=0,this.open_price=0,this.close_volume=BigInt(0),this.close_time=0,this.close_price=0,this.commission=0,this.storage_=0,this.profit=0,this.digits=0,this.digits_currency=0,this.contract_size=0}dealAdd(t){return t.isBalance()?(this.position_id=t.deal,this.trade_type=t.trade_action,this.expert=t.expert,this.profit=t.profit,this.trade_reason=t.trade_reason,this.open_volume=BigInt(0),this.open_time=t.time_create,this.open_price=0,this.sl=0,this.tp=0,this.close_volume=BigInt(0),this.close_time=0,this.close_price=0,this.comment=t.comment,this.digits=t.digits,this.digits_currency=t.digits_currency,!0):!!t.position_id&&(this.open_volume?this.position_id===t.position_id&&(t.isBuy()&&0===this.trade_type||t.isSell()&&1===this.trade_type?(this.profit=a.normalize(this.profit+t.profit,this.digits_currency),this.storage_=a.normalize(this.storage_+t.storage_,this.digits_currency),this.commission=a.normalize(this.commission+t.commission,this.digits_currency),this.commission_fee=a.normalize(this.commission_fee+t.commission_fee,this.digits_currency),t.isService()||(this.open_time=Math.min(this.open_time,t.time_create),this.open_price=(Number(this.open_volume)*this.open_price+Number(t.trade_volume)*t.price_open)/(Number(this.open_volume)+Number(t.trade_volume)),this.open_volume+=t.trade_volume,this.sl=t.sl,this.tp=t.tp),(t.isOut()||t.isInOut())&&(this.close_time=Math.max(this.close_time,t.time_create)),!t.isService()&&t.comment&&(this.comment=t.comment)):(this.profit=a.normalize(this.profit+t.profit,this.digits_currency),this.storage_=a.normalize(this.storage_+t.storage_,this.digits_currency),this.commission=a.normalize(this.commission+t.commission,this.digits_currency),this.commission_fee=a.normalize(this.commission_fee+t.commission_fee,this.digits_currency),t.isService()||(this.close_time?(this.close_time=Math.max(this.close_time,t.time_create),this.close_price=(Number(this.close_volume)*this.close_price+Number(t.trade_volume)*t.price_open)/(Number(this.close_volume)+Number(t.trade_volume)),this.close_volume+=t.trade_volume):(this.close_time=t.time_create,this.close_price=t.price_open,this.close_volume=t.trade_volume),this.sl=t.sl,this.tp=t.tp)),this.digits=t.digits,this.digits_currency=t.digits_currency,this.contract_size=t.contract_size,!0):(this.trade_symbol=t.trade_symbol,this.position_id=t.position_id,this.trade_type=t.isBuy()?0:1,this.expert=t.expert,this.trade_reason=t.trade_reason,this.open_volume=t.trade_volume,this.open_time=t.time_create,this.open_price=t.price_open,this.sl=t.sl,this.tp=t.tp,this.close_volume=BigInt(0),this.close_time=0,this.close_price=0,this.profit=t.profit,this.storage_=t.storage_,this.commission=t.commission,this.commission_fee=t.commission_fee,this.digits=t.digits,this.digits_currency=t.digits_currency,this.contract_size=t.contract_size,this.comment=t.comment,!0))}isBuy(){return 0===this.trade_type}isSell(){return 1===this.trade_type}isBalance(){return V_(this.trade_type)}}class kd{constructor(){this.total=0,this.filled=0,this.canceled=0,this.rejected=0}clearEntity(){return this.total=0,this.filled=0,this.canceled=0,this.rejected=0,this}orderAdd(t){switch(this.total+=1,t.order_state){case 4:return this.filled+=1,this;case 2:return this.canceled+=1,this;case 5:return this.rejected+=1,this}return this}}class Td{constructor(){this.balance=0,this.profit=0,this.swap=0,this.commission=0,this.commissionFee=0,this.buysell=0,this.credit=0,this.deposit=0,this.withdrawal=0}clearEntity(){return this.balance=0,this.profit=0,this.swap=0,this.commission=0,this.commissionFee=0,this.buysell=0,this.credit=0,this.deposit=0,this.withdrawal=0,this}dealAdd(t){const e=t.digits_currency;return this.swap=a.normalize(this.swap+t.storage_,e),this.commission=a.normalize(this.commission+t.commission,e),this.commissionFee=a.normalize(this.commissionFee+t.commission_fee,e),this.balance=a.normalize(this.balance+t.profit,e),this.balance=a.normalize(this.balance+t.storage_,e),this.balance=a.normalize(this.balance+t.commission,e),this.balance=a.normalize(this.balance+t.commission_fee,e),t.isTrade()?(this.profit=a.normalize(this.profit+t.profit,e),this.buysell=a.normalize(this.buysell+t.profit,e),this.buysell=a.normalize(this.buysell+t.storage_,e),this.buysell=a.normalize(this.buysell+t.commission,e),this.buysell=a.normalize(this.buysell+t.commission_fee,e),this):t.isCredit()?(this.credit=a.normalize(this.credit+t.profit,e),this):2===t.trade_action&&t.profit>0?(this.deposit=a.normalize(this.deposit+t.profit,e),this):2===t.trade_action&&t.profit<0?(this.withdrawal=a.normalize(this.withdrawal+t.profit,e),this):t.isBalance()?(this.profit=a.normalize(this.profit+t.profit,e),this.buysell=a.normalize(this.buysell+t.profit,e),this):this}}class Md{constructor(){fc(this,ca,!1),fc(this,la,null),fc(this,ha,null),fc(this,_a,null),fc(this,da,null),fc(this,ua,null),fc(this,pa,null),fc(this,ma,null),fc(this,ga,null),fc(this,ya,null)}clearStorage(){bc(this,da,null),bc(this,la,null),bc(this,pa,null),bc(this,ua,null),bc(this,ha,null),bc(this,_a,null)}getSymbols(){var t;return null==(t=yc(this,la))?void 0:t.reduce(((t,e)=>{const i=e.trade_symbol;return i&&-1===t.indexOf(i)&&t.push(i),t}),[])}addOrder(t){var e,i;null==(e=yc(this,da))||e.push(t),null==(i=yc(this,ga))||i.orderAdd(t)}setOrders(t){bc(this,da,t),this.calcOrdersTotal()}getOrders(){return yc(this,da)&&yc(this,da).slice()||[]}getOrdersTotal(){return yc(this,ga)}calcOrdersTotal(){var t;yc(this,ga)||bc(this,ga,new kd),yc(this,ga).clearEntity(),null==(t=yc(this,da))||t.forEach((t=>{var e;null==(e=yc(this,ga))||e.orderAdd(t)}))}getOrderById(t){var e;if(!(null==(e=yc(this,ua))?void 0:e.length))return null;let i=0,s=yc(this,ua).length;for(;i<s;){let e=Math.floor(i+(s-i)/2);const r=yc(this,ua)[e]&&yc(this,ua)[e].trade_order;if(r===t)return yc(this,ua)[e];r>t?s=e-1:i=e+1}return null}removeOrderById(t,e){if(!yc(this,da))return;const i=yc(this,da)&&yc(this,da).findIndex((e=>e.trade_order===t));-1!==i&&(e?yc(this,da).splice(i,1,e):yc(this,da).splice(i,1),this.sortRecords())}addDeal(t){var e,i;null==(e=yc(this,la))||e.push(t),null==(i=yc(this,ya))||i.dealAdd(t)}setDeals(t){bc(this,la,t),this.calcDealsTotal()}getDeals(){var t;return(null==(t=yc(this,la))?void 0:t.slice())??[]}getDealsTotal(){return yc(this,ya)}calcDealsTotal(){var t;yc(this,ya)||bc(this,ya,new Td),yc(this,ya).clearEntity(),null==(t=yc(this,la))||t.forEach((t=>{var e;null==(e=yc(this,ya))||e.dealAdd(t)}))}getDealByDeal(t){var e;if(!(null==(e=yc(this,ha))?void 0:e.length))return null;let i=0,s=yc(this,ha).length;for(;i<s;){const e=Math.floor(i+(s-i)/2),r=yc(this,ha)[e]&&yc(this,ha)[e].deal;if(r===t)return yc(this,ha)[e];r>t?s=e-1:i=e+1}return null}getDealById(t){var e;if(!(null==(e=yc(this,_a))?void 0:e.length))return null;const i=t.toString();let s=0,r=yc(this,_a).length;for(;s<r;){const t=Math.floor(s+(r-s)/2),e=yc(this,_a)[t]&&yc(this,_a)[t].position_id.toString();if(e===i)return yc(this,_a)[t];e>i?r=t-1:s=t+1}return null}getDealBySymbolId(t,e){return t.isHedgedMargin()?this.getDealById(e):null}getDealsByOrder(t){return yc(this,la)&&yc(this,la).filter((e=>e.trade_order===t))}removeDealByDeal(t,e){if(!yc(this,la))return;const i=yc(this,la).findIndex((e=>e.deal===t));"number"==typeof i&&-1!==i&&(e?yc(this,la).splice(i,1,e):yc(this,la).splice(i,1),this.sortRecords())}getPositions(){return yc(this,pa)&&yc(this,pa).slice()||[]}getPositionsTotal(){return yc(this,ma)}buildPositions(t){if(bc(this,pa,[]),yc(this,ma)||bc(this,ma,new bd),yc(this,ma).clearEntity(),yc(this,la)){let e=yc(this,la).slice().sort(Cd);t&&(e=e.filter((e=>e.trade_symbol===t))),e.forEach((t=>this.updateHistoryPosition(t))),this.calcPositionsTotal(t),yc(this,pa).sort(Bd)}}updateHistoryPosition(t,e=!1){var i;const s=t.isBalance()?t.deal:t.position_id;let r=yc(this,pa)&&yc(this,pa).find((e=>e.position_id===s&&V_(e.trade_type)===V_(t.trade_action)));r?r.dealAdd(t):(r=new wd,r.dealAdd(t),null==(i=yc(this,pa))||i.push(r),e&&yc(this,pa)&&yc(this,pa).sort(Bd))}calcPositionsTotal(t){if(yc(this,ma)||bc(this,ma,new bd),yc(this,ma).clearEntity(),yc(this,la)){let e=yc(this,la);t&&(e=yc(this,la).slice().sort(Cd).filter((e=>e.trade_symbol===t))),e.forEach((t=>{var e;const i=t.isBalance()?t.deal:t.position_id,s=yc(this,pa)&&yc(this,pa).find((e=>e.position_id===i&&V_(e.trade_type)===V_(t.trade_action)));s&&(s.close_volume||s.isBalance())&&(null==(e=yc(this,ma))||e.positionAdd(t))}))}}sortRecords(){yc(this,la)&&(bc(this,ha,yc(this,la).slice().sort(Wd)),bc(this,_a,yc(this,la).slice().sort(zd)),bc(this,ca,yc(this,la).some((t=>!!t.deal_id)))),yc(this,da)&&(bc(this,ua,yc(this,da).slice().sort(Sd)),bc(this,ca,yc(this,ca)||yc(this,da).some((t=>!!t.order_id))))}}function Sd(t,e){const i=t.trade_order.toString(),s=e.trade_order.toString();return i>s?1:i<s?-1:0}function zd(t,e){const i=t.position_id.toString(),s=e.position_id.toString();return i>s?1:i<s?-1:0}function Bd(t,e){if(t.position_id.toString()>e.position_id.toString())return 1;if(t.position_id.toString()<e.position_id.toString())return-1;if(V_(t.trade_type)!==V_(e.trade_type)){if(t.trade_type>e.trade_type)return 1;if(t.trade_type<e.trade_type)return-1}return 0}function Cd(t,e){return t.time_create>e.time_create?1:t.time_create<e.time_create?-1:0}function Wd(t,e){return t.deal>e.deal?1:t.deal<e.deal?-1:0}ca=new WeakMap,la=new WeakMap,ha=new WeakMap,_a=new WeakMap,da=new WeakMap,ua=new WeakMap,pa=new WeakMap,ma=new WeakMap,ga=new WeakMap,ya=new WeakMap;class Id{constructor(t,e){fc(this,fa),fc(this,ba,new Md),fc(this,va),fc(this,wa,(t=>{const{deals:e,orders:i}=t;return yc(this,ba).setOrders(i),yc(this,ba).setDeals(e),yc(this,ba).sortRecords(),yc(this,ba).buildPositions(),t})),bc(this,fa,t),bc(this,va,e)}async loadHistory(t){const e=await yc(this,fa).getTradeHistory(t);yc(this,wa).call(this,e)}destroy(){yc(this,ba).clearStorage()}addOrder(t){yc(this,ba).addOrder(t)}sortRecords(){yc(this,ba).sortRecords()}getOrderById(t){return yc(this,ba).getOrderById(t)}getDealBySymbolId(t){return yc(this,ba).getDealBySymbolId(yc(this,va).getAccount(),t)}removeOrderById(t,e){yc(this,ba).removeOrderById(t,e)}getDealByDeal(t){return yc(this,ba).getDealByDeal(t)}getDealById(t){return yc(this,ba).getDealById(t)}updateHistoryPosition(t,e=!1){yc(this,ba).updateHistoryPosition(t,e),yc(this,ba).calcPositionsTotal()}removeDealByDeal(t,e){yc(this,ba).removeDealByDeal(t,e)}addDeal(t){yc(this,ba).addDeal(t)}getDeals(){return yc(this,ba).getDeals()}getDealsTotal(){return yc(this,ba).getDealsTotal()}getOrders(){return yc(this,ba).getOrders()}getOrdersTotal(){return yc(this,ba).getOrdersTotal()}getPositions(){return yc(this,ba).getPositions()}getPositionsTotal(){return yc(this,ba).getPositionsTotal()}}fa=new WeakMap,ba=new WeakMap,va=new WeakMap,wa=new WeakMap;const Ld=[{propType:17},{propType:11,propLength:64},{propType:11,propLength:64},{propType:6},{propType:6},{propType:6},{propType:6},{propType:6},{propType:6},{propType:6},{propType:8},{propType:8},{propType:8},{propType:8},{propType:8},{propType:17},{propType:17},{propType:6},{propType:17},{propType:17},{propType:11,propLength:64},{propType:8},{propType:6},{propType:6},{propType:8},{propType:8},{propType:8},{propType:6},{propType:3},{propType:3}],Od=Ec.getSeriesSize(Ld);function xd(t,e=0){const i=Ec.parse(t,Ld,e);i[3]=1e3*i[3]+i[28],i[4]*=1e3,i[5]=1e3*i[5]+i[29];const s=new ad;return s.trade_order=i[0],s.order_id=i[1],s.trade_symbol=i[2],s.time_setup=i[3],s.time_expiration=i[4],s.time_done=i[5],s.order_type=i[6],s.type_filling=i[7],s.type_time=i[8],s.type_reason=i[9],s.price_order=i[10],s.price_trigger=i[11],s.price_current=i[12],s.price_sl=i[13],s.price_tp=i[14],s.volume_initial=i[15],s.volume_current=i[16],s.order_state=i[17],s.expert=i[18],s.position_id=i[19],s.comment=i[20],s.contract_size=i[21],s.digits=i[22],s.digits_currency=i[23],s.commission_daily=i[24],s.commission_monthly=i[25],s.margin_rate=i[26],s.activation_mode=i[27],s}function Ad(t,e=0){let i=e;const s=[],r=new DataView(t).getUint32(i,!0);i+=4;for(let a=0;a<r;a++)s.push(xd(t,i)),i+=Od;return s}const Pd=[{propType:17},{propType:11,propLength:64},{propType:17},{propType:6},{propType:6},{propType:11,propLength:64},{propType:6},{propType:6},{propType:8},{propType:8},{propType:8},{propType:8},{propType:18},{propType:8},{propType:8},{propType:8},{propType:8},{propType:8},{propType:17},{propType:17},{propType:11,propLength:64},{propType:8},{propType:6},{propType:6},{propType:6},{propType:3},{propType:3},{propType:8}],Ed=Ec.getSeriesSize(Pd);function $d(t,e=0){const i=Ec.parse(t,Pd,e);return new vd({deal:i[0],deal_id:i[1],trade_order:i[2],time_create:1e3*i[3]+i[25],time_update:1e3*i[4]+i[26],trade_symbol:i[5],trade_action:i[6],entry:i[7],price_open:i[8],price_close:i[9],sl:i[10],tp:i[11],trade_volume:i[12],profit:i[13],rate_profit:i[14],rate_margin:i[15],commission:i[16],storage_:i[17],expert:i[18],position_id:i[19],comment:i[20],contract_size:i[21],digits:i[22],digits_currency:i[23],trade_reason:i[24],commission_fee:i[27]})}function Nd(t,e=0){return new DataView(t).getUint32(e,!0)*Ed+4}function Dd(t,e=0){let i=e;const s=[],r=new DataView(t).getUint32(i,!0);i+=4;for(let a=0;a<r;a++)s.push($d(t,i)),i+=Ed;return s}class qd extends Rc{async getTradeHistory(t){var e;return{deals:Dd(e=(await this.socket.sendCommand(5,function({from:t,to:e}={from:0,to:0}){return Int32Array.from([t,e]).buffer}(t))).resBody,0),orders:Ad(e,Nd(e,0))}}}function Fd(t){return t.deal_id.toString()}function Rd(t){return t.trade_symbol}function Vd(t){return t.position_id?t.position_id.toString():""}function Ud(t){return t.deal.toString()}function Hd(t){return t.trade_order?t.trade_order.toString():""}function Xd(t,e){const i=vh(t.trade_volume);return jd(t,e)(i)}function jd(t,e){let i="",s="";return e&&(i+=`#${e} `),i+=q_(t.trade_action),s+=`${Rd(t)} ${wh(t.price_open,t.digits,3)}`,t=>`${i} ${t} ${s}`}function Gd(t){return Xd(t,Vd(t)||Fd(t))}function Yd(t){switch(t){case 0:case 0:return"buy";case 1:case 1:return"sell";default:return"unknown"}}function Kd(t){return t.trade_symbol}function Jd(t){return t.trade_order.toString()}function Zd(t){return t.order_id}function Qd(t,e=!0){let i="",s=t.volume_initial,r=t.volume_current;if(e)s>=r?(i+=vh(s),i+=" / ",i+=vh(s-r)):(i+=vh(s),i+=" / ",i+=vh(r));else{const e=t.contract_size;s=Th(s,e),r=Th(r,e),i+=vh(s),i+=" / ",i+=vh(s-r)}return i}function tu(t,e=!0){let i="";const s=Jd(t);return s&&(i+=`#${s} `),i+=D_(t.order_type),t.volume_initial===t.volume_current?i+=` ${vh(t.volume_initial)}`:i+=` ${Qd(t)}`,e&&(i+=` ${Kd(t)}`),i}class eu{constructor(t){fc(this,ka),bc(this,ka,t)}async load(t){await yc(this,ka).loadHistory(t)}deals(){return{items:yc(this,ka).getDeals().map(iu.from),total:su.from(yc(this,ka).getDealsTotal())}}orders(){return{items:yc(this,ka).getOrders().map(ru.from),total:au.from(yc(this,ka).getOrdersTotal())}}positions(){const t=[];return yc(this,ka).getPositions().forEach((e=>{e.isBalance()?t.push(new cu(e)):e.close_volume&&t.push(new ou(e))})),{items:t.sort(((t,e)=>t.timeOpen-e.timeOpen)),total:nu.from(yc(this,ka).getPositionsTotal())}}}ka=new WeakMap;class iu{constructor(t){this.isBuy=!1,this.isSell=!1,this.symbol=t.trade_symbol,this.timeCreate=t.time_create,this.deal=Ud(t),this.id=Fd(t),this.order=Hd(t),this.position=Vd(t),this.action=t.trade_action,this.isBuy=t.isBuy(),this.isSell=t.isSell(),this.isBalance=t.isBalance(),this.entry=function(t){switch(t.entry){case 0:return"in";case 1:return"out";case 2:return"in/out";case 3:return"out by";default:return""}}(t),this.volume=vh(t.trade_volume),this.volumeValue=fh.toDouble(t.trade_volume),this.tradeReason=t.trade_reason,this.volumeSize=bh(fh.toSize(t.trade_volume,t.contract_size)),this.priceOpen=a.normalize(t.price_open,t.digits+3),this.priceClose=a.normalize(t.price_close,t.digits+3),this.commission=t.commission,this.commissionFee=t.commission_fee,this.storage=t.storage_,this.digits=t.digits,this.digitsCurrency=t.digits_currency,this.comment=t.comment||"",(t.hasProfit()||t.profit)&&(this.profit=a.normalize(t.profit,t.digits_currency))}static from(t){return new iu(t)}}class su{constructor(t){this.balance=0,this.profit=0,this.swap=0,this.commission=0,this.commissionFee=0,this.buysell=0,this.credit=0,this.deposit=0,this.withdrawal=0,t&&(this.balance=t.balance,this.profit=t.profit,this.swap=t.swap,this.commission=t.commission,this.commissionFee=t.commissionFee,this.buysell=t.buysell,this.credit=t.credit,this.deposit=t.deposit,this.withdrawal=t.withdrawal)}static from(t){return new su(t)}}class ru{constructor(t){this.price=null,this.timeSetup=t.time_setup,this.timeDone=t.time_done,this.order=t.trade_order.toString(),this.id=t.order_id,this.symbol=t.trade_symbol,this.type=t.order_type,this.typeReason=t.type_reason,this.volume=Qd(t,!1),this.volumeValue=fh.toDouble(t.volume_initial),this.volumeSize=Qd(t,!0),this.digits=t.digits,this.digitsCurrency=t.digits_currency,t.price_order&&(this.price=a.normalize(t.price_order,t.digits)),this.sl=a.normalize(t.price_sl,t.digits),this.tp=a.normalize(t.price_tp,t.digits),this.comment=t.comment,this.state=t.order_state}static from(t){return new ru(t)}}class au{constructor(t){this.total=0,this.filled=0,this.canceled=0,this.rejected=0,t&&(this.total=t.total,this.filled=t.filled,this.canceled=t.canceled,this.rejected=t.rejected)}static from(t){return new au(t)}}class ou{constructor(t){this.isBuy=!1,this.isSell=!1,this.isBalance=!1,this.id=Vd(t),this.comment=t.comment||"",this.timeOpen=t.open_time,this.sl=a.normalize(t.sl,t.digits),this.tp=a.normalize(t.tp,t.digits),this.digits=t.digits,this.digitsCurrency=t.digits_currency,this.type=t.trade_type,this.isBuy=t.isBuy(),this.isSell=t.isSell(),this.isBalance=t.isBalance(),t.open_volume===t.close_volume?(this.volume=vh(t.open_volume),this.volumeValue=fh.toDouble(t.open_volume),this.volumeSize=bh(fh.toSize(t.open_volume,t.contract_size))):(this.volume=vh(t.close_volume),this.volumeValue=fh.toDouble(t.close_volume),this.volumeSize=bh(fh.toSize(t.close_volume,t.contract_size))),t.close_volume&&(this.timeClose=t.close_time),this.symbol=Rd(t),this.priceOpen=a.normalize(t.open_price,this.digits+3),this.priceClose=a.normalize(t.close_price,this.digits+3),this.commission=a.normalize(t.commission||0,this.digitsCurrency),this.commissionFee=a.normalize(t.commission_fee||0,this.digitsCurrency),(t.profit||t.isBalance())&&(this.profit=a.normalize(t.profit||0,this.digitsCurrency)),t.close_volume&&(this.storage=a.normalize(t.storage_||0,this.digitsCurrency))}static from(t){return new ou(t)}}class nu{constructor(t){this.balance=0,this.profit=0,this.swap=0,this.commission=0,this.commissionFee=0,this.buysell=0,this.credit=0,this.deposit=0,this.withdrawal=0,t&&(this.balance=t.balance,this.profit=t.profit,this.swap=t.swap,this.commission=t.commission,this.commissionFee=t.commissionFee,this.buysell=t.buysell,this.credit=t.credit,this.deposit=t.deposit,this.withdrawal=t.withdrawal)}static from(t){return new nu(t)}}class cu extends ou{static from(t){return new cu(t)}constructor(t){super(t),this.id=Vd(t),this.comment=t.comment||"",this.timeOpen=t.open_time,this.digits=t.digits,this.digitsCurrency=t.digits_currency,this.type=t.trade_type,(t.profit||t.isBalance())&&(this.profit=a.normalize(t.profit,this.digitsCurrency)),t.close_volume&&(this.storage=a.normalize(t.storage_||0,this.digitsCurrency))}}class lu{constructor(t,e){this.controller=new Id(new qd(t),e),this.view=new eu(this.controller)}}function hu(t,e){let i=0,s=0;return function(t){switch(t.trade_calc_mode){case 32:case 33:case 34:case 35:case 36:case 37:case 38:case 39:return!0;default:return!1}}(t)?(i=e.last_last,s=e.last_last):(i=e.bid,s=e.ask),{bid:i,ask:s}}function _u(t,e,i,s,r,o=!1){if(i.isExchangeMargin()&&t.isStock()){const o=fh.toSize(e.trade_volume,e.contract_size),n=a.normalize(e.price_open*o*e.rate_margin,t.currency_profit_digits);let c=0;e.isBuy()?(e.rate_profit=r,c=a.normalize(e.price_close*o*r,t.currency_profit_digits),e.profit=a.normalize(c-n,i.currency_digits)):(e.rate_profit=s,c=a.normalize(e.price_close*o*s,t.currency_profit_digits),e.profit=a.normalize(n-c,i.currency_digits))}else if(t.isBond()){const o=fh.toSize(e.trade_volume,e.contract_size),n=a.normalize(o*t.trade_face_value*e.price_open/100*e.rate_margin,t.currency_base_digits);let c=0;e.isBuy()?(e.rate_profit=r,c=a.normalize(o*t.trade_face_value*e.price_close/100*e.rate_margin,t.currency_base_digits),e.profit=a.normalize(c-n,i.currency_digits)):(e.rate_profit=s,c=a.normalize(o*t.trade_face_value*e.price_close/100*e.rate_margin,t.currency_base_digits),e.profit=a.normalize(n-c,i.currency_digits))}else e.profit=function(t,e,i,s,r,o,n=!1){let c=0;const l=t.currency_profit_digits,h=t.trade_tick_value,_=t.trade_tick_size,d=t.trade_face_value;switch(t.trade_calc_mode){case 0:case 5:{const t=fh.toSize(i,s);c=e?a.normalize(o*t,l)-a.normalize(r*t,l):a.normalize(r*t,l)-a.normalize(o*t,l);break}case 1:case 33:case 35:case 36:{const t=fh.toDouble(i);c=e?(o-r)*t*h:(r-o)*t*h,_&&(c/=_);break}case 34:{const t=fh.toDouble(i);let s,n;_?(s=a.normalize(r*h/_,l),n=a.normalize(o*h/_,l)):(s=a.normalize(r*h,l),n=a.normalize(o*h,l)),c=e?(n-s)*t:(s-n)*t;break}case 37:case 39:{const t=fh.toSize(i,s);c=e?a.normalize(t*o*d/100,l)-a.normalize(t*r*d/100,l):a.normalize(t*r*d/100,l)-a.normalize(t*o*d/100,l);break}case 64:if(n){const t=fh.toSize(i,s);c=e?o*t-r*t:r*t-o*t}else c=0;break;default:{const t=fh.toSize(i,s);c=e?o*t-r*t:r*t-o*t}}return(c>1e11||c<-1e11)&&(c=0),(o<0||!t.isCollateral()&&!o)&&(c=0),a.normalize(c,l)}(t,e.isBuy(),e.trade_volume,e.contract_size,e.price_open,e.price_close,o),!t.isForex()||1&t.trade_flags?e.profit>0?(e.profit*=r,e.rate_profit=r):(e.profit*=s,e.rate_profit=s):e.isBuy()?(e.profit*=s,e.rate_profit=s):(e.profit*=r,e.rate_profit=r),e.profit=a.normalize(e.profit,i.currency_digits)}class du{constructor(){fc(this,Ta),fc(this,Ma),this.has={},bc(this,Ta,[]),bc(this,Ma,[])}getPositions(){return yc(this,Ta).slice()}getOrders(){return yc(this,Ma).slice()}clearStorage(){bc(this,Ta,[]),bc(this,Ma,[]),this.has.id=!1,this.has.positionSL=!1,this.has.positionTP=!1,this.has.orderSL=!1,this.has.orderTP=!1}sortRecords(){this.has.positionSL=yc(this,Ta).some((t=>!!t.sl)),this.has.positionTP=yc(this,Ta).some((t=>!!t.tp)),this.has.orderSL=yc(this,Ma).some((t=>!!t.price_sl)),this.has.orderTP=yc(this,Ma).some((t=>!!t.price_tp))}addOrder(t){if(!t)return!1;const e=t.trade_order;return!yc(this,Ma).find((t=>t.trade_order===e))&&(t.prev=new ad,yc(this,Ma).push(t),t.order_id&&(this.has.id=!0),!0)}addPosition(t){return t.prev=new vd,yc(this,Ta).push(t),t.external_id&&(this.has.id=!0),!0}removeOrder(t,e=null){if(!t)return!1;const i=t.trade_order,s=yc(this,Ma).findIndex((t=>t.trade_order===i));return-1!==s&&(e?yc(this,Ma).splice(s,1,e):yc(this,Ma).splice(s,1),!0)}removePosition(t,e=null){let i;return i=t.position_id?this.getPositionById(t.position_id,!0):this.getPositionBySymbol(t.trade_symbol,!0),i>-1&&(e?yc(this,Ta).splice(i,1,e):yc(this,Ta).splice(i,1),!0)}getOrderById(t,e){return e?yc(this,Ma).findIndex((e=>e.trade_order===t)):yc(this,Ma).find((e=>e.trade_order===t))??null}getOrdersBySymbol(t){return yc(this,Ma).filter((e=>e.trade_symbol===t))}getPositionById(t,e){return t?e?yc(this,Ta).findIndex((e=>e.position_id===t)):yc(this,Ta).find((e=>e.position_id===t))??null:null}getPositionBySymbol(t,e){return e?yc(this,Ta).findIndex((e=>e.trade_symbol===t)):yc(this,Ta).find((e=>e.trade_symbol===t))??null}getPositionsBySymbol(t){return yc(this,Ta).filter((e=>e.trade_symbol===t))}useSymbol(t){return!!yc(this,Ma).some((e=>e.trade_symbol===t))||!!yc(this,Ta).some((e=>e.trade_symbol===t))}hasOrders(){return Boolean(yc(this,Ma).length)}hasPositions(){return yc(this,Ta).some((t=>!t.isCollateral()))}}Ta=new WeakMap,Ma=new WeakMap;let uu=new Map;class pu{constructor(t,e,i,s,r,a,o){fc(this,$a),fc(this,Sa,null),fc(this,za,new Set),fc(this,Ba),fc(this,Ca),fc(this,Wa),fc(this,Ia),fc(this,La,new du),fc(this,Oa),fc(this,xa),fc(this,Aa),fc(this,Pa,(t=>{const{positions:e}=t;e&&e.forEach((t=>{this.addPosition(t)}));const{orders:i}=t;i&&i.forEach((t=>{this.addOrder(t)}))})),fc(this,Ea,(t=>{const e=t.trade_symbol;let i=uu.get(e);i||(i=vc(this,$a,Na).bind(this,e),uu.set(e,i)),yc(this,za).add(i),yc(this,Sa)||bc(this,Sa,window.setTimeout((()=>{yc(this,za).forEach((t=>t())),yc(this,za).clear(),bc(this,Sa,null)}),200))})),bc(this,Ba,t),bc(this,Ca,e),bc(this,Wa,i),bc(this,Ia,s),bc(this,Oa,r),bc(this,xa,a),bc(this,Aa,o)}calcProfit(t,e,i,s,r){const a=yc(this,Ia).getFullSymbolByName(t),o=yc(this,Oa).getAccount(),n=new vd({trade_volume:fh.toInt(e),price_open:s,price_close:r,trade_action:i?0:1,contract_size:null==a?void 0:a.trade_contract_size});return a&&_u(a,n,o,yc(this,xa).rateBuy(a,a.currency_profit,o.account_currency),yc(this,xa).rateSell(a,a.currency_profit,o.account_currency),!1),n.profit}async init(){await this.loadOpened()}async loadOpened(){const t=await yc(this,Ca).getTradingOpened(),e=[...(null==t?void 0:t.orders)??[],...(null==t?void 0:t.positions)??[]].map((({trade_symbol:t})=>t));await vc(this,$a,Da).call(this,e),yc(this,Pa).call(this,t)}getActiveSymbols(){return[...yc(this,La).getOrders().map((t=>t.trade_symbol)).filter(Boolean),...yc(this,La).getPositions().map((t=>t.trade_symbol)).filter(Boolean)]}destroy(){yc(this,Wa).setTradeList(),this.getActiveSymbols().forEach((t=>yc(this,Wa).off(t,yc(this,Ea)))),yc(this,La).clearStorage(),uu=new Map}hedgeAllowed(){return yc(this,Oa).getAccount().isHedgedMargin()}addOrder(t){if(yc(this,La).addOrder(t)){const e=t.trade_symbol;yc(this,Wa).setTradeList(this.getActiveSymbols()),yc(this,Wa).on(e,yc(this,Ea))}}removeOrder(t,e=null){const i=yc(this,La).removeOrder(t,e);if(i){const e=null==t?void 0:t.trade_symbol;e&&!yc(this,La).useSymbol(e)&&yc(this,Wa).off(e,yc(this,Ea))}return yc(this,Wa).setTradeList(this.getActiveSymbols()),i}addPosition(t){if(yc(this,La).addPosition(t)){yc(this,Wa).setTradeList(this.getActiveSymbols());const e=t.trade_symbol;yc(this,Wa).on(e,yc(this,Ea))}}removePosition(t,e=null){if(yc(this,La).removePosition(t,e)){const e=null==t?void 0:t.trade_symbol;e&&!yc(this,La).useSymbol(e)&&(yc(this,Wa).setTradeList(this.getActiveSymbols()),yc(this,Wa).off(e,yc(this,Ea)))}}useSymbol(t){return yc(this,La).useSymbol(t)}getPositions(){return yc(this,La).getPositions()}getOrders(){return yc(this,La).getOrders()}getOrderById(t){return yc(this,La).getOrderById(t)}sortRecords(){yc(this,La).sortRecords()}getPositionBySymbol(t){return yc(this,La).getPositionBySymbol(t)}getPositionById(t){return yc(this,La).getPositionById(t)}getOrdersBySymbol(t){return yc(this,La).getOrdersBySymbol(t)}getPositionsBySymbol(t){return yc(this,La).getPositionsBySymbol(t)}}Sa=new WeakMap,za=new WeakMap,Ba=new WeakMap,Ca=new WeakMap,Wa=new WeakMap,Ia=new WeakMap,La=new WeakMap,Oa=new WeakMap,xa=new WeakMap,Aa=new WeakMap,Pa=new WeakMap,Ea=new WeakMap,$a=new WeakSet,Na=function(t){const e=yc(this,La).getOrdersBySymbol(t),i=yc(this,La).getPositionsBySymbol(t);if(!e.length&&!i.length)return;const s=yc(this,Ia).getFullSymbolByName(t);if(!s)return;const r=yc(this,Wa).getTick(t,s.isDelayed());if(!r)return;const a=hu(s,r);if(!s.isNegativePrices()&&(a.bid<=0||a.ask<=0))return;const o=yc(this,Oa).getAccount(),n=yc(this,xa).rateBuy(s,s.currency_profit,o.account_currency),c=yc(this,xa).rateSell(s,s.currency_profit,o.account_currency);i.length&&n&&c&&(i.forEach((t=>{s&&(function(t,e,i,s,r,a){let o=0;if(t.isCollateral())s.isExchangeMargin()?o=e.last??o:e.last?o=e.last:(i.isBuy()&&(o=e.bid),i.isSell()&&(o=e.ask));else{const s=hu(t,e);i.isBuy()&&(o=s.bid),i.isSell()&&(o=s.ask)}o&&(i.price_close=o,_u(t,i,s,r,a))}(s,r,t,o,n,c),_u(s,t,o,n,c,s.isCollateral()),yc(this,Ba).trigger(4,t.position_id.toString()))})),yc(this,Aa).calcAccount(this.getOrders(),this.getPositions()),yc(this,Aa).checkStopOut(o),yc(this,Ba).trigger(3)),e.length&&e.forEach((t=>{switch(t.order_type){case 0:case 2:case 4:case 6:a.ask&&(t.price_current=a.ask);break;case 1:case 3:case 5:case 7:a.bid&&(t.price_current=a.bid)}yc(this,Ba).trigger(5,t.trade_order.toString())}))},Da=async function(t){const e=[],i=[],s=[];t.forEach(((t,r)=>{const a=yc(this,Ia).getSymbolByName(t);a&&(a instanceof nh?i.push(a):(i.push(null),s.push({idx:r,symbol:t}),e.push(a.symbol_id)))})),e.length&&(await yc(this,Ia).loadConfig(e),s.forEach((({idx:t,symbol:e})=>{const s=yc(this,Ia).getSymbolByName(e);s&&s instanceof nh&&(i[t]=s)})))};const mu=[{propType:17},{propType:17},{propType:6},{propType:6},{propType:11,propLength:64},{propType:6},{propType:8},{propType:8},{propType:8},{propType:8},{propType:18},{propType:8},{propType:8},{propType:8},{propType:8},{propType:8},{propType:17},{propType:17},{propType:11,propLength:64},{propType:8},{propType:6},{propType:6},{propType:6},{propType:11,propLength:64},{propType:3},{propType:3}],gu=Ec.getSeriesSize(mu);function yu(t,e=0){const i=Ec.parse(t,mu,e);return new vd({position_id:i[0],trade_order:i[1],time_create:1e3*i[2]+i[24],time_update:1e3*i[3]+i[25],trade_symbol:i[4],trade_action:i[5],price_open:i[6],price_close:i[7],sl:i[8],tp:i[9],trade_volume:i[10],profit:i[11],rate_profit:i[12],rate_margin:i[13],commission:i[14],storage_:i[15],expert:i[16],expert_position_id:i[17],comment:i[18],contract_size:i[19],digits:i[20],digits_currency:i[21],trade_reason:i[22],external_id:i[23]})}function fu(t,e=0){return new DataView(t).getUint32(e,!0)*gu+4}function bu(t,e=0){let i=e;const s=[],r=new DataView(t).getUint32(i,!0);i+=4;for(let a=0;a<r;a++)s.push(yu(t,i)),i+=gu;return s}class vu extends Rc{async getTradingOpened(){var t;return{positions:bu(t=(await this.socket.sendCommand(4)).resBody,0),orders:Ad(t,fu(t,0))}}}qa=new WeakMap;let wu=class t{constructor(t){fc(this,qa),bc(this,qa,t)}getPosition(e){const i=yc(this,qa).getPositionById(BigInt(e));return i?t.formatPosition(i):null}getPositions(){const e={items:[]};return yc(this,qa).getPositions().forEach((i=>{i.isCollateral()?e.collateral=t.formatCollateral(i):e.items.push(t.formatPosition(i))})),e}getOrder(e){const i=yc(this,qa).getOrderById(BigInt(e));return i?t.formatOrder(i):null}getOrders(){return yc(this,qa).getOrders().map((e=>t.formatOrder(e)))}static formatPosition(t){return new ku({symbol:Rd(t),id:Vd(t),externalId:t.external_id,timeCreate:t.time_create,timeUpdate:t.time_update,typeName:q_(t.trade_action),tradeAction:t.trade_action,volume:vh(t.trade_volume),volumeValue:fh.toDouble(t.trade_volume),volumeSize:bh(fh.toSize(t.trade_volume,t.contract_size)),priceOpen:a.normalize(t.price_open,t.digits),priceClose:a.normalize(t.price_close,t.digits+3),sl:a.normalize(t.sl,t.digits),tp:a.normalize(t.tp,t.digits),storage_:a.normalize(t.storage_||0,t.digits_currency),profit:a.normalize(t.profit||0,t.digits_currency),profitState:0===Number(t.profit)?null:t.profit>0,comment:t.comment||"",info:Gd(t),infoTemplate:(e=t,jd(e,Vd(e)||Fd(e))),isBuy:t.isBuy(),isSell:t.isSell(),digits:t.digits,digitsCurrency:t.digits_currency});var e}static formatCollateral(t){return new Tu({id:Vd(t),symbol:Rd(t),timeCreate:t.time_create,action:q_(t.trade_action),volume:vh(t.trade_volume),volumeSize:bh(fh.toSize(t.trade_volume,t.contract_size)),priceClose:wh(t.price_close,t.digits,3),comment:t.comment||"",info:Gd(t)})}static formatOrder(t){const e=new Mu({symbol:Kd(t),order:Jd(t),id:Zd(t),timeSetup:t.time_setup,type:t.order_type,typeName:D_(t.order_type),isBuy:t.isBuy(),isSell:t.isSell(),isClose:t.isClose(),isCloseBy:t.isCloseBy(),isLimit:t.isLimit(),isMarket:t.isMarket(),isMarketPrice:t.isMarketPrice(),isPending:t.isPending(),isStop:t.isStop(),isStopLimit:t.isStopLimit(),volumeValue:fh.toDouble(t.volume_initial),volume:Qd(t),volumeLots:Qd(t,!0),price:a.normalize(t.price_order,t.digits),sl:a.normalize(t.price_sl,t.digits),tp:a.normalize(t.price_tp,t.digits),priceCurrent:a.normalize(t.price_current,t.digits+3),state:t.order_state,comment:t.comment||"",info:tu(t),digits:t.digits,digitsCurrency:t.digits_currency,expiration:t.type_time,date:t.time_expiration,filling:t.type_filling});return t.isStopLimit()&&(e.priceOrder=wh(t.price_order,t.digits),e.priceTrigger=t.price_trigger),e}calcProfit(t,e,i,s,r){return yc(this,qa).calcProfit(t,e,i,s,r)}};class ku{constructor(t){this.symbol=t.symbol,this.id=t.id,this.externalId=t.externalId,this.timeCreate=t.timeCreate,this.timeUpdate=t.timeUpdate,this.typeName=t.typeName,this.volume=t.volume,this.volumeValue=t.volumeValue,this.volumeSize=t.volumeSize,this.priceOpen=t.priceOpen,this.priceClose=t.priceClose,this.sl=t.sl,this.tp=t.tp,this.storage=t.storage_,this.profit=t.profit,this.comment=t.comment,this.info=t.info,this.infoTemplate=t.infoTemplate,this.profitState=t.profitState,this.tradeAction=t.tradeAction,this.isBuy=t.isBuy,this.isSell=t.isSell,this.digits=t.digits,this.digitsCurrency=t.digitsCurrency}}class Tu{constructor(t){this.id=t.id,this.symbol=t.symbol,this.timeCreate=t.timeCreate,this.typeName=t.action,this.volume=t.volume,this.volumeSize=t.volumeSize,this.priceClose=t.priceClose,this.comment=t.comment,this.info=t.info}}class Mu{constructor(t){this.symbol=t.symbol,this.order=t.order,this.id=t.id,this.timeSetup=t.timeSetup,this.type=t.type,this.typeName=t.typeName,this.volume=t.volume,this.volumeValue=t.volumeValue,this.volumeLots=t.volumeLots,this.price=t.price,this.sl=t.sl,this.tp=t.tp,this.priceCurrent=t.priceCurrent,this.state=t.state,this.comment=t.comment,this.info=t.info,this.priceOrder=t.priceOrder,this.priceTrigger=t.priceTrigger,this.isBuy=t.isBuy,this.isSell=t.isSell,this.isClose=t.isClose,this.isCloseBy=t.isCloseBy,this.isLimit=t.isLimit,this.isMarket=t.isMarket,this.isMarketPrice=t.isMarketPrice,this.isPending=t.isPending,this.isStop=t.isStop,this.isStopLimit=t.isStopLimit,this.digits=t.digits,this.digitsCurrency=t.digitsCurrency,this.expiration=t.expiration,this.date=t.date,this.filling=t.filling}}class Su{constructor(t,e,i,s,r,a,o){this.controller=new pu(t,new vu(e),i,s,r,a,o),this.view=new wu(this.controller)}}function zu(t){switch(t){case 2:return 1;case 4:return 2;case 3:return 3;case 5:return 4;default:return 0}}class Bu{constructor(t){this.isSell=t.isSell(),this.isBuy=t.isBuy(),this.isSpread=t.isSpread(),this.price=t.price,this.volume=t.trade_volume,this.volumeLots=t.trade_volume_lots,this.ratio=t.ratio;const e=t.orders.map((t=>({isSell:t.isSell(),type:zu(t.order_type),volume:fh.toDouble(t.volume_initial)}))),i=t.sls.map((t=>({isSell:!t.isSell(),type:5,volume:fh.toDouble(t.trade_volume)}))),s=t.tps.map((t=>({isSell:!t.isSell(),type:6,volume:fh.toDouble(t.trade_volume)})));this.actions=[...e,...i,...s]}}class Cu{constructor(t,e,i,s,r){this.orders=[],this.positions=[],this.sls=[],this.tps=[],this.ratio=0,this.flag_mask=t[0],this.book_type=t[1],this.price=a.toDouble(t[2],s),this.trade_volume=fh.toDouble(t[3]),this.trade_volume_lots=a.normalize(this.trade_volume/r,8),this.interest=t[4],this.calcOrders(e),this.calcPositions(i)}formatBook(){return new Bu(this)}calcPositions(t){this.positions=[],this.sls=[],this.tps=[],t.forEach((t=>{t.price_open===this.price&&this.positions.push(t),t.sl===this.price&&this.sls.push(t),t.tp===this.price&&this.tps.push(t)}))}calcOrders(t){this.orders=[],t.forEach((t=>{t.price_order===this.price&&this.orders.push(t)}))}isBuy(){return 2===this.book_type||4===this.book_type}isSell(){return 1===this.book_type||3===this.book_type}isSpread(){return 0===this.book_type}isReset(){return 0===this.book_type}}class Wu{constructor(t){fc(this,Fa),this.symbol=t.symbol,this.digits=t.symbol_config.digits,bc(this,Fa,t.symbol_config.point),this.books=[],t.sell.forEach((t=>this.books.push(t.formatBook()))),t.buy.forEach((t=>this.books.push(t.formatBook()))),this.extendedBooks=[],t.sellExtended.forEach((t=>this.extendedBooks.push(t.formatBook()))),t.spread.forEach((t=>this.extendedBooks.push(t.formatBook()))),t.buyExtended.forEach((t=>this.extendedBooks.push(t.formatBook())))}}Fa=new WeakMap;class Iu{constructor(t,e,i,s,r){fc(this,Xa),fc(this,Ra),fc(this,Va),fc(this,Ua),fc(this,Ha),bc(this,Va,new Map),this.sell=new Map,this.sellExtended=new Map,this.buy=new Map,this.spread=[],this.buyExtended=new Map,this.spreadSize=10,this.symbol_config=e,this.symbol=e.trade_symbol,bc(this,Ra,t[0]),this.books_time=t[1],this.time_msc=t[2],this.flag_mask=t[3],this.books_flags=t[4],this.spreadSize=i,this.updateBooks(t[6],s,r)}static formatBook(t){return new Wu(t)}formatBook(){return new Wu(this)}updateBooks(t=[],e=[],i=[]){const{digits:s,trade_contract_size:r}=this.symbol_config;2&this.books_flags&&vc(this,Xa,Ka).call(this),t.forEach((t=>{const a=new Cu(t,e,i,s,r);vc(this,Xa,Ga).call(this,a)})),this.clearEmpty(),vc(this,Xa,Ya).call(this),vc(this,Xa,ja).call(this);const a=this.extendSell(e,i),o=this.extendBuy(e,i);this.spread=o&&a?this.getSpread(o,a,e,i):[]}clearEmpty(){this.sell.forEach(((t,e)=>{t.trade_volume||this.sell.delete(e)})),this.buy.forEach(((t,e)=>{t.trade_volume||this.buy.delete(e)}))}extendSell(t=[],e=[]){const i=Array.from(this.sell.values()).reverse();if(!i.length)return null;const s=[];let r=a.normalize(i[0].price,this.symbol_config.digits),o=0;for(;o<10;){let i=this.sell.get(r);i||(i=new Cu([1,1,0,BigInt(0),0],[],[],this.symbol_config.digits,this.symbol_config.point),i.price=r,i.calcOrders(t),i.calcPositions(e)),s.push(i),r=a.normalize(r+this.symbol_config.point,this.symbol_config.digits),o+=1}return this.sellExtended=new Map(s.reverse().map((t=>[t.price,t]))),s.length?s[s.length-1].price:null}extendBuy(t=[],e=[]){const i=Array.from(this.buy.values());if(!i.length)return null;const s=[];let r=a.normalize(i[0].price,this.symbol_config.digits),o=0;for(;o<10;){let i=this.buy.get(r);i||(i=new Cu([1,2,0,BigInt(0),0],[],[],this.symbol_config.digits,this.symbol_config.point),i.price=r,i.calcOrders(t),i.calcPositions(e)),s.push(i),r=a.normalize(r-this.symbol_config.point,this.symbol_config.digits),o+=1}return this.buyExtended=new Map(s.map((t=>[t.price,t]))),s.length?s[0].price:null}getSpread(t,e,i=[],s=[]){return function(t,e,i,s,r=10){if(!r)return[];let o=i;const n=function(t,e,i,s){return a.normalize(e-i-(t+i),s)}(t,e,o,s);if(n/o>r){o=function(t,e,i,s){let r=t/e;return r=Math.ceil(r/i)*i,a.normalize(r,s)}(n,r,o,s);let c=a.normalize(t+i,s),l=a.normalize(e-i,s);const h=[c],_=[l];for(c=a.normalize(c+o,s),l=a.normalize(l-o,s);c<e-i;)c<l&&h.unshift(c),c=a.normalize(c+o,s),l>c&&_.push(l),l=a.normalize(l-o,s);return[..._,...h]}const c=[];let l=a.normalize(e-i,s);for(;l>t;)c.push(l),l=a.normalize(l-i,s);return c}(t,e,this.symbol_config.point,this.symbol_config.digits,this.spreadSize).map((t=>{const e=new Cu([1,0,0,BigInt(0),0],[],[],this.symbol_config.digits,this.symbol_config.point);return e.price=t,e.calcOrders(i),e.calcPositions(s),e}))}}Ra=new WeakMap,Va=new WeakMap,Ua=new WeakMap,Ha=new WeakMap,Xa=new WeakSet,ja=function(){const t=Math.max(...Array.from(this.buy.values()).map((t=>Math.abs(t.trade_volume))));this.buy.forEach((e=>{e.ratio=e.trade_volume/t}));const e=Math.max(...Array.from(this.sell.values()).map((t=>Math.abs(t.trade_volume))));this.sell.forEach((t=>{t.ratio=Math.abs(t.trade_volume/e)}))},Ga=function(t){if(t.isBuy())if(0===t.trade_volume)this.buy.delete(t.price);else{const e=this.buy.get(t.price);e?(t.trade_volume+=e.trade_volume,t.trade_volume_lots+=e.trade_volume_lots,t.trade_volume<=0?this.buy.delete(e.price):this.buy.set(t.price,t)):this.buy.set(t.price,t)}else if(t.isSell())if(0===t.trade_volume)this.sell.delete(t.price);else{const e=this.sell.get(t.price);e?(t.trade_volume+=e.trade_volume,t.trade_volume_lots+=e.trade_volume_lots,t.trade_volume<=0?this.sell.delete(e.price):this.sell.set(t.price,t)):this.sell.set(t.price,t)}else t.isReset()?vc(this,Xa,Ka).call(this):yc(this,Va).set(t.price,t)},Ya=function(){this.sell=new Map([...this.sell.entries()].sort(((t,e)=>t[0]<e[0]?1:t[0]>e[0]?-1:0))),this.buy=new Map([...this.buy.entries()].sort(((t,e)=>t[0]<e[0]?1:t[0]>e[0]?-1:0)))},Ka=function(){this.sell.clear(),this.buy.clear()};class Lu{constructor(){fc(this,Ja,10),fc(this,Za,{})}getBooks(){return{...yc(this,Za)}}setSpreadSize(t){bc(this,Ja,t)}clearStorage(){delete this.symbolId,bc(this,Za,{})}getBookBySymbol(t){return yc(this,Za)[t]}setBook(t,e){yc(this,Za)[t]=e}getSpreadSize(){return yc(this,Ja)}}Ja=new WeakMap,Za=new WeakMap;class Ou{constructor(t,e,i,s){fc(this,Qa),fc(this,to),fc(this,eo,new Lu),fc(this,io),fc(this,so),fc(this,ro,(t=>{this.updateDiffs(t).length&&yc(this,Qa).trigger(8,Object.values(Object.values(yc(this,eo).getBooks()).map(Iu.formatBook)))})),bc(this,Qa,t),bc(this,to,e),bc(this,io,i),bc(this,so,s),yc(this,to).on(yc(this,ro))}destroy(){yc(this,to).off(yc(this,ro)),yc(this,eo).clearStorage()}signBooks(t){yc(this,eo).symbolId!==t&&("number"!=typeof t?(yc(this,to).subscribe([]),yc(this,eo).clearStorage()):(yc(this,to).subscribe([t]),yc(this,eo).symbolId=t))}setSpreadSize(t){yc(this,eo).setSpreadSize(t)}updateDiffs(t){const e=[];return t.forEach((t=>{const i=yc(this,io).getFullSymbolById(t[0]);if(!i)return;const s=yc(this,so).getOrdersBySymbol(i.trade_symbol),r=yc(this,so).getPositionsBySymbol(i.trade_symbol);let a=yc(this,eo).getBookBySymbol(i.trade_symbol);a?(a.books_time=t[1],a.time_msc=t[2],a.flag_mask=t[3],a.books_flags=t[4],a.spreadSize=yc(this,eo).getSpreadSize(),a.updateBooks(t[6],s,r)):(a=new Iu(t,i,yc(this,eo).getSpreadSize(),s,r),yc(this,eo).setBook(i.trade_symbol,a)),e.push(a)})),e}}Qa=new WeakMap,to=new WeakMap,eo=new WeakMap,io=new WeakMap,so=new WeakMap,ro=new WeakMap;const xu=[{propType:6},{propType:4},{propType:6},{propType:17},{propType:6}],Au=Ec.getSeriesSize(xu);function Pu(t,e=0){return Ec.parse(t,xu,e)}function Eu(t=0){return t*Au}function $u(t,e=0,i=0){let s=e;const r=[];for(let a=0;a<i;a++)r.push(Pu(t,s)),s+=Au;return r}const Nu=[{propType:6},{propType:3},{propType:3},{propType:6},{propType:6},{propType:5}],Du=Ec.getSeriesSize(Nu);function qu(t,e=0){return Object.values(Ec.parse(t,Nu,e))}class Fu extends Rc{constructor(){super(...arguments),fc(this,oo),fc(this,ao,new WeakMap)}subscribe(t){return this.socket.sendCommand(22,Zl(t),!1)}on(t){let e=yc(this,ao).get(t);e||(e=vc(this,oo,no).bind(this,t),yc(this,ao).set(t,e)),this.socket.on(23,e)}off(t){const e=yc(this,ao).get(t);e&&this.socket.off(23,e)}}ao=new WeakMap,oo=new WeakSet,no=function(t,e){t(function(t){if(t.byteLength<=4)return[];const e=[];let i=0;const s=new DataView(t).getUint32(i,!0);i+=4;for(let r=0;r<s;r++){const s=qu(t,i);i+=Du,e.push([...s,$u(t,i,s[5])]),i+=Eu(s[5])}return e}(e.resBody))};class Ru{constructor(t){fc(this,co),bc(this,co,t)}signBooks(t){yc(this,co).signBooks(t)}setSpreadSize(t){yc(this,co).setSpreadSize(t)}}co=new WeakMap;class Vu{constructor(t,e,i,s){this.controller=new Ou(t,new Fu(e),i,s),this.view=new Ru(this.controller)}}class Uu{constructor(t,e,i,s,r){fc(this,mo),fc(this,lo),fc(this,ho),fc(this,_o),fc(this,uo),fc(this,po),bc(this,lo,t),bc(this,ho,e),bc(this,_o,i),bc(this,uo,s),bc(this,po,r)}init(){const t=yc(this,_o).getAccount(),e=yc(this,uo).getOrders(),i=yc(this,uo).getPositions();yc(this,ho).calcAccount(e,i),yc(this,ho).checkStopOut(t),yc(this,lo).trigger(14)}updateOpenOrder(t){const e=yc(this,uo).getOrderById(t.trade_order);e?(t.prev=e,yc(this,uo).removeOrder(e,t)):yc(this,uo).addOrder(t),yc(this,uo).sortRecords(),vc(this,mo,go).call(this)}deleteOpenOrder(t){yc(this,uo).removeOrder(t)&&(yc(this,uo).sortRecords(),vc(this,mo,go).call(this))}addHistoryOrder(t){yc(this,po).getOrderById(t.trade_order)||(yc(this,po).addOrder(t),yc(this,po).sortRecords(),vc(this,mo,go).call(this))}updateHistoryOrder(t){const e=yc(this,po).getOrderById(t.trade_order);e&&(t.prev=e,yc(this,po).removeOrderById(t.trade_order,t),vc(this,mo,go).call(this))}deleteHistoryOrder(t){yc(this,po).removeOrderById(t.trade_order),vc(this,mo,go).call(this)}addHistoryDeal(t){yc(this,po).getDealByDeal(t.deal)||(yc(this,po).addDeal(t),yc(this,po).sortRecords(),yc(this,po).updateHistoryPosition(t,!0),vc(this,mo,go).call(this))}updateHistoryDeal(t){const e=yc(this,po).getDealByDeal(t.deal);e&&(t.prev=e,yc(this,po).removeDealByDeal(t.deal,t),vc(this,mo,go).call(this))}deleteHistoryDeal(t){yc(this,po).removeDealByDeal(t.deal),vc(this,mo,go).call(this)}updatePosition(t){let e;if(e=t.position_id?yc(this,uo).getPositionById(t.position_id):yc(this,uo).getPositionBySymbol(t.trade_symbol),e)t.prev=e,t.trade_volume?yc(this,uo).removePosition(e,t):yc(this,uo).removePosition(e),vc(this,mo,go).call(this);else{if(!t.trade_volume)return!1;yc(this,uo).addPosition(t),yc(this,uo).sortRecords()}return vc(this,mo,go).call(this),!0}}lo=new WeakMap,ho=new WeakMap,_o=new WeakMap,uo=new WeakMap,po=new WeakMap,mo=new WeakSet,go=function(){const t=yc(this,_o).getAccount(),e=yc(this,uo).getOrders(),i=yc(this,uo).getPositions();yc(this,ho).calcAccount(e,i),yc(this,ho).checkStopOut(t),yc(this,lo).trigger(14),yc(this,lo).trigger(1)};class Hu{constructor(t,e,i,s,r){this.controller=new Uu(t,e,i,s,r)}}class Xu{constructor(t){this.flag_mask=t[0],this.transaction_id=t[1],this.transaction_type=t[2],this.deal=t[3],this.trade_position=t[4],this.balance=t[5],this.credit=t[6],this.commission_daily=t[7],this.commission_monthly=t[8],this.acc_profit=t[9],this.deals=[],this.positions=[]}}const ju=[{propType:6},{propType:6},{propType:6},{propType:12,parser:$d,propLength:Ed},{propType:12,parser:yu,propLength:gu},{propType:8},{propType:8},{propType:8},{propType:8},{propType:8}],Gu=Ec.getSeriesSize(ju);function Yu(t,e=0){let i,s=e,r=0;return r+=Gu,s+=Gu,i=Nd(t,s),r+=i,s+=i,i=fu(t,s),r+=i,s+=i,r}function Ku(t,e=0){let i=e;const s=function(t,e=0){const i=Ec.parse(t,ju,e);return new Xu(i)}(t,i);return i+=Gu,s.deals=Dd(t,i),i+=Nd(t,i),s.positions=bu(t,i),i+=fu(t,i),s}class Ju{constructor(t){this.flag_mask=t[0],this.transaction_id=t[1],this.transaction_type=t[2],this.trade_order=t[3]}}const Zu=[{propType:6},{propType:6},{propType:6},{propType:12,parser:xd,propLength:Od}],Qu=Ec.getSeriesSize(Zu);function tp(t,e=0){const i=Ec.parse(t,Zu,e);return new Ju(i)}class ep{constructor(t,e,i,s,r,a){fc(this,yo),fc(this,fo),fc(this,bo),fc(this,vo),fc(this,wo),fc(this,ko),fc(this,To,(t=>{t.forEach((t=>{const e=t.transaction_type,i=t.flag_mask;if(0===i&&t instanceof Ju){const i=t.trade_order;return 0===e||1===e?yc(this,ko).updateOpenOrder(i):2===e&&yc(this,ko).deleteOpenOrder(i),void(0===e?yc(this,yo).trigger(6,yc(this,bo).printOrderAdd(i)):1===e&&yc(this,yo).trigger(6,yc(this,bo).printOrderUpdate(i)))}if(1===i&&t instanceof Ju){const i=t.trade_order;return 0===e?yc(this,ko).addHistoryOrder(i):1===e?yc(this,ko).updateHistoryOrder(i):2===e&&yc(this,ko).deleteHistoryOrder(i),void(0===e&&yc(this,yo).trigger(6,yc(this,bo).printOrderDelete(i)))}if(2===i&&t instanceof Xu){const{deals:i,deal:s}=t;if(0===e){const e=yc(this,vo).getAccount();e.balance=t.balance,e.credit=t.credit,e.acc_profit=t.acc_profit,e.commission_daily=t.commission_daily,e.commission_monthly=t.commission_monthly}if(t.trade_position.trade_symbol||t.deal.trade_symbol){if(!yc(this,ko).updatePosition(t.trade_position))return;t.positions.forEach((t=>{yc(this,ko).updatePosition(t)})),yc(this,wo).sign(s.trade_symbol)}"0"!==s.deal.toString()&&(0===e?yc(this,ko).addHistoryDeal(s):1===e?yc(this,ko).updateHistoryDeal(s):2===e&&yc(this,ko).deleteHistoryDeal(s),s.isTrade()&&yc(this,yo).trigger(6,yc(this,bo).printDeal(s))),i.forEach((t=>{0===e?yc(this,ko).addHistoryDeal(t):1===e?yc(this,ko).updateHistoryDeal(t):2===e&&yc(this,ko).deleteHistoryDeal(t)})),0===e?yc(this,yo).trigger(6,yc(this,bo).printDealAdd(t.deal)):1===e&&yc(this,yo).trigger(6,yc(this,bo).printPositionUpdate(t.trade_position))}}))})),bc(this,yo,t),bc(this,fo,e),bc(this,bo,i),bc(this,vo,s),bc(this,wo,r),bc(this,ko,a),yc(this,fo).on(yc(this,To))}destroy(){yc(this,fo).off(yc(this,To))}}yo=new WeakMap,fo=new WeakMap,bo=new WeakMap,vo=new WeakMap,wo=new WeakMap,ko=new WeakMap,To=new WeakMap;class ip extends Rc{constructor(){super(...arguments),fc(this,So),fc(this,Mo,new WeakMap)}on(t){let e=yc(this,Mo).get(t);e||(e=vc(this,So,zo).bind(this,t),yc(this,Mo).set(t,e)),this.socket.on(10,e)}off(t){const e=yc(this,Mo).get(t);return e&&this.socket.off(10,e),this}}Mo=new WeakMap,So=new WeakSet,zo=function(t,e){t(function(t){const e=[],i=new DataView(t).getUint32(0,!0);let s=0;const r=t.byteLength;for(;s<r;)2===i?(e.push(Ku(t,s)),s+=Yu(t,s)):(e.push(tp(t,s)),s+=Qu);return e}(e.resBody))};class sp{constructor(t,e,i){fc(this,Io),fc(this,Bo),fc(this,Co),fc(this,Wo),bc(this,Bo,t),bc(this,Co,e),bc(this,Wo,i)}printOrderAdd(t){return""}printOrderUpdate(t){return""}printOrderDelete(t){return""}printDealAdd(t){return""}printPositionUpdate(t){return""}printDeal(t){let e=`${yc(this,Bo).getAccount().login}: deal `;var i;return e+=Xd(i=t,Ud(i)||Fd(i)),e+=" done (based on order #",e+=Hd(t),e+=")",e}}Bo=new WeakMap,Co=new WeakMap,Wo=new WeakMap,Io=new WeakSet;class rp{constructor(t,e,i,s,r,a,o){this.printer=new sp(i,o,a),this.controller=new ep(t,new ip(e),this.printer,i,s,r)}}function ap(t,e){return!(t>1e9||!Number.isFinite(t))&&!(t<0&&!e.isNegativePrices())&&function(t,e){if(!e.trade_tick_size||!t)return!0;const i=10**-(e.digits+1),s=a.normalize(a.fmod(t,e.trade_tick_size),e.digits);return s<=i||s>=e.trade_tick_size}(a.normalize(t,e.digits),e)}function op(t,e,i=!1){if(0===t.trade.trade_exemode||1===t.trade.trade_exemode)return 5===e.trade_action||201===e.trade_action?(i&&(e.type_filling=2),2===e.type_filling):(i&&(e.type_filling=0),0===e.type_filling);if(2===t.trade.trade_exemode)return 5===e.trade_action||201===e.trade_action?(i&&(e.type_filling=2),2===e.type_filling):0===e.type_filling?!!(t.trade.trade_fill_flags&Zc.FOK):1===e.type_filling&&!!(t.trade.trade_fill_flags&Zc.IOC);switch(e.type_filling){case 0:return 5!==e.trade_action&&201!==e.trade_action||2===e.trade_type||3===e.trade_type||6===e.trade_type||7===e.trade_type?!!(t.trade.trade_fill_flags&Zc.FOK):!!i&&(e.type_time=0,e.type_filling=2,!0);case 1:return 5!==e.trade_action&&201!==e.trade_action||2===e.trade_type||3===e.trade_type||6===e.trade_type||7===e.trade_type?!!(t.trade.trade_fill_flags&Zc.IOC):!!i&&(e.type_time=0,e.type_filling=2,!0);case 2:return!0;case 3:return 5!==e.trade_action&&201!==e.trade_action||2===e.trade_type||3===e.trade_type||6===e.trade_type||7===e.trade_type?!!(t.trade.trade_fill_flags&Zc.BOC):!!i&&(e.type_time=0,e.type_filling=2,!0)}return!1}function np(t,e){return!!((t.trade.trade_order_flags&tl.MARKET||0!==e&&1!==e)&&(t.trade.trade_order_flags&tl.LIMIT||2!==e&&3!==e&&6!==e&&7!==e)&&(t.trade.trade_order_flags&tl.STOP||4!==e&&5!==e)&&(t.trade.trade_order_flags&tl.STOP_LIMIT||6!==e&&7!==e))}function cp(t,e,i,s,r,o){if(!e)return 10011;const n=a.normalize(e.point*e.trade.trade_stops_level,e.digits);switch(i.trade_type){case 0:{if(!e.isNegativePrices()){if(i.price_order<0)return 10015;if(i.price_sl<0||i.price_tp<0)return 10016}if(!i.price_order)return 2===e.trade.trade_exemode||3===e.trade.trade_exemode?0:10015;const s=t.bid;if(0===s)return 0;let c=a.normalize(s-n,e.digits);if(i.price_sl>0){if(e.isCollateral())return 10017;if(i.price_sl!==r&&i.price_sl>c)return 10016}if(c=a.normalize(s+n,e.digits),i.price_tp>0){if(e.isCollateral())return 10017;if(i.price_tp!==o&&i.price_tp<c)return 10016}return 0}case 1:{if(i.price_order<0)return 10015;if(i.price_sl<0||i.price_tp<0)return 10016;if(!i.price_order)return 2===e.trade.trade_exemode||3===e.trade.trade_exemode?0:10015;const s=t.ask;if(0===s)return 0;let c=a.normalize(s+n,e.digits);if(i.price_sl>0){if(e.isCollateral())return 10017;if(i.price_sl!==r&&i.price_sl<c)return 10016}if(c=a.normalize(s-n,e.digits),i.price_tp>0){if(e.isCollateral())return 10017;if(i.price_tp!==o&&i.price_tp>c)return 10016}return 0}case 2:{const c=t.ask;if(!e.isNegativePrices()){if(i.price_order<=0)return 10015;if(i.price_sl<0||i.price_tp<0)return 10016}if(3!==e.trade.trade_exemode){const t=a.normalize(c-n,e.digits);if(0!==c&&i.price_order!==s&&i.price_order>t)return 10015}let l=a.normalize(i.price_order-n,e.digits);return i.price_sl>0&&(i.price_sl!==r||s!==i.price_order)&&i.price_sl>l?10016:(l=a.normalize(i.price_order+n,e.digits),i.price_tp>0&&(i.price_tp!==o||s!==i.price_order)&&i.price_tp<l?10016:0)}case 3:{const c=t.bid;if(!e.isNegativePrices()){if(i.price_order<=0)return 10015;if(i.price_sl<0||i.price_tp<0)return 10016}if(3!==e.trade.trade_exemode){const t=a.normalize(c+n,e.digits);if(0!==c&&i.price_order!==s&&i.price_order<t)return 10015}let l=a.normalize(i.price_order+n,e.digits);return i.price_sl>0&&(i.price_sl!==r||s!==i.price_order)&&i.price_sl<l?10016:(l=a.normalize(i.price_order-n,e.digits),i.price_tp>0&&(i.price_tp!==o||s!==i.price_order)&&i.price_tp>l?10016:0)}case 4:{const c=t.ask;if(!e.isNegativePrices()){if(i.price_order<=0)return 10015;if(i.price_sl<0||i.price_tp<0)return 10016}let l=a.normalize(c+n,e.digits);return 0!==c&&i.price_order!==s&&i.price_order<l?10015:(l=a.normalize(i.price_order-n,e.digits),i.price_sl>0&&(i.price_sl!==r||s!==i.price_order)&&i.price_sl>l?10016:(l=a.normalize(i.price_order+n,e.digits),i.price_tp>0&&(i.price_tp!==o||s!==i.price_order)&&i.price_tp<l?10016:0))}case 5:{const c=t.bid;if(!e.isNegativePrices()){if(i.price_order<=0)return 10015;if(i.price_sl<0||i.price_tp<0)return 10016}let l=a.normalize(c-n,e.digits);return 0!==c&&i.price_order!==s&&i.price_order>l?10015:(l=a.normalize(i.price_order+n,e.digits),i.price_sl>0&&(i.price_sl!==r||s!==i.price_order)&&i.price_sl<l?10016:(l=a.normalize(i.price_order-n,e.digits),i.price_tp>0&&(i.price_tp!==o||s!==i.price_order)&&i.price_tp>l?10016:0))}case 6:{const r=t.ask;if(!e.isNegativePrices()){if(i.price_order<=0||i.price_trigger<=0)return 10015;if(i.price_sl<0||i.price_tp<0)return 10016}let o=a.normalize(r+n,e.digits);return 0!==r&&i.price_order!==s&&i.price_order<o||3!==e.trade.trade_exemode&&(o=a.normalize(i.price_order-n,e.digits),i.price_trigger>o)?10015:(o=a.normalize(i.price_trigger-n,e.digits),i.price_sl>0&&i.price_sl>o?10016:(o=a.normalize(i.price_trigger+n,e.digits),i.price_tp>0&&i.price_tp<o?10016:0))}case 7:{const r=t.bid;if(!e.isNegativePrices()){if(i.price_order<=0||i.price_trigger<=0)return 10015;if(i.price_sl<0||i.price_tp<0)return 10016}let o=a.normalize(r-n,e.digits);return 0!==r&&i.price_order!==s&&i.price_order>o||3!==e.trade.trade_exemode&&(o=a.normalize(i.price_order+n,e.digits),i.price_trigger<o)?10015:(o=a.normalize(i.price_trigger+n,e.digits),i.price_sl>0&&i.price_sl<o?10016:(o=a.normalize(i.price_trigger-n,e.digits),i.price_tp>0&&i.price_tp>o?10016:0))}}return 0}function lp(t,e){return e.isBuy()&&t.isBuy()||e.isSell()&&t.isSell()?0:e.trade_volume>=t.volume_current?1:2}class hp{constructor(t,e,i,s){fc(this,Po),fc(this,Lo),fc(this,Oo),fc(this,xo),fc(this,Ao),bc(this,Lo,t),bc(this,Oo,e),bc(this,xo,i),bc(this,Ao,s)}checkAction(t,e,i=!1){let s;const r=yc(this,Lo).getAccount();if(e.login=r.login,e.digits=5,s=vc(this,Po,qo).call(this,e),0!==s)return s;switch(e.trade_action){case 0:s=vc(this,Po,Yo).call(this,e);break;case 1:s=vc(this,Po,Ko).call(this,e);break;case 2:s=vc(this,Po,Eo).call(this,t,e,i);break;case 3:s=vc(this,Po,No).call(this,e);break;case 4:s=vc(this,Po,Xo).call(this,e);break;case 5:s=vc(this,Po,Uo).call(this,e);break;case 6:s=vc(this,Po,Fo).call(this,e);break;case 7:s=vc(this,Po,Ro).call(this,e);break;case 8:s=vc(this,Po,Do).call(this,e);break;case 10:s=vc(this,Po,Vo).call(this,r,e)}return s}}function _p(t){return Boolean(t&&t.isOrderEnabled(tl.CLOSEBY))}function dp(t){return t&&0!==t.trade.trade_mode?0:10017}function up(t,e,i){const s=new ad;return s.order_type=t.trade_type,s.volume_initial=t.trade_volume,s.volume_current=t.trade_volume,function(t,e,i,s){return!(e<=0||1!==lp(i,s)&&e<t.trade.volume_min||e>t.trade.volume_max||e%t.trade.volume_step)}(e,t.trade_volume,s,i)}function pp(t,e,i){const s=new ad;return s.order_type=t.trade_type,s.volume_initial=t.trade_volume,s.volume_current=t.trade_volume,function(t,e,i){switch(t.trade.trade_mode){case 0:default:return 10017;case 1:return t.isCollateral()?10017:e.isBuy()||e.isSell()&&1===lp(e,i)?0:10042;case 2:return t.isCollateral()?10017:e.isSell()||e.isBuy()&&1===lp(e,i)?0:10043;case 3:return 1===lp(e,i)?0:10044;case 4:return t.isCollateral()?10017:0}}(e,s,i)}Lo=new WeakMap,Oo=new WeakMap,xo=new WeakMap,Ao=new WeakMap,Po=new WeakSet,Eo=function(t,e,i=!1){const s={};let r=vc(this,Po,Go).call(this,e,s);if(0!==r||!s.trade_position||!s.symbol_config)return r;const o=s.symbol_config,n=s.trade_position;return ap(e.price_order,o)?1!==o.trade.trade_exemode?10013:op(o,e,!0)?up(e,o,n)?(r=vc(this,Po,jo).call(this,e,o,n),0!==r?r:(r=pp(e,o,n),0!==r?r:e.price_deviation>a.INT32_MAX?10017:np(o,e.trade_type)?(r=vc(this,Po,$o).call(this,t,yc(this,Lo).getAccount(),e,o,i),0!==r?r:(e.type_filling=0,0)):10035)):10014:10030:10015},$o=function(t,e,i,s,r=!1){if(2!==i.trade_action)return 0;if(r&&function(t,e,i){const s=Date.now();let r=null;const a=t.getRequotes();for(let o=0;o<a.length;o++){const i=a[o];if(s>i.time)return t.deleteRequote(i),null;e.trade_action===i.trans_request.trade_action&&e.trade_type===i.trans_request.trade_type&&e.trade_volume===i.trans_request.trade_volume&&e.trade_symbol===i.trans_request.trade_symbol&&(r=i)}if(r){let s;s=0===e.trade_type?r.ask:r.bid,t.deleteRequote(r),10**i.digits*Math.abs(e.price_order-s)>0&&(r=null)}return!!r}(t,i,s))return 0;let a=yc(this,xo).getTick(s.trade_symbol,s.isDelayed());if(!a)return 10021;if(0===i.trade_type&&a.fields&&2&a.fields&&i.price_order===a.ask_last||1===i.trade_type&&a.fields&&1&a.fields&&i.price_order===a.bid_last)return 0;const o=yc(this,xo).getLast(i.trade_symbol);if(!(null==o?void 0:o.size))return 0;let n=Array.from(o);n=n.slice(),n.length>20&&(n.length=20);let c,l,h=0,_=0,d=0;for(l=n.length-1;l>=0;l--)if(a=n[l],a){if(0===i.trade_type){if(!(a.fields&&2&a.fields))continue;c=a.ask,_=Math.floor(a.tick_time_ms/1e3),d+=1,d||(h=_-1)}if(1===i.trade_type){if(!(a.fields&&1&a.fields))continue;c=a.bid,_=Math.floor(a.tick_time_ms/1e3),d+=1,d||(h=_-1)}if(_<h){r&&(e.bad_request+=2);break}if(d>2){r&&(e.bad_request+=2);break}if(c===i.price_order){if(d>1){if(r&&(e.bad_request+=2,e.bad_request>=15))break}else r&&(e.bad_request-=1);return 0}}return d?(l<0&&r&&(e.bad_request+=2),10021):0},No=function(t){const e={};let i=vc(this,Po,Go).call(this,t,e);if(0!==i||!e.symbol_config||!e.trade_position)return i;const s=e.symbol_config,r=e.trade_position;return ap(t.price_order,s)?2!==s.trade.trade_exemode?10013:op(s,t,!0)?up(t,s,r)?(i=vc(this,Po,jo).call(this,t,s,r),0!==i?i:(i=pp(t,s,r),0!==i?i:np(s,t.trade_type)?0:10035)):10014:10030:10015},Do=function(t){const e=yc(this,Ao).getOrderById(t.trade_order);if(!e)return 10013;const i=yc(this,Oo).getFullSymbolByName(e.trade_symbol);if(!i)return 10013;const s=dp(i);return 0!==s?s:0!==e.order_type&&1!==e.order_type||3===i.trade.trade_exemode?1!==e.order_state&&3!==e.order_state?10013:(t.trade_symbol=e.trade_symbol,t.trade_type=e.order_type,t.digits=i.digits,0):10013},qo=function(t){if(1!==t.trade_action&&2!==t.trade_action&&3!==t.trade_action&&4!==t.trade_action)return 0;const e=yc(this,Oo).getFullSymbolByName(t.trade_symbol);if(!e)return 10013;switch(e.trade.trade_exemode){case 0:1!==t.trade_action&&(t.trade_action=1);break;case 1:e.trade.trade_instant_volume&&t.trade_volume>e.trade.trade_instant_volume?t.trade_action=1:t.trade_action=2;break;case 2:3!==t.trade_action&&(t.trade_action=3);break;case 3:4!==t.trade_action&&(t.trade_action=4)}return 0},Fo=function(t){const e={};let i=vc(this,Po,Go).call(this,t,e);if(0!==i||!e.symbol_config||!e.trade_position)return i;const s=e.symbol_config,r=e.trade_position;if(!r.trade_volume)return 10036;if(!ap(t.price_sl,s)||!ap(t.price_tp,s))return 10016;t.price_order=r.price_close,t.trade_type=r.isBuy()?0:1;const a=yc(this,xo).getTick(s.trade_symbol,s.isDelayed());return a?(i=cp(a,s,t,r.price_close,r.sl,r.tp),0!==i?i:r.sl===t.price_sl&&r.tp===t.price_tp?10025:np(s,t.trade_type)?0:10035):10021},Ro=function(t){const e=yc(this,Ao).getOrderById(t.trade_order);if(!e)return 10013;const i=yc(this,Oo).getFullSymbolByName(e.trade_symbol);if(!i)return 10013;if(t.trade_type=e.order_type,0===e.order_type||1===e.order_type)return 10013;if(1!==e.order_state&&3!==e.order_state)return 10013;const s=vc(this,Po,Ho).call(this,t,i,e);return 0!==s?s:e.price_order===t.price_order&&e.price_trigger===t.price_trigger&&e.price_sl===t.price_sl&&e.price_tp===t.price_tp&&e.type_time===t.type_time&&e.time_expiration===t.time_expiration?10025:np(i,t.trade_type)?(t.trade_symbol=e.trade_symbol,t.trade_type=e.order_type,t.digits=i.digits,0):10035},Vo=function(t,e){if(!t.isHedgedMargin())return 10013;const i=yc(this,Ao).getPositionById(e.trade_position),s=yc(this,Ao).getPositionById(e.position_by);if(!i||!s)return 10013;if(i.trade_symbol!==s.trade_symbol||i.trade_action===s.trade_action)return 10013;const r=yc(this,Oo).getFullSymbolByName(i.trade_symbol);if(!r)return 10013;const a=dp(r);return 0!==a?a:_p(r)?(e.trade_symbol=r.trade_symbol,e.digits=r.digits,e.trade_volume=i.trade_volume,0):10035},Uo=function(t){const e={};let i=vc(this,Po,Go).call(this,t,e);if(0!==i||!e.symbol_config||!e.trade_position)return i;const s=e.symbol_config,r=e.trade_position;return function(t,e){switch(e.type_time){case 0:return Boolean(t.trade.trade_time_flags&Qc.GTC);case 1:return Boolean(t.trade.trade_time_flags&Qc.DAY);case 2:return Boolean(t.trade.trade_time_flags&Qc.SPECIFIED);case 3:return Boolean(t.trade.trade_time_flags&Qc.SPECIFIED_DAY);default:return!1}}(s,t)&&(2!==t.type_time&&3!==t.type_time||!(!t.time_expiration||t.time_expiration<0||t.time_expiration>a.INT32_MAX))?up(t,s,r)?(i=vc(this,Po,Ho).call(this,t,s,new ad),0!==i?i:t.isLimit()&&(s.trade_price_limit_min&&d_(t.price_order,s.trade_price_limit_min,s.digits)<0||s.trade_price_limit_max&&d_(t.price_order,s.trade_price_limit_max,s.digits)>0)?10015:(i=pp(t,s,r),0!==i?i:op(s,t,!0)?np(s,t.trade_type)?(2!==s.trade.trade_exemode&&3!==s.trade.trade_exemode&&(t.type_filling=2),0):10035:10030)):10014:10022},Ho=function(t,e,i){if(!ap(t.price_order,e)||!ap(t.price_trigger,e))return 10015;if(!ap(t.price_sl,e)||!ap(t.price_tp,e))return 10016;const s=yc(this,xo).getTick(e.trade_symbol,e.isDelayed());return s?cp(s,e,t,i.price_order,i.price_sl,i.price_tp):10021},Xo=function(t){const e={};let i=vc(this,Po,Go).call(this,t,e);if(0!==i||!e.symbol_config||!e.trade_position)return i;const s=e.symbol_config,r=e.trade_position;return ap(t.price_order,s)?3!==s.trade.trade_exemode?10013:op(s,t,!0)?up(t,s,r)?(i=vc(this,Po,jo).call(this,t,s,r),0!==i?i:(i=pp(t,s,r),0!==i?i:np(s,t.trade_type)?(t.type_flags|=2,t.price_order=0,0):10035)):10014:10030:10015},jo=function(t,e,i){let s=i.sl,r=i.tp;if(!ap(t.price_order,e))return 10015;if(!ap(t.price_sl,e)||!ap(t.price_tp,e))return 10016;(0===t.trade_type&&i.isSell()||1===t.trade_type&&i.isBuy())&&t.trade_volume>=i.trade_volume&&(s=0,r=0);const a=yc(this,xo).getTick(e.trade_symbol,e.isDelayed());return a?cp(a,e,t,i.price_close,s,r):10021},Go=function(t,e){let i=null;if(yc(this,Lo).getAccount().isHedgedMargin()){if(t.trade_position&&(i=yc(this,Ao).getPositionById(t.trade_position),!i))return 10013;if(i&&t.isClose()){if(t.trade_volume>i.trade_volume)return 10014;if(t.isBuy()&&i.isBuy()||t.isSell()&&i.isSell())return 10013}}else t.trade_symbol&&(i=yc(this,Ao).getPositionBySymbol(t.trade_symbol));i||(i=new vd);const s=yc(this,Oo).getFullSymbolByName(i&&i.trade_volume?i.trade_symbol:t.trade_symbol);if(!s)return 10013;const r=dp(s);return 0!==r?r:(t.trade_symbol=s.trade_symbol,t.digits=s.digits,e&&(e.trade_position=i,e.symbol_config=s),0)},Yo=function(t){const e={},i=vc(this,Po,Go).call(this,t,e);if(0!==i||!e.symbol_config||!e.trade_position)return i;const s=e.symbol_config;return 0!==s.trade.trade_exemode&&(1!==s.trade.trade_exemode||!s.trade.trade_instant_volume||s.trade.trade_instant_volume>=t.trade_volume)?10013:function(t,e){return!(void 0===e||e<=0||e>t.trade.volume_max||e%t.trade.volume_step)}(s,t.trade_volume)?0:10014},Ko=function(t){const e={};let i=vc(this,Po,Go).call(this,t,e);if(0!==i||!e.symbol_config||!e.trade_position)return i;const s=e.trade_position,r=e.symbol_config;return op(r,t,!0)?up(t,r,s)?(i=vc(this,Po,jo).call(this,t,r,s),0!==i?i:(i=pp(t,r,s),0!==i?i:np(r,t.trade_type)?(t.type_filling=0,0):10035)):10014:10030};class mp{constructor(t,e,i,s){this.controller=new hp(t,e,i,s)}}class gp extends Rc{async getTradeRequest(t){const e=function(t){return Ec.serialize([[6,t.action_id||0],[6,t.trade_action||0],[11,(t.trade_symbol||"").substring(0,32),64],[18,t.trade_volume||BigInt(0)],[6,t.digits||0],[18,t.trade_order||BigInt(0)],[6,t.trade_type||0],[6,t.type_filling||0],[6,t.type_time||0],[6,t.type_flags||0],[6,t.type_reason||0],[8,t.price_order||0],[8,t.price_trigger||0],[8,t.price_sl||0],[8,t.price_tp||0],[6,t.price_deviation||0],[8,t.price_top||0],[8,t.price_bottom||0],[11,t.comment.substring(0,32),64],[18,t.trade_position||BigInt(0)],[18,t.position_by||BigInt(0)],[6,t.time_expiration||0]])}(t),i=await this.socket.sendCommand(12,e);return new Uint32Array(i.resBody)[0]}}class yp{constructor(t){this.retcode=0,this.trade_order=BigInt(0),this.volume=BigInt(0),this.price=0,this.bid=0,this.ask=0,this.comment="",this.retcode=t??this.retcode}isDone(){const{retcode:t}=this;return 10009===t||10010===t||11001===t}isFinal(){const{retcode:t}=this;return 0!==t&&10001!==t&&10002!==t&&10003!==t&&10028!==t}}function fp(t){return 0===t?"buy":1===t?"sell":2===t?"buy limit":3===t?"sell limit":4===t?"buy stop":5===t?"sell stop":6===t?"buy stop limit":7===t?"sell stop limit":"unknown"}function bp(t,e,i,s=0){if(e){let r="";return r+=wh(t,i,s),r+=` (${wh(e,i)})`,r}return t?wh(t,i):"market"}const vp=t=>` sl: ${t}`;function wp(t,e){switch(t){case 0:case 1:return e("ok");case 2:case 10011:return e("common");case 3:case 4:case 10013:return e("invalidParameters");case 5:case 6:return e("serverProblem");case 7:return e("networkProblem");case 8:return e("permissions");case 9:case 10012:return e("timeout");case 10:case 10031:return e("noConnection");case 12:return e("frequentRequests");case 10001:return e("onTheWay");case 10002:return e("accepted");case 10003:return e("processed");case 10004:return e("requoted");case 10005:return e("prices");case 10006:return e("rejected");case 10007:return e("canceled");case 10008:return e("placed");case 10009:return e("done");case 10010:case 11001:return e("donePartially");case 10014:return e("invalidVolume");case 10015:return e("invalidPrices");case 10016:return e("invalidSLTP");case 10017:return e("tradeDisabled");case 10018:return e("marketClosed");case 10019:return e("notEnoughMoney");case 10020:return e("priceChanged");case 10021:return e("offQuotes");case 10022:return e("invalidExpiration");case 10023:return e("orderChanged");case 10024:return e("manyTradeRequests");case 10026:return e("automatedTradingDisabledServer");case 10027:return e("automatedTradingDisabledClient");case 10029:return e("modificationFailed");case 10030:return e("unsupportedFillingMode");case 10033:return e("ordersLimitReached");case 10034:return e("volumeLimitReached");case 10035:return e("invalidOrderType");case 10036:return e("positionClosed");case 1025:return e("demoAllocationDisabled");case 10039:return e("orderClosePositionExists");case 10040:return e("positionsLimitReached");case 10041:return e("requestRejectedOrderWillCanceled");case 10042:return e("allowedOnlyLongPositions");case 10043:return e("allowedOnlyShortPositions");case 10044:return e("allowedOnlyPositionsClosing");case 10045:return e("positionCloseProhibitedByFIFO")}return"Common error"}function kp(t,e,i,s,r,a,o,c){let l="",h="";if(!s)return"";if(a.isDone()&&(r.isMarket()||r.isPending())){const t=new ad;t.trade_order=a.trade_order,t.order_type=r.trade_type,t.digits=r.digits,t.price_order=a.price,t.price_sl=r.price_sl,t.price_tp=r.price_tp,t.trade_symbol=r.trade_symbol,t.volume_initial=a.volume;const e=function(t){let e="";e+=`#${Jd(t)}`,e+=` ${fp(t.order_type)}`,e+=` ${function(t){return t.volume_current&&t.volume_initial===t.volume_current?vh(t.volume_initial):function(t=BigInt(0),e=BigInt(0)){let i="";return t>=e?(i+=vh(t),i+=" / ",i+=vh(t-e)):(i+=vh(t),i+=" / ",i+=vh(e)),i}(t.volume_initial,t.volume_current)}(t)}`,e+=` ${t.trade_symbol}`;const i=bp(t.price_order,t.price_trigger,t.digits);return i&&(e+=` at ${i}`),e}(t);r.trade_volume===a.volume?l+=`${r.login}: order ${e} done`:l+=`${r.login}: order ${e} done partially`}else{let s=null,o=null;if((r.isPending()||r.isModify()||r.isRemove())&&(s=t.getOrderById(r.trade_order),s||(s=e.getOrderById(r.trade_order))),r.isMarket()||6===r.trade_action||10===r.trade_action){const s=i.getAccount().isHedgedMargin();s&&r.trade_position?o=t.getPositionById(r.trade_position):s||(o=t.getPositionBySymbol(r.trade_symbol),!o&&r.trade_position&&(o=e.getDealBySymbolId(r.trade_position)))}h=function(t,e,i,s){switch(t.trade_action){case 0:return(t=>`prices for ${t.trade_symbol} ${vh(t.trade_volume)}`)(t);case 1:return((t,e)=>{return`#${(i={order:t.trade_order,orderType:fp(e.trade_type),volume:vh(t.volume),symbol:e.trade_symbol,price:wh(t.price,e.digits)}).order} request ${i.orderType} ${i.volume} ${i.symbol} at ${i.price}`;var i})(e,t);case 2:return((t,e)=>{return`#${(i={order:t.trade_order,orderType:fp(e.trade_type),volume:vh(t.volume),symbol:e.trade_symbol,price:wh(t.price,e.digits)}).order} instant ${i.orderType} ${i.volume} ${i.symbol} at ${i.price}`;var i})(e,t);case 3:return((t,e)=>{return t.price?`#${(i={order:t.trade_order,orderType:fp(e.trade_type),volume:vh(t.volume),symbol:e.trade_symbol,price:wh(t.price,e.digits)}).order} market ${i.orderType} ${i.volume} ${i.symbol} at ${i.price}`:(t=>`#${t.order} market ${t.orderType} ${t.volume} ${t.symbol}`)({order:t.trade_order,orderType:fp(e.trade_type),volume:vh(t.volume),symbol:e.trade_symbol});var i})(e,t);case 4:return((t,e)=>{return t.price?`#${(i={order:t.trade_order,orderType:fp(e.trade_type),volume:vh(t.volume),symbol:e.trade_symbol,price:wh(t.price,e.digits)}).order} exchange ${i.orderType} ${i.volume} ${i.symbol} at ${i.price}`:(t=>`#${t.order} exchange ${t.orderType} ${t.volume} ${t.symbol}`)({order:t.trade_order,orderType:fp(e.trade_type),volume:vh(t.volume),symbol:e.trade_symbol});var i})(e,t);case 5:return((t,e)=>{let i=`#${(r={order:t.trade_order,orderType:fp(e.trade_type),volume:vh(t.volume),symbol:e.trade_symbol,price:bp(e.price_order,e.price_trigger,e.digits)}).order} ${r.orderType} ${r.volume} ${r.symbol} at ${r.price}`,s="";var r;return e.price_sl&&(s=vp(wh(e.price_sl,e.digits))),e.price_tp&&(s+=vp(wh(e.price_tp,e.digits))),s&&(i+=`\n${s}`),i})(e,t);case 6:return((t,e)=>{if(!e)return"";let i="";return e.deal_id?i=`#${e.deal_id} ${Yd(e.trade_action)}`:i+=Yd(e.trade_action),`modify ${(s={position:i,volume:vh(e.trade_volume),symbol:e.trade_symbol,sl:wh(t.price_sl,t.digits),tp:wh(t.price_tp,t.digits)}).position} ${s.volume} ${s.symbol}\nsl: ${s.sl}, tp: ${s.tp}`;var s})(t,i);case 7:return((t,e)=>{return e?`${(i={order:t.trade_order,orderType:fp(e.order_type),volume:vh(e.volume_current),symbol:t.trade_symbol,price:bp(t.price_order,t.price_trigger,t.digits),sl:wh(t.price_sl,t.digits),tp:wh(t.price_tp,t.digits)}).order} ${i.orderType} ${i.volume} ${i.symbol} at ${i.price}\nsl: ${i.sl} tp: ${i.tp}`:"";var i})(t,s);case 8:return((t,e)=>{if(!e)return"";let i=`cancel #${(r={order:t.trade_order,orderType:fp(e.order_type),volume:vh(e.volume_current),symbol:e.trade_symbol,price:bp(e.price_order,e.price_trigger,t.digits)}).order} ${r.orderType} ${r.volume} ${r.symbol} at ${r.price}`,s="";var r;return t.price_sl&&(s=vp(wh(e.price_sl,t.digits))),t.price_tp&&(s+=` tp: ${wh(e.price_tp,t.digits)}`),s&&(i+=`\n${s}`),i})(t,s);case 10:return""}return""}(r,a,o,s)}switch(a.retcode){case 10001:if(l+=`${r.login}: ${h}`,10===r.trade_action){let i=t.getPositionById(r.position_by);i||(i=e.getDealById(r.position_by)),i&&(l+=` ${Yd(i.trade_action)}`,l+=` ${vh(i.trade_volume)}`,l+=` ${i.trade_symbol}`)}break;case 10002:l+=`${r.login}: accepted ${h}`;break;case 10003:l+=`${r.login}: processed ${h}`;break;case 10004:l+=`${r.login}: requote`,l+=` ${wh(a.bid,s.digits)}`,l+=` / ${wh(a.ask,s.digits)}`,l+=` (${h})`;break;case 10005:l+=`${r.login}: answer ${h}`,l+=` ${wh(a.bid,s.digits)}`,l+=` / ${wh(a.ask,s.digits)}`,c&&(l+=` in ${c} ms`);break;case 10006:l+=`${r.login}: rejected ${h}`,a.comment&&(l+=` (${a.comment})`);break;case 10008:l+=`${r.login}: ${h} placed for execution`,c&&(l+=` in ${c} ms`);break;case 10009:case 10010:case 11001:switch(r.trade_action){case 1:case 2:case 3:case 4:case 5:break;case 6:case 7:case 8:case 10:l+=`${r.login}: ${function(t){let e="";switch(t.trade_action){case 0:e+=`prices for ${t.trade_symbol} ${vh(t.trade_volume)}`;break;case 1:e+="request",e+=` ${fp(t.trade_type)}`,e+=` ${vh(t.trade_volume)}`,e+=` ${t.trade_symbol}`,e+=" at",e+=wh(t.price_order,t.digits),t.trade_position?e+=`, close #${t.trade_position.toString()}`:(t.price_sl&&(e+=` sl: ${wh(t.price_sl,t.digits)}`),t.price_tp&&(e+=` tp: ${wh(t.price_tp,t.digits)}`));break;case 2:e+="instant",e+=` ${fp(t.trade_type)}`,e+=` ${vh(t.trade_volume)}`,e+=` ${t.trade_symbol}`,e+=" at",e+=` ${wh(t.price_order,t.digits)}`,t.trade_position?e+=`, close #${t.trade_position.toString()}`:(t.price_sl&&(e+=` sl: ${wh(t.price_sl,t.digits)}`),t.price_tp&&(e+=` tp: ${wh(t.price_tp,t.digits)}`));break;case 3:e+="market",e+=` ${fp(t.trade_type)}`,e+=` ${vh(t.trade_volume)}`,e+=` ${t.trade_symbol}`,t.trade_position?e+=`, close #${t.trade_position.toString()}`:(t.price_sl&&(e+=` sl: ${wh(t.price_sl,t.digits)}`),t.price_tp&&(e+=` tp: ${wh(t.price_tp,t.digits)}`));break;case 4:e+="exchange",e+=` ${fp(t.trade_type)}`,e+=` ${vh(t.trade_volume)}`,e+=` ${t.trade_symbol}`,e+=" at",e+=` ${t.price_order?wh(t.price_order,t.digits):"market"}`,t.trade_position?e+=`, close #${t.trade_position.toString()}`:(t.price_sl&&(e+=` sl: ${wh(t.price_sl,t.digits)}`),t.price_tp&&(e+=` tp: ${wh(t.price_tp,t.digits)}`));break;case 5:e+=fp(t.trade_type),e+=` ${vh(t.trade_volume)}`,e+=` ${t.trade_symbol}`,e+=" at",e+=` ${bp(t.price_order,t.price_trigger,t.digits)}`,t.price_sl&&(e+=` sl: ${wh(t.price_sl,t.digits)}`),t.price_tp&&(e+=` tp: ${wh(t.price_tp,t.digits)}`);break;case 6:e+="modify",t.trade_position&&(e+=` #${t.trade_position.toString()}`),e+=` ${Yd(t.trade_type)}`,e+=` ${vh(t.trade_volume)}`,e+=` ${t.trade_symbol}`,e+=" ->",e+=` sl: ${wh(t.price_sl,t.digits)}`,e+=`, tp: ${wh(t.price_tp,t.digits)}`;break;case 7:e+="modify",e+=` #${t.trade_order.toString()}`,e+=` ${fp(t.trade_type)}`,e+=` ${vh(t.trade_volume)}`,e+=` ${t.trade_symbol}`,e+=" ->",e+=` price: ${bp(t.price_order,t.price_trigger,t.digits)}`,e+=`, sl: ${wh(t.price_sl,t.digits)}`,e+=`, tp: ${wh(t.price_tp,t.digits)}`;break;case 8:e+="cancel",e+=` #${t.trade_order.toString()}`,e+=` ${fp(t.trade_type)}`,e+=` ${vh(t.trade_volume)}`,e+=` ${t.trade_symbol}`,e+=` at ${bp(t.price_order,t.price_trigger,t.digits)}`;break;case 9:e+="transfer",e+=` ${n.toMoney(t.price_order,2)}`,e+=" to ''",e+=`${t.comment}`;break;case 10:e+="close position",t.trade_position&&(e+=` #${t.trade_position.toString()}`),e+=` ${fp(t.trade_type)}`,e+=` ${vh(t.trade_volume)}`,e+=` ${t.trade_symbol}`,e+=" by position",e+=` #${t.position_by.toString()}`;break;case 100:e+="activate ",e+=` #${t.trade_order.toString()}`,e+=` ${fp(t.trade_type)}`,e+=` ${vh(t.trade_volume)}`,e+=` ${t.trade_symbol}`,e+=` at ${bp(t.price_order,t.price_trigger,t.digits)}`;break;case 101:e+="activate",t.trade_position&&(e+=` #${t.trade_position.toString()}`),e+=" stop loss,",e+=` ${fp(t.trade_type)}`,e+=` ${vh(t.trade_volume)}`,e+=` ${t.trade_symbol}`,e+=` at ${bp(t.price_order,0,t.digits)}`;break;case 102:e+="activate",t.trade_position&&(e+=` #${t.trade_position.toString()}`),e+=" take profit,",e+=` ${fp(t.trade_type)}`,e+=` ${vh(t.trade_volume)}`,e+=` ${t.trade_symbol}`,e+=` at ${bp(t.price_order,0,t.digits)}`;break;case 103:e+="activate stop-limit order",e+=` #${t.trade_order.toString()}`,e+=` ${fp(t.trade_type)}`,e+=` ${vh(t.trade_volume)}`,e+=` ${t.trade_symbol}`,e+=` at ${bp(t.price_order,t.price_trigger,t.digits)}`;break;case 104:e+="delete stop-out order",e+=` #${t.trade_order.toString()}`,e+=` ${fp(t.trade_type)}`,e+=` ${vh(t.trade_volume)}`,e+=` ${t.trade_symbol}`,e+=` at ${bp(t.price_order,t.price_trigger,t.digits)}`;break;case 105:e+="close stop-out position",t.trade_position&&(e+=` #${t.trade_position.toString()}`),e+=` ${fp(t.trade_type)}`,e+=` ${vh(t.trade_volume)}`,e+=` ${t.trade_symbol}`,e+=` at ${bp(t.price_order,0,t.digits)}`;break;case 106:e+="expire",e+=` #${t.trade_order.toString()}`,e+=` ${fp(t.trade_type)}`,e+=` ${vh(t.trade_volume)}`,e+=` ${t.trade_symbol}`,e+=` at ${bp(t.price_order,0,t.digits)}`;break;case 200:e+="for",e+=` ${t.login}`,e+=` ${fp(t.trade_type)}`,e+=` ${vh(t.trade_volume)}`,e+=` ${t.trade_symbol}`,e+=` at ${bp(t.price_order,0,t.digits)}`,t.trade_position?e+=`, close #${t.trade_position.toString()}`:(t.price_sl&&(e+=` sl: ${wh(t.price_sl,t.digits)}`),t.price_tp&&(e+=` tp: ${wh(t.price_tp,t.digits)}`));break;case 201:e+="for",e+=` ${t.login}`,e+=` ${fp(t.trade_type)}`,e+=` ${vh(t.trade_volume)}`,e+=` ${t.trade_symbol}`,e+=` at ${bp(t.price_order,t.price_trigger,t.digits)}`,t.price_sl&&(e+=` sl: ${wh(t.price_sl,t.digits)}`),t.price_tp&&(e+=` tp: ${wh(t.price_tp,t.digits)}`);break;case 202:e+="for",e+=` ${t.login}`,e+=" modify position",t.trade_position&&(e+=` #${t.trade_position.toString()}`),e+=` ${fp(t.trade_type)}`,e+=` ${vh(t.trade_volume)}`,e+=` ${t.trade_symbol}`,e+=` -> price: ${bp(t.price_order,t.digits,3)}`,e+=` sl: ${wh(t.price_sl,t.digits)}`,e+=` tp: ${wh(t.price_tp,t.digits)}`;break;case 203:e+="for",e+=` ${t.login}`,e+=" modify order",e+=` #${t.trade_order.toString()}`,e+=` ${fp(t.trade_type)}`,e+=` ${vh(t.trade_volume)}`,e+=` ${t.trade_symbol}`,e+=` -> price: ${bp(t.price_order,t.price_trigger,t.digits)}`,e+=` sl: ${wh(t.price_sl,t.digits)}`,e+=` tp: ${wh(t.price_tp,t.digits)}`;break;case 204:e+="for",e+=` ${t.login}`,e+=" cancel order",e+=` #${t.trade_order.toString()}`,e+=` ${fp(t.trade_type)}`,e+=` ${vh(t.trade_volume)}`,e+=` ${t.trade_symbol}`;break;case 205:e+="for",e+=` ${t.login}`,e+=" activate order",e+=` #${t.trade_order.toString()}`,e+=` ${fp(t.trade_type)}`,e+=` ${vh(t.trade_volume)}`,e+=` ${t.trade_symbol}`;break;case 207:e+="for",e+=` ${t.login}`,e+=" activate stop-limit order",e+=` #${t.trade_order.toString()}`,e+=` ${fp(t.trade_type)}`,e+=` ${vh(t.trade_volume)}`,e+=` ${t.trade_symbol}`;break;case 208:e+="for",e+=` ${t.login}`,e+=" close position",t.trade_position&&(e+=` #${t.trade_position.toString()}`),e+=` ${fp(t.trade_type)}`,e+=` ${vh(t.trade_volume)}`,e+=` ${t.trade_symbol}`,e+=` by position #${t.position_by.toString()}`;break;case 206:e+="for",e+=` ${t.login}`,e+=" balance",e+=` ${n.toMoney(t.price_order,2)}`,e+=` ${t.comment}`}return e}(r)} done`;break;default:l+=`${r.login}: ${h} done`}c&&(l+=` in ${c} ms`);break;case 10025:l+=`${r.login}: ${h} skipped as it changes nothing`;break;default:l+=`${r.login}: failed ${h} [${wp(a.retcode,o)}]`}return l}function Tp(t){var e;return{priceOrder:t.price_order,priceTrigger:t.price_trigger,priceSL:t.price_sl,priceTP:t.price_tp,priceDeviation:t.price_deviation,symbol:t.trade_symbol,volume:fh.toDouble(t.trade_volume),position:null==(e=t.trade_position)?void 0:e.toString(),order:t.trade_order?t.trade_order.toString():void 0,expiration:t.time_expiration,id:t.action_id,typeName:D_(t.trade_type),complete:t.complete,isBuy:t.isBuy(),isSell:t.isSell(),isMarket:t.isMarket(),isPending:t.isPending(),isClose:t.isClose(),isCloseBy:t.isCloseBy(),digits:t.digits,tradeAction:t.trade_action,comment:t.comment}}function Mp(t){return{code:t.retcode,order:t.trade_order?t.trade_order.toString():"",volume:fh.toDouble(t.volume),price:t.price,time:t.res_time,bid:t.bid,ask:t.ask,comment:t.comment}}class Sp{constructor(){this.trade_volume=BigInt(0),this.price_order=0,this.price_trigger=0,this.price_sl=0,this.price_tp=0,this.price_deviation=0,this.price_top=0,this.price_bottom=0,this.action_id=0,this.trade_action=0,this.trade_symbol="",this.digits=0,this.trade_order=BigInt(0),this.trade_type=0,this.type_flags=0,this.comment="",this.position_by=BigInt(0),this.send_time=0,this.login=0,this.complete=!1}copy(){const t=new Sp;return t.action_id=this.action_id,t.trade_action=this.trade_action,t.trade_symbol=this.trade_symbol,t.trade_volume=this.trade_volume,t.digits=this.digits,t.trade_order=this.trade_order,t.trade_type=this.trade_type,t.type_filling=this.type_filling,t.type_time=this.type_time,t.type_flags=this.type_flags,t.type_reason=this.type_reason,t.price_order=this.price_order,t.price_trigger=this.price_trigger,t.price_sl=this.price_sl,t.price_tp=this.price_tp,t.price_deviation=this.price_deviation,t.price_top=this.price_top,t.price_bottom=this.price_bottom,t.comment=this.comment,t.trade_position=this.trade_position,t.position_by=this.position_by,t}isBuy(){return O_(this.trade_type)}isSell(){return x_(this.trade_type)}isLimit(){return E_(this.trade_type)}isStop(){return $_(this.trade_type)}isStopLimit(){return N_(this.trade_type)}isMarket(){const t=this.trade_action;return 1===t||2===t||3===t||4===t||200===t}isPending(){return 5===this.trade_action}isModify(){return 7===this.trade_action}isRemove(){return 8===this.trade_action}isClient(){return this.trade_action>=0&&this.trade_action<=10}isDealer(){return this.trade_action>=200&&this.trade_action<=208}isBalance(){return 206===this.trade_action}isServer(){return this.trade_action>=100&&this.trade_action<=106}isExpert(){return!!(256&this.type_flags)}isSignal(){return!!(512&this.type_flags)}isExpiration(){return 106===this.trade_action}isSLTP(){return 101===this.trade_action||102===this.trade_action}isStopoutPosition(){return 105===this.trade_action}isSkipMarginCheck(){return this.isDealer()&&!!(1024&this.type_flags)}isClose(){return Boolean((this.isMarket()||this.isSLTP())&&this.trade_position)}isCloseBy(){return 10===this.trade_action||208===this.trade_action}}class zp{constructor(){fc(this,Jo),fc(this,Zo),bc(this,Jo,new Map),this.count=1e3,bc(this,Zo,new Map)}clearStorage(){this.count=1e3,yc(this,Zo).clear(),yc(this,Jo).clear()}incRequestsCount(){this.count+=1}getRequestsCount(){return this.count}setAction(t){yc(this,Zo).set(t.action_id,t)}getAction(t){return yc(this,Zo).get(t)}getRequotesCount(){return yc(this,Jo).size}getRequote(t){const e=yc(this,Jo).get(t);if(e){if(e.time>Date.now())return e;yc(this,Jo).delete(t)}return null}addRequote(t){yc(this,Jo).set(t.trans_request.trade_symbol,t)}getRequotes(){return Array.from(yc(this,Jo).values())}deleteRequote(t){yc(this,Jo).delete(t.trans_request.trade_symbol)}}Jo=new WeakMap,Zo=new WeakMap;class Bp{constructor(t,e,i,s,r,a,o,n,c){fc(this,hn),fc(this,Qo),fc(this,tn),fc(this,en,new zp),fc(this,sn),fc(this,rn),fc(this,an),fc(this,on),fc(this,nn),fc(this,cn),fc(this,ln),bc(this,Qo,t),bc(this,tn,e),bc(this,sn,i),bc(this,rn,s),bc(this,an,r),bc(this,on,a),bc(this,nn,o),bc(this,cn,n),bc(this,ln,c)}destroy(){this.clearStorage()}clearStorage(){yc(this,en).clearStorage()}sendRequest(t){t.type_reason=0,t.type_flags&=-257,t.type_flags&=-513;const e=yc(this,rn).getAccount();t.login=e.login,t.action_id=yc(this,en).getRequestsCount(),yc(this,en).incRequestsCount(),t.send_time=Date.now();const i=yc(this,cn).checkAction(this,t,!0);if(0!==i){const e=yc(this,an).getSymbolByName(t.trade_symbol);return yc(this,Qo).trigger(6,kp(yc(this,on),yc(this,nn),yc(this,rn),e,t,new yp(i),yc(this,ln))),i}if(!yc(this,sn).hasSignalServerConnection()||!yc(this,sn).hasTradeServerConnection()){const e=yc(this,an).getSymbolByName(t.trade_symbol);return yc(this,Qo).trigger(6,kp(yc(this,on),yc(this,nn),yc(this,rn),e,t,new yp(10),yc(this,ln))),i}yc(this,tn).getTradeRequest(t).then((e=>vc(this,hn,_n).call(this,t,e))).catch((()=>this.onTimeout(t)));const s=yc(this,an).getSymbolByName(t.trade_symbol);return yc(this,Qo).trigger(6,kp(yc(this,on),yc(this,nn),yc(this,rn),s,t,new yp(10001),yc(this,ln))),yc(this,en).setAction(t),0}onTimeout(t){if(this){const e=yc(this,an).getSymbolByName(t.trade_symbol),i=kp(yc(this,on),yc(this,nn),yc(this,rn),e,t,new yp(10012),yc(this,ln));yc(this,Qo).trigger(6,i),yc(this,Qo).trigger(2,{id:t.action_id,order:"",action:Tp(t),code:10012,log:i})}}getAction(t){return yc(this,en).getAction(t)}addRequote(t){yc(this,en).addRequote(t)}orderDelete(t){const e=Cp();if(Wp(e,t),!t)return e;const i=vc(this,hn,dn).call(this,e,t.trade_symbol);return i?(function(t,e,i){const{request:s}=t;s.trade_symbol=i.trade_symbol,s.trade_action=8,s.trade_volume=i.volume_initial,s.trade_order=i.trade_order,s.price_order=Zh(i.price_order,e.trade_tick_size,e.digits),s.price_trigger=Zh(i.price_trigger,e.trade_tick_size,e.digits),s.price_sl=Zh(i.price_sl,e.trade_tick_size,e.digits),s.price_tp=Zh(i.price_tp,e.trade_tick_size,e.digits),s.type_time=i.type_time,s.time_expiration=Math.round((i.time_expiration??0)/1e3),s.trade_type=i.order_type}(e,i,t),e.result.retcode=this.sendRequest(e.request),e):e}orderModify(t,e,i,s,r,o,n,c){const l=Cp();if(Wp(l,t),!t)return l;const h=vc(this,hn,dn).call(this,l,t.trade_symbol);return h?(function(t,e,i,s,r,o,n,c,l,h){const{request:_}=t;let d=s?s-i.price_order:0;i.price_sl&&(i.price_sl=a.normalize(i.price_sl+d,i.digits)),i.price_tp&&(i.price_tp=a.normalize(i.price_tp+d,i.digits)),6!==i.order_type&&7!==i.order_type||(i.price_trigger=a.normalize(i.price_trigger+d,i.digits),h&&0===d&&(d=h-i.price_trigger,i.price_sl&&(i.price_sl=a.normalize(i.price_sl+d,i.digits)),i.price_tp&&(i.price_tp=a.normalize(i.price_tp+d,i.digits))));const u=e.trade_tick_size,p=e.digits;_.trade_symbol=i.trade_symbol,_.trade_action=7,_.trade_volume=i.volume_initial,_.trade_order=i.trade_order,_.trade_type=i.order_type,_.price_order=Zh(s??i.price_order,u,p),_.price_trigger=Zh(h??i.price_trigger,u,p),_.price_sl=Zh(r??i.price_sl,u,p),_.price_tp=Zh(o??i.price_tp,u,p),_.type_time=n??i.type_time,_.time_expiration=Math.round((c??i.time_expiration)/1e3),_.comment=l??i.comment}(l,h,t,e,i,s,r,o,n,c),l.result.retcode=this.sendRequest(l.request),l):l}orderOpen(t,e,i,s,r,a,o,n,c,l,h){const _=Cp(),d=vc(this,hn,dn).call(this,_,e);return d?(function(t,e,i,s,r,a,o,n,c,l,h,_){const{request:d}=t;d.trade_type=i,d.trade_symbol=e.trade_symbol,d.trade_action=P_(i)?5:2,d.trade_volume=fh.toInt(s),d.digits=e.digits,d.type_flags=2,d.price_order=Zh(r,e.trade_tick_size,e.digits),d.price_trigger=Zh(h??0,e.trade_tick_size,e.digits),d.price_sl=Zh(a??0,e.trade_tick_size,e.digits),d.price_tp=Zh(o??0,e.trade_tick_size,e.digits),d.type_time=n??0,d.time_expiration=Math.round((c??0)/1e3),d.comment=l??"",3===e.trade.trade_exemode?d.type_filling=_??2:d.type_filling=2}(_,d,t,i,s,r,a,o,n,c,l,h),_.result.retcode=this.sendRequest(_.request),_):_}positionClose(t,e,i,s){const r=Cp();if(Ip(r,t),!t)return r;const a=vc(this,hn,dn).call(this,r,t.trade_symbol);return a?(function(t,e,i,s,r,a,o){var n;const{request:c}=t;switch(c.trade_symbol=e.trade_symbol,c.trade_volume=o?fh.toInt(o):i.trade_volume,c.digits=e.digits,c.trade_order=BigInt(0),c.type_flags=3,c.trade_position=i.position_id,c.price_order=i.price_close,c.price_trigger=0,c.price_sl=0,c.price_tp=0,c.type_time=0,c.time_expiration=0,c.trade_type=i.isBuy()?1:0,null==(n=e.trade)?void 0:n.trade_exemode){case 1:if(c.type_filling=0,a&&!s&&(i.isBuy()?c.price_order=a.bid:i.isSell()&&(c.price_order=a.ask)),e.trade&&!e.trade.trade_instant_volume||c.trade_volume<=e.trade.trade_instant_volume){c.trade_action=2,c.price_deviation=1;break}case 0:r?(c.price_order=r,c.trade_action=1):c.trade_action=0;break;case 2:c.trade_action=3,e.trade&&e.trade.trade_fill_flags&Zc.IOC?c.type_filling=1:e.trade&&e.trade.trade_fill_flags&Zc.FOK?c.type_filling=0:c.type_filling=2;break;case 3:c.trade_action=4,c.type_filling=2}}(r,a,t,e,i,yc(this,en).getRequote(t.trade_symbol),s),r.result.retcode=this.sendRequest(r.request),r):r}positionCloseBySymbol(t){const e=yc(this,on).getPositionBySymbol(t);return this.positionClose(e,!1)}positionCloseBy(t,e){const i=Cp();if(Ip(i,t),!t)return i;if(Ip(i,e),!e)return i;const s=vc(this,hn,dn).call(this,i,t.trade_symbol);return s?(function(t,e,i,s){const{request:r}=t;let a=i.trade_volume;a>=s.trade_volume&&(a=s.trade_volume),r.trade_symbol=e.trade_symbol,r.trade_volume=a,r.digits=e.digits,r.trade_order=BigInt(0),r.type_flags=3,r.trade_position=i.position_id,r.position_by=s.position_id,r.price_order=i.price_close,r.price_trigger=0,r.price_sl=0,r.price_tp=0,r.type_time=0,r.time_expiration=0,r.trade_type=i.isBuy()?1:0,r.trade_action=10,r.type_filling=0}(i,s,t,e),i.result.retcode=this.sendRequest(i.request),i):i}positionModify(t,e,i,s){const r=Cp();if(Ip(r,t),!t)return r;const a=vc(this,hn,dn).call(this,r,t.trade_symbol);return a?(function(t,e,i,s,r){const{request:a}=t;a.trade_symbol=e.trade_symbol,a.trade_position=i.position_id,a.trade_volume=i.trade_volume,a.trade_action=6,a.digits=e.digits,s!==Number.MAX_VALUE?a.price_sl=Zh(s,e.trade_tick_size,e.digits):a.price_sl=Zh(i.sl,e.trade_tick_size,e.digits),r!==Number.MAX_VALUE?a.price_tp=Zh(r,e.trade_tick_size,e.digits):a.price_tp=Zh(i.tp,e.trade_tick_size,e.digits)}(r,a,t,e,i),r.result.retcode=this.sendRequest(r.request),r):r}positionModifyBySymbol(t,e,i){const s=yc(this,on).getPositionBySymbol(t);return this.positionModify(s,e,i)}positionOpen(t,e,i,s,r,a,o,n){const c=Cp(),l=vc(this,hn,dn).call(this,c,t);return l?(function(t,e,i,s,r,a,o,n,c,l,h){var _;let d=n,u=c;void 0===d&&void 0===u&&(s||i&&(0===a&&i.isBuy()||1===a&&i.isSell())&&(d=i.sl,u=i.tp)),d||(d=0),u||(u=0);const{request:p}=t;switch(p.trade_symbol=e.trade_symbol,p.trade_volume=fh.toInt(r),p.digits=e.digits,p.type_flags=2,p.price_order=0,p.price_trigger=0,p.price_sl=Zh(d,e.trade_tick_size,e.digits),p.price_tp=Zh(u,e.trade_tick_size,e.digits),p.type_time=0,p.time_expiration=0,p.trade_type=a,p.comment=h,null==(_=e.trade)?void 0:_.trade_exemode){case 1:if(p.type_filling=0,!e.trade.trade_instant_volume||p.trade_volume<=e.trade.trade_instant_volume){p.trade_action=2,p.price_order=o,p.price_deviation=0;break}case 0:o?(p.price_order=o,p.trade_action=1):p.trade_action=0;break;case 2:p.trade_action=3,e.trade.trade_fill_flags&Zc.IOC?p.type_filling=1:e.trade.trade_fill_flags&Zc.FOK?p.type_filling=0:p.type_filling=2;break;case 3:p.trade_action=4,p.type_filling=l,p.type_flags=2,p.price_order=0}}(c,l,yc(this,on).getPositionBySymbol(l.trade_symbol),yc(this,rn).getAccount().isHedgedMargin(),e,i,s,r,a,o,n),c.result.retcode=this.sendRequest(c.request),c):c}getRequotes(){return yc(this,en).getRequotes()}deleteRequote(t){yc(this,en).deleteRequote(t)}bulkDeleteOrders(t,e,i,s){const r=yc(this,on).getOrders(),a=Cp();if(!vc(this,hn,dn).call(this,a,t))return a;for(let o=0;o<r.length;o++){a.request=new Sp;const s=r[o];if(s.trade_symbol!==t)continue;if(e&&i){let t;for(t=0;t<i&&e[t]!==s.order_type;t++);if(t>=i)continue}const n=vc(this,hn,dn).call(this,a,s.trade_symbol);n&&(a.request.trade_symbol=s.trade_symbol,a.request.trade_action=8,a.request.trade_order=s.trade_order,a.request.price_order=Zh(s.price_order,n.trade_tick_size,n.digits),a.request.price_trigger=Zh(s.price_trigger,n.trade_tick_size,n.digits),a.request.price_sl=Zh(s.price_sl,n.trade_tick_size,n.digits),a.request.price_tp=Zh(s.price_tp,n.trade_tick_size,n.digits),a.request.type_time=s.type_time,a.request.time_expiration=s.time_expiration,a.request.trade_type=s.order_type,a.result.retcode=this.sendRequest(a.request))}return a}bulkClosePositions(t,e=[],i=0,s=!1){const r=Cp();if(!e.length&&!i&&!this.bulkClosePositionsCloseBy(r,t,e,i,0))return r;const a=yc(this,on).getPositions();for(let o=0;o<a.length;o++){const n=a[o];if(!t||n.trade_symbol===t){if(e.length){let t;for(t=0;t<e.length&&e[t]!==n.trade_action;t++);if(t>=e.length)continue}if(i){if(i>0&&n.profit<=0)continue;if(i<0&&n.profit>=0)continue}if(!this.bulkCloseFill(r,n,s))return r;r.result.retcode=this.sendRequest(r.request)}}return r}bulkClosePositionsCloseBy(t,e,i=[],s=0,r=0){const a=r+1;if((r+=1)>128)return!0;if(i.length)return!0;if(!yc(this,on).hedgeAllowed())return!0;const o=yc(this,on).getPositions(),n=[];if(o.length)for(let c=0;c<o.length;c++){const t=o[c];e&&t.trade_symbol!==e||t.trade_volume&&(s&&(s>0&&t.profit<=0||s<0&&t.profit>=0)||_p(yc(this,an).getFullSymbolByName(t.trade_symbol))&&n.push(t))}for(let c=0;c<o.length;c++){const r=yc(this,on).getPositionById(o[c].deal);if(r)for(let l=0;l<n.length;l++){const h=yc(this,on).getPositionById(n[c].deal);if(h){if(r.trade_symbol===h.trade_symbol&&r.trade_action!==h.trade_action){t.request.trade_symbol=r.trade_symbol,t.request.trade_action=10,t.request.trade_position=r.deal,t.request.digits=r.digits,t.request.position_by=h.deal,o.splice(c,1),c-=1,n.splice(l,1),l-=1,this.bulkClosePositionsCloseBy(t,e,i,s,a);break}}else n.splice(l,1),l-=1}else o.splice(c,1),c-=1}return!0}bulkCloseFill(t,e,i){const s=vc(this,hn,dn).call(this,t,e.trade_symbol);if(!s)return!1;const{request:r}=t;switch(r.trade_symbol=s.trade_symbol,r.digits=s.digits,r.trade_order=BigInt(0),r.type_flags=3,r.price_order=e.price_close,r.price_trigger=0,r.price_sl=0,r.price_tp=0,r.type_time=0,r.time_expiration=0,r.trade_type=e.isBuy()?1:0,i?(r.trade_volume=BigInt(2)*e.trade_volume,r.trade_position=BigInt(0)):(r.trade_volume=e.trade_volume,r.trade_position=e.deal,r.type_flags|=1),s.trade.trade_exemode){case 1:if(r.type_filling=0,s.trade.trade_instant_volume===BigInt(0)||r.trade_volume<=s.trade.trade_instant_volume){r.trade_action=2,r.price_deviation=1;break}case 0:r.trade_action=1;break;case 2:r.trade_action=3,s.trade.trade_fill_flags&Zc.IOC?r.type_filling=1:s.trade.trade_fill_flags&Zc.FOK?r.type_filling=0:r.type_filling=2;break;case 3:r.trade_action=4,r.type_filling=2}return!0}}function Cp(){return{request:new Sp,result:new yp}}function Wp(t,e){return e||(t.result.retcode=3,null)}function Ip(t,e){return e||(t.result.retcode=3,null)}function Lp(t){return{action:Tp(t.request),result:Mp(t.result)}}Qo=new WeakMap,tn=new WeakMap,en=new WeakMap,sn=new WeakMap,rn=new WeakMap,an=new WeakMap,on=new WeakMap,nn=new WeakMap,cn=new WeakMap,ln=new WeakMap,hn=new WeakSet,_n=function(t,e){if(0!==e){const i=new yp(e),s=yc(this,an).getSymbolByName(t.trade_symbol),r=kp(yc(this,on),yc(this,nn),yc(this,rn),s,t,new yp(e),yc(this,ln));yc(this,Qo).trigger(6,r),yc(this,Qo).trigger(2,{id:t.action_id,order:"",action:Tp(t),result:Mp(i),code:e,log:r})}},dn=function(t,e){return yc(this,an).getFullSymbolByName(e)||(t.result.retcode=2,null)};class Op{constructor(t,e){fc(this,un),fc(this,pn),bc(this,un,t),bc(this,pn,e)}positionOpen(t,e,i,s,r,a,o,n){return Lp(yc(this,un).positionOpen(e,i,t,s,r,a,o,n))}positionModify(t,e,i,s){const r=yc(this,pn).getPositionById(BigInt(t));return Lp(yc(this,un).positionModify(r,e,i,s))}modifyBySymbol(t,e,i){return Lp(yc(this,un).positionModifyBySymbol(t,e,i))}positionClose(t,e,i,s){const r=yc(this,pn).getPositionById(BigInt(t)),a=yc(this,un).positionClose(r,e,i,s);return a&&Lp(a)}positionsClose(){const t=yc(this,un).bulkClosePositions();return t&&Lp(t)}positionCloseBy(t,e){const i=yc(this,pn).getPositionById(BigInt(t)),s=yc(this,pn).getPositionById(BigInt(e)),r=yc(this,un).positionCloseBy(i,s);return r&&Lp(r)}positionCloseBySymbol(t){const e=yc(this,un).positionCloseBySymbol(t);return e&&Lp(e)}requestPrice(t,e,i){return this.positionOpen(e,t,i,0,0,0,0,"")}orderOpen(t,e,i,s,r,a,o,n,c,l,h){return Lp(yc(this,un).orderOpen(t,e,i,s,r,a,o,n,c,l,h))}orderModify(t,e,i,s,r,a,o,n){const c=yc(this,pn).getOrderById(BigInt(t));return Lp(yc(this,un).orderModify(c,e,i,s,r,a,o,n))}orderDelete(t){const e=yc(this,pn).getOrderById(BigInt(t));return e?Lp(yc(this,un).orderDelete(e)):null}}un=new WeakMap,pn=new WeakMap;class xp{constructor(t,e,i,s,r,a,o,n,c){this.controller=new Bp(t,new gp(e),i,s,r,a,o,n,c),this.view=new Op(this.controller,a)}}const Ap=[{propType:6},{propType:6},{propType:11,propLength:64},{propType:18},{propType:6},{propType:17},{propType:6},{propType:6},{propType:6},{propType:6},{propType:6},{propType:8},{propType:8},{propType:8},{propType:8},{propType:6},{propType:8},{propType:8},{propType:11,propLength:64},{propType:18},{propType:18},{propType:12,propLength:4}],Pp=Ec.getSeriesSize(Ap),Ep=[{propType:6},{propType:17},{propType:17},{propType:17},{propType:8},{propType:6},{propType:8},{propType:8},{propType:8},{propType:11,propLength:64}],$p=[{propType:6},{propType:12,propLength:Pp,parser:function(t,e=0){return function(t,e=0){const i=Ec.parse(t,Ap,e),s=new Sp;return s.action_id=i[0],s.trade_action=i[1],s.trade_symbol=i[2],s.trade_volume=i[3],s.digits=i[4],s.trade_order=i[5],s.trade_type=i[6],s.type_filling=i[7],s.type_time=i[8],s.type_flags=i[9],s.type_reason=i[10],s.price_order=i[11],s.price_trigger=i[12],s.price_sl=i[13],s.price_tp=i[14],s.price_deviation=i[15],s.price_top=i[16],s.price_bottom=i[17],s.comment=i[18],s.trade_position=i[19],s.position_by=i[20],s}(t,e)}},{propType:12,propLength:Ec.getSeriesSize(Ep),parser:function(t,e=0){return function(t,e=0){const i=Ec.parse(t,Ep,e),s=new yp(i[0]);return s.retcode=i[0],s.deal=i[1],s.trade_order=i[2],s.volume=i[3],s.price=i[4],s.res_time=i[5],s.bid=i[6],s.ask=i[7],s.last=i[8],s.comment=i[9],s}(t,e)}}];class Np extends Rc{constructor(){super(...arguments),fc(this,gn),fc(this,mn,new WeakMap)}on(t){let e=yc(this,mn).get(t);e||(e=vc(this,gn,yn).bind(this,t),yc(this,mn).set(t,e)),this.socket.on(19,e)}off(t){const e=yc(this,mn).get(t);e&&this.socket.off(19,e)}}mn=new WeakMap,gn=new WeakSet,yn=function(t,e){var i;t((i=e.resBody,Ec.parse(i,$p,0)))};class Dp{constructor(t,e,i,s,r,a,o,n){fc(this,fn),fc(this,bn),fc(this,vn),fc(this,wn),fc(this,kn),fc(this,Tn),fc(this,Mn),fc(this,Sn),fc(this,zn,(t=>{yc(this,vn).getAccount();let e=t[1];const i=t[2];if(e=yc(this,kn).getAction(e.action_id),!e)return;const s=yc(this,wn).getSymbolByName(e.trade_symbol),r=(new Date).getTime()-e.send_time,a=kp(yc(this,Tn),yc(this,Mn),yc(this,vn),s,e,i,yc(this,Sn),r);if(i.isFinal()&&yc(this,fn).trigger(7,a),2===e.trade_action&&10004===i.retcode){const t=yc(this,wn).getFullSymbolByName(e.trade_symbol),s=(null==t?void 0:t.trade.trade_instant_timeout)??7;yc(this,kn).addRequote({trans_request:e,time:Date.now()+1e3*s,bid:i.bid,ask:i.ask})}e.complete=!0,yc(this,fn).trigger(2,{action:Tp(e),result:Mp(i),id:e.action_id,order:i.trade_order?i.trade_order.toString():"",code:i.retcode,log:a}),yc(this,fn).trigger(6,a)})),bc(this,fn,t),bc(this,bn,e),bc(this,vn,i),bc(this,wn,s),bc(this,kn,r),bc(this,Tn,a),bc(this,Mn,o),bc(this,Sn,n),yc(this,bn).on(yc(this,zn))}destroy(){yc(this,bn).off(yc(this,zn))}}fn=new WeakMap,bn=new WeakMap,vn=new WeakMap,wn=new WeakMap,kn=new WeakMap,Tn=new WeakMap,Mn=new WeakMap,Sn=new WeakMap,zn=new WeakMap;class qp{constructor(t,e,i,s,r,a,o,n){this.controller=new Dp(t,new Np(e),i,s,r,a,o,n)}}const Fp=[{propType:6},{propType:11,propLength:512},{propType:11,propLength:512},{propType:6},{propType:12,propLength:256}],Rp=Ec.getSeriesSize(Fp);function Vp(t,e){const i=Ec.parse(t,Fp,e);return[i[0],i[1],i[2]]}class Up extends Rc{async loadCorporateLinks(){return function(t){const e=[],i=new DataView(t).getUint32(0,!0);let s=4;for(let r=0;r<i;r++)e.push(Vp(t,s)),s+=Rp;return e}((await this.socket.sendCommand(44)).resBody)}}class Hp{constructor(t,e){fc(this,Bn),fc(this,Cn),bc(this,Cn,t),bc(this,Bn,e)}async getLinks(){if(yc(this,Cn).links)return yc(this,Cn).links;const t=await yc(this,Bn).loadCorporateLinks();return yc(this,Cn).links=t,[...yc(this,Cn).links]}}Bn=new WeakMap,Cn=new WeakMap;class Xp{constructor(){this.links=null}}class jp{constructor(t){fc(this,Wn),bc(this,Wn,t)}async getLinks(){return yc(this,Wn).getLinks()}}Wn=new WeakMap;class Gp{constructor(t){fc(this,In,new Xp),fc(this,Ln),bc(this,Ln,new Up(t)),this.controller=new Hp(yc(this,In),yc(this,Ln)),this.view=new jp(this.controller)}}function Yp(t){var e;let i="",r=null;t.password&&(320===(null==(e=t.password)?void 0:e.length)?r=s.hexToBuffer(t.password):i=t.password.substring(0,32));const a=[[6,5],[18,BigInt(t.login??0)],[11,i,64],[11,(t.otp||"").substring(0,64),128],[11,(t.otp_secret||"").substring(0,64),128],[11,(t.otp_secret_check||"").substring(0,64),128],[12,qc(),16]];return r&&a.push([12,r]),Ec.serialize(a)}async function Kp(t,e,i,s,r){await async function(t){const e=new Cc(Jc,{count:1});await e.connectToServer(`wss://${location.host}/terminal`);try{await e.sendCommand(43,Yp(t)),e.close()}catch(i){throw i}}({server:t,login:e,password:i,otp_secret:s,otp_secret_check:r})}async function Jp(t,e,i,s){try{return await async function(t){const e=new Cc(Jc,{count:1});await e.connectToServer(`wss://${location.host}/terminal`);try{await e.sendCommand(43,Yp(t)),e.close()}catch(i){throw i}}({server:t,login:e,password:i,otp:s}),!0}catch{return!1}}In=new WeakMap,Ln=new WeakMap;class Zp{constructor(t,e){fc(this,On),fc(this,xn),bc(this,On,t),bc(this,xn,e)}getCommissions(t){const e=yc(this,On).getAccount().commissions,i=yc(this,xn).getFullSymbolByName(t);if(i)return e.filter((t=>!(t.isAgent()||!mh.check(t.path,i.trade.symbol_path))))}}On=new WeakMap,xn=new WeakMap;class Qp{constructor(t){fc(this,An),bc(this,An,t)}getCommissions(t){const e=yc(this,An).getCommissions(t);return e?e.map((t=>({path:t.path,mode:t.mode,modeRange:t.mode_range,modeCharge:t.mode_charge,modeCurrency:t.mode_currency,modeEntry:t.mode_entry,tiers:t.tiers.map((t=>({mode:t.mode,type:t.type,value:t.value,rangeFrom:t.range_from,rangeTo:t.range_to,minimal:t.minimal,maximal:t.maximal,currency:t.currency})))}))):[]}}An=new WeakMap;class tm{constructor(t,e){this.controller=new Zp(t,e),this.view=new Qp(this.controller)}}Pn=new WeakMap,En=new WeakMap,$n=new WeakMap,Nn=new WeakMap,Dn=new WeakMap,qn=new WeakMap,Fn=new WeakMap,Rn=new WeakMap,Vn=new WeakMap,Un=new WeakMap,Hn=new WeakMap,Xn=new WeakMap,jn=new WeakMap,Gn=new WeakMap,Yn=new WeakMap,Kn=new WeakMap,Jn=new WeakMap,Zn=new WeakMap,Qn=new WeakMap,tc=new WeakMap,ec=new WeakMap,ic=new WeakMap,sc=new WeakMap,rc=new WeakMap;let em=class t{constructor(t,e,i,s,r){fc(this,Pn),fc(this,En),fc(this,$n),fc(this,Nn),fc(this,Dn),fc(this,qn),fc(this,Fn),fc(this,Rn),fc(this,Vn),fc(this,Un),fc(this,Hn),fc(this,Xn),fc(this,jn),fc(this,Gn),fc(this,Yn),fc(this,Kn),fc(this,Jn),fc(this,Zn),fc(this,Qn),fc(this,tc),fc(this,ec),fc(this,ic),fc(this,sc),fc(this,rc),this.destroy=()=>{yc(this,En).controller.destroy(),yc(this,$n).controller.destroy(),yc(this,Dn).controller.destroy(),yc(this,Fn).controller.destroy(),yc(this,Rn).controller.destroy(),yc(this,Xn).controller.destroy(),yc(this,jn).controller.destroy(),yc(this,Gn).controller.destroy(),yc(this,Kn).controller.destroy(),yc(this,Zn).controller.destroy(),yc(this,Qn).controller.destroy()},bc(this,ic,(()=>{})),bc(this,sc,(()=>{})),bc(this,rc,(()=>{})),bc(this,Pn,t),bc(this,En,i),yc(this,Pn).on(15,yc(this,ic)),yc(this,Pn).on(11,yc(this,rc)),bc(this,$n,s),bc(this,Nn,new Ll(e)),bc(this,Dn,new ql(e)),bc(this,tc,new Gp(e)),bc(this,Fn,new Fh(yc(this,Pn),e,yc(this,Dn).controller,yc(this,$n).controller)),bc(this,ec,new tm(yc(this,$n).controller,yc(this,Fn).controller)),bc(this,qn,new rh(e,yc(this,Fn).controller)),bc(this,Rn,new l_(yc(this,Pn),e,yc(this,Fn).controller,yc(this,qn).controller)),bc(this,Vn,new __(yc(this,Fn).controller,yc(this,Rn).controller)),bc(this,Un,new ud(yc(this,Fn).controller,yc(this,Rn).controller,yc(this,Vn).controller,yc(this,qn).controller,yc(this,$n).controller)),bc(this,Hn,new fd(e)),bc(this,Xn,new lu(e,yc(this,$n).controller)),bc(this,jn,new Su(yc(this,Pn),e,yc(this,Rn).controller,yc(this,Fn).controller,yc(this,$n).controller,yc(this,Vn).controller,yc(this,Un).controller)),bc(this,Gn,new Vu(yc(this,Pn),e,yc(this,Fn).controller,yc(this,jn).controller)),bc(this,Yn,new Hu(yc(this,Pn),yc(this,Un).controller,yc(this,$n).controller,yc(this,jn).controller,yc(this,Xn).controller)),bc(this,Kn,new rp(yc(this,Pn),e,yc(this,$n).controller,yc(this,Rn).controller,yc(this,Yn).controller,yc(this,Xn).controller,yc(this,jn).controller)),bc(this,Jn,new mp(yc(this,$n).controller,yc(this,Fn).controller,yc(this,Rn).controller,yc(this,jn).controller)),bc(this,Zn,new xp(yc(this,Pn),e,yc(this,En).controller,yc(this,$n).controller,yc(this,Fn).controller,yc(this,jn).controller,yc(this,Xn).controller,yc(this,Jn).controller,r)),bc(this,Qn,new qp(yc(this,Pn),e,yc(this,$n).controller,yc(this,Fn).controller,yc(this,Zn).controller,yc(this,jn).controller,yc(this,Xn).controller,r))}async init(){yc(this,$n).controller.getAccount().isResetPass()||(await yc(this,Dn).controller.init(),await yc(this,Fn).controller.init(),await yc(this,jn).controller.init(),yc(this,Yn).controller.init())}static async createApi(e,i,s,r,a){const o=await Bl.createModule(e,i,r),n=new t(e,i,s,o,a);return await n.init(),{destroy:n.destroy,login:yc(n,En).view,account:yc(n,$n).view,notify:yc(n,Nn).view,symbols:yc(n,Fn).view,symbolTypes:yc(n,Dn).view,corporateLinks:yc(n,tc).view,rates:yc(n,Hn).ratesView,otp:{connect:Kp,disconnect:Jp},ticks:yc(n,Rn).view,history:yc(n,Xn).view,books:yc(n,Gn).view,trade:yc(n,jn).view,request:yc(n,Zn).view,margin:yc(n,Un).view,commissions:yc(n,ec).view,on:e.on.bind(e),off:e.off.bind(e)}}};Dc();let im=0;function sm(t){t.trigger(10)}function rm(t,e,i){t.trigger(11,{event:{count:i.count,event:i.event,token:i.token},login:e})}function am(t,e){t.trigger(15,e)}function om(t){const e=[t.mt_firstName||"",t.mt_secondName||""].join(" "),i=new URLSearchParams(window.self.location.search),s=i.get("utm_campaign")??"",r=i.get("utm_source")??"";return Ec.serialize([[11,e.substring(0,128),256],[11,t.mt_group.substring(0,64),128],[11,(t.mt_phonePassword||"").substring(0,32),64],[11,(t.mt_country||"").substring(0,32),64],[11,(t.mt_city||"").substring(0,32),64],[11,(t.mt_state||"").substring(0,32),64],[11,(t.mt_zipcode||"").substring(0,16),32],[11,(t.mt_address||"").substring(0,128),256],[11,(t.mt_phone||"").substring(0,32),64],[11,(t.mt_email||"").substring(0,64),128],[8,t.mt_deposit||1e5],[6,t.mt_leverage||100],[6,0],[6,1],[11,(t.mt_domain||"").substring(0,64),128],[11,s.substring(0,32),64],[11,r.substring(0,32),64],[6,t.mt_emailConfirmCode||0],[6,t.mt_phoneConfirmCode||0],[11,(t.mt_firstName||"").substring(0,64),128],[11,(t.mt_secondName||"").substring(0,64),128],[6,t.mt_agreements||0]])}function nm(t){return Ec.serialize([[6,t.version||0],[11,(t.password||"").substring(0,32),64],[11,(t.otp||"").substring(0,64),128],[12,t.cid||qc(),16],[11,"",64],[11,"",64],[18,BigInt(0)],[11,"",128],[6,0],[11,"",256],[18,BigInt(0)]])}class cm{constructor(){fc(this,ac),this.count=0,this.init=this.init.bind(this),this.closeConnection=this.closeConnection.bind(this),this.traderParams=this.traderParams.bind(this)}async init(){var t;const e=nm({});(null==(t=this.socket)?void 0:t.isReady)||(this.count+=1,this.socket=new Cc(Jc,{count:this.count}),await this.socket.connectToServer(`wss://${location.host}/terminal`),await this.socket.sendCommand(29,e))}closeConnection(){var t;(null==(t=this.socket)?void 0:t.isReady)&&this.socket.close()}traderParams(){if(!this.socket||!this.socket.isReady)throw new Error(JSON.stringify([-1,103]));return vc(this,ac,oc).call(this)}}ac=new WeakSet,oc=async function(){return t=(await this.socket.sendCommand(41)).resBody,Ec.parse(t,[{propType:11,propLength:32},{propType:11,propLength:32}]);var t};const lm=new class{constructor(){this.controller=new cm}},hm={init:lm.controller.init,close:lm.controller.closeConnection,traderParams:lm.controller.traderParams},_m=[{propType:6},{propType:17},{propType:11,propLength:32},{propType:11,propLength:32}];function dm(t){const e=Ec.parse(t,_m);return[e[0],e[1].toString(),e[2],e[3]]}const um=[{propType:4},{propType:4}];function pm(t){return Ec.parse(t,um)}const mm=Object.freeze(Object.defineProperty({__proto__:null,parseAccount:dm,parseVerify:pm},Symbol.toStringTag,{value:"Module"}));class gm{constructor(){fc(this,nc),this.count=0,this.init=this.init.bind(this),this.demo=this.demo.bind(this),this.closeConnection=this.closeConnection.bind(this),this.getVerifyCodes=this.getVerifyCodes.bind(this),this.sendVerifyCodes=this.sendVerifyCodes.bind(this)}async init(){var t;const e=nm({});(null==(t=this.socket)?void 0:t.isReady)||(this.count+=1,this.socket=new Cc(Jc,{count:this.count}),await this.socket.connectToServer(`wss://${location.host}/terminal`),await this.socket.sendCommand(29,e))}closeConnection(){var t;(null==(t=this.socket)?void 0:t.isReady)&&this.socket.close()}demo(t){if(!this.socket||!this.socket.isReady)throw new Error(JSON.stringify([-1,103]));return this.request=vc(this,nc,cc).call(this,{mt_firstName:t.mt_firstName,mt_secondName:t.mt_secondName,mt_email:t.mt_email,mt_deposit:t.mt_deposit,mt_leverage:t.mt_leverage,mt_group:t.mt_group,mt_agreements:t.mt_agreements,mt_language:t.mt_language,mt_phonePassword:t.mt_phonePassword,mt_country:t.mt_country,mt_city:t.mt_city,mt_state:t.mt_state,mt_zipcode:t.mt_zipcode,mt_address:t.mt_address,mt_phone:t.mt_phone,mt_emailConfirmCode:t.mt_emailConfirmCode,mt_phoneConfirmCode:t.mt_phoneConfirmCode,mt_domain:t.mt_domain,mt_utmCampaign:t.mt_utmCampaign,mt_utmSource:t.mt_utmSource}),this.request}getVerifyCodes(t,e){if(!this.socket||!this.socket.isReady)throw new Error(JSON.stringify([-1,103]));return vc(this,nc,lc).call(this,t,e)}async sendVerifyCodes(t,e,i){if(!this.socket||!this.socket.isReady)try{await this.init(),await this.getVerifyCodes(t,i)}catch(s){throw new Error(JSON.stringify([-1,103]))}return vc(this,nc,hc).call(this,t)}}nc=new WeakSet,cc=async function(t){return{account:dm((await this.socket.sendCommand(30,om(t))).resBody)}},lc=async function(t,e){const i=await this.socket.sendCommand(27,function(t,e){return Ec.serialize([[2,e],[12,qc(),16],[12,om(t)]])}(t,e));return{verify:pm(i.resBody)}},hc=async function(t){return{verify:pm((await this.socket.sendCommand(40,om(t))).resBody)}};const ym=new class{constructor(){this.controller=new gm}},fm={init:ym.controller.init,close:ym.controller.closeConnection,open:ym.controller.demo,getVerifyCodes:ym.controller.getVerifyCodes,sendVerifyCodes:ym.controller.sendVerifyCodes};function bm(t=[]){return t.map((t=>{var e;return[12,Ec.serialize([[6,t.mt_dataType],[6,t.mt_documentType],[11,t.mt_frontName,520],[6,t.mt_frontBuffer.byteLength],[11,t.mt_backName??"",520],[6,(null==(e=t.mt_backBuffer)?void 0:e.byteLength)??0],[12,t.mt_frontBuffer],[12,t.mt_backBuffer??new ArrayBuffer(0)]])]}))}class vm{constructor(){fc(this,_c),this.count=0,this.init=this.init.bind(this),this.real=this.real.bind(this),this.closeConnection=this.closeConnection.bind(this),this.getVerifyCodes=this.getVerifyCodes.bind(this),this.sendVerifyCodes=this.sendVerifyCodes.bind(this)}async init(){var t;const e=nm({});(null==(t=this.socket)?void 0:t.isReady)||(this.count+=1,this.socket=new Cc(Jc,{count:this.count}),await this.socket.connectToServer(`wss://${location.host}/terminal`),await this.socket.sendCommand(29,e))}async closeConnection(){var t;(null==(t=this.socket)?void 0:t.isReady)&&await this.socket.close()}real(t){if(!this.socket||!this.socket.isReady)throw new Error(JSON.stringify([-1,103]));return vc(this,_c,dc).call(this,t)}getVerifyCodes(t,e){if(!this.socket||!this.socket.isReady)throw new Error(JSON.stringify([-1,103]));return vc(this,_c,uc).call(this,t,e)}async sendVerifyCodes(t,e,i){if(!this.socket||!this.socket.isReady)try{await this.init(),await this.getVerifyCodes(t,i)}catch(s){throw new Error(JSON.stringify([-1,103]))}return vc(this,_c,pc).call(this,t)}}_c=new WeakSet,dc=async function(t){const e=Promise.resolve().then((()=>mm)),i=this.socket.sendCommand(39,function(t){const e=om(t),i=Ec.serialize([[11,t.mt_firstName,128],[11,t.mt_secondName,128],[11,t.mt_middleName??"",128],[9,t.mt_birthDate],[6,t.mt_gender??0],[11,t.mt_language,128],[11,t.mt_citizenship,64],[11,t.mt_taxId,128],[6,t.mt_employment||0],[6,t.mt_industry||0],[6,t.mt_education||0],[6,t.mt_wealth||0],[18,BigInt(t.mt_annualIncome)],[18,BigInt(t.mt_netWorth)],[18,BigInt(t.mt_annualDeposit)],[6,t.mt_experienceFx||0],[6,t.mt_experienceCfd||0],[6,t.mt_experienceFutures||0],[6,t.mt_experienceStocks||0],[12,Ec.serialize(new Array(128).fill(0).map((()=>[3,0]))),512],...bm(t.mt_documents)]);if(null!==e&&null!==i){const t=new Uint8Array(e.byteLength+i.byteLength);return t.set(new Uint8Array(e),0),t.set(new Uint8Array(i),e.byteLength),t}return null}(t)),[{parseAccount:s},r]=await Promise.all([e,i]);return{account:s(r.resBody)}},uc=async function(t,e){const i=Promise.resolve().then((()=>mm)),s=this.socket.sendCommand(27,function(t,e){return Ec.serialize([[2,e],[12,qc(),16],[12,om(t)]])}(t,e)),[{parseVerify:r},a]=await Promise.all([i,s]);return{verify:r(a.resBody)}},pc=async function(t){const e=Promise.resolve().then((()=>mm)),i=await this.socket.sendCommand(40,om(t)),[{parseVerify:s},r]=await Promise.all([e,i]);return{verify:s(r.resBody)}};const wm=new class{constructor(){this.controller=new vm}},km={demo:fm,real:{init:wm.controller.init,close:wm.controller.closeConnection,open:wm.controller.real,getVerifyCodes:wm.controller.getVerifyCodes,sendVerifyCodes:wm.controller.sendVerifyCodes},config:hm,login:async function(t,e,i,s,r,a,o,n,c){return await Dc(),async function(){im+=1;const t=new Cc(Jc,{count:im,token:c});return await t.connectToServer(`wss://${location.host}/terminal`),async function(){const i=new Lc;t.subscribe(Tc,rm.bind(null,i,e)),t.subscribe(Sc,sm.bind(null,i)),t.subscribe(Mc,am.bind(null,i));const c=new Kc(i,t),[l,h]=await c.controller.login(e,s,r,a,n),_=await async function(t,e,i,s,r,a){return await em.createApi(e,i,s,r,a)}(0,i,t,c,e,o);return[l,h||BigInt(0),_]}}},connectOtp:async function(t,e,i,s,r){await Kp(t,e,i,s,r)},utils:{trade:{printError:wp,isLoadingCode:function(t){return void 0!==t&&[0,10001,10002,10003,10005].includes(t)},isSuccessCode:function(t){return void 0!==t&&[10009,10010,11001,10008].includes(t)}},volume:{toDouble:yh},order:{isBuy:O_,isSell:x_,isMarket:A_,isPending:P_,isLimit:E_,isStop:$_,isStopLimit:N_,printType:D_,printTypeShort:function(t){switch(t){case 0:return"B";case 1:return"S";case 2:return"BL";case 3:return"SL";case 4:return"BS";case 5:return"SS";case 6:return"BSL";case 7:return"SSL";case 8:return"CB";default:return"unknown"}},printOrderStatus:function(t){switch(t){case 0:return"Started";case 1:return"Placed";case 2:return"Canceled";case 3:return"Partial";case 4:return"Filled";case 5:return"Rejected";case 6:return"Expired";case 7:return"Request adding";case 8:return"Request modifying";case 9:return"Request cancelling";default:return"unknown"}}},deal:{printAction:q_,isBuy:F_,isSell:R_,isBalance:V_,isBalanceAllowed:U_},books:{printBookActionType:function(t){switch(t){case 1:return"BL";case 2:return"BS";case 3:return"SL";case 4:return"ST";case 5:return"sl";case 6:return"tp";default:return"unknown"}}},symbol:{printCalcMode:function(t){switch(t){case 0:return"Forex";case 1:return"Futures";case 2:return"CFD";case 3:return"CFD Index";case 4:return"CFD Leverage";case 5:return"Forex No Leverage";case 32:return"Exchange Stocks";case 33:return"Exchange Futures";case 34:return"FORTS Futures";case 35:return"Exchange Option";case 36:return"Exchange Margin Option";case 37:return"Exchange Bonds";case 38:return"Exchange MOEX Stocks";case 39:return"Exchange MOEX Bonds";case 64:return"Collateral";default:return""}},printTradeMode:function(t){switch(t){case 0:return"Disabled";case 1:return"Long only";case 2:return"Short only";case 3:return"Close only";case 4:return"Full access";default:return""}}}}};window.__api=km,e.apiModule=km,e.default=km,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}({},r,s,0,a,0,e);const o=window.__api;delete window.__api;export{o as default};
