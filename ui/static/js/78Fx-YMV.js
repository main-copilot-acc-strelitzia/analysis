var t,e,s,i,r,o,n,h,a,l,c,d,u,p,y,g,m,b,S,w,f,k,v,M,T,P,L,O,x,C,W,B,E,_,D,H,q,A,j,N,R,F,I,$,V,U,z,Q,Y,G,X,J,K,Z,tt,et,st,it,rt,ot,nt,ht,at,lt,ct,dt,ut,pt,yt,gt,mt,bt,St,wt,ft,kt,vt,Mt,Tt,Pt,Lt,Ot,xt,Ct,Wt,Bt,Et,_t,Dt,Ht,qt,At,jt,Nt,Rt,Ft,It,$t,Vt,Ut,zt,Qt,Yt,Gt,Xt,Jt,Kt,Zt,te,ee,se,ie,re,oe,ne,he,ae,le,ce,de,ue,pe,ye,ge,me,be,Se,we,fe,ke,ve,Me,Te,Pe,Le,Oe,xe,Ce,We,Be,Ee,_e,De,He,qe,Ae,je,Ne,Re,Fe,Ie,$e,Ve,Ue,ze,Qe,Ye,Ge,Xe,Je,Ke,Ze,ts,es,ss,is,rs,os,ns,hs,as,ls,cs,ds,us,ps,ys,gs,ms,bs,Ss,ws,fs,ks,vs,Ms,Ts,Ps,Ls,Os,xs,Cs,Ws,Bs,Es,_s,Ds,Hs,qs,As,js,Ns,Rs,Fs,Is,$s,Vs,Us,zs,Qs,Ys,Gs,Xs,Js,Ks,Zs,ti,ei,si,ii,ri,oi,ni,hi,ai,li,ci,di,ui,pi,yi,gi,mi,bi,Si,wi,fi,ki,vi,Mi,Ti,Pi,Li,Oi,xi,Ci,Wi,Bi,Ei,_i,Di,Hi,qi,Ai,ji,Ni,Ri,Fi,Ii,$i,Vi,Ui,zi,Qi=t=>{throw TypeError(t)},Yi=(t,e,s)=>e.has(t)||Qi("Cannot "+s),Gi=(t,e,s)=>(Yi(t,e,"read from private field"),s?s.call(t):e.get(t)),Xi=(t,e,s)=>e.has(t)?Qi("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(t):e.set(t,s),Ji=(t,e,s,i)=>(Yi(t,e,"write to private field"),i?i.call(t,s):e.set(t,s),s),Ki=(t,e,s)=>(Yi(t,e,"access private method"),s);import{ag as Zi,R as tr,ah as er}from"./d_ed_6Ut.js";import{S as sr,B as ir,a7 as rr,a8 as or,a9 as nr,aa as hr,ab as ar,J as lr,h as cr,ac as dr,p as ur,_ as pr,ad as yr,ae as gr}from"./HcGwWu0z.js";import{G as mr,c as br,S as Sr,D as wr}from"./CQ67ee1G.js";import{c as fr,n as kr}from"./BAEQURWy.js";import{B as vr,a as Mr,f as Tr,g as Pr,t as Lr,b as Or}from"./B6FSvflP.js";import{i as xr,H as Cr,O as Wr}from"./BtviGlP5.js";import{h as Br,f as Er,B as _r,u as Dr}from"./Bp5cWvCe.js";class Hr{constructor(i,r,o){Xi(this,t),Xi(this,e),Xi(this,s,(()=>{const s=Gi(this,t).account.getAccount(),i=Gi(this,e).usersStore.getCurrentUser();this.accountStore.updateAccount(s,null==i?void 0:i.id),Gi(this,e).updateCurrentUser(this.accountStore)})),Ji(this,t,i),this.accountStore=r,Ji(this,e,o),this.init()}checkPassword(e){return Gi(this,t).account.checkPassword(e)}init(){Gi(this,t).on(13,Gi(this,s)),Gi(this,t).on(14,Gi(this,s)),Gi(this,t).on(3,Gi(this,s)),Gi(this,s).call(this)}update(){Gi(this,s).call(this)}destroy(){var e,i,r;null==(e=Gi(this,t))||e.off(13,Gi(this,s)),null==(i=Gi(this,t))||i.off(14,Gi(this,s)),null==(r=Gi(this,t))||r.off(3,Gi(this,s)),this.accountStore.reset()}allowedTradeForAccount(){return!this.accountStore.isInvestor&&!this.accountStore.isTradeDisabled&&!this.accountStore.isReadOnly()}getNowServerTime(){const t=Math.floor(this.accountStore.serverOffsetTime/3600),e=this.accountStore.serverOffsetTime%3600,s=new Date;return s.setHours(s.getUTCHours()+t),s.setMinutes(s.getUTCMinutes()+e),s.getTime()}changePassword(e,s,i){return Gi(this,t).login.changePassword(e,s,i)}logout(){return Gi(this,t).login.logout()}async disconnectOtp(e,s,i,r){return Gi(this,t).otp.disconnect(e,s,i,r)}}t=new WeakMap,e=new WeakMap,s=new WeakMap;var qr=Object.defineProperty,Ar=Object.getOwnPropertyDescriptor,jr=(t,e,s,i)=>{for(var r,o=Ar(e,s),n=t.length-1;n>=0;n--)(r=t[n])&&(o=r(e,s,o)||o);return o&&qr(e,s,o),o};class Nr extends sr{constructor(){super(),this._systemName="account",this.inited=!1,this.assets=0,this.balance=0,this.collateral=0,this.commission=0,this.company="",this.credit=0,this.currency="",this.dayLightMode=0,this.digits=0,this.equity=0,this.floating=0,this.liabilities=0,this.margin=0,this.marginFree=0,this.marginInitial=0,this.marginLeverage=0,this.marginLevel=0,this.marginMaintenance=0,this.name="",this.profit=0,this.serverBuild=0,this.serverName="",this.storage=0,this.timezoneShift=0,this.type=void 0,this.isReal=!1,this.isDemo=!1,this.isContest=!1,this.isPreliminary=!1,this.group="",this.login=0,this.isInvestor=!1,this.isTradeDisabled=!1,this.readOnly=!1,this.isResetPass=!1,this.isHedgedMargin=!1,this.passwordMin=8,this.serverOffsetTime=0,this.riskWarning=0,this.otpStatus=0}setInit(t){this.inited=t}changeRiskWarning(t){this.riskWarning=t}isReadOnly(){return this.readOnly||[3,1].includes(this.riskWarning)}updateAccount(t,e){this.assets=t.assets,this.balance=t.balance,this.collateral=t.collateral,this.commission=t.commission,this.company=t.company,this.credit=t.credit,this.currency=t.currency,this.dayLightMode=t.dayLightMode,this.digits=t.digits,this.equity=t.equity,this.floating=t.floating,this.liabilities=t.liabilities,this.margin=t.margin,this.marginFree=t.marginFree,this.marginInitial=t.marginInitial,this.marginLeverage=t.marginLeverage,this.marginLevel=t.marginLevel,this.marginMaintenance=t.marginMaintenance,this.name=t.name,this.profit=t.profit,this.serverBuild=t.serverBuild,this.serverName=t.serverName,this.storage=t.storage,this.timezoneShift=t.timezoneShift,this.type=t.type,this.isReal=t.isReal,this.isDemo=t.isDemo,this.isContest=t.isContest,this.isPreliminary=t.isPreliminary,this.login=t.login,this.isInvestor=t.isInvestor,this.isTradeDisabled=t.isTradeDisabled,this.readOnly=t.isReadOnly,this.isHedgedMargin=t.isHedgedMargin,this.isResetPass=t.isResetPass,this.passwordMin=t.passwordMin,this.serverOffsetTime!==t.serverOffsetTime&&(this.serverOffsetTime=t.serverOffsetTime),t.riskWarning&&e&&(null!==sessionStorage.getItem(e)?this.riskWarning=2:this.riskWarning=1),this.otpStatus=t.otpStatus}reset(){this.assets=0,this.balance=0,this.collateral=0,this.commission=0,this.company="",this.credit=0,this.currency="",this.dayLightMode=0,this.digits=0,this.equity=0,this.floating=0,this.liabilities=0,this.margin=0,this.marginFree=0,this.marginInitial=0,this.marginLeverage=0,this.marginLevel=0,this.marginMaintenance=0,this.name="",this.profit=0,this.serverBuild=0,this.serverName="",this.storage=0,this.timezoneShift=0,this.type=void 0,this.isReal=!1,this.isDemo=!1,this.isContest=!1,this.isPreliminary=!1,this.login=0,this.isInvestor=!1,this.isTradeDisabled=!1,this.readOnly=!1,this.isHedgedMargin=!1,this.isResetPass=!1,this.passwordMin=8,this.serverOffsetTime=0,this.riskWarning=0,this.otpStatus=1}}jr([ir],Nr.prototype,"setInit"),jr([ir],Nr.prototype,"changeRiskWarning"),jr([ir],Nr.prototype,"updateAccount"),jr([ir],Nr.prototype,"reset");class Rr{constructor(t,e){this.accountStore=new Nr,this.accountController=new Hr(t,this.accountStore,e)}}class Fr{constructor(t,e){Xi(this,i),Xi(this,r,(t=>{this.booksStore.setBook(t)})),Ji(this,i,t),this.booksStore=e,this.init()}init(){this.booksStore.reset(),Gi(this,i).on(8,Gi(this,r))}destroy(){Gi(this,i).off(8,Gi(this,r)),this.booksStore.reset()}setSpreadSize(t){Gi(this,i).books.setSpreadSize(t)}sign(t){t?Gi(this,i).books.signBooks(t):this.unSign()}unSign(){Gi(this,i).books.signBooks()}}i=new WeakMap,r=new WeakMap;var Ir=Object.defineProperty,$r=Object.getOwnPropertyDescriptor;class Vr extends sr{constructor(t){super(),this._systemName="BookStore",this.digits=5,this.books=[],this.extendedBooks=[],this.symbol=t.symbol,this.books=t.books?[...t.books]:[],this.extendedBooks=t.extendedBooks?[...t.extendedBooks]:[],this.digits=t.digits?t.digits:this.digits,this._systemName=`tick ${this.symbol}`}setBook(t){return this.books=t.books?[...t.books]:this.books,this.extendedBooks=t.extendedBooks?[...t.extendedBooks]:this.books,this.digits=t.digits??this.digits,this}}((t,e,s)=>{for(var i,r=$r(e,s),o=t.length-1;o>=0;o--)(i=t[o])&&(r=i(e,s,r)||r);r&&Ir(e,s,r)})([ir],Vr.prototype,"setBook");class Ur{constructor(){this.data={}}reset(){this.data={}}getBook(t){return this.data[t]||(this.data[t]=new Vr({symbol:t})),this.data[t]}setBook(t){return t.map((t=>(this.data[t.symbol]||(this.data[t.symbol]=new Vr(t)),this.data[t.symbol].setBook(t),this.data[t.symbol])))}}class zr{constructor(t){this.booksStore=new Ur,this.booksController=new Fr(t,this.booksStore)}}class Qr{constructor(t,e,s){Xi(this,o),Xi(this,n),Xi(this,h,(t=>{Gi(this,o).symbols.getMany(t).then((t=>{this.symbolsStore.addSymbols(t)}))})),Ji(this,o,t),this.symbolsStore=e,Ji(this,n,s),this.init(),Gi(this,o).on(17,Gi(this,h))}init(){const t=Gi(this,o).symbols.all();this.symbolsStore.reset(t)}getLeverageBySymbol(t){return Gi(this,o).margin.getLeveragesBySymbol(window.lang.trade.margin.rangeMode,t)}allowedTradeBySymbol(t){if(!Gi(this,n).allowedTradeForAccount())return!1;let e=null;return"string"!=typeof t&&null!==t?e=t:t&&(e=this.symbolsStore.getBySymbol(t)),!(!e||!e.isTradeEnabled||e.isCollateral)}getAll(){const t=Gi(this,o).symbols.all();this.symbolsStore.setAll(t)}getBySymbol(t){return this.symbolsStore.getBySymbol(t)}getBranch(t=""){return Gi(this,o).symbolTypes.getBranch(t)}getConfigBySymbol(t){return this.symbolsStore.getBySymbol(t)}async loadFullSymbols(t){const e=await Gi(this,o).symbols.getMany(t);e.length&&this.symbolsStore.addSymbols(e)}getCommissions(t){return Gi(this,o).commissions.getCommissions(t)}}o=new WeakMap,n=new WeakMap,h=new WeakMap;var Yr=Object.defineProperty,Gr=Object.getOwnPropertyDescriptor,Xr=(t,e,s,i)=>{for(var r,o=Gr(e,s),n=t.length-1;n>=0;n--)(r=t[n])&&(o=r(e,s,o)||o);return o&&Yr(e,s,o),o};class Jr extends sr{constructor(){super(),Xi(this,c),Xi(this,a),Xi(this,l),this._systemName="symbols",Ji(this,a,[]),Ji(this,l,{symbol:{},index:{},category:{}})}isEmpty(){return Boolean(Gi(this,a).length)}getFirst(){return Gi(this,a)[0]}reset(t=[]){return Ji(this,a,t),Ki(this,c,d).call(this),this}setAll(t=[]){return Ji(this,a,t),Ki(this,c,d).call(this),this}getAll(){return[...Gi(this,a)]}addSymbols(t){let e=!1;return t.forEach((t=>{const s=Gi(this,l).index[t.symbol.toLowerCase()];if("number"==typeof s){Gi(this,a)[s]=t,Gi(this,l).symbol[t.symbol.toLowerCase()]=t,Gi(this,l).category[t.pathCategory]=Gi(this,l).category[t.pathCategory]||[];const e=Gi(this,l).category[t.pathCategory].findIndex((e=>e.symbol===t.symbol));-1===e?Gi(this,l).category[t.pathCategory].push(t):Gi(this,l).category[t.pathCategory][e]=t}else Gi(this,a).push(t),e=!0})),e&&Ki(this,c,d).call(this),this}getBySymbol(t){return Gi(this,l).symbol[null==t?void 0:t.toLowerCase()]}getByCategory(t=""){return Gi(this,l).category[t]?[...Gi(this,l).category[t]]:[]}filter(t=""){return t?Gi(this,a).filter((e=>{const s=e.symbol.toLowerCase().indexOf(t.toLowerCase()),i=e.description.toLowerCase().indexOf(t.toLowerCase());return-1!==s||-1!==i})):Gi(this,a)}}a=new WeakMap,l=new WeakMap,c=new WeakSet,d=function(){return Ji(this,l,{symbol:{},index:{},category:{}}),Gi(this,a).forEach(((t,e)=>{const s=t.symbol.toLowerCase();Gi(this,l).symbol[s]=t,Gi(this,l).index[s]=e,Gi(this,l).category[t.pathCategory]=Gi(this,l).category[t.pathCategory]||[],Gi(this,l).category[t.pathCategory].push(t)})),this},Xr([ir],Jr.prototype,"reset"),Xr([ir],Jr.prototype,"setAll"),Xr([ir],Jr.prototype,"addSymbols");class Kr{constructor(t,e){this.symbolsStore=new Jr,this.symbolsController=new Qr(t,this.symbolsStore,e)}}var Zr=Object.defineProperty,to=Object.getOwnPropertyDescriptor,eo=(t,e,s,i)=>{for(var r,o=to(e,s),n=t.length-1;n>=0;n--)(r=t[n])&&(o=r(e,s,o)||o);return o&&Zr(e,s,o),o};class so extends sr{constructor(){super(),Xi(this,y),Xi(this,u),Xi(this,p),this._systemName="history-deals",Ji(this,u,{id:{},symbol:{}}),Ji(this,p,[]),this.sorts={},this.keys=Object.values(rr),this.loading=!1,this.total=null}setLoading(t){this.loading=t}dealHas(t){return"number"==typeof Gi(this,u).id[t]}reset(){Ji(this,u,{id:{},symbol:{}}),Ji(this,p,[]),this.sorts={},this.total=null}getDeals(t){return t&&Object.values(rr).includes(t)&&this.sorts[t]?[...this.sorts[t]||[]]:[...Gi(this,p)]}getDeal(t){const e=Gi(this,p)[Gi(this,u).id[t]];return e?e.value:null}getDealsPositionBySymbol(t){return Gi(this,u).symbol[t]??new Map}getDealsBySymbolAndPosition(t,e){const s=this.getDealsPositionBySymbol(t),i=null==s?void 0:s.get(e);return(null==i?void 0:i.length)?i:null}updateDeal(t){const e=Gi(this,u).id[t.id];return Gi(this,p)&&"number"==typeof e&&(Gi(this,p)[e].value=t,Gi(this,p)[e].id=t.deal),this}setDeals(t){return Ji(this,p,t.map((t=>({id:t.deal,value:t})))),Ki(this,y,g).call(this),this.keys.forEach((t=>{this.sorts[t]=function(t,e){const s=[...t];return s.sort(((t,s)=>{const i="profit"===e?t.value[e]??0:t.value[e],r="profit"===e?s.value[e]??0:s.value[e];return(i??1/0)<(r??1/0)?-1:(i??-1/0)>(r??-1/0)?1:0})),s}(Gi(this,p),t)})),this}setTotal(t){return this.total=t,this}}u=new WeakMap,p=new WeakMap,y=new WeakSet,g=function(){return Ji(this,u,{id:{},symbol:{}}),Gi(this,p).forEach(((t,e)=>{const{deal:s,symbol:i,position:r}=t.value;if(s&&(Gi(this,u).id[s]=e),Gi(this,u).symbol[i])if(Gi(this,u).symbol[i].has(r)){const e=Gi(this,u).symbol[i].get(r);null==e||e.push(t)}else Gi(this,u).symbol[i].set(r,[t]);else i&&(Gi(this,u).symbol[i]=new Map,Gi(this,u).symbol[i].set(r,[t]))})),this},eo([ir],so.prototype,"setLoading"),eo([ir],so.prototype,"reset"),eo([ir],so.prototype,"updateDeal"),eo([ir],so.prototype,"setDeals"),eo([ir],so.prototype,"setTotal");var io=Object.defineProperty,ro=Object.getOwnPropertyDescriptor,oo=(t,e,s,i)=>{for(var r,o=ro(e,s),n=t.length-1;n>=0;n--)(r=t[n])&&(o=r(e,s,o)||o);return o&&io(e,s,o),o};class no extends sr{constructor(){super(),Xi(this,S),Xi(this,m),Xi(this,b),this._systemName="orders",Ji(this,m,{}),Ji(this,b,[]),this.sorts={},this.keys=Object.values(or),this.loading=!1,this.total=null}setLoading(t){this.loading=t}orderHas(t){return"number"==typeof Gi(this,m)[t]}reset(){Ji(this,m,{}),Ji(this,b,[]),this.sorts={},this.total=null}getOrder(t){const e=Gi(this,m)[t];return"number"==typeof e&&Gi(this,b)[e]?Gi(this,b)[e]:null}getOrders(t){return t&&Object.values(or).includes(t)&&this.sorts[t]?[...this.sorts[t]||[]]:[...Gi(this,b)]}updateOrder(t){const e=Gi(this,m)[t.order];return Gi(this,b)&&"number"==typeof e&&(Gi(this,b)[e].value=t,Gi(this,b)[e].id=t.order),this}setOrders(t){return Ji(this,b,t.map((t=>({id:t.order,value:t})))),Ki(this,S,w).call(this),this.keys.forEach((t=>{this.sorts[t]=function(t,e){const s=[...t];return s.sort(((t,s)=>(t.value[e]??1/0)<(s.value[e]??1/0)?-1:(t.value[e]??-1/0)>(s.value[e]??-1/0)?1:0)),s}(Gi(this,b),t)})),this}setTotal(t){return this.total=t,this}}m=new WeakMap,b=new WeakMap,S=new WeakSet,w=function(){return Ji(this,m,{}),Gi(this,b).forEach(((t,e)=>{t.value.order&&(Gi(this,m)[t.value.order]=e)})),this},oo([ir],no.prototype,"setLoading"),oo([ir],no.prototype,"reset"),oo([ir],no.prototype,"updateOrder"),oo([ir],no.prototype,"setOrders"),oo([ir],no.prototype,"setTotal");var ho=Object.defineProperty,ao=Object.getOwnPropertyDescriptor,lo=(t,e,s,i)=>{for(var r,o=ao(e,s),n=t.length-1;n>=0;n--)(r=t[n])&&(o=r(e,s,o)||o);return o&&ho(e,s,o),o};class co extends sr{constructor(){super(),Xi(this,v),Xi(this,f),Xi(this,k),this._systemName="history-positions",Ji(this,f,{id:{},symbol:{}}),Ji(this,k,[]),this.sorts={},this.keys=Object.values(nr),this.loading=!1,this.total=null}setLoading(t){this.loading=t}positionHas(t){return"number"==typeof Gi(this,f).id[t]}reset(){Ji(this,f,{id:{},symbol:{}}),Ji(this,k,[]),this.sorts={},this.total=null}getPositions(t){return t&&Object.values(nr).includes(t)&&this.sorts[t]?[...this.sorts[t]||[]]:[...Gi(this,k)]}getPositionsBySymbol(t){return Gi(this,f).symbol[t]||[]}getPositionsBySymbolAndDate(t,e,s){const i=Gi(this,f).symbol[t];return i?i.filter((t=>{const{timeOpen:i,timeClose:r}=t.value;return!!r&&(e<=i&&s>=i||e<=r&&s>=r)})):[]}getPosition(t){const e=Gi(this,k)[Gi(this,f).id[t]];return e?e.value:null}updatePosition(t){const e=Gi(this,f).id[t.id];return Gi(this,k)&&"number"==typeof e&&(Gi(this,k)[e].value=t,Gi(this,k)[e].id=t.id),this}setPositions(t){return Ji(this,k,t.map((t=>({id:t.id,value:t})))),Ki(this,v,M).call(this),this.keys.forEach((t=>{this.sorts[t]=function(t,e){const s=[...t];return s.sort(((t,s)=>{const i="profit"===e?t.value[e]??0:t.value[e],r="profit"===e?s.value[e]??0:s.value[e];return(i??1/0)<(r??1/0)?-1:(i??-1/0)>(r??-1/0)?1:0})),s}(Gi(this,k),t)})),this}setTotal(t){return this.total=t,this}}f=new WeakMap,k=new WeakMap,v=new WeakSet,M=function(){return Ji(this,f,{id:{},symbol:{}}),Gi(this,k).forEach(((t,e)=>{const{id:s,symbol:i}=t.value;s&&(Gi(this,f).id[s]=e),Gi(this,f).symbol[i]||(Gi(this,f).symbol[i]=[]),Gi(this,f).symbol[i].push(t)})),this},lo([ir],co.prototype,"setLoading"),lo([ir],co.prototype,"reset"),lo([ir],co.prototype,"updatePosition"),lo([ir],co.prototype,"setPositions"),lo([ir],co.prototype,"setTotal");var uo=Object.defineProperty,po=Object.getOwnPropertyDescriptor,yo=(t,e,s,i)=>{for(var r,o=po(e,s),n=t.length-1;n>=0;n--)(r=t[n])&&(o=r(e,s,o)||o);return o&&uo(e,s,o),o};class go extends sr{constructor(){super(),this._systemName="history",this.prevPeriod=3,this.period=3}setPeriod(t){this.prevPeriod=this.period,this.period=t}reset(){this.period=3}}function mo(t){if(0===t)return{from:0,to:0};const e=new Date;return e.setUTCMilliseconds(0),e.setUTCSeconds(0),e.setUTCMinutes(0),e.setUTCHours(0),2===t&&e.setUTCDate(e.getUTCDate()-7),3===t&&e.setUTCMonth(e.getUTCMonth()-1),4===t&&e.setUTCMonth(e.getUTCMonth()-3),5===t&&e.setUTCMonth(e.getUTCMonth()-6),6===t&&e.setUTCFullYear(e.getUTCFullYear()-1),{from:e.getTime()/1e3,to:0}}yo([ir],go.prototype,"setPeriod"),yo([ir],go.prototype,"reset");class bo{constructor(t,e,s,i,r){Xi(this,P),Xi(this,T),Xi(this,O),this.getHistoryRequestData=mo,Ji(this,O,(()=>{Ki(this,P,W).call(this),Ki(this,P,x).call(this),Ki(this,P,C).call(this)})),Ji(this,T,t),this.historyStore=e,this.historyPositionsStore=s,this.historyOrdersStore=i,this.historyDealsStore=r}init(){this.loadHistory(3),Gi(this,O).call(this),Ki(this,P,L).call(this),this.subscribe()}destroy(){Ki(this,P,L).call(this),this.historyStore.reset(),this.historyPositionsStore.reset(),this.historyOrdersStore.reset(),this.historyDealsStore.reset(),Ki(this,P,B).call(this,!0)}subscribe(){Gi(this,T).on(1,Gi(this,O))}async loadHistory(t,e){Ki(this,P,B).call(this,!0);try{await Gi(this,T).history.load(e||mo(t)),this.setPeriod(t),Gi(this,O).call(this)}catch(s){}Ki(this,P,B).call(this,!1)}setPeriod(t){this.historyStore.setPeriod(t)}}T=new WeakMap,P=new WeakSet,L=function(){var t;null==(t=Gi(this,T))||t.off(1,Gi(this,O))},O=new WeakMap,x=function(){const{items:t,total:e}=Gi(this,T).history.positions();this.historyPositionsStore.setPositions(t),this.historyPositionsStore.setTotal(e)},C=function(){const{items:t,total:e}=Gi(this,T).history.orders();this.historyOrdersStore.setOrders(t),this.historyOrdersStore.setTotal(e)},W=function(){const{items:t,total:e}=Gi(this,T).history.deals();this.historyDealsStore.setDeals(t),this.historyDealsStore.setTotal(e)},B=function(t){this.historyDealsStore.setLoading(t),this.historyOrdersStore.setLoading(t),this.historyPositionsStore.setLoading(t)};class So{constructor(t){this.historyStore=new go,this.historyPositionsStore=new co,this.historyOrdersStore=new no,this.historyDealsStore=new so,this.historyController=new bo(t,this.historyStore,this.historyPositionsStore,this.historyOrdersStore,this.historyDealsStore)}}class wo{constructor(t,e){Xi(this,E),Xi(this,_,(t=>{this.objectsStore.editObject(t.detail.uid)})),Xi(this,D,(t=>{this.objectsStore.selectObject(t.detail.uid)})),Xi(this,H,(()=>{this.objectsStore.selectObject(void 0)})),Ji(this,E,t),this.objectsStore=e}async init(t,e){const s=await Gi(this,E).getAll("symbol",e);return t.on("207",Gi(this,_)),t.on("301",Gi(this,D)),t.on("302",Gi(this,H)),this.objectsStore.reset(s),this}destroy(t){t.off("207",Gi(this,_)),t.off("301",Gi(this,D)),t.off("302",Gi(this,H))}save(t,e){const s=t.toJSON(),i=e?{symbol:e,...s}:{...s};return this.objectsStore.add(i),Gi(this,E).add(i),this}remove(t){return this.objectsStore.removeByUid(t),Gi(this,E).remove(t),this}}E=new WeakMap,_=new WeakMap,D=new WeakMap,H=new WeakMap;class fo extends sr{constructor(){super(),Xi(this,q),this._systemName="objects",this.items=[],this.index={uid:{},index:{}}}getAll(){return this.items}reset(t=[]){return this.items=t.map((t=>{if("string"==typeof t.type){const e=String(t.type).replace(/-/g,"_"),s=Object.entries({none:0,andrews_pitchfork_channel:1,equidistant_channel:2,regression_channel:3,std_dev_channel:4,fibonacci_retracement:5,gann_fan:6,gann_grid:7,gann_line:8,arrow_line:9,cross_line:10,extended_line:11,horizontal_ray:12,horizontal_line:13,info_line:14,ray_line:15,trade_line:16,trend_angle:17,trendline:18,vertical_line:19,disjoint_angle:20,flat_top_bottom:21,shapes_rectangle:22,select_area:23,shapes_circle:24,shapes_triangle:25,shapes_ellipse:26,text:27,measure:28,trade_tp:29,trade_sl:30,trade_price:31,trade_trigger:32,ruler:33}).find((([t])=>t===e));s&&(t.type=s[1])}return t})),Ki(this,q,A).call(this),this.refresh(),this}add(t){const e=this.index.index[t.uid];return"number"==typeof e?this.items[e]=t:this.items.push(t),Ki(this,q,A).call(this),this.refresh(),this}removeByUid(t){const e=this.index.index[t];"number"==typeof e&&(this.removeByIndex(e),this.refresh())}removeByIndex(t){this.items.splice(t,1),Ki(this,q,A).call(this),this.selectObject(void 0),this.refresh()}findByUid(t){return this.index.uid[t]}editObject(t){this.editObjectId=t,this.refresh()}selectObject(t){this.selectedObjectId=t,this.refresh()}}q=new WeakSet,A=function(){return this.index={uid:{},index:{}},this.items.forEach(((t,e)=>{this.index.uid[t.uid]=t,this.index.index[t.uid]=e})),this};class ko{constructor(t){this.objectsStore=new fo,this.objectsController=new wo(t,this.objectsStore)}}class vo{constructor(t,e,s,i){Xi(this,j),Xi(this,N),Xi(this,R),Xi(this,F,(t=>{const[e,s]=t,i=Gi(this,j).ticks.getTick(e,s),r=Gi(this,N).symbolsStore.getBySymbol(e);if(r&&i&&(r.delay&&s||!r.delay&&!s)){const t=this.ticksStore.setTick(i,!0);if(!r)throw new Error(`symbol "${t.symbol}" doesn't exist`);Gi(this,R).barsStore.extends(r,t),t.refresh()}})),Ji(this,j,t),this.ticksStore=e,Ji(this,N,s),Ji(this,R,i),this.init()}init(){this.ticksStore.reset(),Gi(this,j).on(0,Gi(this,F))}destroy(){var t;null==(t=Gi(this,j))||t.off(0,Gi(this,F)),this.ticksStore.getAllSymbols().forEach((t=>this.off(t)))}on(t){this.ticksStore.getTick(t),Gi(this,j).ticks.subscribe(t)}off(t){return Gi(this,j).ticks.unSubscribe(t),this}}j=new WeakMap,N=new WeakMap,R=new WeakMap,F=new WeakMap;class Mo extends sr{constructor(t){super(),this._systemName="_tick",this.ask=0,this.askTrend=0,this.askHigh=0,this.askHighTrend=0,this.askLow=0,this.askLowTrend=0,this.askLast=0,this.askOriginal=0,this.bid=0,this.bidTrend=0,this.bidHigh=0,this.bidHighTrend=0,this.bidLow=0,this.bidLowTrend=0,this.bidLast=0,this.bidOriginal=0,this.last=0,this.change=0,this.lastHigh=0,this.lastLast=0,this.lastLow=0,this.lastTrend=0,this.spread=0,this.symbol=t,this.time=new Date,this.timeMs=new Date,this.volume=0,this.volumeTrend=0,this.isReal=!1,this.fields=0,this.volLast="",this._systemName=`tick "${this.symbol}"`,this.priceOpen=0,this.priceClose=0,this.low=0,this.high=0}setTick(t,e=!1){return this.ask=Number(t.ask),this.askOriginal=Number(t.askOriginal),this.askTrend=t.askTrend,this.askHigh=Number(t.askHigh),this.askHighTrend=t.askHighTrend,this.askLow=Number(t.askLow),this.askLowTrend=t.askLowTrend,this.askLast=Number(t.askLast),this.bid=Number(t.bid),this.bidOriginal=Number(t.bidOriginal),this.bidTrend=t.bidTrend,this.bidHigh=Number(t.bidHigh),this.bidHighTrend=t.bidHighTrend,this.bidLow=Number(t.bidLow),this.bidLowTrend=t.bidLowTrend,this.bidLast=Number(t.bidLast),this.change=t.change,this.last=Number(t.last),this.lastHigh=Number(t.lastHigh),this.lastLast=Number(t.lastLast),this.lastLow=Number(t.lastLow),this.lastTrend=t.lastTrend,this.spread=t.spread,this.symbol=t.symbol,this.time=new Date(t.time),this.timeMs=new Date(t.timeMs),this.volume=Number(t.volume),this.volumeTrend=t.volumeTrend,this.isReal=!0,this.fields=t.fields,this.volLast=t.volLast,this.priceOpen=t.priceOpen,this.priceClose=t.priceClose,this.low=t.low,this.high=t.high,this._systemName=`tick ${this.symbol}`,e||this.refresh(),this}}var To=Object.defineProperty,Po=Object.getOwnPropertyDescriptor;class Lo extends sr{constructor(){super(),Xi(this,$),Xi(this,I),this._systemName="Ticks",Ji(this,I,{})}reset(){Ji(this,I,{})}getAllSymbols(){return Object.keys(Gi(this,I))}setTick(t,e=!1){return Gi(this,I)[t.symbol]||(Gi(this,I)[t.symbol]=new Mo(t.symbol),e||this.refresh()),Gi(this,I)[t.symbol].setTick(t,e),Gi(this,I)[t.symbol]}getTick(t){return Gi(this,I)[t]?Gi(this,I)[t]:Ki(this,$,V).call(this,t)}getTicks(t){return t.map((t=>this.getTick(t)))}}I=new WeakMap,$=new WeakSet,V=function(t){return Gi(this,I)[t]||(Gi(this,I)[t]=new Mo(t),this.refresh()),Gi(this,I)[t]},((t,e,s)=>{for(var i,r=Po(e,s),o=t.length-1;o>=0;o--)(i=t[o])&&(r=i(e,s,r)||r);r&&To(e,s,r)})([ir],Lo.prototype,"reset");class Oo{constructor(t,e,s){this.ticksStore=new Lo,this.ticksController=new vo(t,this.ticksStore,e,s)}}const xo="__global";class Co{constructor(t,e){Xi(this,U),Ji(this,U,t),this.indicatorsStore=e,this.save=this.save.bind(this),this.editIndicator=this.editIndicator.bind(this)}async init(t){let e=await Gi(this,U).getAll("symbol",t);e=e.map((t=>(t.index=t.index??0,t))).sort(((t,e)=>(t.index??0)-(e.index??0))).map(((t,e)=>(t.index=e,t)));const s=t?await Gi(this,U).getAll("symbol",xo):[];this.indicatorsStore.reset([...s,...e])}destroy(){}sectionMove(t){}save(t,e){const s=t.toJSON(),i=e?{symbol:8&t.flags?xo:e,...s}:{...s};return this.indicatorsStore.add(i),Gi(this,U).add(i),this}remove(t){return this.indicatorsStore.removeByUid(t),Gi(this,U).remove(t),this}editIndicator(t){this.indicatorsStore.setEditIndicator(t)}}U=new WeakMap;class Wo extends sr{constructor(){super(),Xi(this,z),this._systemName="indicators",this.items=[],this.index={uid:{},index:{}}}getAll(){return[...this.items]}reset(t=[]){return this.items=[...t],Ki(this,z,Q).call(this),this.refresh(),this}add(t){const e=this.index.index[t.uid];return"number"==typeof e?this.items[e]=t:this.items.push(t),Ki(this,z,Q).call(this),this.refresh(),this}removeByUid(t){const e=this.index.index[t];return"number"!=typeof e||(this.items.splice(e,1),Ki(this,z,Q).call(this),this.refresh()),this}findByUid(t){return this.index.uid[t]??null}setEditIndicator(t){this.editIndicatorId=t,this.refresh()}}z=new WeakSet,Q=function(){return this.index={uid:{},index:{}},this.items.forEach(((t,e)=>{this.index.uid[t.uid]=t,this.index.index[t.uid]=e})),this};class Bo{constructor(t){this.indicatorsStore=new Wo,this.indicatorsController=new Co(t,this.indicatorsStore)}}var Eo=Object.defineProperty,_o=Object.getOwnPropertyDescriptor,Do=(t,e,s,i)=>{for(var r,o=_o(e,s),n=t.length-1;n>=0;n--)(r=t[n])&&(o=r(e,s,o)||o);return o&&Eo(e,s,o),o};const Ho=["symbol","id","sl","tp","priceClose","priceOpen","timeCreate","typeName","volumeValue","storage","profit","comment"];class qo extends sr{constructor(){super(),Xi(this,X),Xi(this,Y),Xi(this,G),this._systemName="positions",Ji(this,Y,{id:{},symbol:{}}),Ji(this,G,[]),this.sorts={},this.keys=Ho,this.direction=0,this.sortBy=""}setSort(t,e){return this.sortBy=t,this.direction=e,this}positionHas(t){return"number"==typeof Gi(this,Y).id[t]}reset(){Ji(this,Y,{id:{},symbol:{}}),Ji(this,G,[]),this.sorts={}}getSortedPositions(){if(this.sortBy&&this.direction){const t=[...this.sorts[this.sortBy]??[]];return-1===this.direction&&t.reverse(),t}const t=[...Gi(this,G)];return-1===this.direction&&t.reverse(),t}getPositions(){return[...Gi(this,G)]}getPositionsBySymbol(t){return Gi(this,Y).symbol[t]||[]}hasPositionForSymbol(t){return Boolean(Gi(this,Y).symbol[t])}getPosition(t){const e=Gi(this,G)[Gi(this,Y).id[t]];return e?e.value:null}updatePosition(t){const e=Gi(this,Y).id[t.id];return Gi(this,G)&&"number"==typeof e&&(Gi(this,G)[e].value=t),this}setPositions(t){return Ji(this,G,t.items.map((t=>({value:t})))),Ki(this,X,J).call(this),this.keys.forEach((t=>{this.sorts[t]=function(t,e){const s=[...t];return s.sort(((t,s)=>(t.value[e]??1/0)<(s.value[e]??1/0)?-1:(t.value[e]??-1/0)>(s.value[e]??-1/0)?1:0)),s}(Gi(this,G),t)})),this}}Y=new WeakMap,G=new WeakMap,X=new WeakSet,J=function(){return Ji(this,Y,{id:{},symbol:{}}),Gi(this,G).forEach(((t,e)=>{const{id:s,symbol:i}=t.value;s&&(Gi(this,Y).id[s]=e),Gi(this,Y).symbol[i]||(Gi(this,Y).symbol[i]=[]),Gi(this,Y).symbol[i].push(t)})),this},Do([ir],qo.prototype,"setSort"),Do([ir],qo.prototype,"reset"),Do([ir],qo.prototype,"updatePosition"),Do([ir],qo.prototype,"setPositions");var Ao=Object.defineProperty,jo=Object.getOwnPropertyDescriptor,No=(t,e,s,i)=>{for(var r,o=jo(e,s),n=t.length-1;n>=0;n--)(r=t[n])&&(o=r(e,s,o)||o);return o&&Ao(e,s,o),o};class Ro extends sr{constructor(){super(),this._systemName="trade",this.transactions={},this.prices={}}reset(){this.transactions={},this.prices={}}resetRequest(){this.request=void 0}resetQuickTradeRequest(){this.quickTradeRequest=void 0}setCollateral(t){this.total=t}setTransaction(t,e){return this.transactions[t]=this.transactions[t]||{},"number"==typeof e.state&&(this.transactions[t].state=e.state),"number"==typeof e.code&&(this.transactions[t].code=e.code),e.order&&(this.transactions[t].order=e.order),this}setRequest(t,e){this.requestTimeout=e,this.request=t}setQuickTradeRequest(t,e){this.quickTradeRequestTimeout=e,this.quickTradeRequest=t}clearPrices(){this.prices={}}setPrice(t,e){e?(this.prices[t]=e,this.refresh()):this.prices[t]&&(delete this.prices[t],this.refresh())}}No([ir],Ro.prototype,"resetRequest"),No([ir],Ro.prototype,"resetQuickTradeRequest"),No([ir],Ro.prototype,"setCollateral"),No([ir],Ro.prototype,"setTransaction"),No([ir],Ro.prototype,"setRequest"),No([ir],Ro.prototype,"setQuickTradeRequest"),No([ir],Ro.prototype,"clearPrices");var Fo=Object.defineProperty,Io=Object.getOwnPropertyDescriptor,$o=(t,e,s,i)=>{for(var r,o=Io(e,s),n=t.length-1;n>=0;n--)(r=t[n])&&(o=r(e,s,o)||o);return o&&Fo(e,s,o),o};const Vo=["symbol","order","sl","tp","timeSetup","price","priceCurrent","typeName","volumeValue"];class Uo extends sr{constructor(){super(),Xi(this,tt),Xi(this,K),Xi(this,Z),this._systemName="orders",Ji(this,K,{id:{},symbol:{}}),Ji(this,Z,[]),this.sorts={},this.keys=Vo,this.direction=0,this.sortBy=""}setSort(t,e){return this.sortBy=t,this.direction=e,this}orderHas(t){return"number"==typeof Gi(this,K).id[t]}reset(){Ji(this,K,{id:{},symbol:{}}),Ji(this,Z,[]),this.sorts={}}getSortedOrders(){if(this.sortBy&&this.direction){const t=[...this.sorts[this.sortBy]??[]];return-1===this.direction&&t.reverse(),t}const t=[...Gi(this,Z)];return-1===this.direction&&t.reverse(),t}getOrders(){return[...Gi(this,Z)]}getOrdersBySymbol(t){return Gi(this,K).symbol[t]||[]}getOrder(t){const e=Gi(this,Z)[Gi(this,K).id[t]];return e?e.value:null}hasOrderForSymbol(t){return Boolean(Gi(this,K).symbol[t])}updateOrder(t){const e=Gi(this,K).id[t.order];return Gi(this,Z)&&"number"==typeof e&&(Gi(this,Z)[e].value=t,Gi(this,Z)[e].id=t.order),this}setOrders(t){return Ji(this,Z,t.map((t=>({value:t,id:t.order})))),Ki(this,tt,et).call(this),this.keys.forEach((t=>{this.sorts[t]=function(t,e){const s=[...t];return s.sort(((t,s)=>(t.value[e]??1/0)<(s.value[e]??1/0)?-1:(t.value[e]??-1/0)>(s.value[e]??-1/0)?1:0)),s}(Gi(this,Z),t)})),this}}function zo(t){const{axis:e}=t;return[e.yToValue(t.height),e.yToValue(0)]}function Qo(t,e,s,i){const[r,o]=zo(e),n=t.isStop(s),h=t.isStopLimit(s);return(n||h?t.isSell(s):t.isBuy(s))?isNaN(r)?i:i+(r-i)/2:isNaN(o)?i:i+(o-i)/2}function Yo(t,e,s,i,r){const[o,n]=zo(e),h=r??Qo(t,e,s,i);return t.isBuy(s)?isNaN(o)?.75*h:h+.5*(o-h):isNaN(n)?1.25*h:h+.5*(n-h)}function Go(t,e,s,i,r){const[o,n]=zo(e),h=r??Qo(t,e,s,i);return t.isBuy(s)?isNaN(n)?1.25*h:h+.5*(n-h):isNaN(o)?.75*h:h+.5*(o-h)}function Xo(t,e,s,i,r,o){if(!e)return!0;if(t){if(e&&e>s-o)return!0;if(e&&i&&e-o<i)return!0;if(e&&r&&e+o>r)return!0}else{if(e&&e<s+o)return!0;if(e&&i&&e+o>i)return!0;if(e&&r&&e-o<r)return!0}return!1}function Jo(t,e,s,i,r,o){if(!e)return!0;if(t){if(e&&e<s+o)return!0;if(e&&i&&e-o<i)return!0;if(e&&r&&e+o>r)return!0}else{if(e&&e>s-o)return!0;if(e&&i&&e+o>i)return!0;if(e&&r&&e-o<r)return!0}return!1}function Ko(t,e,s,i,r,o,n,h){if(!n)return!0;if(!e)return!0;if(!o)return!0;if(t){if(e&&e<s+h)return!0;if(e&&o&&e-h<o)return!0;if(o&&i&&o-h<i)return!0;if(o&&r&&o+h>r)return!0}else{if(e&&e>s-h)return!0;if(e&&o&&e+h>o)return!0;if(o&&i&&o+h>i)return!0;if(o&&r&&o-h<r)return!0}return!1}function Zo(t,e,s,i,r){if(t){if(s&&s>e-r)return!0;if(i&&i<e+r)return!0;if(i&&s&&i<s)return!0}else{if(s&&s<e+r)return!0;if(i&&i>e-r)return!0;if(i&&s&&i>s)return!0}return!1}function tn(t,e){const{isFuture:s,tradePriceLimitMin:i,tradePriceLimitMax:r}=t;return!!(e&&s&&(i&&e<i||r&&e>r))}K=new WeakMap,Z=new WeakMap,tt=new WeakSet,et=function(){return Ji(this,K,{id:{},symbol:{}}),Gi(this,Z).forEach(((t,e)=>{const{order:s,symbol:i}=t.value;s&&(Gi(this,K).id[s]=e),Gi(this,K).symbol[i]||(Gi(this,K).symbol[i]=[]),Gi(this,K).symbol[i].push(t)})),this},$o([ir],Uo.prototype,"setSort"),$o([ir],Uo.prototype,"reset"),$o([ir],Uo.prototype,"updateOrder"),$o([ir],Uo.prototype,"setOrders");const en=Object.freeze(Object.defineProperty({__proto__:null,calcMarketDisable:Zo,calcMarketSL:function(t,e,s,i){return Yo(t,e,s,i,i)},calcMarketTP:function(t,e,s,i){return Go(t,e,s,i,i)},calcOrderDisable:function(t,e,s,i,r,o,n,h,a,l,c){const{isBuy:d,isLimit:u,isStop:p,isStopLimit:y,volumeValue:g}=e;return!((s&&e.price!==s||e.sl!==(i??0)||e.tp!==(r??0)||e.expiration!==n||e.date!==(h??0)||e.comment!==(a??"")||y&&o&&e.priceTrigger!==o)&&(2!==n&&3!==n||h)&&(!u||!Xo(d,s,l,i,r,c)&&!tn(t,s))&&(!p||!Jo(d,s,l,i,r,c))&&(!y||!Ko(d,s,l,i,r,o,g,c)))},calcPendingDisable:function(t,e,s,i,r,o,n,h,a,l){if(null===i)return!0;if(null===r)return!0;const c=t.isBuy(s),d=t.isLimit(s),u=t.isStop(s),p=t.isStopLimit(s);return!(!d||!Xo(c,r,o,n,h,l)&&!tn(e,r))||!(!u||!Jo(c,r,o,n,h,l))||!(!p||!Ko(c,r,o,n,h,a,i,l))},calcPendingPrice:Qo,calcPendingSL:Yo,calcPendingTP:Go,calcPendingTriggerPrice:function(t,e,s,i){const[r,o]=zo(e),n=t.isStop(s),h=t.isStopLimit(s);return(n||h?t.isSell(s):t.isBuy(s))?isNaN(r)?i:i+.25*(r-i):isNaN(o)?i:i+.25*(o-i)},calcPositionDisable:function(t,e,s,i,r,o,n){return i!==t.volumeValue||!((e??0)!==t.sl||(s??0)!==t.tp||(r??"")!==t.comment)||!!Zo(t.isBuy,o,e,s,n)},calcPositionSL:function(t,e,s,i){const[r,o]=zo(t);return e?isNaN(r)?.75*i:i+.5*(r-i):s?isNaN(o)?1.25*i:i+.5*(o-i):0},calcPositionTP:function(t,e,s,i){const[r,o]=zo(t);return e?isNaN(o)?1.25*i:i+.5*(o-i):s?isNaN(r)?.75*i:i+.5*(r-i):0},whyTradeIsDisabled:function(t,e){return t.isInvestor?window.tr(window.lang.trade.tradeIsDisabled.investor):t.isReadOnly()?window.tr(window.lang.trade.tradeIsDisabled.readOnly):t.isTradeDisabled?window.tr(window.lang.trade.tradeIsDisabled.account):(null==e?void 0:e.isTradeEnabled)?(null==e?void 0:e.isCollateral)?window.tr(window.lang.trade.tradeIsDisabled.collateral):window.tr(window.lang.trade.tradeIsDisabled.disabled):window.tr(window.lang.trade.tradeIsDisabled.symbol)}},Symbol.toStringTag,{value:"Module"}));class sn{constructor(t,e,s,i,r,o,n){Xi(this,ot),Xi(this,st),Xi(this,it),Xi(this,rt),Xi(this,at),Xi(this,ct),Xi(this,dt),Xi(this,ut),this.utils=en,Ji(this,at,(t=>{const{request:e}=this.tradeStore;if(t.result&&e&&"number"==typeof e.action.id&&e.action.id===t.action.id)if(e.quickTrade)if(10004===t.code){const e=Gi(this,it).symbolsStore.getBySymbol(t.action.symbol),s=1e3*((null==e?void 0:e.requoteTimeout)||7);e&&this.setQuickTradeRequest({action:t.action,result:t.result},(()=>window.setTimeout((()=>this.tradeStore.resetQuickTradeRequest()),s)))}else this.setQuickTradeRequest({action:t.action,result:t.result});else if(10005===t.code){const e=t.action.symbol,s=Gi(this,it).symbolsStore.getBySymbol(e),i=1e3*((null==s?void 0:s.requestTimeout)||7);this.tradeStore.setPrice(e,{bid:t.result.bid,ask:t.result.ask,time:Date.now(),timeout:(()=>(this.tradeStore.prices[e]&&window.clearTimeout(this.tradeStore.prices[e].timeout),window.setTimeout((()=>{this.tradeStore.setPrice(e)}),i)))()})}else if(10004===t.code){const e=Gi(this,it).symbolsStore.getBySymbol(t.action.symbol),s=1e3*((null==e?void 0:e.requoteTimeout)||7);e&&this.setRequest({action:t.action,result:t.result},(()=>window.setTimeout((()=>this.tradeStore.resetRequest()),s)))}else this.setRequest({action:t.action,result:t.result}),Ki(this,ot,lt).call(this)})),Ji(this,ct,(t=>{if(this.positionsStore.positionHas(t)){const e=Gi(this,st).trade.getPosition(t);e&&this.positionsStore.updatePosition(e)}else Ki(this,ot,pt).call(this)})),Ji(this,dt,(t=>{if(this.ordersStore.orderHas(t)){const e=Gi(this,st).trade.getOrder(t);e&&this.ordersStore.updateOrder(e)}else Ki(this,ot,yt).call(this)})),Ji(this,ut,(()=>{Ki(this,ot,pt).call(this),Ki(this,ot,yt).call(this)})),Ji(this,st,t),this.apiUtilsTrade=e,this.tradeStore=s,this.ordersStore=i,this.positionsStore=r,Ji(this,it,o),Ji(this,rt,n),this.init()}init(){this.tradeStore.reset(),Ki(this,ot,yt).call(this),Ki(this,ot,pt).call(this),Ki(this,ot,ht).call(this),Ki(this,ot,nt).call(this)}destroy(){Ki(this,ot,ht).call(this),this.positionsStore.reset(),this.ordersStore.reset()}setRequest(t,e){this.tradeStore.requestTimeout&&clearTimeout(this.tradeStore.requestTimeout),this.tradeStore.setRequest(t,e&&e())}setQuickTradeRequest(t,e){this.tradeStore.quickTradeRequestTimeout&&clearTimeout(this.tradeStore.quickTradeRequestTimeout),this.tradeStore.setQuickTradeRequest(t,e&&e())}openLimitOrder(t){const e=Gi(this,st).request.orderOpen(t.type,t.symbol,t.volume,t.price,t.sl,t.tp,t.expiration??0,t.date??0,t.comment??"",0,t.fillingType??2);"number"==typeof e.action.id&&this.tradeStore.setTransaction(e.action.id,{code:e.result.code}),this.setRequest(e)}openStopOrder(t){const e=Gi(this,st).request.orderOpen(t.type,t.symbol,t.volume,t.price,t.sl??0,t.tp??0,t.expiration??0,t.date??0,t.comment,0,t.fillingType??2);"number"==typeof e.action.id&&this.tradeStore.setTransaction(e.action.id,{code:e.result.code}),this.setRequest(e)}openStopLimitOrder(t){const e=Gi(this,st).request.orderOpen(t.type,t.symbol,t.volume,t.price,t.sl??0,t.tp??0,t.expiration??0,t.date??0,t.comment??"",t.trigger,t.fillingType??2);"number"==typeof e.action.id&&this.tradeStore.setTransaction(e.action.id,{code:e.result.code}),this.setRequest(e)}modifyLimitOrder(t){const e=Gi(this,st).request.orderModify(t.id,t.price,t.sl,t.tp,t.expiration,t.date,t.comment);"number"==typeof e.action.id&&this.tradeStore.setTransaction(e.action.id,{code:e.result.code,order:t.id}),this.setRequest(e)}modifyStopLimitOrder(t){const e=Gi(this,st).request.orderModify(t.id,t.price,t.sl,t.tp,t.expiration,t.date,t.comment,t.trigger);"number"==typeof e.action.id&&this.tradeStore.setTransaction(e.action.id,{code:e.result.code,order:t.id}),this.setRequest(e)}deleteOrder(t){const e=Gi(this,st).request.orderDelete(t);e&&("number"==typeof e.action.id&&this.tradeStore.setTransaction(e.action.id,{code:e.result.code,order:t}),this.setRequest(e))}acceptRequote(){var t;if(null==(t=this.tradeStore.request)?void 0:t.action){const{action:t}=this.tradeStore.request;t.position?this.closePosition(t.position,!1,t.volume):this.openPosition({type:t.isBuy?0:1,symbol:t.symbol,volume:t.volume,sl:t.priceSL,tp:t.priceTP,fillingType:2,comment:t.comment})}}openPosition(t){var e,s;const i=Gi(this,it).symbolsStore.getBySymbol(t.symbol);if(!i)return;let r=0;if(i.isInstantExecution&&!t.quickTrade&&10004===(null==(s=null==(e=this.tradeStore.request)?void 0:e.result)?void 0:s.code))0===t.type?r=this.tradeStore.request.result.ask:1===t.type&&(r=this.tradeStore.request.result.bid);else if(i.isRequestExecution||i.isInstantExecution&&i.maxInstantVolume&&t.volume>i.maxInstantVolume){if(!this.tradeStore.prices[i.symbol])return void Ki(this,ot,gt).call(this,t.type,i.symbol,t.volume);0===t.type?r=this.tradeStore.prices[i.symbol].ask:1===t.type&&(r=this.tradeStore.prices[i.symbol].bid)}else if(i.isInstantExecution){const e=Gi(this,rt).ticksStore.getTick(i.symbol);if(!e)return;0===t.type?r=e.ask:1===t.type&&(r=e.bid)}const o=Gi(this,st).request.positionOpen(t.type,t.symbol,t.volume,r,t.sl??0,t.tp??0,t.fillingType??2,t.comment??"");"number"==typeof o.action.id&&this.tradeStore.setTransaction(o.action.id,{code:o.result.code}),this.setRequest({...o,quickTrade:t.quickTrade})}modifyPosition(t){const e=Gi(this,st).request.positionModify(t.id,t.sl??0,t.tp??0,t.comment??"");"number"==typeof e.action.id&&this.tradeStore.setTransaction(e.action.id,{code:e.result.code,order:t.id}),this.setRequest(e)}closePosition(t,e,s){let i;const r=Gi(this,st).trade.getPosition(t);if(r){const t=Gi(this,it).symbolsStore.getBySymbol(r.symbol);t&&(t.isRequestExecution||t.isInstantExecution&&t.maxInstantVolume&&r.volumeValue>t.maxInstantVolume)&&this.tradeStore.prices[t.symbol]&&(r.isBuy?i=this.tradeStore.prices[t.symbol].bid:r.isSell&&(i=this.tradeStore.prices[t.symbol].ask))}const o=Gi(this,st).request.positionClose(t,e,i,s);return"number"==typeof o.action.id&&this.tradeStore.setTransaction(o.action.id,{code:o.result.code,order:t}),this.setRequest({...o,quickTrade:e}),o.action.id}bulkClosePosition(){const t=Gi(this,st).request.positionsClose();return"number"==typeof t.action.id&&this.tradeStore.setTransaction(t.action.id,{code:t.result.code}),this.setRequest({...t,quickTrade:!0}),t.action.id}closePositionByPosition(t,e){const s=Gi(this,st).request.positionCloseBy(t,e);"number"==typeof s.action.id&&this.tradeStore.setTransaction(s.action.id,{code:s.result.code,order:t}),this.setRequest(s)}calcProfit(t,e,s,i,r){return Gi(this,st).trade.calcProfit(t,e,s,i,r)}}st=new WeakMap,it=new WeakMap,rt=new WeakMap,ot=new WeakSet,nt=function(){Gi(this,st).on(5,Gi(this,dt)),Gi(this,st).on(4,Gi(this,ct)),Gi(this,st).on(2,Gi(this,at)),Gi(this,st).on(1,Gi(this,ut))},ht=function(){var t,e,s,i;null==(t=Gi(this,st))||t.off(5,Gi(this,dt)),null==(e=Gi(this,st))||e.off(4,Gi(this,ct)),null==(s=Gi(this,st))||s.off(2,Gi(this,at)),null==(i=Gi(this,st))||i.off(1,Gi(this,ut))},at=new WeakMap,lt=function(){Object.keys(this.tradeStore.prices).forEach((t=>{var e;(null==(e=this.tradeStore.prices[t])?void 0:e.timeout)&&window.clearTimeout(this.tradeStore.prices[t].timeout)})),this.tradeStore.clearPrices()},ct=new WeakMap,dt=new WeakMap,ut=new WeakMap,pt=function(){this.positionsStore.setPositions(Gi(this,st).trade.getPositions())},yt=function(){this.ordersStore.setOrders(Gi(this,st).trade.getOrders())},gt=function(t,e,s){const i=Gi(this,st).request.requestPrice(e,t,s);"number"==typeof i.action.id&&this.tradeStore.setTransaction(i.action.id,{code:i.result.code}),this.setRequest(i)};class rn{constructor(t,e,s,i){this.tradeStore=new Ro,this.ordersStore=new Uo,this.positionsStore=new qo,this.tradeController=new sn(t,e,this.tradeStore,this.ordersStore,this.positionsStore,s,i)}}class on{constructor(t,e,s,i,r,o){Xi(this,mt),Xi(this,bt),Xi(this,St),Xi(this,wt),Xi(this,ft),Xi(this,kt),Xi(this,vt),Xi(this,Mt,(()=>{})),Xi(this,Tt,(t=>{const[e]=t;if(this.watchlistStore.has(e)){const t=Gi(this,wt).ticksStore.getTicks(this.watchlistStore.getList()),e=function(t,e){const s={};e.forEach((t=>{s[t.symbol]=t}));const i={[hr.Symbol]:[...t],[hr.Bid]:[...t],[hr.Ask]:[...t],[hr.DailyChange]:[...t],[hr.High]:[...t],[hr.Low]:[...t],[hr.Spread]:[...t],[hr.Time]:[...t],[hr.BidHigh]:[...t],[hr.BidLow]:[...t],[hr.AskHigh]:[...t],[hr.AskLow]:[...t],[hr.PriceOpen]:[...t],[hr.PriceClose]:[...t],[hr.Last]:[...t],[hr.LastHigh]:[...t],[hr.LastLow]:[...t]};return i[hr.Symbol].sort(((t,e)=>s[t].symbol<s[e].symbol?-1:s[t].symbol>s[e].symbol?1:0)),i[hr.Bid].sort(((t,e)=>(s[t].bid??1/0)<(s[e].bid??1/0)?-1:(s[t].bid??-1/0)>(s[e].bid??-1/0)?1:0)),i[hr.Ask].sort(((t,e)=>(s[t].ask??1/0)<(s[e].ask??1/0)?-1:(s[t].ask??-1/0)>(s[e].ask??-1/0)?1:0)),i[hr.DailyChange].sort(((t,e)=>(s[t].change??1/0)<(s[e].change??1/0)?-1:(s[t].change??-1/0)>(s[e].change??-1/0)?1:0)),i[hr.Spread].sort(((t,e)=>(s[t].spread??1/0)<(s[e].spread??1/0)?-1:(s[t].spread??-1/0)>(s[e].spread??-1/0)?1:0)),i[hr.Time].sort(((t,e)=>(s[t].time.getTime()??1/0)<(s[e].time.getTime()??1/0)?-1:(s[t].time.getTime()??-1/0)>(s[e].time.getTime()??-1/0)?1:0)),i[hr.BidHigh].sort(((t,e)=>(s[t].bidHigh??1/0)<(s[e].bidHigh??1/0)?-1:(s[t].bidHigh??-1/0)>(s[e].bidHigh??-1/0)?1:0)),i[hr.BidLow].sort(((t,e)=>(s[t].bidLow??1/0)<(s[e].bidLow??1/0)?-1:(s[t].bidLow??-1/0)>(s[e].bidLow??-1/0)?1:0)),i[hr.AskHigh].sort(((t,e)=>(s[t].askHigh??1/0)<(s[e].askHigh??1/0)?-1:(s[t].askHigh??-1/0)>(s[e].askHigh??-1/0)?1:0)),i[hr.AskLow].sort(((t,e)=>(s[t].askLow??1/0)<(s[e].askLow??1/0)?-1:(s[t].askLow??-1/0)>(s[e].askLow??-1/0)?1:0)),i[hr.PriceOpen].sort(((t,e)=>(s[t].priceOpen??1/0)<(s[e].priceOpen??1/0)?-1:(s[t].priceOpen??-1/0)>(s[e].priceOpen??-1/0)?1:0)),i[hr.PriceClose].sort(((t,e)=>(s[t].priceClose??1/0)<(s[e].priceClose??1/0)?-1:(s[t].priceClose??-1/0)>(s[e].priceClose??-1/0)?1:0)),i[hr.Last].sort(((t,e)=>(s[t].last??1/0)<(s[e].last??1/0)?-1:(s[t].last??-1/0)>(s[e].last??-1/0)?1:0)),i[hr.LastHigh].sort(((t,e)=>(s[t].lastHigh??1/0)<(s[e].lastHigh??1/0)?-1:(s[t].lastHigh??-1/0)>(s[e].lastHigh??-1/0)?1:0)),i[hr.LastLow].sort(((t,e)=>(s[t].lastLow??1/0)<(s[e].lastLow??1/0)?-1:(s[t].lastLow??-1/0)>(s[e].lastLow??-1/0)?1:0)),i}(this.watchlistStore.getList(),t);this.watchlistStore.setSort(e)}})),Xi(this,Pt,(()=>{const t=new Set;[...Gi(this,ft).positionsStore.getPositions(),...Gi(this,ft).ordersStore.getOrders()].forEach((({value:{symbol:e}})=>{this.watchlistStore.has(e)||t.add(e)})),t.size&&this.add(Array.from(t))})),Ji(this,mt,t),this.watchlistStore=s,Ji(this,St,i),Ji(this,wt,r),Ji(this,ft,o),Ji(this,bt,e),this.ready=new Promise((t=>{Ji(this,Mt,t)}))}async init(){var t;const e=(await Gi(this,bt).getAll())[0],s=(null==(t=null==e?void 0:e.symbols)?void 0:t.filter(Boolean))??[];this.watchlistStore.reset(this.filterSymbols(s)),Gi(this,St).loadFullSymbols(s),this.fillSymbolsFromUrl(),this.generate(),Gi(this,Mt).call(this),Ji(this,kt,Gi(this,ft).positionsStore.subscribe(Gi(this,Pt))),Ji(this,vt,Gi(this,ft).ordersStore.subscribe(Gi(this,Pt))),Gi(this,mt).on(0,Gi(this,Tt))}destroy(){var t;null==(t=Gi(this,mt))||t.off(0,Gi(this,Tt)),this.watchlistStore.reset(),Gi(this,kt)&&Gi(this,kt).call(this),Gi(this,vt)&&Gi(this,vt).call(this)}filterSymbols(t){return t.filter((t=>Gi(this,St).symbolsStore.getBySymbol(t)))}fillSymbolsFromUrl(){if(this.watchlistStore.getList().length)return;const t=function(){const t=new URLSearchParams(window.self.location.search);if(t.get("marketwatch")){const e=t.get("marketwatch");if(e)return e.split(",").filter((t=>t&&"string"==typeof t)).map((t=>t.trim().toLowerCase()))}return[]}(),e=[];t.forEach((t=>{const s=Gi(this,St).symbolsStore.getBySymbol(t);s&&e.push(s.symbol)})),this.add(e)}getList(){return this.watchlistStore.getList()}generate(t=10){if(this.watchlistStore.getList().length)return this;const e=[],s=Gi(this,mt).symbolTypes.getTypes();for(const i of s){const s=Gi(this,St).symbolsStore.getByCategory(i[1]);for(let i=0;i<s.length&&!(e.length>=t);i++)e.push(s[i].symbol)}return this.add(e),this}add(t){return t.forEach((t=>Gi(this,wt).on(t))),this.watchlistStore.add(t),Gi(this,St).loadFullSymbols(t),Gi(this,bt).add({symbols:this.watchlistStore.getList()}).then((()=>{})).catch((()=>{})),this}remove(t){return Gi(this,wt).off(t),this.watchlistStore.remove(t),Gi(this,bt).add({symbols:this.watchlistStore.getList()}).then((()=>{})).catch((()=>{})),this}}mt=new WeakMap,bt=new WeakMap,St=new WeakMap,wt=new WeakMap,ft=new WeakMap,kt=new WeakMap,vt=new WeakMap,Mt=new WeakMap,Tt=new WeakMap,Pt=new WeakMap;var nn=Object.defineProperty,hn=Object.getOwnPropertyDescriptor,an=(t,e,s,i)=>{for(var r,o=hn(e,s),n=t.length-1;n>=0;n--)(r=t[n])&&(o=r(e,s,o)||o);return o&&nn(e,s,o),o};class ln extends sr{constructor(){super(),Xi(this,Ct),Xi(this,Lt),Xi(this,Ot),Xi(this,xt),this._systemName=ar.watchlist,Ji(this,Lt,[]),Ji(this,Ot,{symbol:{}}),Ji(this,xt,{})}has(t){return Boolean(Gi(this,Ot).symbol[t])}getList(t){return"number"==typeof t&&Gi(this,xt)[t]?[...Gi(this,xt)[t]||[]]:[...Gi(this,Lt)]}setSort(t){Ji(this,xt,t)}add(t){return(Array.isArray(t)?t:[t]).forEach((t=>Ki(this,Ct,Wt).call(this,t))),Ki(this,Ct,Bt).call(this)}remove(t){const e=Gi(this,Lt).findIndex((e=>t===e));return-1!==e&&Gi(this,Lt).splice(e,1),Ki(this,Ct,Bt).call(this)}reset(t=[]){return Ji(this,Lt,[...t]),Ki(this,Ct,Bt).call(this)}}Lt=new WeakMap,Ot=new WeakMap,xt=new WeakMap,Ct=new WeakSet,Wt=function(t){return-1===Gi(this,Lt).findIndex((e=>t===e))&&Gi(this,Lt).push(t),this},Bt=function(){return Ji(this,Ot,{symbol:{}}),Gi(this,Lt).forEach((t=>{Gi(this,Ot).symbol[t]=t})),this},an([ir],ln.prototype,"setSort"),an([ir],ln.prototype,"add"),an([ir],ln.prototype,"remove"),an([ir],ln.prototype,"reset");class cn{constructor(t,e,s,i,r){this.watchlistStore=new ln,this.watchlistController=new on(t,e,this.watchlistStore,s,i,r)}}function dn(t){return t instanceof wr?t instanceof Tr&&t.component?t.component:dn(t.parent):null}class un extends vr{constructor(t,e=6e3,s,i,r,o,n,h){super(t,e,s),Xi(this,Et),this.clickData=null,this.arrowTextures={up:{},down:{}},this.horizontalLineTextures={},this.layoutStore=h,this.interactionStore=i,this.positionsStore=r,this.ordersStore=o,this.historyPositionsStore=n,this.sections=this.chart.sections}createMask(){const t=this._createGraphics("mask");return t.isMask=!0,t.x=Math.round(this.section.x),t.y=Math.round(this.section.y),t.beginFill(),t.drawRect(0,0,this.section.width+1,this.section.height),t.endFill(),t}drawHorizontalLine(t,e,s,i,r,o,n,h){const a=this.chart.state.graphWidth+1;if(h&&xr(t,0,s,a,s),n){const e=Ki(this,Et,_t).call(this,r.line),i=new br(e,this.chart.state.graphWidth+1,1);i.y=Math.floor(s),t.addChild(i)}else t.beginFill(r.line),t.lineStyle(0),t.drawRect(0,s,a,1),t.endFill();if(!this.layoutStore.tradeEdit&&null===this.layoutStore.tradeCreate){const o=18,n=this.chart.state.yAxisIsLeft?this.chart.state.yAxisWidth-2:this.chart.state.yAxisWidth-1,h=this.chart.state.yAxisIsLeft?this.chart.state.yAxisWidth-n+1:this.chart.state.graphX+this.chart.state.graphWidth+1;t.beginFill(this.chart.colors.chart.backgroundColor),t.lineStyle(1,r.line,1,0),t.drawRect(h,s-o/2,n,o),t.endFill();const a=lr(i,this.chart.digits),l=this.createText(a,`${e}price`);l.text=a,l.tint=r.text||r.line,l.y=s-o/2+1,l.x=h+5,t.addChild(l)}if(o){const i=this.createText(o,`${e}title`);i.text=o,i.tint=r.text||r.line,i.x=5,i.y=s-i.fontSize,t.addChild(i)}}drawArrow(t,e,s,i,r){const o=Ki(this,Et,Dt).call(this,i,r.arrow,r.border),n=new Sr(o);n.x=Math.floor(e-n.width/2),n.y=Math.floor(i?s:s-n.height)-1,t.addChild(n)}destroy(){super.destroy()}getXPosition(t){const e=Mr(t,this.chart.bars.period),s=this.chart.bars.index(e,!0);return this.chart.state.indexToX(s)+.5}hasSelectedOnSymbol(t){const{selectedPosition:e,selectedOrder:s,selectedHistoryPosition:i}=this.interactionStore;if(e){const s=this.positionsStore.getPosition(e);if((null==s?void 0:s.symbol)===t)return!0}if(s){const e=this.ordersStore.getOrder(s);if((null==e?void 0:e.symbol)===t)return!0}if(i){const e=this.historyPositionsStore.getPosition(i);if((null==e?void 0:e.symbol)===t)return!0}return!1}tick(){}value(t){return[]}_drawGraph(t,e){}getLevels(t,e,s,i){const r=this.valueToY(t),o=e?this.valueToY(e):null,n=s?this.valueToY(s):null,h=i?this.valueToY(i):null;return{price:{y:r,inSection:r>0&&r<this.section.height},sl:{y:o,inSection:o?o>0&&o<this.section.height:null},tp:{y:n,inSection:n?n>0&&n<this.section.height:null},trigger:{y:h,inSection:h?h>0&&h<this.section.height:null}}}drawTooltip(t,e){if(!this.hover)return;const{bgColor:s,textColor:i,alpha:r,borderRadius:o,padding:n,margin:h}={bgColor:5263968,textColor:16777215,alpha:1,borderRadius:5,padding:10,margin:10},a=this.createText(e);a.tint!==i&&(a.tint=i);const l=a.width+n,c=Math.max(a.height,16)+n;let d=Math.round(this.hover.x-l/2);this.hover.x+h+l>this.section.width&&(d=Math.round(this.hover.x-h-l));let u=Math.round(this.hover.y-h-c);this.hover.y-h-c<0&&(u=Math.round(this.hover.y+h)),a.x=Math.round(d+n/2),a.y=Math.round(u+n/2),t.lineStyle(0),t.beginFill(s,r),t.drawRoundedRect(d,u,l,c,o),t.endFill(),t.addChild(a)}updateQuickEditLevel(t,e,s,i){if(e&&void 0!==e)if(i)this.interactionStore.quickEdit[t]=e+i;else{const i=this.valueToY(e)+s;this.interactionStore.quickEdit[t]=this.yToValue(i)}}}Et=new WeakSet,_t=function(t){if(this.horizontalLineTextures[t])return this.horizontalLineTextures[t];const e=new mr;return e.beginFill(t,.7),e.drawRect(0,0,3,1),e.drawRect(9,0,3,1),e.width=9,e.height=1,e.endFill(),this.horizontalLineTextures[t]=this.chart.app.renderer.generateTexture(e,{resolution:window.devicePixelRatio}),this.horizontalLineTextures[t]},Dt=function(t,e,s){const i=`${e}${s}`,r=t?1:-1,o=t?"up":"down";if(this.arrowTextures[o][i])return this.arrowTextures[o][i];const n=new mr;return n.beginFill(s),n.moveTo(0,0),n.lineTo(7,10*r),n.lineTo(-7,10*r),n.endFill(),n.beginFill(e),n.moveTo(0,2*r),n.lineTo(5,9*r),n.lineTo(-5,9*r),n.endFill(),this.arrowTextures[o][i]=this.chart.app.renderer.generateTexture(n,{resolution:window.devicePixelRatio,multisample:8}),this.arrowTextures[o][i]},Ht=new WeakMap,qt=new WeakMap,At=new WeakMap,jt=new WeakMap,Nt=new WeakMap,Rt=new WeakMap,Ft=new WeakMap,It=new WeakMap,$t=new WeakMap,Vt=new WeakMap,Ut=new WeakSet,zt=function(){const t=this.historyPositionsStore.getPositionsBySymbol(this.chart.bars.symbol);if(0===t.length)return;const{buyLine:e,buyText:s,buyArrow:i,buyArrowBorder:r,sellLine:o,sellText:n,sellArrow:h,sellArrowBorder:a,blurLine:l,blurArrow:c,blurArrowBorder:d,slArrow:u,tpArrow:p,slArrowBorder:y,tpArrowBorder:g}=this.chart.colors.tradeMark,m=this.hasSelectedOnSymbol(this.chart.bars.symbol),b=this._createGraphics("history-mask"),S=this.createMask();b.mask=S,this.container.addChild(b),t.forEach((t=>{const{priceOpen:S,timeOpen:w,priceClose:f,timeClose:k,id:v,volumeValue:M,symbol:T,isBuy:P,profit:L}=t.value,O=this.getXPosition(w),x=this.valueToY(S);if(!k)return;const C=this.getXPosition(k),W=this.valueToY(f),B=O<this.section.width&&O>0&&x<this.section.height&&x>0,E=C<this.section.width&&C>0&&W<this.section.height&&W>0;if(!B&&!E)return;const _=this._createGraphics(v);_.name=v,_.eventMode="static",_.cursor="pointer",b.addChild(_);const D=m&&this.interactionStore.selectedHistoryPosition!==v;let H=P?{arrow:i,border:r}:{arrow:h,border:a};if(D&&(H={arrow:c,border:d}),B&&this.drawArrow(_,O,x,P,H),E){const t=Gi(this,Ft).getDealsBySymbolAndPosition(T,v),e=(null==t?void 0:t.length)?t[t.length-1]:null,s=Boolean(e&&3===e.value.tradeReason),o=Boolean(e&&4===e.value.tradeReason);H=P?{arrow:h,border:a}:{arrow:i,border:r},D&&(H={arrow:c,border:d}),s&&(H={arrow:u,border:y}),o&&(H={arrow:p,border:g}),this.drawArrow(_,C,W,!P,H)}const q=P?{line:e,text:s}:{line:o,text:n};if(v===this.interactionStore.selectedHistoryPosition){const t=this._createGraphics(`${v}selected`);this.container.addChild(t),Br(_,O,x,C,W,{color:q.line,dash:4});const{digits:e}=this.chart,s=`${P?"BUY":"SELL"} ${M} at ${lr(S,e)}`;this.drawHorizontalLine(t,v,x,S,q,s);const i=Gi(this,It).getPoints(T,P,S,f);this.drawHorizontalLine(t,v,W,f,{line:l,text:q.text},i,!0)}else if(this.hover&&v===this.hover.id){Br(_,O,x,C,W,{color:q.line,dash:4});const t=this._createGraphics("tooltip");this.container.addChild(t);const e=`${P?"Buy":"Sell"} ${M} ${L&&L>0?"+":""}${L}`;this.drawTooltip(t,e)}}))},Qt=function(){const{symbol:t}=this.chart.bars,{buyLine:e,buyText:s,buyArrow:i,buyArrowBorder:r,sellLine:o,sellText:n,sellArrow:h,sellArrowBorder:a,blurLine:l,blurText:c,blurArrow:d,blurArrowBorder:u,slArrow:p,slArrowBorder:y,tpArrow:g,tpArrowBorder:m}=this.chart.colors.tradeMark,b=this.chart.state.getFrom(),S=this.chart.state.getCount(),w=this.chart.bars.time(b),f=this.chart.bars.time(b+S),k=this.historyPositionsStore.getPositionsBySymbolAndDate(t,w,f),v=this.hasSelectedOnSymbol(t),M=this.createMask();k.forEach((s=>{const n=Gi(this,Ft).getDealsBySymbolAndPosition(t,s.value.id);if(!n)return;const{id:b}=s.value;let S=this._createGraphics(`${b}mask`);S.mask=M;const w=S;b===this.interactionStore.selectedHistoryPosition?(S=this._createGraphics(b),S.addChild(w),S.name=b):(w.name=b,w.eventMode="static",w.cursor="pointer");const f=s.value.isBuy,k=v&&this.interactionStore.selectedHistoryPosition!==b;let T=f?{line:e}:{line:o};k&&(T={line:l,text:c});let P=this.getXPosition(n[0].value.timeCreate),L=this.valueToY(n[0].value.priceOpen),O=P<this.section.width&&P>0&&L<this.section.height&&L>0;for(let t=1;t<n.length;t++){const{priceOpen:e,timeCreate:s}=n[t].value,o=this.getXPosition(s),l=this.valueToY(e),c=o<this.section.width&&o>0&&l<this.section.height&&l>0;if(O){const e=n[t-1].value.isBuy;let s=e?{arrow:i,border:r}:{arrow:h,border:a};k&&(s={arrow:d,border:u}),this.drawArrow(w,P,L,e,s),b===this.interactionStore.selectedHistoryPosition&&Ki(this,Ut,Yt).call(this,S,n[t-1],L)}if((O||c)&&Br(w,P,L,o,l,{color:T.line,dash:4}),t===n.length-1&&c){const e=n[t].value,s=3===e.tradeReason,c=4===e.tradeReason;let f=e.isBuy?{arrow:i,border:r}:{arrow:h,border:a};k&&(f={arrow:d,border:u}),s&&(f={arrow:p,border:y}),c&&(f={arrow:g,border:m}),this.drawArrow(w,o,l,e.isBuy,f),b===this.interactionStore.selectedHistoryPosition&&Ki(this,Ut,Yt).call(this,S,n[t],l)}P=o,L=l,O=c}this.container.addChild(S)}))},Yt=function(t,e,s){const{priceOpen:i,deal:r,volumeValue:o}=e.value,{buyLine:n,buyText:h,sellLine:a,sellText:l}=this.chart.colors.tradeMark,{isBuy:c}=e.value,d=c?{line:n,text:h}:{line:a,text:l},u=`${c?"BUY":"SELL"} ${o} at ${lr(i,this.chart.digits)}`;this.drawHorizontalLine(t,r,s,i,d,u,!0)},Gt=new WeakMap,Xt=new WeakMap,Jt=new WeakMap;let pn=class t extends un{constructor(e,s=6e3,i,r,o,n,h,a,l,c,d){super(e,s,i,r,o,n,h,a),Xi(this,Ut),Xi(this,Ht),Xi(this,qt),Xi(this,At),Xi(this,jt),Xi(this,Nt),Xi(this,Rt,!1),Xi(this,Ft),Xi(this,It),Xi(this,$t,(()=>{this.settings.visible!==this.prevVisible&&(this.prevVisible=this.settings.visible,this.toggle(this.settings.visible))})),Xi(this,Vt,Zi(50,(()=>{this.draw()}))),Xi(this,Gt,(t=>{if(null!==this.layoutStore.tradeCreate||this.layoutStore.tradeEdit)return;const{x:e,y:s}=t.data.global;this.clickData={x:e,y:s},this.chart.app.stage.addEventListener("pointerup",Gi(this,Xt))})),Xi(this,Xt,(e=>{var s;const{x:i,y:r}=e.data.global;if(this.clickData&&Math.abs(i-this.clickData.x)<3&&Math.abs(r-this.clickData.y)<3&&e.target instanceof wr){const i=dn(e.target),r=null==(s=e.target)?void 0:s.name;i instanceof t?r&&Gi(this,It).onSelectHistoryMark(r):this.interactionStore.setSelectedHistoryPosition()}this.clickData=null,this.chart.app.stage.removeEventListener("pointerup",Gi(this,Xt))})),Xi(this,Jt,(e=>{var s;if(e.target instanceof wr){const i=dn(e.target),r=null==(s=e.target)?void 0:s.name;i instanceof t&&r?(this.hover={id:r,x:e.globalX,y:e.globalY},this.draw()):void 0!==this.hover&&(this.hover=void 0,this.draw())}})),Ji(this,Rt,l),Ji(this,Ft,c),this.historyPositionsStore=h,Ji(this,It,d),this.layoutStore=a,Ji(this,Nt,this.settings.subscribe(Gi(this,$t)))}toggle(t){t?(this.chart.app.stage.addEventListener("pointerdown",Gi(this,Gt)),this.chart.app.stage.addEventListener("pointerover",Gi(this,Jt)),Ji(this,Ht,this.interactionStore.subscribe(Gi(this,Vt))),Ji(this,qt,this.layoutStore.subscribe(Gi(this,Vt))),Ji(this,At,this.historyPositionsStore.subscribe(Gi(this,Vt))),Gi(this,Rt)||Ji(this,jt,Gi(this,Ft).subscribe(Gi(this,Vt)))):(this.chart.app.stage.removeEventListener("pointerdown",Gi(this,Gt)),this.chart.app.stage.removeEventListener("pointerover",Gi(this,Jt)),Gi(this,Ht)&&(Gi(this,Ht).call(this),Ji(this,Ht,void 0)),Gi(this,qt)&&(Gi(this,qt).call(this),Ji(this,qt,void 0)),Gi(this,At)&&(Gi(this,At).call(this),Ji(this,At,void 0)),Gi(this,jt)&&(Gi(this,jt).call(this),Ji(this,jt,void 0)))}_draw(){null!==this.layoutStore.tradeCreate||this.layoutStore.tradeEdit||(Gi(this,Rt)?Ki(this,Ut,zt).call(this):Ki(this,Ut,Qt).call(this))}destroy(){super.destroy(),this.chart.app.stage.removeEventListener("pointerup",Gi(this,Xt)),this.chart.app.stage.removeEventListener("pointerdown",Gi(this,Gt)),Gi(this,Nt)&&(Gi(this,Nt).call(this),Ji(this,Nt,void 0)),Gi(this,Ht)&&(Gi(this,Ht).call(this),Ji(this,Ht,void 0)),Gi(this,qt)&&(Gi(this,qt).call(this),Ji(this,qt,void 0)),Gi(this,At)&&(Gi(this,At).call(this),Ji(this,At,void 0)),Gi(this,jt)&&(Gi(this,jt).call(this),Ji(this,jt,void 0))}};const yn=class extends sr{constructor(t){super(),this.digits=0,this.visible=!0,this.flags=26,this.parent="",this.params={},this.style={},this.mask={period:511,navigator:!0},t&&Pr(this,t)}toJSON(){return{...Lr(this)}}};yn.flags=26;let gn=yn;const mn=class t extends gn{constructor(){super(...arguments),this.type="history_trade_mark",this.title=t.title,this.fullTitle=t.fullTitle,this.uid="history_trade_mark"}};mn.title="History Trade Mark",mn.fullTitle=mn.title;let bn=mn;Kt=new WeakMap,Zt=new WeakMap,te=new WeakMap,ee=new WeakMap,se=new WeakMap,ie=new WeakMap,re=new WeakMap,oe=new WeakMap,ne=new WeakMap,he=new WeakMap,ae=new WeakMap,le=new WeakSet,ce=function(t){t?(this.container.addEventListener("pointerdown",Gi(this,ye)),fr()||(this.container.interactive||(this.container.eventMode="static"),this.container.addEventListener("pointerdown",Gi(this,fe)),this.container.addEventListener("pointerover",Gi(this,Se)),this.container.addEventListener("pointerleave",Gi(this,we))),Ji(this,Kt,this.interactionStore.subscribe(Gi(this,de))),Ji(this,Zt,this.layoutStore.subscribe(Gi(this,de))),Ji(this,te,this.ordersStore.subscribe(Gi(this,de))),Ji(this,se,Gi(this,re).subscribe(Gi(this,de)))):(this.container.removeEventListener("pointerdown",Gi(this,ye)),fr()||(this.container.removeEventListener("pointerdown",Gi(this,fe)),this.container.removeEventListener("pointerover",Gi(this,Se)),this.container.removeEventListener("pointerleave",Gi(this,we))),Gi(this,Kt)&&(Gi(this,Kt).call(this),Ji(this,Kt,void 0)),Gi(this,Zt)&&(Gi(this,Zt).call(this),Ji(this,Zt,void 0)),Gi(this,te)&&(Gi(this,te).call(this),Ji(this,te,void 0)),Gi(this,se)&&(Gi(this,se).call(this),Ji(this,se,void 0)))},de=new WeakMap,ue=function(t,e,s){const{order:i,volumeValue:r,isBuy:o,price:n,priceTrigger:h,sl:a,symbol:l,type:c}=e,d=this.interactionStore.selectedOrder===i;if(!Gi(this,re).showSlTp&&!d)return;const{slLine:u,slText:p,blurLine:y,blurText:g}=this.chart.colors.tradeMark,{quickEdit:m}=this.interactionStore;let b=`SL at ${lr(d&&m.sl?m.sl:a,this.chart.digits)}`;if(d&&Gi(this,he)&&m.sl&&"sl"===Gi(this,ne)){const t=6!==c&&7!==c||!h?n:h;b+=`, ${Gi(this,oe).getProfit(l,r,o,t,m.sl)}, ${Gi(this,oe).getPoints(l,o,t,m.sl)}`}this.drawHorizontalLine(t,i,d&&m.sl?this.valueToY(m.sl):s,d&&m.sl?m.sl:a,d?{line:u,text:p}:{line:y,text:g},b,this.interactionStore.selectedOrder!==i,!0)},pe=function(t,e,s){const{order:i,volumeValue:r,isBuy:o,price:n,priceTrigger:h,tp:a,symbol:l,type:c}=e,d=this.interactionStore.selectedOrder===i;if(!Gi(this,re).showSlTp&&!d)return;const{tpLine:u,tpText:p,blurLine:y,blurText:g}=this.chart.colors.tradeMark,{quickEdit:m}=this.interactionStore;let b=`TP at ${lr(d&&m.tp?m.tp:a,this.chart.digits)}`;if(d&&Gi(this,he)&&m.tp&&"tp"===Gi(this,ne)){const t=6!==c&&7!==c||!h?n:h;b+=`, ${Gi(this,oe).getProfit(l,r,o,t,m.tp)}, ${Gi(this,oe).getPoints(l,o,t,m.tp)}`}this.drawHorizontalLine(t,i,d&&m.tp?this.valueToY(m.tp):s,d&&m.tp?m.tp:a,d?{line:u,text:p}:{line:y,text:g},b,this.interactionStore.selectedOrder!==i,!0)},ye=new WeakMap,ge=new WeakMap,me=new WeakMap,be=new WeakMap,Se=new WeakMap,we=new WeakMap,fe=new WeakMap;let Sn=class t extends un{constructor(e,s=6e3,i,r,o,n,h,a,l,c,d){super(e,s,i,r,o,n,h,a),Xi(this,le),Xi(this,Kt),Xi(this,Zt),Xi(this,te),Xi(this,ee),Xi(this,se),Xi(this,ie),Xi(this,re),Xi(this,oe),Xi(this,ne),Xi(this,he,!1),Xi(this,ae,(()=>{this.settings.visible!==this.prevVisible&&(this.prevVisible=this.settings.visible,Ki(this,le,ce).call(this,this.settings.visible))})),Xi(this,de,Zi(50,(()=>{this.draw()}))),Xi(this,ye,Zi(500,(t=>{var e,s;const{x:i,y:r}=t.global;if(this.clickData={x:i,y:r},this.interactionStore.selectedOrder&&t.target instanceof wr&&(null==(e=t.target)?void 0:e.name)&&(null==(s=t.target)?void 0:s.name)===this.interactionStore.selectedOrder){t.stopPropagation();const e=this.ordersStore.getOrder(this.interactionStore.selectedOrder);if(!e)return;const{price:s,sl:i,tp:o,priceTrigger:n}=e,h=this.getLevels(s,i,o,n),a=!!h.tp.y&&Math.abs(h.tp.y-r)<=8,l=!!h.sl.y&&Math.abs(h.sl.y-r)<=8,c=!!h.trigger.y&&Math.abs(h.trigger.y-r)<=8,d=!!h.price.y&&Math.abs(h.price.y-r)<=8;a?Ji(this,ne,"tp"):l?Ji(this,ne,"sl"):c&&e.priceTrigger?Ji(this,ne,"trigger"):d&&Ji(this,ne,"price"),this.chart.app.stage.addEventListener("pointermove",Gi(this,me)),this.chart.app.stage.addEventListener("pointerup",Gi(this,be))}else this.chart.app.stage.addEventListener("pointerup",Gi(this,ge))}))),Xi(this,ge,(e=>{var s;const{x:i,y:r}=e.global;if(this.clickData&&Math.abs(i-this.clickData.x)<3&&Math.abs(r-this.clickData.y)<3&&e.target instanceof wr){const i=dn(e.target),r=null==(s=e.target)?void 0:s.name;i instanceof t?r&&(Gi(this,oe).onSelectOrderMark(r),(this.layoutStore.tradeEdit||null!==this.layoutStore.tradeCreate)&&Gi(this,ie).setSelectedForEdit(r)):this.layoutStore.tradeEdit||null!==this.layoutStore.tradeCreate||this.interactionStore.setSelectedOrder()}this.clickData=null,this.chart.app.stage.removeEventListener("pointerup",Gi(this,ge))})),Xi(this,me,(t=>{const{y:e}=t.global;if(!this.clickData||Math.abs(e-this.clickData.y)<3&&!Gi(this,he))return;Ji(this,he,!0);const s=this.ordersStore.getOrder(this.interactionStore.selectedOrder);if(!s)return;const i=e-this.clickData.y;if("price"===Gi(this,ne)){const t=this.yToValue(e)-s.price;this.updateQuickEditLevel("price",s.price,i),this.updateQuickEditLevel("tp",s.tp,i,t),this.updateQuickEditLevel("sl",s.sl,i,t),this.updateQuickEditLevel("trigger",s.priceTrigger,i,t)}else"tp"===Gi(this,ne)?this.updateQuickEditLevel("tp",s.tp,i):"sl"===Gi(this,ne)?this.updateQuickEditLevel("sl",s.sl,i):"trigger"===Gi(this,ne)&&this.updateQuickEditLevel("trigger",s.priceTrigger,i);this.drawOrder(s)})),Xi(this,be,(()=>{Gi(this,he)&&Gi(this,oe).endQuickEditOrder(),this.clickData=null,Ji(this,ne,void 0),Ji(this,he,!1),this.chart.app.stage.removeEventListener("pointermove",Gi(this,me)),this.chart.app.stage.removeEventListener("pointerup",Gi(this,be))})),Xi(this,Se,(e=>{var s;if(e.target instanceof wr){const i=dn(e.target),r=null==(s=e.target)?void 0:s.name;i instanceof t&&r?(this.hover={id:r,x:e.globalX,y:e.globalY},this.draw()):void 0!==this.hover&&(this.hover=void 0,this.draw())}})),Xi(this,we,(()=>{this.hover&&(this.hover=void 0,this.draw())})),Xi(this,fe,Er((t=>{if(null==t||t.stopPropagation(),t&&t.target instanceof wr){const e=t.target.name;Gi(this,ie).setSelectedForEdit(e??void 0),this.interactionStore.setSelectedOrder(e??void 0)}}))),this.ordersStore=n,Ji(this,ie,l),Ji(this,re,c),Ji(this,oe,d),Ji(this,ee,this.settings.subscribe(Gi(this,ae)))}_draw(){this.ordersStore.getOrdersBySymbol(this.chart.bars.symbol).forEach((t=>this.drawOrder(t.value)))}drawOrder(t){const{buyLine:e,buyText:s,sellLine:i,sellText:r,blurLine:o,blurText:n}=this.chart.colors.tradeMark,{order:h,volumeValue:a,isBuy:l,price:c,type:d,typeName:u,sl:p,tp:y,priceTrigger:g,symbol:m}=t,{quickEdit:b}=this.interactionStore,S=this.interactionStore.selectedOrder===h,w=this.getLevels(c,S&&b.sl?b.sl:p,S&&b.tp?b.tp:y,S&&b.trigger?b.trigger:g);if(!(w.price.inSection||w.sl.inSection||w.tp.inSection||w.trigger.inSection))return;const f=this._createGraphics(h);f.name=h,f.eventMode="static",f.cursor=h===this.interactionStore.selectedOrder?"ns-resize":"pointer",this.container.addChild(f);let k=l?{line:e,text:s}:{line:i,text:r};if((this.interactionStore.selectedOrder!==h||this.layoutStore.tradeEdit||null!==this.layoutStore.tradeCreate)&&(k={line:o,text:n}),!this.layoutStore.tradeEdit||this.interactionStore.selectedForEdit!==h){if(w.price.inSection){let t=`${u.toUpperCase()} ${a} at ${lr(S&&b.price?b.price:c,this.chart.digits)}`;if(S&&Gi(this,he)&&b.price&&"price"===Gi(this,ne)){const e=Gi(this,oe).getMarketPrice(m,d);t+=`, ${Gi(this,oe).getProfit(m,a,l,e,b.price)}, ${Gi(this,oe).getPoints(m,l,e,b.price)}`}this.drawHorizontalLine(f,h,S&&b.price?this.valueToY(b.price):w.price.y,S&&b.price?b.price:c,k,t,this.interactionStore.selectedOrder!==h,!0)}if(w.sl.inSection&&null!==w.sl.y&&Ki(this,le,ue).call(this,f,t,w.sl.y),w.tp.inSection&&null!==w.tp.y&&Ki(this,le,pe).call(this,f,t,w.tp.y),g&&w.trigger.inSection&&null!==w.trigger.y){const t=`STOP LIMIT PRICE ${a} at ${lr(S&&b.trigger?b.trigger:g,this.chart.digits)}`;this.drawHorizontalLine(f,h,S&&b.trigger?this.valueToY(b.trigger):w.trigger.y,S&&b.trigger?b.trigger:g,S?k:{line:o,text:n},t,this.interactionStore.selectedOrder!==h,!0)}if(this.hover&&this.hover.id===this.interactionStore.selectedOrder&&!Gi(this,he)){const t=this._createGraphics("tooltip");this.container.addChild(t),this.drawTooltip(t,window.window.tr(window.lang.trade.marks.drag))}}}destroy(){super.destroy(),this.container.removeEventListener("pointerdown",Gi(this,ye)),fr()||(this.container.removeEventListener("pointerdown",Gi(this,fe)),this.container.removeEventListener("pointerover",Gi(this,Se)),this.container.removeEventListener("pointerleave",Gi(this,we))),Gi(this,ee)&&(Gi(this,ee).call(this),Ji(this,ee,void 0)),Gi(this,Kt)&&(Gi(this,Kt).call(this),Ji(this,Kt,void 0)),Gi(this,Zt)&&(Gi(this,Zt).call(this),Ji(this,Zt,void 0)),Gi(this,te)&&(Gi(this,te).call(this),Ji(this,te,void 0)),Gi(this,se)&&(Gi(this,se).call(this),Ji(this,se,void 0))}};const wn=class t extends gn{constructor(){super(...arguments),this.type=t.type,this.title=t.title,this.uid="orders_trade_mark",this.fullTitle=t.fullTitle}};wn.type="orders_trade_mark",wn.title="Orders Trade Mark",wn.fullTitle=wn.title;let fn=wn;ke=new WeakMap,ve=new WeakMap,Me=new WeakMap,Te=new WeakMap,Pe=new WeakMap,Le=new WeakMap,Oe=new WeakMap,xe=new WeakMap,Ce=new WeakMap,We=new WeakMap,Be=new WeakMap,Ee=new WeakMap,_e=new WeakMap,De=new WeakMap,He=new WeakSet,qe=function(t){t?(this.container.addEventListener("pointerdown",Gi(this,ze)),fr()||(this.container.interactive||(this.container.eventMode="static"),this.container.addEventListener("pointerdown",Gi(this,Ye)),this.container.addEventListener("pointerover",Gi(this,Je)),this.container.addEventListener("pointerleave",Gi(this,Ke))),Ji(this,ke,this.interactionStore.subscribe(Gi(this,Ae))),Ji(this,ve,this.layoutStore.subscribe(Gi(this,Ae))),Ji(this,Me,this.positionsStore.subscribe(Gi(this,Ae))),Ji(this,Le,Gi(this,Ce).subscribe(Gi(this,Ae))),Gi(this,Oe)||Ji(this,Te,Gi(this,Be).subscribe(Gi(this,Ae)))):(this.container.removeEventListener("pointerdown",Gi(this,ze)),fr()||(this.container.removeEventListener("pointerdown",Gi(this,Ye)),this.container.removeEventListener("pointerover",Gi(this,Je)),this.container.removeEventListener("pointerleave",Gi(this,Ke))),Gi(this,ke)&&(Gi(this,ke).call(this),Ji(this,ke,void 0)),Gi(this,ve)&&(Gi(this,ve).call(this),Ji(this,ve,void 0)),Gi(this,Me)&&(Gi(this,Me).call(this),Ji(this,Me,void 0)),Gi(this,Le)&&(Gi(this,Le).call(this),Ji(this,Le,void 0)),Gi(this,Te)&&(Gi(this,Te).call(this),Ji(this,Te,void 0)))},Ae=new WeakMap,je=function(t){const e=this._createGraphics(t),s=this._createGraphics(`${t}mask`),i=this.createMask();return s.mask=i,e.addChild(s),e.name=t,e.eventMode="static",e.cursor=t===this.interactionStore.selectedPosition?"ns-resize":"pointer",this.container.addChild(e),{graphics:e,graphicsMask:s}},Ne=function(t,e){const{buyLine:s,buyText:i,buyArrow:r,buyArrowBorder:o,sellLine:n,sellText:h,sellArrow:a,sellArrowBorder:l,blurLine:c,blurText:d,blurArrow:u,blurArrowBorder:p}=this.chart.colors.tradeMark,{id:y,isBuy:g,timeCreate:m,priceOpen:b,sl:S,tp:w}=t,f=this.getLevels(b,S,w);if(!(f.price.inSection||f.sl.inSection||f.tp.inSection))return;const k=this._createGraphics(y);k.name=y,k.eventMode="static",k.cursor=y===this.interactionStore.selectedPosition?"ns-resize":"pointer",this.container.addChild(k);const v=e&&this.interactionStore.selectedPosition!==y||this.layoutStore.tradeEdit||null!==this.layoutStore.tradeCreate;let M=g?{line:s,text:i}:{line:n,text:h};v&&(M={line:c,text:d}),Ki(this,He,Fe).call(this,k,t,f,M);const T=this.getXPosition(m),P=T<this.section.width-3.5&&T>0;if(f.price.inSection&&P){let t=g?{arrow:r,border:o}:{arrow:a,border:l};!(this.interactionStore.selectedPosition===y)&&v&&(t={arrow:u,border:p}),this.drawArrow(k,T,f.price.y,g,t)}},Re=function(t,e){const{buyLine:s,buyText:i,sellLine:r,sellText:o,blurLine:n,blurText:h}=this.chart.colors.tradeMark,{id:a,isBuy:l,priceOpen:c,sl:d,tp:u}=t,{graphics:p,graphicsMask:y}=Ki(this,He,je).call(this,a),g=e&&this.interactionStore.selectedPosition!==a||this.layoutStore.tradeEdit||null!==this.layoutStore.tradeCreate;let m=l?{line:s,text:i}:{line:r,text:o};g&&(m={line:n,text:h});const b=this.getLevels(c,d,u);Ki(this,He,Fe).call(this,p,t,b,m),Ki(this,He,Ve).call(this,p,y,t,g)},Fe=function(t,e,s,i){const{id:r,volumeValue:o,priceOpen:n,typeName:h}=e;if(!this.layoutStore.tradeEdit||this.interactionStore.selectedForEdit!==r){if(s.price.inSection){const e=h.length?`${h.toUpperCase()} ${o} at ${lr(n,this.chart.digits)}`:"";this.drawHorizontalLine(t,r,s.price.y,n,i,e,this.interactionStore.selectedPosition!==r,!0)}const{quickEdit:a}=this.interactionStore;(s.sl.inSection&&null!==s.sl.y||a.sl)&&Ki(this,He,Ie).call(this,t,e,s),(s.tp.inSection&&null!==s.tp.y||a.tp)&&Ki(this,He,$e).call(this,t,e,s)}},Ie=function(t,e,s){const{id:i,volumeValue:r,isBuy:o,priceOpen:n,sl:h,symbol:a}=e,l=this.interactionStore.selectedPosition===i;if(!Gi(this,Ce).showSlTp&&!l)return;const{slLine:c,slText:d,blurLine:u,blurText:p}=this.chart.colors.tradeMark,{quickEdit:y}=this.interactionStore;let g=`SL at ${lr(l&&y.sl?y.sl:h,this.chart.digits)}`;l&&Gi(this,_e)&&y.sl&&("sl"===Gi(this,Ee)||"price"===Gi(this,Ee))&&(g+=`, ${Gi(this,We).getProfit(a,r,o,n,y.sl)}, ${Gi(this,We).getPoints(a,o,n,y.sl)}`),this.drawHorizontalLine(t,i,l&&y.sl?this.valueToY(y.sl):s.sl.y??0,l&&y.sl?y.sl:h,l?{line:c,text:d}:{line:u,text:p},g,this.interactionStore.selectedPosition!==i,!0)},$e=function(t,e,s){const{id:i,volumeValue:r,isBuy:o,priceOpen:n,tp:h,symbol:a}=e,l=this.interactionStore.selectedPosition===i;if(!Gi(this,Ce).showSlTp&&!l)return;const{tpLine:c,tpText:d,blurLine:u,blurText:p}=this.chart.colors.tradeMark,{quickEdit:y}=this.interactionStore;let g=`TP at ${lr(l&&y.tp?y.tp:h,this.chart.digits)}`;l&&Gi(this,_e)&&y.tp&&("tp"===Gi(this,Ee)||"price"===Gi(this,Ee))&&(g+=`, ${Gi(this,We).getProfit(a,r,o,n,y.tp)}, ${Gi(this,We).getPoints(a,o,n,y.tp)}`),this.drawHorizontalLine(t,i,l&&y.tp?this.valueToY(y.tp):s.tp.y??0,l&&y.tp?y.tp:h,l?{line:c,text:d}:{line:u,text:p},g,this.interactionStore.selectedPosition!==i,!0)},Ve=function(t,e,s,i=!1){const{id:r,isBuy:o}=s,n=Gi(this,Be).getDealsBySymbolAndPosition(this.chart.bars.symbol,r);if(!n)return;const{buyLine:h,buyText:a,buyArrow:l,buyArrowBorder:c,sellLine:d,sellText:u,sellArrow:p,sellArrowBorder:y,blurLine:g,blurText:m,blurArrow:b,blurArrowBorder:S}=this.chart.colors.tradeMark;let w=o?{line:h,text:a}:{line:d,text:u};i&&(w={line:g,text:m});let f=this.getXPosition(n[0].value.timeCreate),k=this.valueToY(n[0].value.priceOpen),v=f<this.section.width&&f>0&&k<this.section.height&&k>0;if(1===(null==n?void 0:n.length)){const t=n[0].value.isBuy;let s=t?{arrow:l,border:c}:{arrow:p,border:y};return i&&(s={arrow:b,border:S}),void this.drawArrow(e,f,k,t,s)}for(let M=1;M<n.length;M++){const{priceOpen:s,timeCreate:h,volumeValue:a}=n[M].value,l=this.getXPosition(h),c=this.valueToY(s),d=l<this.section.width&&l>0&&c<this.section.height&&c>0;if(v&&Ki(this,He,Ue).call(this,t,n[M-1],f,k,i),(v||d)&&Br(e,f,k,l,c,{color:w.line,dash:4}),M===n.length-1&&d&&Ki(this,He,Ue).call(this,t,n[M],l,c,i),r===this.interactionStore.selectedPosition&&0===M&&!this.settings.selectedDeal){const e=`${o?"BUY":"SELL"} ${a} at ${lr(s,this.chart.digits)}`;this.drawHorizontalLine(t,r,c,s,w,e,!0,!0)}f=l,k=c,v=d}},Ue=function(t,e,s,i,r=!1){const{priceOpen:o,deal:n,volumeValue:h}=e.value,{buyLine:a,buyText:l,buyArrow:c,buyArrowBorder:d,sellLine:u,sellText:p,sellArrow:y,sellArrowBorder:g,blurLine:m,blurText:b,blurArrow:S,blurArrowBorder:w}=this.chart.colors.tradeMark,f=e.value.isBuy;let k=f?{line:a,text:l}:{line:u,text:p};r&&(k={line:m,text:b});const v=this._createGraphics(n),M=this.createMask();v.mask=M;let T=f?{arrow:c,border:d}:{arrow:y,border:g};if(r&&(T={arrow:S,border:w}),this.drawArrow(v,s,i,f,T),v.name=n,v.eventMode="static",this.settings.selectedDeal===n){const e=`${f?"BUY":"SELL"} ${h} at ${lr(o,this.chart.digits)}`;this.drawHorizontalLine(t,n,i,o,k,e,!0,!0)}t.addChild(v)},ze=new WeakMap,Qe=new WeakMap,Ye=new WeakMap,Ge=new WeakMap,Xe=new WeakMap,Je=new WeakMap,Ke=new WeakMap;let kn=class t extends un{constructor(e,s=6e3,i,r,o,n,h,a,l,c,d,u,p){super(e,s,i,r,o,n,h,a),Xi(this,He),Xi(this,ke),Xi(this,ve),Xi(this,Me),Xi(this,Te),Xi(this,Pe),Xi(this,Le),Xi(this,Oe,!1),Xi(this,xe),Xi(this,Ce),Xi(this,We),Xi(this,Be),Xi(this,Ee),Xi(this,_e,!1),Xi(this,De,(()=>{this.settings.visible!==this.prevVisible&&(this.prevVisible=this.settings.visible,Ki(this,He,qe).call(this,this.settings.visible))})),Xi(this,Ae,Zi(50,(()=>{this.draw()}))),Xi(this,ze,Zi(500,(t=>{var e,s;const{x:i,y:r}=t.global;if(this.clickData={x:i,y:r},this.interactionStore.selectedPosition&&t.target instanceof wr&&(null==(e=t.target)?void 0:e.name)&&(null==(s=t.target)?void 0:s.name)===this.interactionStore.selectedPosition){t.stopPropagation();const e=this.positionsStore.getPosition(this.interactionStore.selectedPosition);if(!e)return;const{priceOpen:s,sl:i,tp:o}=e,n=this.getLevels(s,i,o),h=!!n.price.y&&Math.abs(n.price.y-r)<=8,a=!!n.tp.y&&Math.abs(n.tp.y-r)<=8,l=!!n.sl.y&&Math.abs(n.sl.y-r)<=8;a?Ji(this,Ee,"tp"):l?Ji(this,Ee,"sl"):h&&Ji(this,Ee,"price"),this.chart.app.stage.addEventListener("pointermove",Gi(this,Ge)),this.chart.app.stage.addEventListener("pointerup",Gi(this,Xe))}else this.chart.app.stage.addEventListener("pointerup",Gi(this,Qe))}))),Xi(this,Qe,(e=>{var s;const{x:i,y:r}=e.data.global;if(this.clickData&&Math.abs(i-this.clickData.x)<3&&Math.abs(r-this.clickData.y)<3&&e.target instanceof wr){const i=dn(e.target),r=null==(s=e.target)?void 0:s.name;if(i instanceof t){if(r)if(Gi(this,Oe))Gi(this,We).onSelectPositionMark(r),(this.layoutStore.tradeEdit||null!==this.layoutStore.tradeCreate)&&Gi(this,xe).setSelectedForEdit(r);else{const t=this.positionsStore.positionHas(r),e=Gi(this,Be).dealHas(r);if(t)Gi(this,We).onSelectPositionMark(r),(this.layoutStore.tradeEdit||null!==this.layoutStore.tradeCreate)&&Gi(this,xe).setSelectedForEdit(r);else if(e){this.settings.selectedDeal=r;const t=Gi(this,Be).getDeal(this.settings.selectedDeal);t&&(Gi(this,We).onSelectPositionMark(null==t?void 0:t.position),(this.layoutStore.tradeEdit||null!==this.layoutStore.tradeCreate)&&Gi(this,xe).setSelectedForEdit(null==t?void 0:t.position))}}}else this.layoutStore.tradeEdit||null!==this.layoutStore.tradeCreate||(this.settings.selectedDeal="",this.interactionStore.setSelectedPosition())}this.clickData=null,this.chart.app.stage.removeEventListener("pointerup",Gi(this,Qe))})),Xi(this,Ye,Er((t=>{if(null==t||t.stopPropagation(),(null==t?void 0:t.target)instanceof wr){const e=t.target.name;Gi(this,xe).setSelectedForEdit(e??void 0),this.interactionStore.setSelectedPosition(e??void 0)}}))),Xi(this,Ge,(t=>{const{y:e}=t.global;if(!this.clickData||Math.abs(e-this.clickData.y)<3&&!Gi(this,_e))return;Ji(this,_e,!0);const s=this.positionsStore.getPosition(this.interactionStore.selectedPosition);if(!s)return;const i=e-this.clickData.y;if("price"===Gi(this,Ee)){const{quickEdit:t}=this.interactionStore;0===s.sl&&(s.isBuy&&i>0||s.isSell&&i<0)&&(this.updateQuickEditLevel("sl",s.priceOpen,i),0===s.tp&&t.tp&&(t.tp=null)),0===s.tp&&(s.isBuy&&i<0||s.isSell&&i>0)&&(this.updateQuickEditLevel("tp",s.priceOpen,i),0===s.sl&&t.sl&&(t.sl=null))}else"tp"===Gi(this,Ee)?this.updateQuickEditLevel("tp",s.tp,i):"sl"===Gi(this,Ee)&&this.updateQuickEditLevel("sl",s.sl,i);const r=this.hasSelectedOnSymbol(this.chart.bars.symbol);Gi(this,Oe)?Ki(this,He,Ne).call(this,s,r):Ki(this,He,Re).call(this,s,r)})),Xi(this,Xe,(()=>{Gi(this,_e)&&Gi(this,We).endQuickEditPosition(),this.clickData=null,Ji(this,Ee,void 0),Ji(this,_e,!1),this.chart.app.stage.removeEventListener("pointermove",Gi(this,Ge)),this.chart.app.stage.removeEventListener("pointerup",Gi(this,Xe))})),Xi(this,Je,(e=>{var s;if(e.target instanceof wr){const i=dn(e.target),r=null==(s=e.target)?void 0:s.name;if(i instanceof t&&r){const t=this.positionsStore.getPosition(this.interactionStore.selectedPosition);if(!t)return;if(t.sl&&t.tp){const{y:s}=e.global,{priceOpen:i,sl:r,tp:o}=t,n=this.getLevels(i,r,o);if(n.price.y&&Math.abs(n.price.y-s)<=10)return}this.hover={id:r,x:e.globalX,y:e.globalY},this.draw()}else void 0!==this.hover&&(this.hover=void 0,this.draw())}})),Xi(this,Ke,(()=>{this.hover&&(this.hover=void 0,this.draw())})),Ji(this,Oe,l),Ji(this,xe,c),this.positionsStore=o,Ji(this,Ce,d),Ji(this,We,u),Ji(this,Be,p),Ji(this,Pe,this.settings.subscribe(Gi(this,De)))}_draw(){const t=this.positionsStore.getPositionsBySymbol(this.chart.bars.symbol);if(0===t.length)return;const e=this.hasSelectedOnSymbol(this.chart.bars.symbol);if(Gi(this,Oe)?t.forEach((t=>{Ki(this,He,Ne).call(this,t.value,e)})):Ki(this,He,Re).call(this,t[0].value,e),this.hover&&this.hover.id===this.interactionStore.selectedPosition&&!Gi(this,_e)){const t=this._createGraphics("tooltip");this.container.addChild(t),this.drawTooltip(t,window.window.tr(window.lang.trade.marks.drag))}}destroy(){super.destroy(),this.container.removeEventListener("pointerdown",Gi(this,ze)),fr()||(this.container.removeEventListener("pointerdown",Gi(this,Ye)),this.container.removeEventListener("pointerover",Gi(this,Je)),this.container.removeEventListener("pointerleave",Gi(this,Ke))),Gi(this,Pe)&&(Gi(this,Pe).call(this),Ji(this,Pe,void 0)),Gi(this,ke)&&(Gi(this,ke).call(this),Ji(this,ke,void 0)),Gi(this,ve)&&(Gi(this,ve).call(this),Ji(this,ve,void 0)),Gi(this,Me)&&(Gi(this,Me).call(this),Ji(this,Me,void 0)),Gi(this,Le)&&(Gi(this,Le).call(this),Ji(this,Le,void 0)),Gi(this,Te)&&(Gi(this,Te).call(this),Ji(this,Te,void 0))}};const vn=class t extends gn{constructor(){super(...arguments),this.type="positions_trade_mark",this.title=t.title,this.fullTitle=t.fullTitle,this.uid="positions_trade_mark",this.selectedDeal=""}};vn.title="Positions Trade Mark",vn.fullTitle=vn.title;let Mn=vn;class Tn extends Or{constructor(t,e,s,i,r,o,n,h){super(t),Xi(this,Ze),Xi(this,ts),Xi(this,es),Xi(this,ss),Xi(this,is),Xi(this,rs),Xi(this,os),Xi(this,ns),this.data=[],Ji(this,Ze,{}),Ji(this,ts,{}),Ji(this,ns,h),Ji(this,es,s),Ji(this,ss,i),Ji(this,is,r),Ji(this,rs,e),Ji(this,os,o)}setVisible(t,e){const s=Gi(this,ts)[t];s&&(s.settings.visible=e,s.settings.refresh(),this.trigger("208",t))}getOptions(t){let e=this.chart.sections.getByIndex(0);return 4&t&&(e=this.chart.sections.add()),this.chart.createOptions(e)}get(t){const e=Gi(this,Ze)[t];return this.data[e]}getOrderMarks(){var t;return null==(t=Gi(this,ts).orders_trade_mark)?void 0:t.settings}getPositionMarks(){var t;return null==(t=Gi(this,ts).positions_trade_mark)?void 0:t.settings}getHistoryMarks(){var t;return null==(t=Gi(this,ts).history_trade_mark)?void 0:t.settings}addOrdersMarks(t){const e=this.getOptions(fn.flags),s=new fn(t),i=new Sn(e,6e3,s,Gi(this,es).interactionStore,Gi(this,ss).positionsStore,Gi(this,ss).ordersStore,Gi(this,os).historyPositionsStore,Gi(this,ns),Gi(this,es),Gi(this,rs).marksStore,Gi(this,rs));return this.data[0]=i,Gi(this,ts).orders_trade_mark=i,Gi(this,Ze).orders_trade_mark=0,this.trigger("201",s.uid),i.settings.uid}addPositionMarks(t){const e=this.getOptions(Mn.flags),s=new Mn(t),i=new kn(e,6e3,s,Gi(this,es).interactionStore,Gi(this,ss).positionsStore,Gi(this,ss).ordersStore,Gi(this,os).historyPositionsStore,Gi(this,ns),Gi(this,is).accountStore.isHedgedMargin,Gi(this,es),Gi(this,rs).marksStore,Gi(this,rs),Gi(this,os).historyDealsStore);return this.data[1]=i,Gi(this,ts).positions_trade_mark=i,Gi(this,Ze).positions_trade_mark=1,this.trigger("208",s.uid),i.settings.uid}addHistoryMarks(t){const e=this.getOptions(bn.flags),s=new bn(t),i=new pn(e,6e3,s,Gi(this,es).interactionStore,Gi(this,ss).positionsStore,Gi(this,ss).ordersStore,Gi(this,os).historyPositionsStore,Gi(this,ns),Gi(this,is).accountStore.isHedgedMargin,Gi(this,os).historyDealsStore,Gi(this,rs));return this.data[2]=i,Gi(this,ts).history_trade_mark=i,Gi(this,Ze).history_trade_mark=2,this.trigger("208",s.uid),i.settings.uid}remove(t){const e=Gi(this,Ze)[t],s=e&&this.data[e];s&&(s.destroy(),delete Gi(this,Ze)[t],delete Gi(this,ts)[t],this.trigger("202",t))}removeAll(){"number"==typeof Gi(this,Ze).orders_trade_mark&&this.data[Gi(this,Ze).orders_trade_mark].destroy(),"number"==typeof Gi(this,Ze).positions_trade_mark&&this.data[Gi(this,Ze).positions_trade_mark].destroy(),"number"==typeof Gi(this,Ze).history_trade_mark&&this.data[Gi(this,Ze).history_trade_mark].destroy()}destroy(){this.data.forEach((t=>t.destroy())),super.destroy()}}Ze=new WeakMap,ts=new WeakMap,es=new WeakMap,ss=new WeakMap,is=new WeakMap,rs=new WeakMap,os=new WeakMap,ns=new WeakMap;class Pn{constructor(t,e,s,i,r,o,n,h,a,l,c,d){Xi(this,hs),Xi(this,as),Xi(this,ls),Xi(this,cs),Xi(this,ds),Xi(this,us),Xi(this,ps),Xi(this,ys),Xi(this,gs),Xi(this,ms),Xi(this,bs,(()=>{Gi(this,hs).add({showSlTp:this.marksStore.showSlTp,showTradeOrders:this.marksStore.showTradeOrders,showTradePositions:this.marksStore.showTradePositions,showTradeHistory:this.marksStore.showTradeHistory});const t=this.marksManager.getOrderMarks();if(t){const{uid:e}=t;this.marksManager.visible(e,this.marksStore.showTradeOrders)}const e=this.marksManager.getPositionMarks();if(e){const{uid:t}=e;this.marksManager.visible(t,this.marksStore.showTradePositions)}const s=this.marksManager.getHistoryMarks();if(s){const{uid:t}=s;this.marksManager.visible(t,this.marksStore.showTradeHistory)}})),this.marksStore=e,Ji(this,as,s),Ji(this,ls,i),Ji(this,cs,r),Ji(this,ds,o),Ji(this,us,n),Ji(this,ps,h),Ji(this,ys,l),Ji(this,gs,c),Ji(this,ms,d),this.marksManager=new Tn(Gi(this,ls).chart,this,Gi(this,as),Gi(this,ds),Gi(this,cs),Gi(this,us),Gi(this,ps),a),this.marksManager.addOrdersMarks(),this.marksManager.addPositionMarks(),this.marksManager.addHistoryMarks(),Ji(this,hs,t)}async init(){const t=(await Gi(this,hs).getAll())[0]||{};this.marksStore.setOptions(t),this.marksStoreUnsubscribe&&(this.marksStoreUnsubscribe(),delete this.marksStoreUnsubscribe),this.marksStoreUnsubscribe=this.marksStore.subscribe(Gi(this,bs))}destroy(){this.marksStoreUnsubscribe&&(this.marksStoreUnsubscribe(),delete this.marksStoreUnsubscribe)}toggleOrdersTradeMarks(t=!this.marksStore.showTradeOrders){this.marksStore.setOptions({showTradeOrders:t})}togglePositionsTradeMarks(t=!this.marksStore.showTradePositions){this.marksStore.setOptions({showTradePositions:t})}toggleHistoryTradeMarks(t=!this.marksStore.showTradeHistory){this.marksStore.setOptions({showTradeHistory:t})}async onSelectOrderMark(t){await tr(),Gi(this,as).interactionStore.setSelectedOrder(t)}async onSelectPositionMark(t){await tr(),Gi(this,as).interactionStore.setSelectedPosition(t)}async onSelectHistoryMark(t){await tr(),Gi(this,as).interactionStore.setSelectedHistoryPosition(t)}endQuickEditOrder(){if(1===Gi(this,ys).oneClick){const t=Gi(this,ds).ordersStore.getOrder(Gi(this,as).interactionStore.selectedOrder);if(!t)return;const e=Gi(this,ps).getBySymbol(t.symbol);if(!e)return;const s=Gi(this,ps).allowedTradeBySymbol(t.symbol),i=e.stopsLevel?e.stopsLevel/10**e.digits:0,r=this.getMarketPrice(t.symbol,t.type),o=Gi(this,as).interactionStore.quickEdit;if(!s||Gi(this,ds).utils.calcOrderDisable(e,t,o.price??t.price,o.sl??t.sl,o.tp??t.tp,o.trigger??t.priceTrigger??null,t.expiration,t.date,t.comment,r,i))return void Gi(this,as).interactionStore.resetQuickEdit();2===t.type||3===t.type||4===t.type||5===t.type?Gi(this,ds).modifyLimitOrder({type:t.type,id:t.order,sl:o.sl??t.sl,tp:o.tp??t.tp,price:o.price??t.price,expiration:t.expiration,date:t.date,comment:t.comment}):7!==t.type&&6!==t.type||Gi(this,ds).modifyStopLimitOrder({type:t.type,id:t.order,sl:o.sl??t.sl,tp:o.tp??t.tp,price:o.price??t.price,trigger:o.trigger??t.priceTrigger??0,expiration:t.expiration,date:t.date,comment:t.comment})}else Gi(this,as).setSelectedForEdit(Gi(this,as).interactionStore.selectedOrder)}endQuickEditPosition(){if(1===Gi(this,ys).oneClick){const{selectedPosition:t}=Gi(this,as).interactionStore,e=Gi(this,ds).positionsStore.getPosition(t);if(!e)return;const s=Gi(this,ps).getBySymbol(e.symbol);if(!s)return;const i=Gi(this,ps).allowedTradeBySymbol(e.symbol),r=s.stopsLevel?s.stopsLevel/10**s.digits:0,o=this.getMarketPrice(e.symbol,e.isBuy?0:1),n=Gi(this,as).interactionStore.quickEdit;if(!i||Gi(this,ds).utils.calcPositionDisable(e,n.sl??e.sl,n.tp??e.tp,Number(e.volume),e.comment,o,r))return void Gi(this,as).interactionStore.resetQuickEdit();Gi(this,ds).modifyPosition({id:e.id,sl:n.sl??e.sl,tp:n.tp??e.tp,comment:e.comment}),Gi(this,as).interactionStore.resetQuickEdit()}else Gi(this,as).setSelectedForEdit(Gi(this,as).interactionStore.selectedPosition)}getProfit(t,e,s,i,r){const o=Gi(this,cs).accountStore.currency;return`${Gi(this,ds).calcProfit(t,e,s,i,r)} ${o}`}getPoints(t,e,s,i){const r=Gi(this,ps).getBySymbol(t);return(null==r?void 0:r.multiply)?`${((e?i-s:s-i)*r.multiply).toFixed(0)} points`:""}getMarketPrice(t,e){const s=Gi(this,gs).ticksStore.getTick(t);let i=0;return Gi(this,ms).isBuy(e)?i=s.ask:Gi(this,ms).isSell(e)&&(i=s.bid),i}}hs=new WeakMap,as=new WeakMap,ls=new WeakMap,cs=new WeakMap,ds=new WeakMap,us=new WeakMap,ps=new WeakMap,ys=new WeakMap,gs=new WeakMap,ms=new WeakMap,bs=new WeakMap;var Ln=Object.defineProperty,On=Object.getOwnPropertyDescriptor;class xn extends sr{constructor(){super(),this._systemName=ar.marks,this.showTradeOrders=!1,this.showTradePositions=!1,this.showTradeHistory=!1,this.showSlTp=!1}setOptions(t){this.showTradeOrders=t.showTradeOrders??this.showTradeOrders,this.showTradePositions=t.showTradePositions??this.showTradePositions,this.showTradeHistory=t.showTradeHistory??this.showTradeHistory,this.showSlTp=t.showSlTp??this.showSlTp}}((t,e,s)=>{for(var i,r=On(e,s),o=t.length-1;o>=0;o--)(i=t[o])&&(r=i(e,s,r)||r);r&&Ln(e,s,r)})([ir],xn.prototype,"setOptions");class Cn{constructor(t,e,s,i,r,o,n,h,a,l,c){this.marksStore=new xn,this.marksController=new Pn(t,this.marksStore,e,s,i,r,o,n,h,a,l,c)}}class Wn{constructor(t,e,s){Xi(this,Ss),Xi(this,ws),this.interactionStore=t,Ji(this,Ss,e),Ji(this,ws,s)}setSelectedForEdit(t=""){Gi(this,ws).tradeStore.resetRequest(),t&&(Gi(this,ws).ordersStore.orderHas(t)||Gi(this,ws).positionsStore.positionHas(t))?(Gi(this,Ss).layoutStore.setLayout({tradeEdit:!1,tradeCreate:null}),tr().then((()=>{Gi(this,Ss).layoutStore.setLayout({tradeEdit:!0}),this.interactionStore.setSelectedForEdit(t)}))):this.interactionStore.setSelectedForEdit()}}Ss=new WeakMap,ws=new WeakMap;var Bn=Object.defineProperty,En=Object.getOwnPropertyDescriptor,_n=(t,e,s,i)=>{for(var r,o=En(e,s),n=t.length-1;n>=0;n--)(r=t[n])&&(o=r(e,s,o)||o);return o&&Bn(e,s,o),o};class Dn extends sr{constructor(){super(),this.selectedForEdit="",this.selectedPosition="",this.selectedOrder="",this.selectedHistoryPosition="",this.quickEdit={tp:null,sl:null,price:null,trigger:null}}resetSelected(t=!0){this.selectedPosition="",this.selectedOrder="",this.selectedHistoryPosition="",this.resetQuickEdit(!1),t&&this.refresh()}resetQuickEdit(t=!0){this.quickEdit={tp:null,sl:null,price:null,trigger:null},t&&this.refresh()}setSelectedPosition(t=""){this.resetSelected(!1),this.selectedPosition=t}setSelectedOrder(t=""){this.resetSelected(!1),this.selectedOrder=t}setSelectedHistoryPosition(t=""){this.resetSelected(!1),this.selectedHistoryPosition=t}setSelectedForEdit(t=""){this.selectedForEdit=t}}_n([ir],Dn.prototype,"setSelectedPosition"),_n([ir],Dn.prototype,"setSelectedOrder"),_n([ir],Dn.prototype,"setSelectedHistoryPosition"),_n([ir],Dn.prototype,"setSelectedForEdit");class Hn{constructor(t,e){this.interactionStore=new Dn,this.interactionController=new Wn(this.interactionStore,t,e)}}class qn{constructor(t,e,s){Xi(this,fs),Xi(this,ks),Xi(this,vs),Xi(this,Ms,(t=>{var e,s;const i=Gi(this,vs).call(this,t.code),r=Gi(this,ks).call(this,t.code);var o;this.add({id:(null==(e=t.result)?void 0:e.order)||String(Math.round(1e4*Math.random())),type:t.action.typeName,symbol:t.action.symbol??"",isBuy:t.action.isBuy,isClose:t.action.isClose,isCloseBy:t.action.isCloseBy,isMarket:t.action.isMarket,isPending:t.action.isPending,isSell:t.action.isSell,volume:String(t.action.volume),price:t.action.priceOrder?lr(t.action.priceOrder,t.action.digits):"",time:(o=null==(s=t.result)?void 0:s.time,o?cr(new Date(o),"hhhh:mm:ss"):""),code:t.code},i||r?this.noticesStore.types.Info:this.noticesStore.types.Error)})),Ji(this,fs,t),Ji(this,ks,e.isSuccessCode),Ji(this,vs,e.isLoadingCode),this.printError=e.printError,this.noticesStore=s}init(){Gi(this,fs).off(2,Gi(this,Ms)),Gi(this,fs).on(2,Gi(this,Ms))}destroy(){var t;null==(t=Gi(this,fs))||t.off(2,Gi(this,Ms))}add(t,e,s=4e3){const i=this.noticesStore.add(t.id,t,e);i.timeout&&clearTimeout(i.timeout),i.timeout=window.setTimeout((()=>this.noticesStore.delete(t.id)),s)}}fs=new WeakMap,ks=new WeakMap,vs=new WeakMap,Ms=new WeakMap;var An=Object.defineProperty,jn=Object.getOwnPropertyDescriptor,Nn=(t,e,s,i)=>{for(var r,o=jn(e,s),n=t.length-1;n>=0;n--)(r=t[n])&&(o=r(e,s,o)||o);return o&&An(e,s,o),o},Rn=(t=>(t[t.Info=0]="Info",t[t.Warn=1]="Warn",t[t.Error=2]="Error",t))(Rn||{});class Fn extends sr{constructor(){super(),Xi(this,Ps),Xi(this,Ts),this.types=Rn,this._systemName="Messages",this.list=new Map,Ji(this,Ts,5)}reset(){return this.list=new Map,this}changeSize(t){return t>0&&(Ji(this,Ts,t),Ki(this,Ps,Ls).call(this)),Gi(this,Ts)}add(t,e,s){let i=this.list.get(t);return i?(i.data=e,i.type=s):i={id:t,data:e,type:s},this.list.set(t,i),Ki(this,Ps,Ls).call(this),i}delete(t){return this.list.delete(t),this}}Ts=new WeakMap,Ps=new WeakSet,Ls=function(){if(this.list.size>Gi(this,Ts)){const t=this.list.size-Gi(this,Ts);this.list=new Map(Array.from(this.list).slice(t)),this.refresh()}},Nn([ir],Fn.prototype,"add"),Nn([ir],Fn.prototype,"delete");class In{constructor(t,e){this.noticesStore=new Fn,this.noticesController=new qn(t,e,this.noticesStore)}}var $n=Object.defineProperty,Vn=Object.getOwnPropertyDescriptor,Un=(t,e,s,i)=>{for(var r,o=Vn(e,s),n=t.length-1;n>=0;n--)(r=t[n])&&(o=r(e,s,o)||o);return o&&$n(e,s,o),o};class zn extends sr{constructor(){super(),this._systemName=ar.configs,this.data={}}reset(t){this.data={},t.forEach((t=>this.setOptions(t.symbol,t)))}getOptions(t){return this.data[t]?this.data[t]:this.createOptions(t)}createOptions(t){return this.data[t]={period:60,quickTradeVolume:0},this.data[t]}setOptionsFromConfig(t){t.symbol&&(this.refresh(),this.data[t.symbol]=t.getOptions())}setOptions(t,e){return this.data[t]?(this.data[t]={...this.data[t],...e},this.data[t]):(this.data[t]={period:e.period??60,quickTradeVolume:e.quickTradeVolume},this.data[t])}}Un([ir],zn.prototype,"createOptions"),Un([ir],zn.prototype,"setOptions");class Qn extends sr{constructor(){super(...arguments),this._systemName="config",this.symbol="",this.period=60,this.tradeVolume=0,this.quickTradeVolume=0}setOptions(t,e){return void 0!==t.quickTradeVolume&&t.quickTradeVolume!==this.quickTradeVolume&&(this.quickTradeVolume=t.quickTradeVolume,t.quickTradeVolume,this.quickTradeVolume=t.quickTradeVolume),void 0!==t.period&&t.period!==this.period&&(this.period=t.period,t.period),e||this.refresh(),this}reset(t,e){this.symbol=t,this.setOptions(e)}getOptions(){return{tradeVolume:this.tradeVolume,quickTradeVolume:this.quickTradeVolume,symbol:this.symbol,period:this.period}}}class Yn{constructor(t,e,s,i,r){Xi(this,Os),Xi(this,xs,""),Xi(this,Cs),Xi(this,Ws),Xi(this,Bs),Xi(this,Es,Zi(100,(()=>{const t=Gi(this,Cs).symbolsStore.getBySymbol(this.configStore.symbol);let e=!1;if(t&&(this.configStore.tradeVolume>t.lotsMax?(this.configStore.tradeVolume=t.lotsMax,e=!0):this.configStore.tradeVolume<t.lotsMin&&(this.configStore.tradeVolume=t.lotsMin,e=!0),e))return void this.configStore.refresh();const s=this.configStore.getOptions();this.configsStore.setOptions(this.configStore.symbol,s),Gi(this,Os).add({symbol:this.configStore.symbol,period:s.period,quickTradeVolume:s.quickTradeVolume})}))),this.configsStore=e,this.configStore=s,Ji(this,Cs,i),Ji(this,Ws,r),Ji(this,Os,t)}async init(){const t=await Gi(this,Os).getAll();Ji(this,xs,dr.getItem("ss")??""),Gi(this,Bs)&&Gi(this,Bs).call(this),Ji(this,Bs,this.configStore.subscribe(Gi(this,Es))),this.configsStore.reset(t),this.setConfig(Gi(this,xs))}destroy(){Gi(this,Bs)&&Gi(this,Bs).call(this)}setConfig(t){const e=this.getRealSelectedSymbol(t),s=this.configsStore.getOptions(e);Gi(this,xs)!==e&&(Ji(this,xs,e),dr.setItem("ss",Gi(this,xs))),this.configStore.reset(Gi(this,xs),s)}getRealSelectedSymbol(t){let e=t;if(e&&(Boolean(Gi(this,Cs).symbolsStore.getBySymbol(e))||(e="")),!e){if(!Gi(this,Cs).symbolsStore.isEmpty())throw new Error("symbols list is empty");e=Gi(this,Ws).watchlistStore.getList()[0]??Gi(this,Cs).symbolsStore.getFirst().symbol}return e}}Os=new WeakMap,xs=new WeakMap,Cs=new WeakMap,Ws=new WeakMap,Bs=new WeakMap,Es=new WeakMap;class Gn{constructor(t,e,s){this.configsStore=new zn,this.configStore=new Qn,this.configsController=new Yn(t,this.configsStore,this.configStore,e,s)}}function Xn(t,e){const s=new Date(t);if(0!==s.getUTCMilliseconds()||0!==s.getUTCSeconds())return!1;switch(e){case 1:return!0;case 5:return s.getUTCMinutes()%5==0;case 15:return s.getUTCMinutes()%15==0;case 30:return s.getUTCMinutes()%30==0}if(e>=60){if(0!==s.getUTCMinutes())return!1;switch(e){case 60:return!0;case 240:return s.getUTCHours()%4==0}}return!(e>=1440&&0!==s.getUTCHours()||e>=43200&&1!==s.getUTCDate())}class Jn{constructor(t,e,s,i){Xi(this,As),Xi(this,_s),Xi(this,Ds),Xi(this,Hs),Xi(this,qs),this.timeouts={},Ji(this,_s,t),Ji(this,qs,e.toDouble),Ji(this,Ds,s),this.barsStore=i,this.loadBars=this.loadBars.bind(this)}async loadBars(t,e,s,i,r){const o=this.barsStore.find(Gi(this,qs),t,e);return i===s&&i===o.lastTo?null:(o.lastTo=i,o.pending=!0,o.pendingDirection=r,Ki(this,As,js).call(this,t,e,s,i))}async init(){const t=await Gi(this,Ds).getAll();this.barsStore.reset(Gi(this,qs),t)}destroy(){this.barsStore.reset(Gi(this,qs)),Gi(this,Hs)&&Gi(this,Hs).call(this)}find(t,e){return this.barsStore.find(Gi(this,qs),t,e)}update(t,e,s){this.barsStore.add(Gi(this,qs),t,e,s);const i=this.barsStore.find(Gi(this,qs),t,e).buffer;this.updateStorage(t,e,i)}updateStorage(t,e,s){const i=`${t}_${e}`;this.timeouts[i]&&window.clearTimeout(this.timeouts[i]),this.timeouts[i]=window.setTimeout((()=>{Gi(this,Ds).add({id:i,symbol:t,period:e,buffer:s})}),1e3)}}_s=new WeakMap,Ds=new WeakMap,Hs=new WeakMap,qs=new WeakMap,As=new WeakSet,js=async function(t,e,s,i){const r=this.barsStore.find(Gi(this,qs),t,e);let o;try{o=await Gi(this,_s).rates.getRates(t,e,s,i)}catch(n){if(r.pending=!1,r.pendingDirection=0,1e4===ur(n)[0])return r.pending=!1,null;throw n}if(!function(t,e){const s=new Uint32Array(t);for(let i=0,r=s.length;i<r;i+=12)if(!Xn(1e3*s[i],e))return!1;return!0}(o,r.period))throw r.pending=!1,r.pendingDirection=0,new Error(`bars is not aligned by period (${r.symbol}, ${r.period})`);return r.pending=!1,r.real=!0,r.lastLoadedBarTime=r.time(r.length-1),this.update(t,e,o),o};var Kn=Object.defineProperty,Zn=Object.getOwnPropertyDescriptor,th=(t,e,s,i)=>{for(var r,o=Zn(e,s),n=t.length-1;n>=0;n--)(r=t[n])&&(o=r(e,s,o)||o);return o&&Kn(e,s,o),o};class eh extends sr{constructor(){super(),this._systemName=ar.tradeBars,this.data={}}reset(t,e=[]){return this.data={},e.forEach((e=>{this.data[e.symbol]=this.data[e.symbol]||{},this.data[e.symbol][e.period]=new _r(e.symbol,e.period,t,e.buffer)})),this}add(t,e,s,i){const r=this.data[e]&&this.data[e][s];return r?i&&r.impose(i):(this.data[e]=this.data[e]||{},this.data[e][s]=new _r(e,s,t,i)),this.data[e][s]}find(t,e,s){return this.data[e]&&this.data[e][s]||this.add(t,e,s)}extends(t,e){const s=this.data[e.symbol];s&&Object.values(s).forEach((s=>s.extends({chartMode:t.chartMode??0,ticksBookDepth:t.ticksBookDepth??0,digits:t.digits??0},e)))}}th([ir],eh.prototype,"reset"),th([ir],eh.prototype,"add");class sh{constructor(t,e,s){this.barsStore=new eh,this.barsController=new Jn(t,e,s,this.barsStore)}}const ih={volumeType:0,chartType:1,xScale:2,magnet:3,hidden:4,locked:5};class rh extends sr{constructor(){super(...arguments),this._systemName="chart",this.volumeType=0,this.chartType=1,this.xScale=.03336,this.magnet=!1,this.hidden=!1,this.locked=!1}getOptions(){return{volumeType:this.volumeType,chartType:this.chartType,xScale:this.xScale,hidden:this.hidden,magnet:this.magnet,locked:this.locked}}reset(t){this.xScale=t.xScale,this.volumeType=function(t){switch(t){case 0:case 2:case 1:return t;default:return 0}}(t.volumeType),this.chartType=function(t){switch(t){case 1:case 2:case 4:return t;default:return 2}}(t.chartType),this.hidden=Boolean(t.hidden),this.locked=Boolean(t.locked)}}const oh={volumeType:0,chartType:2,xScale:.03336,magnet:!1,hidden:!1,locked:!1},nh=function(t){let e;for(e in t)t[e]===oh[e]?dr.removeItem(`1${ih[e]}`):dr.setItem(`1${ih[e]}`,String(Number(t[e]??"")))},hh=new Set(["USD","JPY","EUR","GBP","CAD","AUD","CHF","CNY","NZD","SEK","BRL","KRW","HKD","MXN","SGD","ZAR","INR","NOK"]);class ah{constructor(t,e,s,i,r,o,n,h,a,l,c,d,u,p,y,g){Xi(this,oi),Xi(this,Ns),Xi(this,Rs),Xi(this,Fs),Xi(this,Is),Xi(this,$s),Xi(this,Vs),Xi(this,Us),Xi(this,zs),Xi(this,Qs),Xi(this,Ys),Xi(this,Gs),Xi(this,Xs),Xi(this,Js),Xi(this,Ks),Xi(this,Zs),Xi(this,ti),Xi(this,ei),Xi(this,si),Xi(this,ii),Xi(this,ri),Xi(this,di,(()=>{this.chart.tick()})),Xi(this,yi,(async(t,e,s,i,r)=>{this.chart.setLoading("Loading...");const o=await Gi(this,ti).loadBars(t,e,s,i,r),n=this.chart.bars;Gi(this,Ks).on(n.symbol);const h=Gi(this,Ks).ticksStore.getTick(n.symbol),a=Gi(this,Zs).symbolsStore.getBySymbol(n.symbol);return n.askPrice=(null==a?void 0:a.digits)?kr(h.ask,a.digits):h.ask,a&&this.chart.setDigits(a.digits),Gi(this,$s)&&Gi(this,$s).call(this),Ji(this,$s,h.subscribe(Gi(this,di))),this.chart.setLoading(),o})),Xi(this,gi,(()=>{const t={};this.chart.setChartType(this.chartStore.chartType)&&(t.chartType=this.chartStore.chartType),this.chart.setVolumeType(this.chartStore.volumeType)&&(t.volumeType=this.chartStore.volumeType),this.chart.setHidden(this.chartStore.hidden)&&(t.hidden=this.chartStore.hidden),this.chart.setLocked(this.chartStore.locked)&&(t.locked=this.chartStore.locked),this.chart.setMagnet(this.chartStore.magnet)&&(t.magnet=this.chartStore.magnet),nh(t)})),Xi(this,mi,(()=>{const t=Dr(Gi(this,Js).themeStore);this.chart.setStyle(t)})),Xi(this,bi,er(100,(()=>{const{uiSettingsStore:t}=Gi(this,Qs);this.chart.setShowAskPrice(t.askPrice),this.chart.setShowGrid(t.grid),this.chart.setShowCrosshair(t.crosshair),this.chart.setMode(t.chartMode),this.updateCalendar()}))),Xi(this,Si,(async()=>{await tr(),this.chart.refresh()})),Xi(this,wi,(async()=>{const{symbol:t,period:e}=Gi(this,ii).configStore,s=Gi(this,Zs).getBySymbol(t);this.chart.sections.init(),await Ki(this,oi,li).call(this),await Ki(this,oi,ci).call(this),await this.updateCalendar(),await this.chart.setBars(Gi(this,ti).find(t,e),null==s?void 0:s.digits)})),Xi(this,fi,(async()=>{const t=Gi(this,Zs).getBySymbol(Gi(this,ii).configStore.symbol);t&&(this.chart.setDigits(t.digits),await this.updateCalendar())})),Xi(this,ki,(t=>{Gi(this,Qs).uiSettingsStore.setSettings({askPrice:t.detail})})),Xi(this,vi,(t=>{Gi(this,Qs).uiSettingsStore.setSettings({grid:t.detail})})),Xi(this,Mi,(t=>{this.chartStore.hidden=t.detail,this.chartStore.refresh()})),Xi(this,Ti,(()=>{Gi(this,Qs).uiSettingsStore.setSettings({chartMode:this.chart.mode}),Gi(this,Qs).uiSettingsStore.refresh()})),Xi(this,Pi,(t=>{this.chartStore.locked!==t.detail&&(this.chartStore.locked=t.detail,this.chartStore.refresh())})),Xi(this,Oi,(t=>{this.chartStore.volumeType=t.detail,this.chartStore.refresh()})),Xi(this,xi,(async()=>{await tr(),this.chart.refresh()})),Xi(this,Ci,(()=>{Gi(this,Xs).sectionMove(this.chart.sections)})),Xi(this,Wi,(t=>{Gi(this,Xs).remove(t.detail)})),Xi(this,Bi,(t=>{const e=this.chart.analysis.get(t.detail);e&&(this.chart.refresh(),Gi(this,Xs).save(e.settings,Gi(this,ii).configStore.symbol))})),Xi(this,Ei,(t=>{Gi(this,Xs).editIndicator(t.detail.uid)})),Xi(this,_i,(t=>{Gi(this,Gs).remove(t.detail)})),Xi(this,Di,(t=>{const e=this.chart.objects.get(t.detail),{symbol:s}=Gi(this,ii).configStore;e&&s&&Gi(this,Gs).save(e.settings,s)})),Ji(this,ri,t),this.chartStore=r,Ji(this,Qs,o),Ji(this,Ys,n),Ji(this,ii,h),Ji(this,Gs,u),Ji(this,Xs,p),Ji(this,Ks,y),Ji(this,Zs,c),Ji(this,ti,l),Ji(this,ei,d),Ji(this,Js,a),Ji(this,si,g);const m=Gi(this,Zs).symbolsStore.getBySymbol(Gi(this,ii).configStore.symbol);this.chartStore.reset(function(){const t={};return Object.keys(ih).forEach((e=>{const s=e,i=function(t){const e=dr.getItem(`1${ih[t]}`);if(null===e)return Number(oh[t]);const s=Number(e);return isNaN(s)?(dr.removeItem(`${ih[t]}`),Number(oh[t])):s}(s);t[s]=i})),t}()),this.chart=new e(Gi(this,Qs).uiSettingsStore.askPrice,Gi(this,Qs).uiSettingsStore.grid,Gi(this,Qs).uiSettingsStore.crosshair,(null==m?void 0:m.delay)??0,(null==m?void 0:m.digits)??0,this.chartStore.xScale,this.chartStore.chartType,this.chartStore.volumeType,this.chartStore.magnet,Dr(Gi(this,Js).themeStore),Gi(this,Js).themeStore.colors,Gi(this,ti).find(Gi(this,ii).configStore.symbol,Gi(this,ii).configStore.period),Gi(this,ei).accountStore.timezoneShift,Gi(this,ei).accountStore.dayLightMode,Gi(this,yi),s,i),this.chart.sections.init(),this.addHotkeys()}addHotkeys(){Gi(this,si).addHandler(34,(()=>this.chart.setMode(0))),Gi(this,si).addHandler(9,(()=>this.chart.setChartType(1))),Gi(this,si).addHandler(10,(()=>this.chart.setChartType(2))),Gi(this,si).addHandler(11,(()=>this.chart.setChartType(4))),Gi(this,si).addHandler(12,(()=>this.chart.setChartType(3))),Gi(this,si).addHandler(13,(()=>this.toggleVolume(2))),Gi(this,si).addHandler(14,(()=>this.toggleVolume(1))),Gi(this,si).addHandler(15,(()=>{var t;return null==(t=this.chart)?void 0:t.setMode(18)})),Gi(this,si).addHandler(16,(()=>{var t;return null==(t=this.chart)?void 0:t.setMode(13)})),Gi(this,si).addHandler(17,(()=>{var t;return null==(t=this.chart)?void 0:t.setMode(19)})),Gi(this,si).addHandler(18,(()=>{var t;return null==(t=this.chart)?void 0:t.setMode(14)})),Gi(this,si).addHandler(19,(()=>{var t;return null==(t=this.chart)?void 0:t.setMode(9)})),Gi(this,si).addHandler(20,(()=>{var t;return null==(t=this.chart)?void 0:t.setMode(15)})),Gi(this,si).addHandler(21,(()=>{var t;return null==(t=this.chart)?void 0:t.setMode(11)})),Gi(this,si).addHandler(22,(()=>{var t;return null==(t=this.chart)?void 0:t.setMode(10)})),Gi(this,si).addHandler(24,(()=>{var t;return null==(t=this.chart)?void 0:t.moveLeft()})),Gi(this,si).addHandler(23,(()=>{var t;return null==(t=this.chart)?void 0:t.moveRight()})),Gi(this,si).addHandler(26,(()=>{var t;return null==(t=this.chart)?void 0:t.moveScreenLeft()})),Gi(this,si).addHandler(25,(()=>{var t;return null==(t=this.chart)?void 0:t.moveScreenRight()})),Gi(this,si).addHandler(27,(()=>{var t;return null==(t=this.chart)?void 0:t.moveToStart()})),Gi(this,si).addHandler(28,(()=>{var t;return null==(t=this.chart)?void 0:t.moveToEnd()})),Gi(this,si).addHandler(29,(()=>{var t;return null==(t=this.chart)?void 0:t.resetView()})),Gi(this,si).addHandler(30,(()=>{var t;return null==(t=this.chart)?void 0:t.zoomOut()})),Gi(this,si).addHandler(31,(()=>{var t;return null==(t=this.chart)?void 0:t.zoomIn()})),Gi(this,si).addHandler(33,(()=>this.takeScreenshot()))}init(t){this.element=t,this.chart.mount(t),this.chart.sections.init(),Ki(this,oi,hi).call(this),Ki(this,oi,pi).call(this)}destroy(){var t;Ki(this,oi,ai).call(this),Ki(this,oi,ui).call(this),Gi(this,Gs).destroy(this.chart.objects),Gi(this,Xs).destroy(),null==(t=this.calendarManager)||t.destroy(),this.chart.destroy()}async updateCalendar(){var t,e,s;if(Gi(this,Qs).uiSettingsStore.showCalendar){this.calendarManager||(this.calendarManager=await Ki(this,oi,ni).call(this));const t=Gi(this,Zs).getBySymbol(Gi(this,ii).configStore.symbol);t&&(e=t.currencyMargin,s=t.currencyProfit,Boolean(e&&hh.has(e)||s&&hh.has(s)))?this.calendarManager.show(t.currencyMargin,t.currencyProfit):this.calendarManager.hide()}else null==(t=this.calendarManager)||t.hide()}toggleVolume(t){const e=this.chartStore.volumeType;this.chartStore.volumeType=t===e?0:t,this.chartStore.refresh()}select(t){Gi(this,ii).setConfig(t)}async setBarsForce(){const{symbol:t,period:e}=Gi(this,ii).configStore,s=Gi(this,Zs).getBySymbol(t);await this.chart.setBars(Gi(this,ti).find(t,e),null==s?void 0:s.digits,!0)}takeScreenshot(){this.chart.takeScreenshot(yr(this.chart.bars.period))}}Ns=new WeakMap,Rs=new WeakMap,Fs=new WeakMap,Is=new WeakMap,$s=new WeakMap,Vs=new WeakMap,Us=new WeakMap,zs=new WeakMap,Qs=new WeakMap,Ys=new WeakMap,Gs=new WeakMap,Xs=new WeakMap,Js=new WeakMap,Ks=new WeakMap,Zs=new WeakMap,ti=new WeakMap,ei=new WeakMap,si=new WeakMap,ii=new WeakMap,ri=new WeakMap,oi=new WeakSet,ni=async function(){const{CalendarManager:t}=await pr((async()=>{const{CalendarManager:t}=await import("./DNDUHdFU.js");return{CalendarManager:t}}),[]);return new t(this.chart,{protocol_version:8,client_type:4,client_build:Gi(this,ri),connect_type:1})},hi=function(){this.chart.on("111",Gi(this,ki)),this.chart.on("113",Gi(this,vi)),this.chart.on("110",Gi(this,Ti)),this.chart.on("107",Gi(this,Mi)),this.chart.on("108",Gi(this,Pi)),this.chart.on("122",Ki(this,oi,Li)),this.chart.on("117",Gi(this,Oi)),this.chart.analysis.on("202",Gi(this,Wi)),this.chart.analysis.on("208",Gi(this,Bi)),this.chart.analysis.on("207",Gi(this,Ei)),this.chart.objects.on("202",Gi(this,_i)),this.chart.objects.on("208",Gi(this,Di)),this.chart.sections.on("402",Gi(this,Ci))},ai=function(){this.chart.analysis.off("202",Gi(this,Wi)),this.chart.analysis.off("208",Gi(this,Bi)),this.chart.analysis.off("207",Gi(this,Ei)),this.chart.objects.off("202",Gi(this,_i)),this.chart.objects.off("208",Gi(this,Di)),this.chart.sections.off("402",Gi(this,Ci)),this.chart.off("111",Gi(this,ki)),this.chart.off("113",Gi(this,vi)),this.chart.off("107",Gi(this,Mi)),this.chart.off("108",Gi(this,Pi)),this.chart.off("117",Gi(this,Oi))},li=async function(){await Gi(this,Xs).init(Gi(this,ii).configStore.symbol),await this.chart.analysis.init(Gi(this,Xs).indicatorsStore.getAll())},ci=async function(){await Gi(this,Gs).init(this.chart.objects,Gi(this,ii).configStore.symbol),this.chart.objects.init(Gi(this,Gs).objectsStore.getAll())},di=new WeakMap,ui=function(){Gi(this,Rs)&&(Gi(this,Rs).call(this),Ji(this,Rs,void 0)),Gi(this,Ns)&&(Gi(this,Ns).call(this),Ji(this,Ns,void 0)),Gi(this,Fs)&&(Gi(this,Fs).call(this),Ji(this,Fs,void 0)),Gi(this,Is)&&(Gi(this,Is).call(this),Ji(this,Is,void 0)),Gi(this,Vs)&&(Gi(this,Vs).call(this),Ji(this,Vs,void 0)),Gi(this,Us)&&(Gi(this,Us).call(this),Ji(this,Us,void 0)),Gi(this,zs)&&(Gi(this,zs).call(this),Ji(this,zs,void 0))},pi=function(){Ki(this,oi,ui).call(this),Ji(this,Ns,Gi(this,ti).barsStore.subscribe(Gi(this,xi))),Ji(this,Fs,Gi(this,ii).configStore.subscribe(Gi(this,wi))),Ji(this,Is,Gi(this,Zs).symbolsStore.subscribe(Gi(this,fi))),Ji(this,Vs,Gi(this,Js).themeStore.subscribe(Gi(this,mi))),Ji(this,Us,Gi(this,Qs).uiSettingsStore.subscribe(Gi(this,bi))),Ji(this,zs,Gi(this,Ys).layoutStore.subscribe(Gi(this,Si))),Ji(this,Rs,this.chartStore.subscribe(Gi(this,gi)))},yi=new WeakMap,gi=new WeakMap,mi=new WeakMap,bi=new WeakMap,Si=new WeakMap,wi=new WeakMap,fi=new WeakMap,ki=new WeakMap,vi=new WeakMap,Mi=new WeakMap,Ti=new WeakMap,Pi=new WeakMap,Li=function(t){nh({xScale:t.detail})},Oi=new WeakMap,xi=new WeakMap,Ci=new WeakMap,Wi=new WeakMap,Bi=new WeakMap,Ei=new WeakMap,_i=new WeakMap,Di=new WeakMap;class lh{constructor(t,e,s,i,r,o,n,h,a,l,c,d,u,p,y){this.chartStore=new rh,this.chartController=new ah(t,e,s,i,this.chartStore,r,o,n,h,a,l,c,d,u,p,y)}}class ch{constructor(t){Xi(this,Hi),Ji(this,Hi,t)}async agree(){await Gi(this,Hi).notify.send(1)}}Hi=new WeakMap;class dh{constructor(t){this.notifyController=new ch(t)}}var uh=Object.defineProperty,ph=Object.getOwnPropertyDescriptor;class yh extends sr{constructor(){super(),this._systemName="UserSettingsStore",this.oneClick=0}setSettings(t){void 0!==t.oneClick&&(this.oneClick=t.oneClick)}reset(t){this.oneClick=0,this.setSettings(t)}}((t,e,s)=>{for(var i,r=ph(e,s),o=t.length-1;o>=0;o--)(i=t[o])&&(r=i(e,s,r)||r);r&&uh(e,s,r)})([ir],yh.prototype,"setSettings");class gh{constructor(t,e){Xi(this,qi),Xi(this,Ai),Xi(this,ji,(t=>{Gi(this,qi).add({oneClick:t.oneClick})})),this.userSettingsStore=e,Ji(this,qi,t)}async init(){const t=await Gi(this,qi).getAll();this.userSettingsStore.reset(t[0]||{}),Gi(this,Ai)&&Gi(this,Ai).call(this),Ji(this,Ai,this.userSettingsStore.subscribe(Gi(this,ji)))}destroy(){Gi(this,Ai)&&(Gi(this,Ai).call(this),Ji(this,Ai,void 0))}}qi=new WeakMap,Ai=new WeakMap,ji=new WeakMap;class mh{constructor(t){this.userSettingsStore=new yh,this.userSettingsController=new gh(t,this.userSettingsStore)}}function bh(t){switch(t[0]){case 0:return t[1];case 1:return window.tr(window.lang.trade.corporateLink.type.clientAgreement);case 2:return window.tr(window.lang.trade.corporateLink.type.riskDisclosure);case 3:return window.tr(window.lang.trade.corporateLink.type.clientAgreementAndRiskDisclosure);case 4:return window.tr(window.lang.trade.corporateLink.type.complaintsHandlingProcedure);case 5:return window.tr(window.lang.trade.corporateLink.type.orderExecutionPolicy);case 6:return window.tr(window.lang.trade.corporateLink.type.clientCategorisationNotice);case 7:return window.tr(window.lang.trade.corporateLink.type.conflictsOfInterestPolicy);case 8:return window.tr(window.lang.trade.corporateLink.type.dataProtectionPolicy);case 9:return window.tr(window.lang.trade.corporateLink.type.fdmDisclaimer);default:return t[2]}}class Sh{constructor(t){Xi(this,Ni),Ji(this,Ni,t)}async getLinks(){return(await Gi(this,Ni).corporateLinks.getLinks()).map((t=>[bh(t),t[2]]))}}Ni=new WeakMap;class wh{constructor(t){this.corporateLinksController=new Sh(t)}}class fh extends Cr{_drawObject(t){const{section:e,settings:s,chart:i}=this,{state:r}=i,{coordinates:o,lock:n}=s;this.settings.style.line.priceFill=this.chart.colors.chart.backgroundColor;const h=o.price1||0,a=this.valueToY(h);a<0||a>e.height||(n||(t.eventMode="static",t.cursor="pointer"),this._drawMask(),this._drawLine(t,h,0,a),this._drawText(t,0,a),n||this._drawSelected(t,.5*r.graphWidth,a))}_drawSelected(t,e=0,s=0){const{settings:i}=this,{backgroundColor:r}=this.chart.colors.chart,o=i.style.line,n={backgroundColor:r,borderColor:o.color,borderThickness:2},h={backgroundColor:o.color,borderColor:r,borderThickness:0};n&&(this._drawPoint(t,n,e,s),this._drawPoint(t,h,e,s,3))}onPointerDown(t){this.focused=!0,this.settings.setMovingStatus(!0),super.onPointerDown(t)}onPointerUp(t){super.onPointerUp(t),this.settings.setMovingStatus(!1)}selectIfInArea(){return!1}}var kh=Object.defineProperty,vh=Object.getOwnPropertyDescriptor,Mh=(t,e,s,i)=>{for(var r,o=vh(e,s),n=t.length-1;n>=0;n--)(r=t[n])&&(o=r(e,s,o)||o);return o&&kh(e,s,o),o};class Th extends Wr{constructor(t,e){super(t,{price1:0},{line:{color:3978097,thickness:1,price:!0,priceColor:3978097,priceFill:16777215},text:{content:"Trade line",visible:!0,color:3978097,size:12,align:0,valign:0}},16,1,0,!1),Xi(this,Ri),this.moving=!1,Ji(this,Ri,e),void 0!==(null==t?void 0:t.lineType)&&(this.lineType=t.lineType)}setMovingStatus(t){this.moving=t}clear(){this.visible=!1,delete this.digits,delete this.volume,delete this.orderType,this.coordinates.price1=0}setValue(t={}){this.visible=Boolean("number"==typeof t.value),"number"==typeof t.volume&&(this.volume=t.volume),t.digits&&(this.digits=t.digits),void 0!==t.type&&(this.orderType=t.type),"number"==typeof t.valueFrom&&(this.valueFrom=t.valueFrom),"number"==typeof t.multiply&&(this.multiply=t.multiply),"number"==typeof t.profit&&(this.profit=t.profit),t.currency&&(this.currency=t.currency),this.setCoordinates({price1:t.value??void 0})}setCoordinates(t){super.setCoordinates(t),this.coordinates.price1&&"number"==typeof this.coordinates.price1&&this.setLineData(this.coordinates.price1)}setLineData(t){switch(this.lineType){case 0:if(void 0!==this.orderType&&this.volume){const e=`${Gi(this,Ri).printType(this.orderType).toUpperCase()} ${this.volume} at ${t.toFixed(this.digits)}`;this.style.text.content=e,Gi(this,Ri).isBuy(this.orderType)?(this.style.text.color=3899884,this.style.line.color=3899884,this.style.line.priceColor=3899884):Gi(this,Ri).isSell(this.orderType)&&(this.style.text.color=15354956,this.style.line.color=15354956,this.style.line.priceColor=15354956)}break;case 1:case 2:if(this.style.text.title){let e=`${this.style.text.title}`;if("number"==typeof this.valueFrom&&void 0!==this.orderType){const s=Gi(this,Ri).isBuy(this.orderType);"number"==typeof this.profit&&(e+=`, ${this.profit.toFixed(2)}`,this.currency&&(e+=` ${this.currency}`)),e+=`, ${this.getPoints(s,this.valueFrom,t)}`}this.style.text.content=e}break;case 3:if(this.style.text.title){const e=t.toFixed(this.digits),s=`${this.style.text.title} ${this.volume||""} at ${e}`;this.style.text.content=s}}}getPoints(t,e,s){return this.multiply?`${((t?s-e:e-s)*this.multiply).toFixed(0)} points`:""}}Ri=new WeakMap,Mh([ir],Th.prototype,"setMovingStatus"),Mh([ir],Th.prototype,"clear"),Mh([ir],Th.prototype,"setValue");class Ph extends Or{constructor(t,e){super(t),Xi(this,Ii),Xi(this,Fi),this.inited=!1,Ji(this,Fi,e),this.onMove=this.onMove.bind(this),this.onMoveStart=this.onMoveStart.bind(this),this.onMoveFinish=this.onMoveFinish.bind(this),this.onFocus=this.onFocus.bind(this),this.onBlur=this.onBlur.bind(this),this.onDoubleClick=this.onDoubleClick.bind(this),this.init()}get(){}getPrice(){return this.data[0].settings}getSL(){return this.data[1].settings}getTP(){return this.data[2].settings}getTriggerPrice(){return this.data[3].settings}getIndex(t){return this.data.findIndex((e=>(null==e?void 0:e.settings.uid)===t))}setVisible(t,e){const s=this.data.find((({settings:e})=>e.uid===t));s&&s.settings.setVisible(e)}init(){this.on("3005",this.onMove),this.on("3002",this.onMoveStart),this.on("3003",this.onMoveFinish),this.on("3006",this.onFocus),this.on("3004",this.onBlur),this.on("3001",this.onDoubleClick),this.data=[Ki(this,Ii,$i).call(this,fh,new Th({uid:"price",type:31,visible:!1,lineType:0,style:{line:{color:3899884,thickness:1,price:!0,priceColor:3899884,priceFill:16777215},text:{title:"",content:"",visible:!0,color:3899884,size:12,align:0,valign:0}}},Gi(this,Fi))),Ki(this,Ii,$i).call(this,fh,new Th({uid:"sl",type:30,visible:!1,lineType:1,style:{line:{color:15495191,thickness:1,price:!0,priceColor:16746051,priceFill:16777215},text:{title:"SL",content:"",visible:!0,color:16746051,size:12,align:0,valign:0}}},Gi(this,Fi))),Ki(this,Ii,$i).call(this,fh,new Th({uid:"tp",type:29,visible:!1,lineType:2,style:{line:{color:3584843,thickness:1,price:!0,priceColor:4900447,priceFill:16777215},text:{title:"TP",content:"",visible:!0,color:4900447,size:12,align:0,valign:0}}},Gi(this,Fi))),Ki(this,Ii,$i).call(this,fh,new Th({uid:"trigger",type:32,visible:!1,lineType:3,style:{line:{color:3899884,thickness:1,price:!0,priceColor:3899884,priceFill:16777215},text:{title:"STOP LIMIT PRICE",content:"",visible:!0,color:3899884,size:12,align:0,valign:0}}},Gi(this,Fi)))],this.inited=!0}getOptions(t,e){let s=t.parent&&this.chart.sections.getByIndicatorUid(t.parent)||void 0;if(e&&!(1&t.flags)){const{x:i,y:r}=e.data.global;s=this.chart.sections.getByCoordinate(i,r),s&&(s.collapsed()?s=void 0:s.indicator&&(t.parent=s.indicator.settings.uid))}return this.chart.createOptions(s)}lock(t,e=!0){const s=this.data.find((({settings:e})=>e.uid===t));return s&&(s.settings.lock=e,s.blur()),this}onFocus(t){const{detail:e}=t;this.trigger("301",e)}onBlur(t){const{detail:e}=t;this.trigger("302",e)}onMove(t){const{detail:e}=t;this.trigger("303",{uid:e.uid,bar:e.bar,date:e.date,price:e.price})}onMoveStart(t){const{detail:e}=t;this.trigger("304",e)}onMoveFinish(t){const{detail:e}=t;this.trigger("305",e)}onDoubleClick(t){this.edit(t.detail.uid)}destroy(){this.off("3005",this.onMove),this.off("3002",this.onMoveStart),this.off("3003",this.onMoveFinish),this.off("3006",this.onFocus),this.off("3004",this.onBlur),this.off("3001",this.onDoubleClick),this.data.forEach((t=>t.destroy())),super.destroy()}}Fi=new WeakMap,Ii=new WeakSet,$i=function(t,e){const s=new t(this.getOptions(e),8e3,e);return this.trigger("201",e.uid),s};class Lh{constructor(t,e){this.tradeLinesManager=new Ph(t.chart,e)}destroy(){this.tradeLinesManager.destroy()}}class Oh{constructor(t,e){this.tradeLinesController=new Lh(t,e)}}class xh{constructor(t,e,s,i,r,o,n){Xi(this,Ui),Xi(this,Vi),this.disabled=!1,this.api=s,Ji(this,Vi,e),this.apiUtils=i,e.journal.journalController.connectApi(s),this.notify=new dh(s),this.notices=new In(s,i.trade),this.history=new So(s),this.books=new zr(s),this.corporateLinks=new wh(s),this.bars=new sh(s,i.volume,gr.trade_bars),this.userSettings=new mh(gr.user_settings),this.account=new Rr(s,e.users.usersController),this.symbols=new Kr(s,this.account.accountController),this.ticks=new Oo(s,this.symbols.symbolsController,this.bars.barsController),this.trade=new rn(s,i.trade,this.symbols.symbolsController,this.ticks.ticksController),this.watchlist=new cn(s,gr.watchlist,this.symbols.symbolsController,this.ticks.ticksController,this.trade.tradeController),this.configs=new Gn(gr.configs,this.symbols.symbolsController,this.watchlist.watchlistController),this.objects=new ko(gr.objects),this.indicators=new Bo(gr.indicators),this.chart=new lh(t,r,o,n,e.uiSettings.uiSettingsController,e.layout.layoutController,this.configs.configsController,e.theme.themeController,this.bars.barsController,this.symbols.symbolsController,this.account.accountController,this.objects.objectsController,this.indicators.indicatorsController,this.ticks.ticksController,e.hotkeys.hotkeysController),this.interaction=new Hn(e.layout.layoutController,this.trade.tradeController),this.marks=new Cn(gr.marks,this.interaction.interactionController,this.chart.chartController,this.account.accountController,this.trade.tradeController,this.history.historyController,this.symbols.symbolsController,e.layout.layoutController.layoutStore,this.userSettings.userSettingsStore,this.ticks.ticksController,i.order),this.tradeLines=new Oh(this.chart.chartController,i.order)}async init(){this.account.accountStore.isResetPass||(this.notices.noticesController.init(),await this.userSettings.userSettingsController.init(),this.ticks.ticksController.init(),await this.watchlist.watchlistController.init(),await this.configs.configsController.init(),await this.bars.barsController.init(),this.history.historyController.init(),this.marks.marksController.init(),Ki(this,Ui,zi).call(this))}async destroy(){this.disabled=!0,await tr(),this.account.accountController.destroy(),this.notices.noticesController.destroy(),this.userSettings.userSettingsController.destroy(),this.notices.noticesController.destroy(),this.configs.configsController.destroy(),this.bars.barsController.destroy(),this.books.booksController.destroy(),this.history.historyController.destroy(),this.ticks.ticksController.destroy(),this.trade.tradeController.destroy(),this.watchlist.watchlistController.destroy(),this.marks.marksController.destroy(),this.tradeLines.tradeLinesController.destroy(),this.chart.chartController.destroy(),this.api.destroy()}}Vi=new WeakMap,Ui=new WeakSet,zi=function(){Gi(this,Vi).layout.layoutController.addHotkeys(),Gi(this,Vi).uiSettings.uiSettingsController.addHotkeys(),this.chart.chartController.addHotkeys()};export{xh as Modules};
